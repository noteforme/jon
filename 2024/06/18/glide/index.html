<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Glide | Jon's Blog</title><meta name="author" content="Jon"><meta name="copyright" content="Jon"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Table of Contents  Toggle- Question  Glide Flow sequenceDiagram Status.WAITING_FOR_SIZE   Bind lifecycle Old lifecycle architecture new lifecycle architecture Advantages of the New Approach LifeCycle">
<meta property="og:type" content="article">
<meta property="og:title" content="Glide">
<meta property="og:url" content="https://noteforme.github.io/2024/06/18/glide/index.html">
<meta property="og:site_name" content="Jon&#39;s Blog">
<meta property="og:description" content="Table of Contents  Toggle- Question  Glide Flow sequenceDiagram Status.WAITING_FOR_SIZE   Bind lifecycle Old lifecycle architecture new lifecycle architecture Advantages of the New Approach LifeCycle">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png">
<meta property="article:published_time" content="2024-06-18T05:50:06.000Z">
<meta property="article:modified_time" content="2024-09-13T21:02:22.000Z">
<meta property="article:author" content="Jon">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://noteforme.github.io/2024/06/18/glide/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Glide',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-09-14 05:02:22'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">243</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">33</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">30</div></a></div><hr class="custom-hr"/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Jon's Blog"><span class="site-name">Jon's Blog</span></a></span><div id="menus"><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Glide</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-06-18T05:50:06.000Z" title="Created 2024-06-18 13:50:06">2024-06-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-09-13T21:02:22.000Z" title="Updated 2024-09-14 05:02:22">2024-09-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Library/">Library</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Glide"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><div class="ez-toc-v2_0_66_1 ez-toc-wrap-right counter-hierarchy ez-toc-counter ez-toc-grey ez-toc-container-direction" id="ez-toc-container"><div class="ez-toc-title-container">Table of Contents

<p><span class="ez-toc-title-toggle"><a href="#"><span class="ez-toc-js-icon-con"><span class><span class="eztoc-hide" style="display:none;">Toggle</span><span class="ez-toc-icon-toggle-span"><svg class="list-377408" fill="none" height="20px" style="fill: #999;color:#999" viewbox="0 0 24 24" width="20px" xmlns="http://www.w3.org/2000/svg"><path d="M6 6H4v2h2V6zm14 0H8v2h12V6zM4 11h2v2H4v-2zm16 0H8v2h12v-2zM4 16h2v2H4v-2zm16 0H8v2h12v-2z" fill="currentColor"/></svg><svg baseprofile="tiny" class="arrow-unsorted-368013" height="10px" style="fill: #999;color:#999" version="1.2" viewbox="0 0 24 24" width="10px" xmlns="http://www.w3.org/2000/svg"><path d="M18.2 9.3l-6.2-6.3-6.2 6.3c-.2.2-.3.4-.3.7s.1.5.3.7c.2.2.4.3.7.3h11c.3 0 .5-.1.7-.3.2-.2.3-.5.3-.7s-.1-.5-.3-.7zM5.8 14.7l6.2 6.3 6.2-6.3c.2-.2.3-.5.3-.7s-.1-.5-.3-.7c-.2-.2-.4-.3-.7-.3h-11c-.3 0-.5.1-.7.3-.2.2-.3.5-.3.7s.1.5.3.7z"/></svg></span></span></span></a></span></p></div><nav>- <a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Question" title="Question">Question</a><p></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Glide_Flow" title="Glide Flow">Glide Flow</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#sequenceDiagram_StatusWAITING_FOR_SIZE" title="sequenceDiagram   Status.WAITING_FOR_SIZE">sequenceDiagram Status.WAITING_FOR_SIZE</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Bind_lifecycle" title="Bind lifecycle">Bind lifecycle</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Old_lifecycle_architecture" title="Old lifecycle architecture">Old lifecycle architecture</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#new_lifecycle_architecture" title="new lifecycle architecture">new lifecycle architecture</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Advantages_of_the_New_Approach" title="Advantages of the New Approach">Advantages of the New Approach</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#LifeCycle_flow_UML" title="LifeCycle flow UML">LifeCycle flow UML</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#connective_lifecycle_UML" title="connective lifecycle UML">connective lifecycle UML</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Glide_caching_strategy" title="Glide caching strategy">Glide caching strategy</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Concept" title="Concept">Concept</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Cache_Levels" title="Cache Levels">Cache Levels</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Caching_Keys" title="Caching Keys">Caching Keys</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Image_Requests" title="Image Requests">Image Requests</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Cache_Invalidation" title="Cache Invalidation">Cache Invalidation</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Disk_Cache" title="Disk Cache">Disk Cache</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#KEY" title="KEY">KEY</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Identifying_an_Object" title="Identifying an Object">Identifying an Object</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Example_Implementation" title="Example Implementation">Example Implementation</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Key_Points" title="Key Points">Key Points</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#equal_objects_cannot_have_different_hash_codes" title="equal objects cannot have different hash codes">equal objects cannot have different hash codes</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Key_Points-2" title="Key Points">Key Points</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Active_recyle" title="Active recyle">Active recyle</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#LruCache" title="LruCache">LruCache</a><ul>
<li><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#How_Glide_Uses_LruCache" title="How Glide Uses LruCache">How Glide Uses LruCache</a></li>
</ul>
</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Bitmap_Reuse" title="Bitmap Reuse">Bitmap Reuse</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#botain_bitmap" title="botain bitmap">botain bitmap</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#save_bitmap" title="save bitmap">save bitmap</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#bitmap_save_condition" title="bitmap save condition">bitmap save condition</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#decoded_VS_without_decode" title="decoded VS without decode">decoded VS without decode</a><br>- <a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Decoded_Cache" title="Decoded Cache">Decoded Cache</a><br>- <a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Without_Decode_Encoded_Cache" title="Without Decode (Encoded Cache)">Without Decode (Encoded Cache)</a></li>
</ul>
</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#BUILD_PROJECT" title="BUILD PROJECT">BUILD PROJECT</a></li>
</ul>
</nav></div># <span class="ez-toc-section" id="Question"></span>Question<span class="ez-toc-section-end"></span>

<p>This article has many <strong>flowcharts</strong> to introduce the principles<br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/ZjKkTJ5GpP8e2BnttiJEiA">https://mp.weixin.qq.com/s/ZjKkTJ5GpP8e2BnttiJEiA</a><br><a target="_blank" rel="noopener" href="https://juejin.cn/post/6882536990400020494">https://juejin.cn/post/6882536990400020494</a></p>
<p>Glide使用什么缓存机制<br>LRUcache底层实现</p>
<p>glide和OkHttp的任务调度是怎么实现的（比如同时发起很多请求）<br>自己去实现图片库，怎么做？<br>Glide内存缓存如何控制大小？</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6956090846470995975">https://juejin.cn/post/6956090846470995975</a></p>
<p>bitmap decode<br><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904161327185927">https://juejin.cn/post/6844904161327185927</a><br><a target="_blank" rel="noopener" href="https://juejin.cn/post/6994669144490639368#heading-4">https://juejin.cn/post/6994669144490639368#heading-4</a></p>
<h1 id="Glide-Flow"><a href="#Glide-Flow" class="headerlink" title="Glide Flow"></a><span class="ez-toc-section" id="Glide_Flow"></span>Glide Flow<span class="ez-toc-section-end"></span></h1><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/oSXDYhc_t4xhAVCfADxXfg">https://mp.weixin.qq.com/s/oSXDYhc_t4xhAVCfADxXfg</a><br><a target="_blank" rel="noopener" href="https://juejin.cn/post/7083367492810686472">https://juejin.cn/post/7083367492810686472</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43298955/article/details/118661784">https://blog.csdn.net/weixin_43298955&#x2F;article&#x2F;details&#x2F;118661784</a><br><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1gq4y1n7wq?p=4">https://www.bilibili.com/video/BV1gq4y1n7wq?p=4</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/48d9e4d5d75d">https://www.jianshu.com/p/48d9e4d5d75d</a></p>
<p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/Architecture/2021-08-09_4.51_glideflow.png"></p>
<p>According to this picture, the image acquisition process is first from Active Resource, then from Memory cache, and then from Disk cache.</p>
<h2 id="sequenceDiagram-Status-WAITING-FOR-SIZE"><a href="#sequenceDiagram-Status-WAITING-FOR-SIZE" class="headerlink" title="sequenceDiagram Status.WAITING_FOR_SIZE"></a><span class="ez-toc-section" id="sequenceDiagram_StatusWAITING_FOR_SIZE"></span>sequenceDiagram Status.WAITING_FOR_SIZE<span class="ez-toc-section-end"></span></h2><p>Loading an image flow for the first time from the network</p>
<div class="mermaid">
  sequenceDiagram
  RequestBuilder ->> RequestManager : track()
  RequestBuilder ->> RequestTracker : runRequest()
  RequestBuilder ->> SingleRequest : begin()
alt status.WAITING_FOR_SIZE
  SingleRequest ->> SingleRequest : onSizeReady()
  SingleRequest ->> Engine : load()

 alt  no memoryResource 
  Engine ->> Engine : waitForExistingOrStartNewJob()
  Engine ->> Engine : build()
  Engine ->> DecodeJob : run()
  DecodeJob ->> DecodeJob : runWrapped() INITIALIZE
  DecodeJob ->> DecodeJob : getNextStage(INITIALIZE) 
  DecodeJob ->> DecodeJob : getNextGenerator(),runGenerators()
  DecodeJob ->> ResourceCacheGenerator : startNext()
  loop stage == Stage.SOURCE
  DecodeJob ->> DecodeJob :  reschedule(SWITCH_TO_SOURCE_SERVICE)
  end
  DecodeJob ->> DecodeJob : run()
  DecodeJob ->> DecodeJob : runWrapped(),runGenerators()
  DecodeJob ->> SourceGenerator : startNext()
  SourceGenerator ->> SourceGenerator : startNextLoad(loadData)
  SourceGenerator ->> MultiModelLoader : loadData(loadData)
  MultiModelLoader ->> HttpUrlFetcher : loadData(loadData)
  HttpUrlFetcher -->> MultiModelLoader :  callback.onDataReady(data)
  MultiModelLoader -->> SourceGenerator :  callback.onDataReady(data)
  SourceGenerator -->> SourceGenerator :  onDataReadyInternal()
  SourceGenerator -->> DecodeJob :  reschedule(SWITCH_TO_SOURCE_SERVICE)
  DecodeJob ->> DecodeJob : run()
  DecodeJob ->> DecodeJob : runWrapped(),runGenerators()
  DecodeJob ->> DecodeJob : startNext()
  DecodeJob ->> SourceGenerator : startNext()
  SourceGenerator ->> SourceGenerator : startNextLoad(loadData)

  SourceGenerator ->> DataCacheGenerator : sourceCacheGenerator.startNext()
  DataCacheGenerator ->> ByteBufferFileLoader : loadData(helper.getPriority(), this)
  ByteBufferFileLoader -->> DataCacheGenerator : onDataReady(result)
  DataCacheGenerator -->> SourceGenerator : onDataFetcherReady()
  SourceGenerator -->> DecodeJob : onDataFetcherReady()
  DecodeJob ->> DecodeJob : decodeFromRetrievedData()
  DecodeJob ->> DecodeJob : decodeFromData(),notifyEncodeAndRelease()
  DecodeJob ->> DecodeJob : notifyComplete()
  DecodeJob ->> EngineJob : onResourceReady(),notifyCallbacksOfResult()
  EngineJob ->> CallResourceReady : run(),notifyCallbacksOfResult(cb)
  CallResourceReady -->> EngineJob : callCallbackOnResourceReady(cb)
  EngineJob -->> SingleRequest : onResourceReady(cb)
  SingleRequest ->> ImageViewTarget : target.onResourceReady(result)
  ImageViewTarget ->> ImageViewTarget : setResourceInternal()
  ImageViewTarget ->> DrawableImageViewTarget : setResource()
 end
end
</div>


<p>What should be noted here is that I looked at the source code. After getting the image from the Internet, it will not go directly to the active resource, nor will it be displayed directly on the ImageView. Instead, <strong>it will be saved to the disk and then read from the disk</strong>. I saw this</p>
<h1 id="Bind-lifecycle"><a href="#Bind-lifecycle" class="headerlink" title="Bind lifecycle"></a><span class="ez-toc-section" id="Bind_lifecycle"></span>Bind lifecycle<span class="ez-toc-section-end"></span></h1><h2 id="Old-lifecycle-architecture"><a href="#Old-lifecycle-architecture" class="headerlink" title="Old lifecycle architecture"></a><span class="ez-toc-section" id="Old_lifecycle_architecture"></span>Old lifecycle architecture<span class="ez-toc-section-end"></span></h2><p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/Architecture/2021-08-09_4.52_lifecycle.png"></p>
<h2 id="new-lifecycle-architecture"><a href="#new-lifecycle-architecture" class="headerlink" title="new lifecycle architecture"></a><span class="ez-toc-section" id="new_lifecycle_architecture"></span>new lifecycle architecture<span class="ez-toc-section-end"></span></h2><p>The Glide library for Android indeed underwent significant changes in its architecture. As of Glide version 4.x, Glide has moved away from using <del>RequestManagerFragment</del> for lifecycle management. Instead, Glide now uses <strong>LifecycleListener</strong> interfaces and <strong>RequestManagerRetriever</strong> to more efficiently manage the lifecycle of requests.</p>
<p>Here is a brief overview of the changes:</p>
<p>Glide 4.x and Lifecycle Management</p>
<ol>
<li>Lifecycle Integration:<br>  Glide now directly integrates with Android’s lifecycle components (Activity, Fragment, Application), which simplifies the lifecycle management of requests. Glide automatically pauses and resumes requests based on the lifecycle events.</li>
<li>LifecycleListeners:<br>  Glide uses LifecycleListener interfaces to handle lifecycle events. These listeners are registered with the Android components (Activities and Fragments), and they notify Glide when to start, stop, or recycle requests.</li>
</ol>
<h2 id="Advantages-of-the-New-Approach"><a href="#Advantages-of-the-New-Approach" class="headerlink" title="Advantages of the New Approach"></a><span class="ez-toc-section" id="Advantages_of_the_New_Approach"></span>Advantages of the New Approach<span class="ez-toc-section-end"></span></h2><ul>
<li>Improved Lifecycle Handling: Glide now more accurately handles the lifecycle of requests, reducing the chances of memory leaks or unnecessary work.</li>
<li>Simplified API: The new API is more intuitive and easier to use, thanks to the integration with Android’s lifecycle components.</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Qy4y1s7Gh?p=15">https://www.bilibili.com/video/BV1Qy4y1s7Gh?p=15</a></p>
<h2 id="LifeCycle-flow-UML"><a href="#LifeCycle-flow-UML" class="headerlink" title="LifeCycle flow UML"></a><span class="ez-toc-section" id="LifeCycle_flow_UML"></span>LifeCycle flow UML<span class="ez-toc-section-end"></span></h2><div class="mermaid">
  sequenceDiagram
autonumber
Glide ->> RequestManagerRetriever : get(FragmentActivity)
RequestManagerRetriever ->> LifecycleRequestManagerRetriever : getOrCreate(getLifecycle())

LifecycleRequestManagerRetriever ->> LifecycleLifecycle:  constructor(lifecycle)
LifecycleLifecycle ->> LifecycleRegistry : lifecycle.addObserver(this)

LifecycleRequestManagerRetriever ->> RequestManager : build(getLifecycle)
RequestManager ->> DefaultConnectivityMonitor : ConnectivityMonitor
Note over RequestManager , DefaultConnectivityMonitor : network connection monitor

LifecycleRegistry -->> LifecycleLifecycle : onStart()
LifecycleRegistry -->> LifecycleLifecycle : onStop()
LifecycleRegistry -->> LifecycleLifecycle : onDestroy()
LifecycleLifecycle ->> RequestManager :  onStart()
Note right of RequestManager : resumeRequests()
LifecycleLifecycle ->> RequestManager :  onStop()
Note right of RequestManager : pauseRequests()
LifecycleLifecycle ->> RequestManager :  onDestroy()
</div>


<h2 id="connective-lifecycle-UML"><a href="#connective-lifecycle-UML" class="headerlink" title="connective lifecycle UML"></a><span class="ez-toc-section" id="connective_lifecycle_UML"></span>connective lifecycle UML<span class="ez-toc-section-end"></span></h2><div class="mermaid">
  classDiagram
%% Creator
  class ConnectivityMonitorFactory {
    + someOperation()
    + factoryMethod(): ConnectivityMonitor
  }

%% concreate factory
  class DefaultConnectivityMonitorFactory {
    +createProduct(): Product
  }

  class ConnectivityMonitor {
     interface
    +operation(): void
  }

%% concreate product
  class DefaultConnectivityMonitor 

%% concreate product
  class NullConnectivityMonitor 

  ConnectivityMonitor <|-- defaultconnectivitymonitor : inheritance connectivitymonitor <|-- nullconnectivitymonitor connectivitymonitorfactory <|.. defaultconnectivitymonitorfactory realization ..> ConnectivityMonitor
</|--></div>


<h1 id="Glide-caching-strategy"><a href="#Glide-caching-strategy" class="headerlink" title="Glide caching strategy"></a><span class="ez-toc-section" id="Glide_caching_strategy"></span>Glide caching strategy<span class="ez-toc-section-end"></span></h1><p>Glide使用什么缓存机制<br>LRUcache底层实现</p>
<p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/glide/Screenshot%202024-06-19%20at%2009.58.55.png"></p>
<h2 id="Concept"><a href="#Concept" class="headerlink" title="Concept"></a><span class="ez-toc-section" id="Concept"></span>Concept<span class="ez-toc-section-end"></span></h2><h3 id="Cache-Levels"><a href="#Cache-Levels" class="headerlink" title="Cache Levels"></a><span class="ez-toc-section" id="Cache_Levels"></span>Cache Levels<span class="ez-toc-section-end"></span></h3><ul>
<li><strong>Active Resources</strong>: These are images currently being displayed. They are kept in memory for immediate access.</li>
<li><strong>Memory Cache</strong>: Once images are no longer in the active resources, they move to the memory cache if there is enough space.</li>
<li><strong>Disk Cache</strong> : If images are no longer in the memory cache, they are still stored in the disk cache. This allows for retrieval without needing to download the image again.</li>
</ul>
<h3 id="Caching-Keys"><a href="#Caching-Keys" class="headerlink" title="Caching Keys"></a><span class="ez-toc-section" id="Caching_Keys"></span>Caching Keys<span class="ez-toc-section-end"></span></h3><ul>
<li>Glide generates unique keys for caching images. These keys are based on the image URL and any transformation or resizing options applied to the image.</li>
<li>Custom keys can be provided by the developer to manage cache more effectively, especially when dealing with dynamic content.</li>
</ul>
<h3 id="Image-Requests"><a href="#Image-Requests" class="headerlink" title="Image Requests"></a><span class="ez-toc-section" id="Image_Requests"></span>Image Requests<span class="ez-toc-section-end"></span></h3><ul>
<li>When a request for an image is made, Glide first checks the active resources, then the memory cache, and finally the disk cache.</li>
<li>If the image is not found in any of these caches, it is fetched from the network or local storage.</li>
</ul>
<h3 id="Cache-Invalidation"><a href="#Cache-Invalidation" class="headerlink" title="Cache Invalidation"></a><span class="ez-toc-section" id="Cache_Invalidation"></span>Cache Invalidation<span class="ez-toc-section-end"></span></h3><ul>
<li>Cache invalidation is necessary to ensure outdated images are not served. Glide allows developers to clear specific entries or entire caches.</li>
<li>It supports automatic cache invalidation based on configurable time intervals.</li>
<li>If the image does not exist in the memory cache, it is read from the disk cache and then placed into the active resources.</li>
<li>If the image does not exist in the memory cache, it will be requested from the network. and then what ???</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/dba296118f35">https://www.jianshu.com/p/dba296118f35</a><br><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1mT4y1R7F4/?p=37">https://www.bilibili.com/video/BV1mT4y1R7F4/?p=37</a></p>
<h2 id="Disk-Cache"><a href="#Disk-Cache" class="headerlink" title="Disk Cache"></a><span class="ez-toc-section" id="Disk_Cache"></span>Disk Cache<span class="ez-toc-section-end"></span></h2><div class="mermaid">
  sequenceDiagram
  autonumber
  RequestBuilder ->> RequestBuilder : into()
  RequestBuilder ->> RequestManager : track()
  RequestBuilder ->> RequestTracker : runRequest()
  RequestTracker ->> SingleRequest : begin()
  SingleRequest ->> SingleRequest : onSizeReady(overrideWidth, overrideHeight)
  SingleRequest ->> Engine : load()
  Engine ->> Engine : loadFromMemory()
  Engine ->> Engine : loadFromActiveResources(key) 
  Note right of Engine : Active Resource
  Engine ->> Engine : loadFromCache(key)
  Note right of Engine : Memory Cache
  Engine ->> DecodeJob : runWrapped(),runGenerators()
  Engine ->> DataCacheGenerator : currentGenerator.startNext()
  DataCacheGenerator ->> ByteBufferFileLoader : loadData(helper.getPriority(), this)
  ByteBufferFileLoader -->> DataCacheGenerator : onDataReady(result)
  DataCacheGenerator -->> SourceGenerator : onDataFetcherReady()
  SourceGenerator -->> DecodeJob : onDataFetcherReady()
  DecodeJob ->> DecodeJob : decodeFromRetrievedData()
  DecodeJob ->> DecodeJob : decodeFromData(),notifyEncodeAndRelease()
  DecodeJob ->> DecodeJob : notifyComplete()
  DecodeJob ->> EngineJob : onResourceReady(),notifyCallbacksOfResult()
  EngineJob -->> Engine : onEngineJobComplete()
  Note right of Engine : activeResources.activate()

  EngineJob ->> CallResourceReady : run(),notifyCallbacksOfResult(cb)
  CallResourceReady -->> EngineJob : callCallbackOnResourceReady(cb)
  EngineJob -->> SingleRequest : onResourceReady(cb)
  SingleRequest ->> ImageViewTarget : target.onResourceReady(result)
  ImageViewTarget ->> ImageViewTarget : setResourceInternal()
  ImageViewTarget ->> DrawableImageViewTarget : setResource()
</div>


<p>step8 : get Active Resources<br>step9 : get Memery Cache<br>step20 : Read from disk cache and then put into active resources.</p>
<h1 id="KEY"><a href="#KEY" class="headerlink" title="KEY"></a><span class="ez-toc-section" id="KEY"></span>KEY<span class="ez-toc-section-end"></span></h1><p>In Java, the equals and hashCode methods are used to compare objects and manage how objects are stored in certain collections like HashMap and HashSet.</p>
<ul>
<li>equals Method<br>The equals method determines whether two objects are equal. By default, the equals method in the Object class compares the memory addresses of the objects (i.e., whether they are the same instance). However, it is common to override this method to provide a meaningful equality check based on the object’s state (i.e., its fields).</li>
<li>hashCode Method<br>The hashCode method returns an integer hash code representation of the object. The contract between equals and hashCode is that if two objects are equal according to the equals method, they must have the same hash code. However, two objects with the same hash code do not necessarily have to be equal.</li>
</ul>
<h2 id="Identifying-an-Object"><a href="#Identifying-an-Object" class="headerlink" title="Identifying an Object"></a><span class="ez-toc-section" id="Identifying_an_Object"></span>Identifying an Object<span class="ez-toc-section-end"></span></h2><p>When you override the equals and hashCode methods properly, they can be used to uniquely identify an object in certain collections. Here’s how:</p>
<ol>
<li>Equality Check: When you use collections like HashSet or keys in HashMap, the equals method is used to check if an object already exists in the collection.</li>
<li>Hash Code: The hashCode method is used by hash-based collections (like HashMap and HashSet) to efficiently locate a bucket in which the object might be stored. Proper implementation of hashCode ensures that objects are distributed evenly across the buckets, reducing the number of collisions and improving performance.</li>
</ol>
<h2 id="Example-Implementation"><a href="#Example-Implementation" class="headerlink" title="Example Implementation"></a><span class="ez-toc-section" id="Example_Implementation"></span>Example Implementation<span class="ez-toc-section-end"></span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Constructor, getters, and setters</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == obj) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="literal">null</span> || getClass() != obj.getClass()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> (Person) obj;</span><br><span class="line">        <span class="keyword">return</span> age == person.age &amp;&amp; Objects.equals(name, person.name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hash(name, age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Key-Points"><a href="#Key-Points" class="headerlink" title="Key Points"></a><span class="ez-toc-section" id="Key_Points"></span>Key Points<span class="ez-toc-section-end"></span></h2><ol>
<li>Consistency: Ensure that equals and hashCode are consistent. If equals returns true for two objects, hashCode must return the same value for both.</li>
<li>Non-Equal Objects: It is acceptable for non-equal objects to have the same hash code, though this can degrade the performance of hash-based collections.</li>
</ol>
<h3 id="equal-objects-cannot-have-different-hash-codes"><a href="#equal-objects-cannot-have-different-hash-codes" class="headerlink" title="equal objects cannot have different hash codes"></a><span class="ez-toc-section" id="equal_objects_cannot_have_different_hash_codes"></span>equal objects cannot have different hash codes<span class="ez-toc-section-end"></span></h3><ol>
<li>Consistent with equals: If two objects are equal according to the equals method, they must have the same hash code.</li>
<li>Self-Consistency: If an object is compared to itself, the equals method must return true, and the hashCode method must consistently return the same integer, provided no information used in equals comparisons on the object is modified.</li>
<li>Non-Equal Objects: If two objects are not equal according to the equals method, it is not required that they have different hash codes. However, different hash codes for non-equal objects can improve the performance of hash-based collections.</li>
</ol>
<p>  if two Person objects have the same name and age, they are considered equal. Consequently, their hash codes will also be the same because the hashCode method uses these fields to compute the hash code.</p>
<h3 id="Key-Points-1"><a href="#Key-Points-1" class="headerlink" title="Key Points"></a><span class="ez-toc-section" id="Key_Points-2"></span>Key Points<span class="ez-toc-section-end"></span></h3><ul>
<li>Consistency Requirement: Equal objects must have the same hash code to ensure that hash-based collections (like HashMap and HashSet) function correctly.</li>
<li>Implementation: The hashCode method should use the same fields that are used in the equals method to ensure consistency.</li>
<li>Efficiency: While it is not required for unequal objects to have different hash codes, it is beneficial for the performance of hash-based collections.</li>
</ul>
<p>Violating this contract by allowing equal objects to have different hash codes can lead to unexpected behavior in collections like HashMap and HashSet, resulting in problems such as missing entries or increased lookup times.</p>
<h2 id="Active-recyle"><a href="#Active-recyle" class="headerlink" title="Active recyle"></a><span class="ez-toc-section" id="Active_recyle"></span>Active recyle<span class="ez-toc-section-end"></span></h2><p>After onDestroy() or recycling the bitmap, the active resource is put into memory cache.</p>
<p>ActiveResources.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">void</span> <span class="title function_">cleanupActiveReference</span><span class="params">(<span class="meta">@NonNull</span> ResourceWeakReference ref)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">      activeEngineResources.remove(ref.key);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!ref.isCacheable || ref.resource == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EngineResource&lt;?&gt; newResource =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">EngineResource</span>&lt;&gt;(</span><br><span class="line">            ref.resource,</span><br><span class="line">            <span class="comment">/* isMemoryCacheable= */</span> <span class="literal">true</span>,</span><br><span class="line">            <span class="comment">/* isRecyclable= */</span> <span class="literal">false</span>,</span><br><span class="line">            ref.key,</span><br><span class="line">            listener);</span><br><span class="line">    listener.onResourceReleased(ref.key, newResource); <span class="comment">// 这里存储进内存缓存</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">Engine.java</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResourceReleased</span><span class="params">(Key cacheKey, EngineResource&lt;?&gt; resource)</span> &#123;</span><br><span class="line">    activeResources.deactivate(cacheKey);</span><br><span class="line">    <span class="keyword">if</span> (resource.isMemoryCacheable()) &#123;</span><br><span class="line">      cache.put(cacheKey, resource);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      resourceRecycler.recycle(resource, <span class="comment">/* forceNextFrame= */</span> <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h1 id="LruCache"><a href="#LruCache" class="headerlink" title="LruCache"></a><span class="ez-toc-section" id="LruCache"></span>LruCache<span class="ez-toc-section-end"></span></h1><p><code>LruCache</code> stands for Least Recently Used Cache. It’s a cache mechanism that keeps track of the most recently used items and evicts the least recently used items when the cache reaches its maximum size. This helps in maintaining a balance between memory usage and access speed.</p>
<h3 id="How-Glide-Uses-LruCache"><a href="#How-Glide-Uses-LruCache" class="headerlink" title="How Glide Uses LruCache"></a><span class="ez-toc-section" id="How_Glide_Uses_LruCache"></span>How Glide Uses LruCache<span class="ez-toc-section-end"></span></h3><p>Glide uses <code>LruCache</code> to store decoded images (<code>Bitmap</code> objects) in memory. When an image is requested:</p>
<ol>
<li><strong>Check Cache</strong>: Glide first checks the memory cache for the image.</li>
<li><strong>Load from Cache</strong>: If the image is found in the cache, it is loaded from there, making the process very fast.</li>
<li><strong>Fetch and Decode</strong>: If the image is not in the cache, Glide fetches it from the source (e.g., network, disk), decodes it, and adds it to the cache.</li>
<li></li>
</ol>
<p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/Architecture/2021-08-09_4.4_lrucache.png"></p>
<p>LinkedHashMap参数含义</p>
<p>initialCapacity : 最大容量</p>
<p>loadFactor : 负载因子</p>
<p>accessOrder : 排序方式, true 按照访问顺序排序， false 按照插入顺序排序</p>
<p>访问顺序排序</p>
<p>accessOrder : true</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">LinkedHashMap&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;(<span class="number">0</span>, <span class="number">0.75f</span>, <span class="literal">true</span>);</span><br><span class="line">map.put(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;A&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;b&quot;</span>, <span class="string">&quot;B&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;c&quot;</span>, <span class="string">&quot;C&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;d&quot;</span>, <span class="string">&quot;D&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;e&quot;</span>, <span class="string">&quot;E&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;f&quot;</span>, <span class="string">&quot;F&quot;</span>);</span><br><span class="line"></span><br><span class="line">map.get(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;n&quot;</span>,<span class="string">&quot;N&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : map.entrySet()) &#123;</span><br><span class="line">    Log.d(<span class="string">&quot;LruCacheTest&quot;</span>, <span class="string">&quot;testLinkedHashMap : &quot;</span>+ entry.getKey()+<span class="string">&quot; : &quot;</span> + entry.getValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果</p>
<blockquote>
<p>D LruCacheTest: testLinkedHashMap : b : B<br>D LruCacheTest: testLinkedHashMap : c : C<br>D LruCacheTest: testLinkedHashMap : d : D<br>D LruCacheTest: testLinkedHashMap : e : E<br>D LruCacheTest: testLinkedHashMap : f : F<br>D LruCacheTest: testLinkedHashMap : a : A<br>D LruCacheTest: testLinkedHashMap : n : N</p>
</blockquote>
<p>可以看到 先访问a ,在插入n,把最新最近使用和访问的 A N,放到链表后面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LinkedHashMap&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;(<span class="number">100</span>, <span class="number">0.75f</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>D LruCacheTest: testLinkedHashMap : a : A<br>D LruCacheTest: testLinkedHashMap : b : B<br>D LruCacheTest: testLinkedHashMap : c : C<br>D LruCacheTest: testLinkedHashMap : d : D<br>D LruCacheTest: testLinkedHashMap : e : E<br>D LruCacheTest: testLinkedHashMap : f : F<br>D LruCacheTest: testLinkedHashMap : n : N</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/JakeWharton/DiskLruCache">https://github.com/JakeWharton/DiskLruCache</a></p>
<h1 id="Bitmap-Reuse"><a href="#Bitmap-Reuse" class="headerlink" title="Bitmap Reuse"></a><span class="ez-toc-section" id="Bitmap_Reuse"></span>Bitmap Reuse<span class="ez-toc-section-end"></span></h1><h2 id="botain-bitmap"><a href="#botain-bitmap" class="headerlink" title="botain bitmap"></a><span class="ez-toc-section" id="botain_bitmap"></span>botain bitmap<span class="ez-toc-section-end"></span></h2><div class="mermaid">
  sequenceDiagram
LruBitmapPool ->> LruBitmapPool : get()
LruBitmapPool ->> LruBitmapPool : getDirtyOrNull()
LruBitmapPool ->> SizeStrategy : strategy.get()
Note  right of SizeStrategy : possibleSize <= size * max_size_multiple(8) < div>


<p>LruBitmapPool</p>
<p>此步骤用于查找 entries 中最合适用来复用的 bitmap<br>先找到 sizes 中大于 size 且和 size 最接近的 key，如果 key 存在且其大小不超出 size 的四倍，则使用该 key，否则直接使用 size<br>即找到最接近 size 但又不超出 size 太多的 bitmap，否则如果拿来复用的 bitmap 太大的话也比较浪费</p>
<p>链接：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6956090846470995975">https://juejin.cn/post/6956090846470995975</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7133243966052368392">肢解Glide：LruBitmapPool如何具体操作Bitmap复用？ - 掘金</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">SizeStrategy</span> <span class="keyword">implements</span> <span class="title class_">LruPoolStrategy</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_SIZE_MULTIPLE</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Bitmap <span class="title function_">get</span><span class="params">(<span class="type">int</span> width, <span class="type">int</span> height, Bitmap.Config config)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> Util.getBitmapByteSize(width, height, config);</span><br><span class="line">    <span class="type">Key</span> <span class="variable">key</span> <span class="operator">=</span> keyPool.get(size);</span><br><span class="line"></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">possibleSize</span> <span class="operator">=</span> sortedSizes.ceilingKey(size);</span><br><span class="line">    <span class="keyword">if</span> (possibleSize != <span class="literal">null</span> &amp;&amp; possibleSize != size &amp;&amp; possibleSize &lt;= size * MAX_SIZE_MULTIPLE) &#123;</span><br><span class="line">      keyPool.offer(key);</span><br><span class="line">      key = keyPool.get(possibleSize);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="save-bitmap"><a href="#save-bitmap" class="headerlink" title="save bitmap"></a><span class="ez-toc-section" id="save_bitmap"></span>save bitmap<span class="ez-toc-section-end"></span></h2><div class="mermaid">
  sequenceDiagram
BitmapPool ->> LruBitmapPool : put(bitmap)
LruBitmapPool ->> SizeConfigStrategy : strategy.put(bitmap)
SizeConfigStrategy ->> KeyPool : get(size, bitmap.getConfig())
Note  over SizeConfigStrategy, KeyPool : groupedMap.put(key, bitmap);
</div>


<h3 id="bitmap-save-condition"><a href="#bitmap-save-condition" class="headerlink" title="bitmap save condition"></a><span class="ez-toc-section" id="bitmap_save_condition"></span>bitmap save condition<span class="ez-toc-section-end"></span></h3><ul>
<li>is mutable</li>
<li>less than maxSize</li>
<li>allowedConfigs</li>
</ul>
<p>LruBitmapPool.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(Bitmap bitmap)</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (!bitmap.isMutable()</span><br><span class="line">       || strategy.getSize(bitmap) &gt; maxSize</span><br><span class="line">       || !allowedConfigs.contains(bitmap.getConfig())) &#123;</span><br><span class="line">     bitmap.recycle();</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> strategy.getSize(bitmap);</span><br><span class="line">   strategy.put(bitmap);</span><br><span class="line">   tracker.add(bitmap);</span><br><span class="line"></span><br><span class="line">   puts++;</span><br><span class="line">   currentSize += size;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>SizeConfigStrategy.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Key</span> <span class="keyword">implements</span> <span class="title class_">Poolable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (o <span class="keyword">instanceof</span> Key) &#123;</span><br><span class="line">      <span class="type">Key</span> <span class="variable">other</span> <span class="operator">=</span> (Key) o;</span><br><span class="line">      <span class="keyword">return</span> size == other.size &amp;&amp; Util.bothNullOrEqual(config, other.config);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> size;</span><br><span class="line">    result = <span class="number">31</span> * result + (config != <span class="literal">null</span> ? config.hashCode() : <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The key is judged based on bitmap size and Config format.</p>
<h3 id="decoded-VS-without-decode"><a href="#decoded-VS-without-decode" class="headerlink" title="decoded VS without decode"></a><span class="ez-toc-section" id="decoded_VS_without_decode"></span>decoded VS without decode<span class="ez-toc-section-end"></span></h3><p>In the context of using the Glide library in Android for image loading, the terms “decoded cache” and “without decode” refer to different stages and aspects of the image loading process. Here’s a detailed explanation:</p>
<h4 id="Decoded-Cache"><a href="#Decoded-Cache" class="headerlink" title="Decoded Cache"></a><span class="ez-toc-section" id="Decoded_Cache"></span>Decoded Cache<span class="ez-toc-section-end"></span></h4><p><strong>Decoded Cache</strong> refers to the cache that stores images that have already been decoded into <code>Bitmap</code> objects. This means the images are stored in a format that can be directly used by the UI without needing further decoding. The benefits of using the decoded cache include:</p>
<ol>
<li><strong>Faster Loading:</strong> Since the images are already decoded, they can be quickly retrieved and displayed, reducing the load time and improving the user experience.</li>
<li><strong>Reduced CPU Usage:</strong> Decoding an image is a CPU-intensive process. By caching decoded images, you avoid repeatedly decoding the same image, which saves CPU resources.</li>
<li><strong>Efficient Memory Usage:</strong> Decoded images are stored in memory, which allows for quick access, but this also means that the memory usage can be higher, especially if you are caching many large images.</li>
</ol>
<h4 id="Without-Decode-Encoded-Cache"><a href="#Without-Decode-Encoded-Cache" class="headerlink" title="Without Decode (Encoded Cache)"></a><span class="ez-toc-section" id="Without_Decode_Encoded_Cache"></span>Without Decode (Encoded Cache)<span class="ez-toc-section-end"></span></h4><p><strong>Without Decode</strong> or <strong>Encoded Cache</strong> refers to the cache that stores the raw, compressed image files (such as JPEG, PNG, or WebP) without decoding them into <code>Bitmap</code> objects. This cache stores the images in their original, encoded format. The benefits of using the encoded cache include:</p>
<h1 id="BUILD-PROJECT"><a href="#BUILD-PROJECT" class="headerlink" title="BUILD PROJECT"></a><span class="ez-toc-section" id="BUILD_PROJECT"></span>BUILD PROJECT<span class="ez-toc-section-end"></span></h1><p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/Retrofit/20240618162126.jpg"></p>
<p>监控大图<br><a target="_blank" rel="noopener" href="https://juejin.im/post/6844904136266219534">https://juejin.im/post/6844904136266219534</a></p>
<p><a target="_blank" rel="noopener" href="https://bumptech.github.io/glide/">https://bumptech.github.io/glide/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/xfhy/Android-Notes/blob/master/Blogs/Android/%E4%B8%89%E6%96%B9%E5%BA%93%E5%8E%9F%E7%90%86/Glide%E4%B8%BB%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.md">https://github.com/xfhy/Android-Notes/blob/master/Blogs/Android/%E4%B8%89%E6%96%B9%E5%BA%93%E5%8E%9F%E7%90%86/Glide%E4%B8%BB%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.md</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/pAazRD9NaLPvBseG51ZOLw">https://mp.weixin.qq.com/s/pAazRD9NaLPvBseG51ZOLw</a></p>
</=></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://noteforme.github.io">Jon</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://noteforme.github.io/2024/06/18/glide/">https://noteforme.github.io/2024/06/18/glide/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/06/19/android-safe/" title="Android Safe"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">Android Safe</div></div></a></div><div class="next-post pull-right"><a href="/2024/06/18/design-pattern-strategy/" title="Design Pattern Strategy"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next</div><div class="next_info">Design Pattern Strategy</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Jon</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">243</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">33</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">30</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Glide-Flow"><span class="toc-number">1.</span> <span class="toc-text">Glide Flow</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#sequenceDiagram-Status-WAITING-FOR-SIZE"><span class="toc-number">1.1.</span> <span class="toc-text">sequenceDiagram Status.WAITING_FOR_SIZE</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Bind-lifecycle"><span class="toc-number">2.</span> <span class="toc-text">Bind lifecycle</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Old-lifecycle-architecture"><span class="toc-number">2.1.</span> <span class="toc-text">Old lifecycle architecture</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#new-lifecycle-architecture"><span class="toc-number">2.2.</span> <span class="toc-text">new lifecycle architecture</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Advantages-of-the-New-Approach"><span class="toc-number">2.3.</span> <span class="toc-text">Advantages of the New Approach</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LifeCycle-flow-UML"><span class="toc-number">2.4.</span> <span class="toc-text">LifeCycle flow UML</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#connective-lifecycle-UML"><span class="toc-number">2.5.</span> <span class="toc-text">connective lifecycle UML</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Glide-caching-strategy"><span class="toc-number">3.</span> <span class="toc-text">Glide caching strategy</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Concept"><span class="toc-number">3.1.</span> <span class="toc-text">Concept</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Cache-Levels"><span class="toc-number">3.1.1.</span> <span class="toc-text">Cache Levels</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Caching-Keys"><span class="toc-number">3.1.2.</span> <span class="toc-text">Caching Keys</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Image-Requests"><span class="toc-number">3.1.3.</span> <span class="toc-text">Image Requests</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cache-Invalidation"><span class="toc-number">3.1.4.</span> <span class="toc-text">Cache Invalidation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Disk-Cache"><span class="toc-number">3.2.</span> <span class="toc-text">Disk Cache</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#KEY"><span class="toc-number">4.</span> <span class="toc-text">KEY</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Identifying-an-Object"><span class="toc-number">4.1.</span> <span class="toc-text">Identifying an Object</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Example-Implementation"><span class="toc-number">4.2.</span> <span class="toc-text">Example Implementation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Points"><span class="toc-number">4.3.</span> <span class="toc-text">Key Points</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#equal-objects-cannot-have-different-hash-codes"><span class="toc-number">4.3.1.</span> <span class="toc-text">equal objects cannot have different hash codes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Key-Points-1"><span class="toc-number">4.3.2.</span> <span class="toc-text">Key Points</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Active-recyle"><span class="toc-number">4.4.</span> <span class="toc-text">Active recyle</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LruCache"><span class="toc-number">5.</span> <span class="toc-text">LruCache</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#How-Glide-Uses-LruCache"><span class="toc-number">5.0.1.</span> <span class="toc-text">How Glide Uses LruCache</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Bitmap-Reuse"><span class="toc-number">6.</span> <span class="toc-text">Bitmap Reuse</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#botain-bitmap"><span class="toc-number">6.1.</span> <span class="toc-text">botain bitmap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#save-bitmap"><span class="toc-number">6.2.</span> <span class="toc-text">save bitmap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bitmap-save-condition"><span class="toc-number">6.2.1.</span> <span class="toc-text">bitmap save condition</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#decoded-VS-without-decode"><span class="toc-number">6.2.2.</span> <span class="toc-text">decoded VS without decode</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Decoded-Cache"><span class="toc-number">6.2.2.1.</span> <span class="toc-text">Decoded Cache</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Without-Decode-Encoded-Cache"><span class="toc-number">6.2.2.2.</span> <span class="toc-text">Without Decode (Encoded Cache)</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#BUILD-PROJECT"><span class="toc-number">7.</span> <span class="toc-text">BUILD PROJECT</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><div class="content"><a class="title" href="/2024/07/04/DesignPatterns-State/" title="DesignPatterns_State">DesignPatterns_State</a><time datetime="2024-07-04T07:57:26.000Z" title="Created 2024-07-04 15:57:26">2024-07-04</time></div></div><div class="aside-list-item"><div class="content"><a class="title" href="/2024/07/03/glide/" title="glide">glide</a><time datetime="2024-07-03T05:51:25.000Z" title="Created 2024-07-03 13:51:25">2024-07-03</time></div></div><div class="aside-list-item"><div class="content"><a class="title" href="/2024/06/28/bitmap/" title="Bitmap">Bitmap</a><time datetime="2024-06-28T09:37:49.000Z" title="Created 2024-06-28 17:37:49">2024-06-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/28/bits-and-bytes/" title="Bits and Bytes">Bits and Bytes</a><time datetime="2024-06-28T08:04:14.000Z" title="Created 2024-06-28 16:04:14">2024-06-28</time></div></div><div class="aside-list-item"><div class="content"><a class="title" href="/2024/06/26/lifecycle/" title="LifeCycle">LifeCycle</a><time datetime="2024-06-26T06:45:50.000Z" title="Created 2024-06-26 14:45:50">2024-06-26</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Jon</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>