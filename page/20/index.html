<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>Page 20 | Jon&#39;s Blog</title>
  <meta name="author" content="Jon">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Jon&#39;s Blog"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="Jon&#39;s Blog" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70812759-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70812759-1');
</script>






<meta name="generator" content="Hexo 6.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Jon&#39;s Blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class=""></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class=""></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class=""></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header logo">
  <h1>Cease to struggle and you cease to live. - Thomas Carlyle<span class="blink-fast">|</span></h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">


		<i class="fa fa-heart blink-slow"></i>

		wubba lubba dub dub.

</div>    

		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/09/20/ubuntu_guide/" >ubuntu_guide</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-09-20  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>　<strong>解决Ubuntu 16.04 系统的一些错误</strong></p>
<h2 id="Unable-to-mount-root-fs-on-unknown-block"><a href="#Unable-to-mount-root-fs-on-unknown-block" class="headerlink" title="Unable to mount root fs on unknown-block"></a>Unable to mount root fs on unknown-block</h2><p>　看到Ubuntu系统有更新就点了下，早上打开电脑 Ubuntu直接进不去最下面弹出这这样的<br>　错误　Unable to mount root fs on unknown-block　而且只能强制关机，心想完了我的<br>　资料，还有辛苦编译的源码，不过好在晚上回来倒腾了一把　终于好了。</p>
<p>步骤<br>1、  Advanced options for Ubuntu<br>２、ubuntu Linux 4.4.0-96… (recovery mdoe)  　这里我选择的是第二个，第一个点击后还是<br>　　会报错<br>3、Menu界面　，把能清的先清了，然后点击grub,执行后续操作</p>
<p>4、登录进入命令行界面</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -o rw <span class="regexp">//</span>这一行和参考资料不同</span><br><span class="line">sudo dpkg --configure -a　<span class="regexp">//</span>在这里等了很久 Device ....Start的字样,接着就按了　Ctrl + Alt + Delete , 重启就好了</span><br><span class="line"></span><br><span class="line">sudo apt-get install -f  <span class="comment"># to finish upgrades 最好加这个吧</span></span><br><span class="line">type reboot</span><br></pre></td></tr></table></figure>

<p>  <a target="_blank" rel="noopener" href="https://askubuntu.com/questions/875862/kernel-panic-unable-to-mount-root-in-ubuntu-16-04/875868">https://askubuntu.com/questions/875862/kernel-panic-unable-to-mount-root-in-ubuntu-16-04/875868</a></p>
<h2 id="解压乱码"><a href="#解压乱码" class="headerlink" title="解压乱码"></a>解压乱码</h2><p>在windows上压缩的文件，是以系统默认编码中文来压缩文件。由于zip文件中没有声明其编码，所以linux上的unzip一般以默认编码解压，中文文件名会出现乱码。<br>可以使用终端zip文件进行解压并指定解压的编码<br>　<code>unzip -O GBK   xxx.zip</code><br>解压后的文件的路径为当前终端所在的路径</p>
<p>参考：　<a target="_blank" rel="noopener" href="http://hareric.com/2016/07/26/%E7%AE%80%E6%98%93%E6%96%B9%E6%B3%95%E8%A7%A3%E5%86%B3ubuntu%E4%B8%8B%E8%A7%A3%E5%8E%8B%E6%96%87%E4%BB%B6%E4%B9%B1%E7%A0%81/">Eric Chan</a> </p>
<p>** 17.10的问题　**</p>
<ul>
<li>Android studio3.1无法输入中文<br>　使用 fcitx 选择sunpingying  也可以选择 google pinyin<br>  　然后输入这两行命令<pre><code>      pidof fcitx | xargs kill  #找到原有的fcitx端口并kill掉
      fcitx                     #开启fcitx
</code></pre>
</li>
</ul>
<p>参考： 　<a target="_blank" rel="noopener" href="https://blog.csdn.net/he729164860/article/details/78484713">https://blog.csdn.net/he729164860/article/details/78484713</a>
  　
  　
  　</p>
<h2 id="安装Gnome-shell"><a href="#安装Gnome-shell" class="headerlink" title="安装Gnome　shell"></a>安装Gnome　shell</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="builtin-name">get</span> install gnome-tweak-tool</span><br><span class="line">sudo apt-<span class="builtin-name">get</span> install chrome-gnome-shell</span><br></pre></td></tr></table></figure>
<p>打开tweak可以看到按钮</p>
<p>浏览点击 ||| off按钮系统就会安装</p>
<p>开源chromium加载有问题，使用firefox</p>
<p>很有用的插件</p>
<p><a target="_blank" rel="noopener" href="https://extensions.gnome.org/extension/545/hide-top-bar/">https://extensions.gnome.org/extension/545/hide-top-bar/</a></p>
<p>参考:<a target="_blank" rel="noopener" href="https://www.mobibrw.com/2017/9342">https://www.mobibrw.com/2017/9342</a></p>
<p>　</p>
<h2 id="ctrl-alt-left-（Intellij-idea-shortcut-conflict）"><a href="#ctrl-alt-left-（Intellij-idea-shortcut-conflict）" class="headerlink" title="ctrl + alt + left （Intellij idea shortcut conflict）"></a>ctrl + alt + left （Intellij idea shortcut conflict）</h2><ul>
<li><p>install <u>Dconf Editor</u>   in ubuntu software</p>
</li>
<li><p>launch <u>Dconf Editor</u>, go to    /org/gnome/desktop/wm/keybindings/switch-to-workspace-left  </p>
<p>double click like below</p>
<p><img src="/2017/09/20/ubuntu_guide/ubuntu_guide_01.png" alt="df"></p>
</li>
</ul>
<p> use default value(click Off) -&gt; Custom value(like me or else)</p>
<ul>
<li>you could use it in intellij idea now .</li>
</ul>
<h4 id="genymotion安装"><a href="#genymotion安装" class="headerlink" title="genymotion安装"></a>genymotion安装</h4><ul>
<li>下载Virtualbox</li>
<li>下载genymotion</li>
<li>下载Android stuido genymotion插件</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod +x genymotion-<span class="number">2.6</span>.<span class="number">0</span>-linux_x64.bin      </span><br><span class="line">.<span class="regexp">/genymotion-2.6.0-linux_x64.bin -d /</span>home<span class="regexp">/qiu/</span>Work/genymotion  </span><br></pre></td></tr></table></figure>

<p>//注意： chmod +x 有空格</p>
<h4 id="输入法设置"><a href="#输入法设置" class="headerlink" title="输入法设置"></a>输入法设置</h4><p>ubuntu 18.04 intellij 输入法选择有问题，可以用命令行安装 ibus-pinyin，然后input souce选择拼音输入法</p>

	
	</div>
  <a type="button" href="/2017/09/20/ubuntu_guide/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/09/19/SDK_Integration/" >SDK_Integration</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-09-19  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>平常集成SDK虽然简单，但是过了半年就全忘了，又得重新来过</p>
<h4 id="友盟分享"><a href="#友盟分享" class="headerlink" title="友盟分享"></a>友盟分享</h4><p><a target="_blank" rel="noopener" href="https://open.weixin.qq.com/">微信开发者平台</a><br>创建应用需要 <strong>应用签名</strong></p>
<p>需要签名工具,可以从 <a target="_blank" rel="noopener" href="https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&t=resource/res_list&verify=1&id=open1419319167&token=&lang=zh_CN">微信资源中心</a> 获取</p>
<p> 注意要打包才能运行</p>
<h4 id="商汤认证"><a href="#商汤认证" class="headerlink" title="商汤认证"></a>商汤认证</h4><p><a target="_blank" rel="noopener" href="https://v2-devcenter.visioncloudapi.com/#!/home/doc/ocr/android/online/useguide">文档</a></p>
<p>身份证认证</p>
<ul>
<li><p>在common-idcard包中的assets目录下添加 SenseID_OCR.lic文件就可以了</p>
</li>
<li><p>在androidmanifest.xml注册activity</p>
</li>
</ul>
<p>活体认证</p>
<p>最终调用onDetectOver</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public void on<span class="constructor">DetectOver(ResultCode <span class="params">code</span>, String <span class="params">id</span>, List <span class="params">imageData</span>)</span></span><br></pre></td></tr></table></figure>

<p>会返回id,然后把id,身份证number,name传给商汤对比</p>
<h4 id="极光推送"><a href="#极光推送" class="headerlink" title="极光推送"></a>极光推送</h4><ul>
<li><p>集成过程</p>
<p>按照文档，主要是要注意这个广播接收器就可以了</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;receiver</span><br><span class="line">          android:name=&quot;.jpush.MyReceiver&quot;</span><br><span class="line">          android:enabled=&quot;true&quot;&gt;</span><br><span class="line">          <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">              <span class="comment">&lt;!--Required 用户注册SDK的intent--&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;cn.jpush.android.intent.REGISTRATION&quot;</span> /&gt;</span></span><br><span class="line">              <span class="comment">&lt;!--Required 用户接收SDK消息的intent--&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;cn.jpush.android.intent.MESSAGE_RECEIVED&quot;</span> /&gt;</span></span><br><span class="line">              <span class="comment">&lt;!--Required 用户接收SDK通知栏信息的intent--&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;cn.jpush.android.intent.NOTIFICATION_RECEIVED&quot;</span> /&gt;</span></span><br><span class="line">              <span class="comment">&lt;!--Required 用户打开自定义通知栏的intent--&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;cn.jpush.android.intent.NOTIFICATION_OPENED&quot;</span> /&gt;</span></span><br><span class="line">              <span class="comment">&lt;!-- 接收网络变化 连接/断开 since 1.6.3 --&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;cn.jpush.android.intent.CONNECTION&quot;</span> /&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;com.zhujia.land&quot;</span> /&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>有点疑惑的是推送给特定的APP</p>
<p>目前获取RegistrationID，登陆接口把 RegistrationID传给服务端, 然后Server推送过来就可以了</p>
<p><a target="_blank" rel="noopener" href="http://blog.jiguang.cn/push_audience_tech-2/">http://blog.jiguang.cn/push_audience_tech-2/</a></p>
<p> 暂时别试用Jcenter集成,会出现各种问题</p>
</li>
</ul>
<h4 id="微信登陆"><a href="#微信登陆" class="headerlink" title="微信登陆"></a>微信登陆</h4><h5 id="App登录"><a href="#App登录" class="headerlink" title="App登录"></a>App登录</h5><p><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/doc/oplatform/Mobile_App/Resource_Center_Homepage.html">https://developers.weixin.qq.com/doc/oplatform/Mobile_App/Resource_Center_Homepage.html</a></p>
<ol>
<li>问题1</li>
</ol>
<p><code>E/MtaSDK: [pool-4-thread-1(320): null:705] - Server response error code:404, error:&#123;&quot;ret&quot;:-1, &quot;msg&quot;:&quot;invalid appkey&quot;&#125;</code></p>
<p>Demo里的wechat-sdk-android-with-mta 换成     api ‘com.tencent.mm.opensdk:wechat-sdk-android-without-mta:+’  这个弄了一上午</p>
<ol start="2">
<li><p>问题2  </p>
<p> <code> No value for openid.</code> WXEntryActivity {“errcode”:40029,”errmsg”:”invalid code”}   WXEntryActivity<br> appid secret错误</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (resp.<span class="built_in">getType</span>() == ConstantsAPI.COMMAND_SENDAUTH) &#123;</span><br><span class="line">   SendAuth.Resp authResp = (SendAuth.Resp)resp;</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">String</span> code = authResp.code;</span><br><span class="line">   NetworkUtil.<span class="built_in">sendWxAPI</span>(handler, <span class="keyword">String</span>.format(<span class="string">&quot;https://api.weixin.qq.com/sns/oauth2/access_token?&quot;</span> +</span><br><span class="line">               <span class="string">&quot;appid=%s&amp;secret=%s&amp;code=%s&amp;grant_type=authorization_code&quot;</span>, <span class="string">&quot;wx930ea5d5a258f4f&quot;</span>,</span><br><span class="line">         <span class="string">&quot;1d6d1d57a3dd06336d917bc0b44d964&quot;</span>, code), NetworkUtil.GET_TOKEN);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET https://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&amp;secret=SECRET&amp;code=CODE&amp;grant_type=authorization_code</span><br></pre></td></tr></table></figure>

<p>demo中 </p>
<p>appid wxd930ea5d5a2584f要换成自己的</p>
<p>secret 1d6d1d57a3dd063b36d91bc0b44d964也要换成自己的</p>
<ol start="3">
<li><p>问题3  需要注册，否则WXEntryActivity不能收到回调</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String APP_ID = <span class="string">&quot;wx88888888&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IWXAPI 是第三方app和微信通信的openApi接口</span></span><br><span class="line"><span class="keyword">private</span> IWXAPI api;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">regToWx</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 通过WXAPIFactory工厂，获取IWXAPI的实例</span></span><br><span class="line">    api = WXAPIFactory.createWXAPI(<span class="keyword">this</span>, APP_ID, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将应用的appId注册到微信</span></span><br><span class="line">    api.registerApp(APP_ID);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//建议动态监听微信启动广播进行注册到微信</span></span><br><span class="line">  registerReceiver(<span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 将该app注册到微信</span></span><br><span class="line">    api.registerApp(Constants.APP_ID);</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;, <span class="keyword">new</span> IntentFilter(ConstantsAPI.ACTION_REFRESH_WXAPP));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="二维码扫码登录"><a href="#二维码扫码登录" class="headerlink" title="二维码扫码登录"></a>二维码扫码登录</h5><p><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/doc/oplatform/Mobile_App/WeChat_Login/Login_via_Scan.html">https://developers.weixin.qq.com/doc/oplatform/Mobile_App/WeChat_Login/Login_via_Scan.html</a></p>
<ol>
<li><p>登录公众平台 <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/cgi-bin/home?t=home">https://mp.weixin.qq.com/cgi-bin/home?t=home</a> ,点击配置进入IP白名单</p>
<p>点击配置进入IP白名单设置页</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/cgi-bin/announce?action=getannouncement&amp;key=1495617578&amp;version=1&amp;lang=zh_CN&amp;platform=2&amp;token=38764305">https://mp.weixin.qq.com/cgi-bin/announce?action=getannouncement&amp;key=1495617578&amp;version=1&amp;lang=zh_CN&amp;platform=2&amp;token=38764305</a></p>
</li>
<li><p>二维码扫码登录的appid secret key用开放平台的  <a target="_blank" rel="noopener" href="https://open.weixin.qq.com/cgi-bin/index?t=home/index&amp;lang=zh_CN">https://open.weixin.qq.com/cgi-bin/index?t=home/index&amp;lang=zh_CN</a></p>
<p>注意两个不同的平台配置</p>
</li>
</ol>
</li>
</ol>
<p>二维码失效:  首先普及一下二维码是有失效时间以及失效状态的，一旦你扫过一次二维码或者在某段时间内没有扫描页面上的二维码，该二维码就失效了</p>
<p>app分享拉新规则</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/3bsmiv78yJ4XKwd8iu-0Ig">https://mp.weixin.qq.com/s/3bsmiv78yJ4XKwd8iu-0Ig</a></p>
<h4 id="Wechat-Pay"><a href="#Wechat-Pay" class="headerlink" title="Wechat Pay"></a>Wechat Pay</h4><p><a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=8_5">https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=8_5</a></p>
<h4 id="Alipay"><a href="#Alipay" class="headerlink" title="Alipay"></a>Alipay</h4><p><a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/204/105296">https://opendocs.alipay.com/open/204/105296</a></p>
<p>orderInfo订单信息 由接口拼接就可以了</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/wWB5ENo3eQJH03OXvoup8w">https://mp.weixin.qq.com/s/wWB5ENo3eQJH03OXvoup8w</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzUxODg0MzU2OQ==&amp;mid=2247485318&amp;idx=1&amp;sn=174338566ad8c0426c95815c4f4aee5a&amp;scene=21#wechat_redirect">https://mp.weixin.qq.com/s?__biz=MzUxODg0MzU2OQ==&amp;mid=2247485318&amp;idx=1&amp;sn=174338566ad8c0426c95815c4f4aee5a&amp;scene=21#wechat_redirect</a></p>
<p>推送相关</p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/6881414546859229192">https://juejin.im/post/6881414546859229192</a></p>

	
	</div>
  <a type="button" href="/2017/09/19/SDK_Integration/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/09/12/JavaIo/" >JavaIo</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-09-12  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>![Screen Shot 2020-09-12 at 5.20.14 PM](JavaIo/Screen Shot 2020-09-12 at 5.20.14 PM.png)</p>
<p>![Screen Shot 2020-09-12 at 5.22.29 PM](JavaIo/Screen Shot 2020-09-12 at 5.22.29 PM.png)</p>
<img src="/2017/09/12/JavaIo/java7-1535863955.jpg" alt="java7-1535863955">



<p>Byte Stream : 对于二进制文件或处理 数字字母之类的数据</p>
<p><a target="_blank" rel="noopener" href="https://www.javazhiyin.com/17362.html">https://www.javazhiyin.com/17362.html</a></p>
<h4 id="FileInputStream"><a href="#FileInputStream" class="headerlink" title="FileInputStream"></a>FileInputStream</h4><p>单个字节读</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    fis = <span class="keyword">new</span> FileInputStream(<span class="string">&quot;/Users/john/Documents/jywork/THINKJAVA/src/main/resource/a.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> data;</span><br><span class="line">    <span class="keyword">while</span> ((data = fis.<span class="keyword">read</span>()) != -<span class="number">1</span>) &#123;</span><br><span class="line">        System.out.<span class="keyword">print</span>((<span class="keyword">char</span>) data+<span class="string">&quot;  &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>读到bytes数组里面</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">FileInputStream fis = null;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">14</span>];</span><br><span class="line">    fis = <span class="keyword">new</span> <span class="built_in">FileInputStream</span>(<span class="string">&quot;/Users/john/Documents/jywork/THINKJAVA/src/main/resource/a.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> read = fis.<span class="built_in">read</span>(bytes);</span><br><span class="line">    <span class="keyword">String</span> s  = <span class="keyword">new</span> <span class="built_in"><span class="keyword">String</span></span>(bytes);</span><br><span class="line">    System.out.<span class="built_in">println</span>(s);</span><br><span class="line">    System.out.<span class="built_in">println</span>(read);</span><br><span class="line">&#125; <span class="built_in"><span class="keyword">catch</span></span> (FileNotFoundException e) &#123;</span><br><span class="line">    e.<span class="built_in">printStackTrace</span>();</span><br><span class="line">&#125; <span class="built_in"><span class="keyword">catch</span></span> (IOException e) &#123;</span><br><span class="line">    e.<span class="built_in">printStackTrace</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>读到bytes里面 ,限定读的字节个数</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">FileInputStream fis = null;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">14</span>];</span><br><span class="line">    fis = <span class="keyword">new</span> <span class="built_in">FileInputStream</span>(<span class="string">&quot;/Users/john/Documents/jywork/THINKJAVA/src/main/resource/a.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> read = fis.<span class="built_in">read</span>(bytes,<span class="number">0</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">String</span> s  = <span class="keyword">new</span> <span class="built_in"><span class="keyword">String</span></span>(bytes);</span><br><span class="line">    System.out.<span class="built_in">println</span>(s);</span><br><span class="line">    System.out.<span class="built_in">println</span>(read);</span><br><span class="line">&#125; <span class="built_in"><span class="keyword">catch</span></span> (FileNotFoundException e) &#123;</span><br><span class="line">    e.<span class="built_in">printStackTrace</span>();</span><br><span class="line">&#125; <span class="built_in"><span class="keyword">catch</span></span> (IOException e) &#123;</span><br><span class="line">    e.<span class="built_in">printStackTrace</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于为什么必须继承装饰器父类 FilterInputStream的思考</p>
<blockquote>
<p>实际上，如果去查看 JDK 的源码，你会发现，BufferedInputStream、DataInputStream 并非继承自 InputStream，而是另外一个叫 FilterInputStream 的类。那这又是出于什么样的设计意图，才引入这样一个类呢？我们再重新来看一下 BufferedInputStream 类的代码。InputStream 是一个抽象类而非接口，而且它的大部分函数（比如 read()、available()）都有默认实现，按理来说，我们只需要在 BufferedInputStream 类中重新实现那些需要增加缓存功能的函数就可以了，其他函数继承 InputStream 的默认实现。但实际上，这样做是行不通的。对于即便是不需要增加缓存功能的函数来说，BufferedInputStream 还是必须把它重新实现一遍，简单包裹对 InputStream 对象的函数调用。具体的代码示例如下所示。如果不重新实现，那 BufferedInputStream 类就无法将最终读取数据的任务，委托给传递进来的 InputStream 对象来完成。这一部分稍微有点不好理解，你自己多思考一下。</p>
</blockquote>

	
	</div>
  <a type="button" href="/2017/09/12/JavaIo/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/09/01/WebView/" >WebView</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-09-01  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://developer.android.com/guide/webapps/webview.html">https://developer.android.com/guide/webapps/webview.html</a></p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><h5 id="加载apk包中的html页面"><a href="#加载apk包中的html页面" class="headerlink" title="加载apk包中的html页面"></a>加载apk包中的html页面</h5><p><code> webView.loadUrl(&quot;file:///android_asset/java.html&quot;);</code></p>
<h5 id="Enabling-JavaScript"><a href="#Enabling-JavaScript" class="headerlink" title="Enabling JavaScript"></a>Enabling JavaScript</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">WebView myWebView &#x3D; (WebView) findViewById(R.id.webview);</span><br><span class="line">WebSettings webSettings &#x3D; myWebView.getSettings();</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F;支持JavaScript</span><br><span class="line">&#x2F;&#x2F;        webSettings.setJavaScriptEnabled(true); &#x2F;&#x2F; 在 onStop 和 onResume 里分别把 setJavaScriptEnabled() 给设置成 false 和 true 即可</span><br><span class="line"></span><br><span class="line">        &#x2F;**</span><br><span class="line">         *  设置自适应屏幕,两者合用</span><br><span class="line">         *&#x2F;</span><br><span class="line">        webSettings.setUseWideViewPort(true); &#x2F;&#x2F;将图片调整到适合webview的大小</span><br><span class="line">        webSettings.setLoadWithOverviewMode(true); &#x2F;&#x2F;缩放至屏幕的大小</span><br><span class="line"></span><br><span class="line">        &#x2F;**</span><br><span class="line">         * 缩放操作</span><br><span class="line">         *&#x2F;</span><br><span class="line">        webSettings.setSupportZoom(true);  &#x2F;&#x2F;支持缩放，默认为true。是下面那个的前提。</span><br><span class="line">        webSettings.setBuiltInZoomControls(true); &#x2F;&#x2F;设置内置的缩放控件。若为false，则该WebView不可缩放</span><br><span class="line">        webSettings.setDisplayZoomControls(false);&#x2F;&#x2F;隐藏原生的缩放控件</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;        myWebView.setWebChromeClient(new MyWebViewClient());</span><br><span class="line">        myWebView.setWebViewClient(new MyViewClient());</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上面是一些常用的操作</p>
<h5 id="Binding-JavaScript-code-to-Android-code-JS交互"><a href="#Binding-JavaScript-code-to-Android-code-JS交互" class="headerlink" title="Binding JavaScript code to Android code(JS交互)"></a>Binding JavaScript code to Android code(JS交互)</h5><p>When developing a web application that’s designed specifically for the WebView in your Android application, you can create interfaces between your JavaScript code and client-side Android code. For example, your JavaScript code can call a method in your Android code to display a Dialog, instead of using JavaScript’s alert() function.</p>
<p>To bind a new interface between your JavaScript and Android code, call addJavascriptInterface(), passing it a class instance to bind to your JavaScript and an interface name that your JavaScript can call to access the class.</p>
<ul>
<li>office Demo</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">inner class WebLoginInterface(context: Context?) &#123;</span><br><span class="line">     @JavascriptInterface</span><br><span class="line">     fun showToast() &#123;</span><br><span class="line">         Timber.i(&quot;appLogin&quot;)</span><br><span class="line">             mWebView?.post &#123;</span><br><span class="line">                 val mSessionId &#x3D; SharedPreferencesUtils.getParam(AppCtxUtil.getApp(), GsonUtil.SHARE_TOKEN_KEY, &quot;&quot;) as String</span><br><span class="line">                 Timber.i(&quot;mSessionId $&#123;mSessionId&#125;&quot;)</span><br><span class="line">                 val jsMethodName &#x3D; &quot;javascript:appLoginCallBack(&#39;$mSessionId&#39;,&#39;4&#39;)&quot;; &#x2F;&#x2F;需要参数的JS函数名</span><br><span class="line">                 Timber.i(&quot;jsMethodName $jsMethodName&quot;)</span><br><span class="line">                 mWebView?.loadUrl(jsMethodName)</span><br><span class="line">             &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>注意</p>
<blockquote>
<p>Caution: If you’ve set your targetSdkVersion to 17 or higher, you must add the @JavascriptInterface annotation to any method that you want available to your JavaScript (the method must also be public). If you do not provide the annotation, the method is not accessible by your web page when running on Android 4.2 or higher.</p>
</blockquote>
<p> html小例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type&#x3D;&quot;button&quot; value&#x3D;&quot;Say hello&quot; onClick&#x3D;&quot;showAndroidToast(&#39;Hello Android!&#39;)&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">&lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;</span><br><span class="line">    function showAndroidToast(toast) &#123;</span><br><span class="line">        Android.showToast(toast);</span><br><span class="line">    &#125;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>


<p>接着加载JS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WebView webView &#x3D; (WebView) findViewById(R.id.webview);</span><br><span class="line">webView.addJavascriptInterface(new WebAppInterface(this), &quot;Android&quot;);</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/3c94ae673e2a">http://www.jianshu.com/p/3c94ae673e2a</a></p>
<p><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/c20513cad758">http://www.jianshu.com/p/c20513cad758</a></p>
<h5 id="缓存方案"><a href="#缓存方案" class="headerlink" title="缓存方案"></a>缓存方案</h5><h5 id="office-原生缓存"><a href="#office-原生缓存" class="headerlink" title="office (原生缓存)"></a>office (原生缓存)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">	   </span><br><span class="line">WebSettings webSettings &#x3D; wbNews.getSettings();</span><br><span class="line">   webSettings.setJavaScriptEnabled(true);&#x2F;&#x2F; 启用支持javascript</span><br><span class="line">   webSettings.setCacheMode(WebSettings.LOAD_CACHE_ELSE_NETWORK);&#x2F;&#x2F;缓存模式</span><br><span class="line">   webSettings.setDomStorageEnabled(true); &#x2F;&#x2F; 开启DOM storage API 功能</span><br><span class="line">   &#x2F;&#x2F; 开启database storage API功能</span><br><span class="line">   webSettings.setDatabaseEnabled(true);</span><br><span class="line">   webSettings.setAllowFileAccess(true);&#x2F;&#x2F;可以访问文件</span><br><span class="line">   webSettings.setBuiltInZoomControls(true);&#x2F;&#x2F;支持缩放</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; 设置数据库缓存路径</span><br><span class="line">   String cacheDirPath &#x3D; getFilesDir().getAbsolutePath() + APP_CACHE_DIRNAME;</span><br><span class="line">   webSettings.setAppCachePath(cacheDirPath);</span><br><span class="line">   webSettings.setAppCacheEnabled(true);</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/coder_pig/article/details/48468969">http://blog.csdn.net/coder_pig/article/details/48468969</a></p>
<h5 id="图片替换方式"><a href="#图片替换方式" class="headerlink" title="图片替换方式"></a>图片替换方式</h5><p><a target="_blank" rel="noopener" href="https://github.com/GcsSloop/diycode/blob/master/blog/journal-02.md">https://github.com/GcsSloop/diycode/blob/master/blog/journal-02.md</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/yipianfengye/androidProject/blob/master/18%20android%E4%BA%A7%E5%93%81%E7%A0%94%E5%8F%91-webview%E9%97%AE%E9%A2%98%E9%9B%86%E9%94%A6.md">其他常用方式</a><br><a target="_blank" rel="noopener" href="https://tech.meituan.com/WebViewPerf.html">美团点评</a><br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/evzDnTsHrAr2b9jcevwBzA">腾讯</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/5a94f9d15188257a63113a74">https://juejin.im/post/5a94f9d15188257a63113a74</a></p>
<h5 id="页面白屏"><a href="#页面白屏" class="headerlink" title="页面白屏"></a>页面白屏</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webSettings.setDomStorageEnabled(true); &#x2F;&#x2F; 开启DOM storage API 功能</span><br></pre></td></tr></table></figure>

<p>​      </p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ONLYMETAGAIN/article/details/78390643">https://blog.csdn.net/ONLYMETAGAIN/article/details/78390643</a></p>
<p><a target="_blank" rel="noopener" href="https://iluhcm.com/2017/12/10/design-an-elegant-and-powerful-android-webview-part-one/">https://iluhcm.com/2017/12/10/design-an-elegant-and-powerful-android-webview-part-one/</a></p>
<ul>
<li><p>不显示图片的问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">webSettings.setBlockNetworkImage(false);</span><br><span class="line">if (Build.VERSION.SDK_INT&gt;&#x3D;Build.VERSION_CODES.LOLLIPOP)&#123;</span><br><span class="line">    webSettings.setMixedContentMode(WebSettings.MIXED_CONTENT_ALWAYS_ALLOW);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是我的还是不显示</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:hardwareAccelerated&#x3D;&quot;false&quot;</span><br></pre></td></tr></table></figure>



<p>WebView缓存功能</p>
<p><a target="_blank" rel="noopener" href="https://github.com/yale8848/CacheWebView">https://github.com/yale8848/CacheWebView</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.leanote.com/post/zbyzhlsp/%E6%BC%AB%E8%B0%88Android-Webview%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E5%9C%BA%E6%99%AF%E4%B8%8E%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95">http://blog.leanote.com/post/zbyzhlsp/%E6%BC%AB%E8%B0%88Android-Webview%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E5%9C%BA%E6%99%AF%E4%B8%8E%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zybuluo.com/zyl06/note/737188">https://www.zybuluo.com/zyl06/note/737188</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/5b94ca52e51d450e7d097f38">https://juejin.im/post/5b94ca52e51d450e7d097f38</a></p>
<p><strong>2、缓存模式(5种)</strong></p>
<p><strong>LOAD_CACHE_ONLY:</strong>  不使用网络，只读取本地缓存数据</p>
<p><strong>LOAD_DEFAULT:</strong>  根据cache-control决定是否从网络上取数据。</p>
<p><strong>LOAD_CACHE_NORMAL: API level 17</strong>中已经废弃, 从<strong>API level 11</strong>开始作用同LOAD_DEFAULT模式</p>
<p><strong>LOAD_NO_CACHE:</strong> 不使用缓存，只从网络获取数据.</p>
<p><strong>LOAD_CACHE_ELSE_NETWORK</strong>，只要本地有，无论是否过期，或者no-cache，都使用缓存中的数据。<br>如：<a target="_blank" rel="noopener" href="http://www.taobao.com的cache-control为no-cache,在模式load_default下,无论如何都会从网络上取数据,如果没有网络,就会出现错误页面;在load_cache_else_network模式下,无论是否有网络,只要本地有缓存,都使用缓存.本地没有缓存时才从网络上获取./">www.taobao.com的cache-control为no-cache，在模式LOAD_DEFAULT下，无论如何都会从网络上取数据，如果没有网络，就会出现错误页面；在LOAD_CACHE_ELSE_NETWORK模式下，无论是否有网络，只要本地有缓存，都使用缓存。本地没有缓存时才从网络上获取。</a><br><a target="_blank" rel="noopener" href="http://www.360.com.cn的cache-control为max-age=60,在两种模式下都使用本地缓存数据./">www.360.com.cn的cache-control为max-age=60，在两种模式下都使用本地缓存数据。</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/entry/5ad70987f265da239148a614">https://juejin.im/entry/5ad70987f265da239148a614</a></p>
<p>zip离线缓存</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/AV2SwFfwwJH7xyrIBJemgw">https://mp.weixin.qq.com/s/AV2SwFfwwJH7xyrIBJemgw</a></p>
<h4 id="安全问题"><a href="#安全问题" class="headerlink" title="安全问题"></a>安全问题</h4><p>WebView漏洞的根源在于强制其访问攻击者控制的网页。网页中含有攻击者可以控制的JS,因此可能钓鱼，窃取私有文件，甚至是 RCE,带来比较大的危害。</p>
<p>下面主要是4.4系统以上的机型</p>
<h5 id="Webview密码明文存储漏洞"><a href="#Webview密码明文存储漏洞" class="headerlink" title="Webview密码明文存储漏洞"></a>Webview密码明文存储漏洞</h5><p>WebView默认开启密码保存功能mWebView.setSavePassword(true),如果未关闭，用户输入密码时，会弹出提示框，询问用户是否保存密码，如果选是，密码会明文保存到 /data/data/com.package.name/databases/webview.db</p>
<h5 id="WebView域控制不严格漏洞"><a href="#WebView域控制不严格漏洞" class="headerlink" title="WebView域控制不严格漏洞"></a>WebView域控制不严格漏洞</h5><p>setAllowFileAccess(true) : 窃取APP任意目录下的私有文件</p>
<p>setAllowUniversalAccessFromFileURLs : 允许通过file域url中的 javascript访问其他的源。</p>
<p>方案</p>
<ol>
<li><p>通过以下设置，防止越权访问，跨域等安全问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">setAllowFileAccess(<span class="keyword">false</span>)</span><br><span class="line"></span><br><span class="line">setAllowFileAccessFromFileURLs(<span class="keyword">false</span>)</span><br><span class="line"></span><br><span class="line">setAllowUniversalAccessFromFileURLs(<span class="keyword">false</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>WebSettings.setSavePassword(false)</p>
<p>关闭密码保存提醒功能</p>
</li>
<li><p>建议开发者通过以下方式移除该JavaScript接口</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">removeJavascriptInterface(<span class="string">&quot;searchBoxJavaBridge_&quot;</span>)</span><br><span class="line"></span><br><span class="line">removeJavascriptInterface(<span class="string">&quot;accessibility&quot;</span>)；</span><br><span class="line"></span><br><span class="line">removeJavascriptInterface(<span class="string">&quot;accessibilityTraversal&quot;</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/21787366">https://zhuanlan.zhihu.com/p/21787366</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.kanxue.com/article-14155.htm">https://zhuanlan.kanxue.com/article-14155.htm</a></p>

	
	</div>
  <a type="button" href="/2017/09/01/WebView/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/08/28/Camera/" >Camera</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-08-28  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://developer.android.com/training/camera/photobasics.html#TaskPath">https://developer.android.com/training/camera/photobasics.html#TaskPath</a></p>
<h5 id="Get-the-thumbnail-缩略图"><a href="#Get-the-thumbnail-缩略图" class="headerlink" title="Get the thumbnail(缩略图)"></a>Get the thumbnail(缩略图)</h5><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_IMAGE_CAPTURE = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">btAlbum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       Intent takePictureIntent = <span class="keyword">new</span> <span class="built_in">Intent</span>(</span><br><span class="line">               Intent.ACTION_PICK,</span><br><span class="line">               MediaStore.Images.Media.EXTERNAL_CONTENT_URI);</span><br><span class="line">       <span class="built_in">startActivityForResult</span>(takePictureIntent, REQUEST_IMAGE_CAPTURE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">  public void on<span class="constructor">ActivityResult(<span class="params">int</span> <span class="params">requestCode</span>, <span class="params">int</span> <span class="params">resultCode</span>, Intent <span class="params">data</span>)</span> &#123;</span><br><span class="line">      super.on<span class="constructor">ActivityResult(<span class="params">requestCode</span>, <span class="params">resultCode</span>, <span class="params">data</span>)</span>;</span><br><span class="line">   <span class="keyword">if</span> (requestCode<span class="operator"> == </span>REQUEST_IMAGE_CAPTURE<span class="operator"> &amp;&amp; </span>resultCode<span class="operator"> == </span>Activity.RESULT_OK) &#123;</span><br><span class="line">            data?.extras?.<span class="keyword">let</span> &#123;</span><br><span class="line">                <span class="keyword">val</span> imageBitmap = it.get(<span class="string">&quot;data&quot;</span>) <span class="keyword">as</span> Bitmap</span><br><span class="line">                img_show.set<span class="constructor">ImageBitmap(<span class="params">imageBitmap</span>)</span></span><br><span class="line">       &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h5 id="Save-the-full-size-photo"><a href="#Save-the-full-size-photo" class="headerlink" title="Save the full-size photo"></a>Save the full-size photo</h5><pre><code>  provider_camera.xml 
</code></pre>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">paths</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line">    &lt;external-path</span><br><span class="line">        name=&quot;my_images&quot;</span><br><span class="line">        path=&quot;Android/data/com.zhujia.land/files/Pictures&quot; /&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">paths</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>跳转拍照 : 还得注意申请权限</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> void dispatch<span class="constructor">TakePictureIntent(<span class="params">int</span> <span class="params">num</span>)</span> &#123;</span><br><span class="line">       Intent takePictureIntent = <span class="keyword">new</span> <span class="constructor">Intent(MediaStore.ACTION_IMAGE_CAPTURE)</span>;</span><br><span class="line">       <span class="keyword">if</span> (takePictureIntent.resolve<span class="constructor">Activity(<span class="params">this</span>.<span class="params">getPackageManager</span>()</span>) != null) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               photoFile = create<span class="constructor">ImageFile()</span>;</span><br><span class="line">           &#125; catch (IOException e) &#123;</span><br><span class="line">               e.print<span class="constructor">StackTrace()</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (photoFile<span class="operator"> == </span>null) &#123;</span><br><span class="line">               return;</span><br><span class="line">           &#125;</span><br><span class="line">           Uri imgUri;</span><br><span class="line">           <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; <span class="number">24</span>) &#123;</span><br><span class="line">               imgUri = <span class="module-access"><span class="module"><span class="identifier">Uri</span>.</span></span>from<span class="constructor">File(<span class="params">photoFile</span>)</span>;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">//Android 7.0系统开始 使用本地真实的Uri路径不安全,使用FileProvider封装共享Uri</span></span><br><span class="line">               <span class="comment">//参数二:fileprovider绝对路径 com.dyb.testcamerademo：项目包名</span></span><br><span class="line">               imgUri = <span class="module-access"><span class="module"><span class="identifier">FileProvider</span>.</span></span>get<span class="constructor">UriForFile(<span class="params">this</span>, <span class="string">&quot;com.zhujia.land.fileprovider&quot;</span>, <span class="params">photoFile</span>)</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           takePictureIntent.put<span class="constructor">Extra(MediaStore.EXTRA_OUTPUT, <span class="params">imgUri</span>)</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       start<span class="constructor">ActivityForResult(<span class="params">takePictureIntent</span>, <span class="params">num</span>)</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityResult</span><span class="params">(requestCode: <span class="type">Int</span>, resultCode: <span class="type">Int</span>, <span class="keyword">data</span>: <span class="type">Intent</span>?)</span></span> &#123;</span><br><span class="line">      <span class="keyword">super</span>.onActivityResult(requestCode, resultCode, <span class="keyword">data</span>)</span><br><span class="line">      <span class="keyword">if</span> (requestCode == REQUEST_IMAGE_CAPTURE &amp;&amp; resultCode == Activity.RESULT_OK) &#123;</span><br><span class="line">          <span class="comment">//如果拍照成功，将Uri用BitmapFactory的decodeStream方法转为Bitmap</span></span><br><span class="line">          <span class="keyword">val</span> imageBitmap = BitmapFactory.decodeStream(photoURI?.let &#123;</span><br><span class="line">              contentResolver.openInputStream(</span><br><span class="line">                  it</span><br><span class="line">              )</span><br><span class="line">          &#125;)</span><br><span class="line">           galleryAddPic(mImageUriFromFile) <span class="comment">//将拍的照片添加到相册</span></span><br><span class="line">          img_show.setImageBitmap(imageBitmap)</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<p>照片添加到相册</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将拍的照片添加到相册</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uri 拍的照片的Uri</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">galleryAddPic</span><span class="params">(uri: <span class="type">Uri</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> mediaScanIntent = Intent(Intent.ACTION_MEDIA_SCANNER_SCAN_FILE,uri)</span><br><span class="line">    sendBroadcast(mediaScanIntent)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>But it has a question</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">createImageFile</span><span class="params">(context: <span class="type">Context</span>)</span></span>: File? &#123;</span><br><span class="line">            <span class="comment">// Create an image file name</span></span><br><span class="line">            <span class="keyword">val</span> timeStamp: String = SimpleDateFormat(yyyyMMDD_HHmmss).format(Date())</span><br><span class="line"><span class="comment">//            val storageDir: File? = context.getExternalFilesDir(Environment.DIRECTORY_PICTURES)</span></span><br><span class="line">            <span class="keyword">val</span> storageDir = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_PICTURES)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> File.createTempFile(</span><br><span class="line">                <span class="string">&quot;JPEG_<span class="subst">$&#123;timeStamp&#125;</span>_&quot;</span>, <span class="comment">/* prefix */</span></span><br><span class="line">                <span class="string">&quot;.jpg&quot;</span>, <span class="comment">/* suffix */</span></span><br><span class="line">                storageDir <span class="comment">/* directory */</span></span><br><span class="line">            ).apply &#123;</span><br><span class="line">                <span class="comment">// Save a file: path for use with ACTION_VIEW intents</span></span><br><span class="line">                <span class="keyword">var</span> currentPhotoPath = absolutePath</span><br><span class="line">                Timber.i(<span class="string">&quot;createImageFile  <span class="variable">$currentPhotoPath</span>&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p><code>ACTION_MEDIA_SCANNER_SCAN_FILE</code> 还有一个限制条件，那就是传递进去的文件绝对路径，必须是以 <code>Environment.getExternalStorageDirectory()</code> 方法的返回值开头。</p>
<p>这样 ‘context.getExternalFilesDir(Environment.DIRECTORY_PICTURES)’  这个暂时没弄好</p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/5ae0541df265da0b9d77e45a">https://juejin.im/post/5ae0541df265da0b9d77e45a</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f269bcda335f#">https://www.jianshu.com/p/f269bcda335f#</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/26d29e187f89">https://www.jianshu.com/p/26d29e187f89</a></p>
<p>servlet<br><a target="_blank" rel="noopener" href="https://my.oschina.net/u/2008084/blog/524937">https://my.oschina.net/u/2008084/blog/524937</a></p>
<p>7.0<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/u011418943/article/details/77712662">https://blog.csdn.net/u011418943/article/details/77712662</a></p>
<p>Android 10</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/31esIqMudRRDBY8JDs8D4A">https://mp.weixin.qq.com/s/31esIqMudRRDBY8JDs8D4A</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/5a33a5106fb9a04525782db5">https://juejin.im/post/5a33a5106fb9a04525782db5</a></p>

	
	</div>
  <a type="button" href="/2017/08/28/Camera/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/08/27/ConcurrencyThreadPool/" >ConcurrencyThreadPool</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-08-27  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<img src="/2017/08/27/ConcurrencyThreadPool/Screen Shot 2020-08-19 at 10.07.23 AM.png" alt="Screen Shot 2020-08-19 at 10.07.23 AM" style="zoom:50%;">



<h4 id="线程池状态切换"><a href="#线程池状态切换" class="headerlink" title="线程池状态切换"></a>线程池状态切换</h4><p><img src="https://img2020.cnblogs.com/blog/1208468/202102/1208468-20210219204031490-460634238.png"></p>
<p>1、RUNNING</p>
<p>(1) 状态说明：线程池处在RUNNING状态时，能够接收新任务，以及对已添加的任务进行处理。<br> (02) 状态切换：线程池的初始化状态是RUNNING。换句话说，线程池被一旦被创建，就处于RUNNING状态，并且线程池中的任务数为0！</p>
<ul>
<li>1</li>
</ul>
<p>2、 SHUTDOWN</p>
<p>(1) 状态说明：线程池处在SHUTDOWN状态时，不接收新任务，但能处理已添加的任务。<br> (2) 状态切换：调用线程池的shutdown()接口时，线程池由RUNNING -&gt; SHUTDOWN。</p>
<p>3、STOP</p>
<p>(1) 状态说明：线程池处在STOP状态时，不接收新任务，不处理已添加的任务，并且会中断正在处理的任务。<br> (2) 状态切换：调用线程池的shutdownNow()接口时，线程池由(RUNNING or SHUTDOWN ) -&gt; STOP。</p>
<p>4、TIDYING</p>
<p>(1)  状态说明：当所有的任务已终止，ctl记录的”任务数量”为0，线程池会变为TIDYING状态。当线程池变为TIDYING状态时，会执行钩子函数terminated()。terminated()在ThreadPoolExecutor类中是空的，若用户想在线程池变为TIDYING时，进行相应的处理；可以通过重载terminated()函数来实现。<br> (2) 状态切换：当线程池在SHUTDOWN状态下，阻塞队列为空并且线程池中执行的任务也为空时，就会由 SHUTDOWN -&gt; TIDYING。<br> 当线程池在STOP状态下，线程池中执行的任务为空时，就会由STOP -&gt; TIDYING。</p>
<p>5、 TERMINATED</p>
<p>(1) 状态说明：线程池彻底终止，就变成TERMINATED状态。<br> (2) 状态切换：线程池处在TIDYING状态时，执行完terminated()之后，就会由 TIDYING -&gt; TERMINATED。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/nmjhehe/article/details/115901549">https://blog.csdn.net/nmjhehe/article/details/115901549</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/east7/p/14417977.html">https://www.cnblogs.com/east7/p/14417977.html</a></p>
<h4 id="线程池工作原理"><a href="#线程池工作原理" class="headerlink" title="线程池工作原理"></a>线程池工作原理</h4><p><img src="https://s0.lgstatic.com/i/image2/M01/AD/A3/CgoB5l3eH8mAAoJCAACEOKMHtpw036.png"></p>
<h5 id="各参数含义"><a href="#各参数含义" class="headerlink" title="各参数含义"></a>各参数含义</h5><h6 id="corePoolSize"><a href="#corePoolSize" class="headerlink" title="corePoolSize"></a>corePoolSize</h6><p>线程池初始化时线程数默认为 0，当有新的任务提交后，会创建新线程执行任务，如果不做特殊设置，此后线程数通常不会再小于 corePoolSize ，因为它们是核心线程，即便未来可能没有可执行的任务也不会被销毁。</p>
<h6 id="maximumPoolSize"><a href="#maximumPoolSize" class="headerlink" title="maximumPoolSize"></a>maximumPoolSize</h6><p>​    maximumPoolSize 最大线程数，线程池会在 corePoolSize 核心线程数的基础上继续创建线程来执行任务，假设任务被不断提交，线程池会持续创建线程直到线程数达到 maximumPoolSize 最大线程数，如果依然有任务被提交，这就超过了线程池的最大处理能力，这个时候线程池就会拒绝这些任务，我们可以看到实际上任务进来之后，线程池会逐一判断 corePoolSize、workQueue、maximumPoolSize，如果依然不能满足需求，则会拒绝任务。</p>
<h6 id="keepAliveTime-时间单位"><a href="#keepAliveTime-时间单位" class="headerlink" title="keepAliveTime+时间单位"></a>keepAliveTime+时间单位</h6><p>​    当线程池中线程数量多于核心线程数时，而此时又没有任务可做，线程池就会检测线程的 keepAliveTime，如果超过规定的时间，无事可做的线程就会被销毁，以便减少内存的占用和资源消耗。但是要注意到了核心线程数就不会销毁了。</p>
<p><img src="/2017/08/27/ConcurrencyThreadPool/queueThreadWork.png"></p>
<p>如上图所示，当提交任务后，线程池首先会检查当前线程数，如果此时线程数小于核心线程数，比如最开始线程数量为 0，则新建线程并执行任务，随着任务的不断增加，线程数会逐渐增加并达到核心线程数，此时如果仍有任务被不断提交，就会被放入 workQueue 任务队列中，等待核心线程执行完当前任务后重新从 workQueue 中提取正在等待被执行的任务。</p>
<p>此时，假设我们的任务特别的多，已经达到了 workQueue 的容量上限，这时线程池就会启动后备力量，也就是 maximumPoolSize 最大线程数，线程池会在 corePoolSize 核心线程数的基础上继续创建线程来执行任务，假设任务被不断提交，线程池会持续创建线程直到线程数达到 maximumPoolSize 最大线程数，如果依然有任务被提交，这就超过了线程池的最大处理能力，这个时候线程池就会拒绝这些任务，我们可以看到实际上任务进来之后，线程池会逐一判断 corePoolSize、workQueue、maximumPoolSize，如果依然不能满足需求，则会拒绝任务。</p>
<h4 id="6-种线程池"><a href="#6-种线程池" class="headerlink" title="6 种线程池"></a>6 种线程池</h4><ol>
<li><p>FixedThreadPool</p>
<p>它的核心线程数和最大线程数是一样的</p>
</li>
<li><p>CachedThreadPool</p>
<p>它的特点在于线程数是几乎可以无限增加的（实际最大可以达到 Integer.MAX_VALUE，为 2^31-1),当我们提交一个任务后，线程池会判断已创建的线程中是否有空闲线程，如果有空闲线程则将任务直接指派给空闲线程，如果没有空闲线程，则新建线程去执行任务，这样就做到了动态地新增线程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService service = Executors.newCachedThreadPool();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123; </span><br><span class="line">        service.execute(<span class="keyword">new</span> Task() &#123; </span><br><span class="line">    &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>使用 for 循环提交 1000 个任务给 CachedThreadPool，假设这些任务处理的时间非常长，会发生什么情况呢？因为 for 循环提交任务的操作是非常快的，但执行任务却比较耗时，就可能导致 1000 个任务都提交完了但第一个任务还没有被执行完，所以此时 CachedThreadPool 就可以动态的伸缩线程数量，随着任务的提交，不停地创建 1000 个线程来执行任务，而当任务执行完之后，假设没有新的任务了，那么大量的闲置线程又会造成内存资源的浪费，这时线程池就会检测线程在 60 秒内有没有可执行任务，如果没有就会被销毁，最终线程数量会减为 0。</p>
</li>
<li><p>ScheduledThreadPool</p>
<p>周期性的执行任务</p>
</li>
<li><p>SingleThreadExecutor</p>
<p>它会使用唯一的线程去执行任务，原理和 FixedThreadPool 是一样的，只不过这里线程只有一个，如果线程在执行任务的过程中发生异常，线程池也会重新创建一个线程来执行后续的任务</p>
</li>
<li><p>SingleThreadScheduledExecutor</p>
<p>它实际和第三种 ScheduledThreadPool 线程池非常相似，它只是 ScheduledThreadPool 的一个特例，内部只有一个线程.</p>
</li>
<li><p>ForkJoinPool</p>
<p>我们有一个 Task，这个 Task 可以产生三个子任务，三个子任务并行执行完毕后将结果汇总给 Result。</p>
<img src="https://s0.lgstatic.com/i/image2/M01/AF/A0/CgotOV3kzomAflZxAAB99x9-MzI241.png" style="zoom:50%;"></li>
</ol>
<h4 id="拒绝策略"><a href="#拒绝策略" class="headerlink" title="拒绝策略"></a>拒绝策略</h4><ul>
<li><p>第一种拒绝策略是 AbortPolicy，这种拒绝策略在拒绝任务时，会直接抛出一个类型为 RejectedExecutionException 的 RuntimeException，让你感知到任务被拒绝了，于是你便可以根据业务逻辑选择重试或者放弃提交等策略。</p>
</li>
<li><p>第二种拒绝策略是 DiscardPolicy，这种拒绝策略正如它的名字所描述的一样，当新任务被提交后直接被丢弃掉，也不会给你任何的通知，相对而言存在一定的风险，因为我们提交的时候根本不知道这个任务会被丢弃，可能造成数据丢失。</p>
</li>
<li><p>第三种拒绝策略是 DiscardOldestPolicy，如果线程池没被关闭且没有能力执行，则会丢弃任务队列中的头结点，通常是存活时间最长的任务，这种策略与第二种不同之处在于它丢弃的不是最新提交的，而是队列中存活时间最长的，这样就可以腾出空间给新提交的任务，但同理它也存在一定的数据丢失风险。</p>
</li>
<li><p>第四种拒绝策略是 CallerRunsPolicy，相对而言它就比较完善了，当有新任务提交后，如果线程池没被关闭且没有能力执行，则把这个任务交于提交任务的线程执行，也就是谁提交任务，谁就负责执行任务。这样做主要有两点好处。<br>第一点新提交的任务不会被丢弃，这样也就不会造成业务损失。<br>第二点好处是，由于谁提交任务谁就要负责执行任务，这样提交任务的线程就得负责执行任务，而执行任务又是比较耗时的，在这段期间，提交任务的线程被占用，也就不会再提交新的任务，减缓了任务提交的速度，相当于是一个负反馈。在此期间，线程池中的线程也可以充分利用这段时间来执行掉一部分任务，腾出一定的空间，相当于是给了线程池一定的缓冲期。</p>
<p><strong>提交任务的线程是不固定的，取决于具体是哪个线程执行submit等方法的</strong></p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=16#/detail/pc?id=248">https://kaiwu.lagou.com/course/courseInfo.htm?courseId=16#/detail/pc?id=248</a></p>
<h4 id="线程数量和CPU核数关系"><a href="#线程数量和CPU核数关系" class="headerlink" title="线程数量和CPU核数关系"></a>线程数量和CPU核数关系</h4><p><code>线程数 = CPU 核心数 *（1+平均等待时间/平均工作时间）</code></p>
<ol>
<li><p>线程平均等待时间所占比例越高，就需要越多的线程</p>
<blockquote>
<p>耗时 IO 型任务 , 比如数据库、文件的读写，网络通信等任务，这种任务的特点是并不会特别消耗 CPU 资源，但是 IO 操作很耗时，总体会占用比较多的时间 , 因为 IO 读写速度相比于 CPU 的速度而言是比较慢的，如果我们设置过少的线程数，就可能导致 CPU 资源的浪费,而如果我们设置更多的线程数，那么当一部分线程正在等待 IO 的时候，它们此时并不需要 CPU 来计算，那么另外的线程便可以利用 CPU 去执行其他的任务，互不影响，这样的话在任务队列中等待的任务就会减少，可以更好地利用资源。</p>
</blockquote>
</li>
<li><p> 线程的平均工作时间所占比例越高，就需要越少的线程</p>
</li>
</ol>
<blockquote>
<p> 平均工作时间长 : CPU密集型任务，加密、解密、压缩、计算等一系列需要大量耗费 CPU 资源的任务。因为计算任务非常重，会占用大量的 CPU 资源，所以这时 CPU 的每个核心工作基本都是满负荷的，而我们又设置了过多的线程，每个线程都想去利用 CPU 资源来执行自己的任务，这就会造成不必要的上下文切换，此时线程数的增多并没有让性能提升，反而由于线程数量过多会导致性能下降。</p>
</blockquote>
<p>   可以通过写代码等办法统计到各部分语句的运行时长</p>
<p>如果我们执行的任务类型不是固定的，比如可能一段时间是 CPU 密集型，另一段时间是 IO 密集型，或是同时有两种任务相互混搭。那么在这种情况下，我们可以把最大线程数设置成核心线程数的几倍，以便应对任务突发情况。当然更好的办法是用不同的线程池执行不同类型的任务，让任务按照类型区分开，而不是混杂在一起，这样就可以按照上一课时估算的线程数或经过压测得到的结果来设置合理的线程数了，达到更好的性能。</p>
<p><a target="_blank" rel="noopener" href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=16#/detail/pc?id=254">https://kaiwu.lagou.com/course/courseInfo.htm?courseId=16#/detail/pc?id=254</a></p>
<h4 id="阻塞队列"><a href="#阻塞队列" class="headerlink" title="阻塞队列"></a>阻塞队列</h4><h5 id="5种常见的线程池"><a href="#5种常见的线程池" class="headerlink" title="5种常见的线程池"></a>5种常见的线程池</h5><img src="/2017/08/27/ConcurrencyThreadPool/blockQueue.png" alt="Screen Shot 2020-08-19 at 10.07.23 AM" style="zoom:50%;">



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService fixedThreadPool = Executors.newFixedThreadPool(<span class="number">1</span>);      <span class="comment">//LinkedBlockingQueue</span></span><br><span class="line">ExecutorService singleThreadExecutor = Executors.newSingleThreadExecutor();     <span class="comment">// LinkedBlockingQueue</span></span><br><span class="line">ExecutorService cachedThreadPool = Executors.newCachedThreadPool();             <span class="comment">// SynchronousQueue</span></span><br><span class="line">ScheduledExecutorService scheduledThreadPool = Executors.newScheduledThreadPool(<span class="number">1</span>); <span class="comment">//DelayedWorkQueue</span></span><br><span class="line">ScheduledExecutorService singleThreadScheduledExecutor = Executors.newSingleThreadScheduledExecutor(); <span class="comment">//DelayedWorkQueue</span></span><br></pre></td></tr></table></figure>



<p>上图 前面是线程池，后面是使用的阻塞队列</p>
<ol>
<li><p>LinkedBlockingQueue (FixedThreadPool,SingleThreadExector)</p>
<p>使用的有 FixedThreadPool ,SingleThreadExector,它们使用的阻塞队列是容量为 Integer.MAX_VALUE 的 LinkedBlockingQueue,可以认为是无界队列。由于 FixedThreadPool 线程池的线程数是固定的，所以没有办法增加特别多的线程来处理任务，这时就<em>需要 LinkedBlockingQueue 这样一个没有容量限制的阻塞队列来存放任务</em>。</p>
<p><em>缺点</em>: 最终大量堆积的任务会占用大量内存，并发生 OOM ，也就是OutOfMemoryError.</p>
</li>
<li><p>SynchronousQueue  (CachedThreadPool)</p>
<p>对应的线程池是 CachedThreadPool,线程池 CachedThreadPool 的最大线程数是 Integer 的最大值，可以理解为线程数是可以无限扩展的。和LinkedBlockingQueue阻塞队列重复相反，</p>
<p><em>缺点</em>: 当任务数量特别多的时候，就可能会导致创建非常多的线程，最终超过了操作系统的上限而无法创建新线程，或者导致内存不足。</p>
</li>
<li><p>DelayedWorkQueue (DelayedWorkQueue)</p>
<p>顾名思义，特点就是可以延迟执行任务</p>
<p><em>缺点</em>: 它采用的任务队列是 DelayedWorkQueue，这是一个延迟队列，同时也是一个无界队列，所以和 LinkedBlockingQueue 一样，如果队列中存放过多的任务，就可能导致 OOM</p>
</li>
</ol>
<h5 id="OkHttp线程池"><a href="#OkHttp线程池" class="headerlink" title="OkHttp线程池"></a>OkHttp线程池</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ThreadPoolExecutor executor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">        <span class="number">0</span>, Integer.MAX_VALUE, <span class="number">60</span>, TimeUnit.SECONDS, <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;());</span><br></pre></td></tr></table></figure>

<p>可以看到 corePoolSize  0 ,  MaxPoolSize Integer.MAX_VALUE</p>
<p>根据线程池执行流程： </p>
<ol>
<li>首先核心线程，corePoolSize 为0 。</li>
<li>把任务加入SynchronousQueue，但是这个队列加入就会失败。</li>
<li>创建非核心线程，数量为Integer.MAX_VALUE，可以创建。</li>
<li>当任务执行完后，3创建的非核心线程 根据keepAliveTime时间，逐步销毁。</li>
</ol>
<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>OkHttpThreadPool.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ThreadPoolExecutor executor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">        <span class="number">0</span>, Integer.MAX_VALUE, <span class="number">60</span>, TimeUnit.SECONDS, <span class="keyword">new</span> LinkedBlockingDeque&lt;&gt;());</span><br><span class="line">executor.execute(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;任务1&quot;</span>);</span><br><span class="line">    System.out.println(Thread.currentThread());</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">executor.execute(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;任务1&quot;</span>);</span><br><span class="line">    System.out.println(Thread.currentThread());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">executor.execute(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;任务1&quot;</span>);</span><br><span class="line">    System.out.println(Thread.currentThread());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>运行结果: </p>
<p>任务1<br>Thread[pool-1-thread-1,5,main]</p>
<p>如果 new LinkedBlockingDeque&lt;&gt;(1)能正常执行，因为LinkedBlockingDeque加入 任务1 就满了，后面的任务创建非核心线程</p>
<p>但是有点疑惑，我这里核心线程是0，任务都加入到LinkedBlockingDeque, 按照线程池流程，<strong>非核心就不应该创建呀？怎么任务1就执行了呢</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV15y4y1B7Rw?p=5">https://www.bilibili.com/video/BV15y4y1B7Rw?p=5</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/BHDrSgwUVXkzvswK1khidQ">https://mp.weixin.qq.com/s/BHDrSgwUVXkzvswK1khidQ</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Snailclimb/programmer-advancement">https://github.com/Snailclimb/programmer-advancement</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/6855586076132655118">https://juejin.im/post/6855586076132655118</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&amp;mid=2247485441&amp;idx=1&amp;sn=303a25ab02fa9f14a319923e6b0d9759&amp;chksm=cea247caf9d5cedc3a5e1d31f26c08d8ae4c11c349fbdc91ac1d90d8b35807517accb5f5d527&amp;token=2128752750&amp;lang=zh_CN#rd">https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&amp;mid=2247485441&amp;idx=1&amp;sn=303a25ab02fa9f14a319923e6b0d9759&amp;chksm=cea247caf9d5cedc3a5e1d31f26c08d8ae4c11c349fbdc91ac1d90d8b35807517accb5f5d527&amp;token=2128752750&amp;lang=zh_CN#rd</a></p>

	
	</div>
  <a type="button" href="/2017/08/27/ConcurrencyThreadPool/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/08/21/Handler/" >Handler</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-08-21  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h4 id="Handler作用"><a href="#Handler作用" class="headerlink" title="Handler作用"></a>Handler作用</h4><p>既然process内的thread share their memories. why we need handler.我们直接可以 subThread get data,赋值给Ui thread的变量呀。</p>
<p>正常来说是没问题的。但是像下面这种情况。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;123&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> anInt = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 子</span></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                anInt = <span class="number">2</span>;</span><br><span class="line">                Log.i(TAG, <span class="string">&quot;子线程: &quot;</span> + anInt);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="comment">// 主</span></span><br><span class="line">            Log.i(TAG, <span class="string">&quot;主线程: &quot;</span> + anInt);</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">————————————————</span><br><span class="line">版权声明：本文为CSDN博主「dev晴天」的原创文章，遵循CC <span class="number">4.0</span> BY-SA版权协议，转载请附上原文出处链接及本声明。</span><br><span class="line">原文链接：https:<span class="comment">//blog.csdn.net/qq_38350635/article/details/90440833</span></span><br></pre></td></tr></table></figure>

<p>如上：主线程定义了anInt，子线程对其修改。我们再在主线程打印，能得到修改后的anInt = 2 吗？<br> 答案：不确定<br> 原因：线程争夺cup使用权顺序不确定，可能,子线程先获得使用权，则两个Log都打印2。当然主线程先获得使用权时主线程的log打印数值为1。</p>
<p>解决方案<br>1、让子线程先执行。</p>
<pre><code>比如主线程设置低优先级、主线程休息等等（不靠谱，提供一种想法吧）
</code></pre>
<p>2、安卓中的Handler机制</p>
<pre><code>子线程发送消息，主线程接受消息，只有主线程收到消息再打印处理数值。
handler使用略。。。。。。
</code></pre>
<p>3、接口回调机制</p>
<h5 id="原理图"><a href="#原理图" class="headerlink" title="原理图"></a>原理图</h5><img src="/2017/08/21/Handler/2021-07-07_15-49-54_hanlder.png">



<p> <img src="https://images.xiaozhuanlan.com/photo/2019/5dd99feb4297e4c3a5ad55dba0812a1a.png"></p>
<h5 id="各组件作用"><a href="#各组件作用" class="headerlink" title="各组件作用"></a>各组件作用</h5><ul>
<li>Handler：事件的发送及处理者，在构造方法中可以设置其 async，默认为 false。若 async 为 true 则该 Handler 发送的 Message 均为异步消息，有同步屏障的情况下会被优先处理。</li>
<li>Looper：一个用于遍历 MessageQueue 的类，每个线程有一个独有的 Looper，它会在所处的线程开启一个死循环，不断从 MessageQueue 中拿出消息，并将其发送给 target 进行处理</li>
<li>MessageQueue：在主线程,用于存储 Message，内部维护了 Message 的链表，每次拿取 Message 时，若该  Message 离真正执行还需要一段时间，会通过 nativePollOnce  进入阻塞状态，避免资源的浪费。若存在消息屏障，则会忽略同步消息优先拿取异步消息，从而实现异步消息的优先消费。</li>
</ul>
<h5 id="消息入队算法"><a href="#消息入队算法" class="headerlink" title="消息入队算法"></a>消息入队算法</h5><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/9efe3b48b730">https://www.jianshu.com/p/9efe3b48b730</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904113470177293">https://juejin.cn/post/6844904113470177293</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1VE411Z7Ay?p=4">https://www.bilibili.com/video/BV1VE411Z7Ay?p=4</a></p>
<h5 id="ThreadLocal存取算法"><a href="#ThreadLocal存取算法" class="headerlink" title="ThreadLocal存取算法"></a>ThreadLocal存取算法</h5><p>　ThreadLocal是一个线程内部的数据存储类，它可以指定线程的存储数据，数据存储后只有在指定的线程种裁可以获取到存储的数据, 其他线程无法获取。</p>
<p> 验证:</p>
<pre><code>  private ThreadLocal&lt;String&gt; mStringThreadLocal = new ThreadLocal&lt;&gt;();
  mStringThreadLocal.set(&quot;我是主线程&quot;);
    Log.d(TAG, &quot;mStringThreadLocal 主线程 :　&quot; + mStringThreadLocal.get());
    exec.submit(new Runnable() &#123;
        @Override
        public void run() &#123;
            mStringThreadLocal.set(&quot;我是线程１&quot;);
            Log.d(TAG, &quot;mStringThreadLocal 线程１:　&quot; + mStringThreadLocal.get());
        &#125;
    &#125;);

    exec.submit(new Runnable() &#123;
        @Override
        public void run() &#123;
            Log.d(TAG, &quot;mStringThreadLocal 线程2: &quot; + mStringThreadLocal.get());
        &#125;
    &#125;);
</code></pre>
<p>运行结果:</p>
<blockquote>
<pre><code>  D/MainActivity: mStringThreadLocal 主线程 :　我是主线程
 D/MainActivity: mStringThreadLocal 线程１:　我是线程１
 D/MainActivity: mStringThreadLocal 线程2: null
</code></pre>
</blockquote>
<p>从日志可以看到，虽然在不同线程访问的同一个ThreadLocal对象，但是他们通过ThreadLocal获取到的值确不一样<br>　结论：　对ThreadLocal所做的　读写操作仅限于各自线程的内部，ThreadLocal可以在多个线程互不干扰的存储和修改数据。<br>  !!!任务： 分析ThreadLocal存取算法</p>
<p>[^参考：Android开发艺术探索　p377]</p>
<h5 id="消息"><a href="#消息" class="headerlink" title="消息"></a>消息</h5><h6 id="同步消息"><a href="#同步消息" class="headerlink" title="同步消息"></a>同步消息</h6><p> 来个简单的例子<br> <figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">new</span> Thread(<span class="built_in">new</span> Runnable() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        <span class="built_in">public</span> <span class="type">void</span> run() &#123;</span><br><span class="line">          Looper.<span class="keyword">prepare</span>();</span><br><span class="line">          <span class="keyword">handler</span> = <span class="built_in">new</span> <span class="keyword">Handler</span>();</span><br><span class="line">          Looper.<span class="keyword">loop</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).<span class="keyword">start</span>();</span><br></pre></td></tr></table></figure><br>把　Looper.prepare();注释，报错日志 : <code>java.lang.RuntimeException: Can&#39;t create handler inside thread that has not called Looper.prepare()</code></p>
<p>从报错信息入手看原因，初始化Handler (API = 25)</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="title">Handler</span>(<span class="params">Callback callback, <span class="built_in">boolean</span> <span class="keyword">async</span></span>)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (FIND_POTENTIAL_LEAKS) &#123;</span><br><span class="line">           final Class&lt;? <span class="keyword">extends</span> Handler&gt; klass = getClass();</span><br><span class="line">           <span class="keyword">if</span> ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp;</span><br><span class="line">                   (klass.getModifiers() &amp; Modifier.STATIC) == <span class="number">0</span>) &#123;</span><br><span class="line">               Log.w(TAG, <span class="string">&quot;The following Handler class should be static or leaks might occur: &quot;</span> +</span><br><span class="line">                   klass.getCanonicalName());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       mLooper = Looper.myLooper();</span><br><span class="line">       <span class="keyword">if</span> (mLooper == <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">               <span class="string">&quot;Can&#x27;t create handler inside thread that has not called Looper.prepare()&quot;</span>);  <span class="comment">//报错信息</span></span><br><span class="line">       &#125;</span><br><span class="line">       mQueue = mLooper.mQueue;</span><br><span class="line">       mCallback = callback;</span><br><span class="line">       mAsynchronous = <span class="keyword">async</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>　mLooper为空,所以报错，看下<code>Looper.myLooper();</code></p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Return the Looper object associated with the current thread.  Returns</span></span><br><span class="line"><span class="comment">    * null if the calling thread is not associated with a Looper.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> @<span class="function">Nullable Looper <span class="title">myLooper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> sThreadLocal.<span class="built_in">get</span>();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>  注释可以看到，当前线程没有Looper对象, 那么Looper对象是怎么创建的呢，很显然就是上面例子里的<code> Looper.prepare();</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Initialize the current thread as a looper.</span></span><br><span class="line"><span class="comment">     * This gives you a chance to create handlers that then reference</span></span><br><span class="line"><span class="comment">     * this looper, before actually starting the loop. Be sure to call</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link </span>#loop()&#125; after calling this method, and end it by calling</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link </span>#quit()&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="function"><span class="title">prepare</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">       prepare(<span class="literal">true</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="function"><span class="title">prepare</span>(<span class="params"><span class="built_in">boolean</span> quitAllowed</span>)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (sThreadLocal.get() != <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Only one Looper may be created per thread&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       sThreadLocal.set(<span class="keyword">new</span> Looper(quitAllowed));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>如果没有Looper　则new 一个，由此也看到每个线程最多一个Looper对象,接着看初始化的Looper</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="constructor">Looper(<span class="params">boolean</span> <span class="params">quitAllowed</span>)</span> &#123;</span><br><span class="line">       mQueue = <span class="keyword">new</span> <span class="constructor">MessageQueue(<span class="params">quitAllowed</span>)</span>;</span><br><span class="line">       mThread = <span class="module-access"><span class="module"><span class="identifier">Thread</span>.</span></span>current<span class="constructor">Thread()</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>MesageQueue也是通过Looper创建的，看到private 构造方法,一个Looper管理一个　ＭesageQueue,<br>但是我们通常在UI线程初始化Handler不需要调用 <code>Looper.prepare();</code>,这是因为应用启动后,主线程<br>ActivityThread main方法为我们做了工作。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">String</span>[] args)</span> </span>&#123;</span><br><span class="line">       Trace.<span class="built_in">traceBegin</span>(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;ActivityThreadMain&quot;</span>);</span><br><span class="line">       SamplingProfilerIntegration.<span class="built_in">start</span>();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// CloseGuard defaults to true and can be quite spammy.  We</span></span><br><span class="line">       <span class="comment">// disable it here, but selectively enable it later (via</span></span><br><span class="line">       <span class="comment">// StrictMode) on debug builds, but using DropBox, not logs.</span></span><br><span class="line">       CloseGuard.<span class="built_in">setEnabled</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">       Environment.<span class="built_in">initForCurrentUser</span>();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Set the reporter for event logging in libcore</span></span><br><span class="line">       EventLogger.<span class="built_in">setReporter</span>(<span class="keyword">new</span> <span class="built_in">EventLoggingReporter</span>());</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Make sure TrustedCertificateStore looks in the right place for CA certificates</span></span><br><span class="line">       <span class="keyword">final</span> <span class="built_in">File</span> configDir = Environment.<span class="built_in">getUserConfigDirectory</span>(UserHandle.<span class="built_in">myUserId</span>());</span><br><span class="line">       TrustedCertificateStore.<span class="built_in">setDefaultUserDirectory</span>(configDir);</span><br><span class="line"></span><br><span class="line">       <span class="built_in">Process</span>.<span class="built_in">setArgV0</span>(<span class="string">&quot;&lt;pre-initialized&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">       Looper.<span class="built_in">prepareMainLooper</span>();</span><br><span class="line"></span><br><span class="line">       ActivityThread thread = <span class="keyword">new</span> <span class="built_in">ActivityThread</span>();</span><br><span class="line">       thread.<span class="built_in">attach</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (sMainThreadHandler == null) &#123;</span><br><span class="line">           sMainThreadHandler = thread.<span class="built_in">getHandler</span>();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="literal">false</span>) &#123;</span><br><span class="line">           Looper.<span class="built_in">myLooper</span>().<span class="built_in">setMessageLogging</span>(<span class="keyword">new</span></span><br><span class="line">                   <span class="built_in">LogPrinter</span>(Log.DEBUG, <span class="string">&quot;ActivityThread&quot;</span>));</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// End of event ActivityThreadMain.</span></span><br><span class="line">       Trace.<span class="built_in">traceEnd</span>(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">       Looper.<span class="built_in">loop</span>();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(<span class="string">&quot;Main thread loop unexpectedly exited&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这样初始化Handler操作分析好了，接着就开始发消息了 <code>handler.sendMessage(message);</code>,经过层层调用来到这个方法</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">　 <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sendMessageAtTime</span><span class="params">(Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</span><br><span class="line">    MessageQueue queue = mQueue;</span><br><span class="line">    <span class="keyword">if</span> (queue == null) &#123;</span><br><span class="line">        RuntimeException e = <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(</span><br><span class="line">                <span class="keyword">this</span> + <span class="string">&quot; sendMessageAtTime() called with no mQueue&quot;</span>);</span><br><span class="line">        Log.<span class="built_in">w</span>(<span class="string">&quot;Looper&quot;</span>, e.<span class="built_in">getMessage</span>(), e);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">enqueueMessage</span>(queue, msg, uptimeMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二个参数时间是可以添加延时的参数</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">boolean <span class="title">enqueueMessage</span>(<span class="params">Message msg, <span class="built_in">long</span> <span class="keyword">when</span></span>)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (msg.target == <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Message must have a target.&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (msg.isInUse()) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(msg + <span class="string">&quot; This message is already in use.&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       synchronized (<span class="keyword">this</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (mQuitting) &#123;</span><br><span class="line">               IllegalStateException e = <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                       msg.target + <span class="string">&quot; sending message to a Handler on a dead thread&quot;</span>);</span><br><span class="line">               Log.w(TAG, e.getMessage(), e);</span><br><span class="line">               msg.recycle();</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           msg.markInUse();</span><br><span class="line">           msg.<span class="keyword">when</span> = <span class="keyword">when</span>;</span><br><span class="line">           Message p = mMessages;</span><br><span class="line">           boolean needWake;</span><br><span class="line">           <span class="keyword">if</span> (p == <span class="literal">null</span> || <span class="keyword">when</span> == <span class="number">0</span> || <span class="keyword">when</span> &lt; p.<span class="keyword">when</span>) &#123;</span><br><span class="line">               <span class="comment">// New head, wake up the event queue if blocked.</span></span><br><span class="line">               msg.next = p;</span><br><span class="line">               mMessages = msg;</span><br><span class="line">               needWake = mBlocked;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// Inserted within the middle of the queue.  Usually we don&#x27;t have to wake</span></span><br><span class="line">               <span class="comment">// up the event queue unless there is a barrier at the head of the queue</span></span><br><span class="line">               <span class="comment">// and the message is the earliest asynchronous message in the queue.</span></span><br><span class="line">               needWake = mBlocked &amp;&amp; p.target == <span class="literal">null</span> &amp;&amp; msg.isAsynchronous();</span><br><span class="line">               Message prev;</span><br><span class="line">               <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                   prev = p;</span><br><span class="line">                   p = p.next;</span><br><span class="line">                   <span class="keyword">if</span> (p == <span class="literal">null</span> || <span class="keyword">when</span> &lt; p.<span class="keyword">when</span>) &#123;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">if</span> (needWake &amp;&amp; p.isAsynchronous()) &#123;</span><br><span class="line">                       needWake = <span class="literal">false</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               msg.next = p; <span class="comment">// invariant: p == prev.next</span></span><br><span class="line">               prev.next = msg;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// We can assume mPtr != 0 because mQuitting is false.</span></span><br><span class="line">           <span class="keyword">if</span> (needWake) &#123;</span><br><span class="line">               nativeWake(mPtr);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这要Mesage消息就添加到 MesageQueue中了，按事件顺序添加，然后就是取消息了，通过调用<code>Looper.loop();</code></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Run the message queue in this thread. Be sure to call</span></span><br><span class="line"><span class="comment">    * &#123;@link #quit()&#125; to end the loop.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   public static void loop<span class="literal">()</span> &#123;</span><br><span class="line">       final Looper me = my<span class="constructor">Looper()</span>;</span><br><span class="line">       <span class="keyword">if</span> (me<span class="operator"> == </span>null) &#123;</span><br><span class="line">           throw <span class="keyword">new</span> <span class="constructor">RuntimeException(<span class="string">&quot;No Looper; Looper.prepare() wasn&#x27;t called on this thread.&quot;</span>)</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       final MessageQueue queue = me.mQueue;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Make sure the identity of this thread is that of the local process,</span></span><br><span class="line">       <span class="comment">// and keep track of what that identity token actually is.</span></span><br><span class="line">       <span class="module-access"><span class="module"><span class="identifier">Binder</span>.</span></span>clear<span class="constructor">CallingIdentity()</span>;</span><br><span class="line">       final long ident = <span class="module-access"><span class="module"><span class="identifier">Binder</span>.</span></span>clear<span class="constructor">CallingIdentity()</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">           Message msg = queue.next<span class="literal">()</span>; <span class="comment">// might block</span></span><br><span class="line">           <span class="keyword">if</span> (msg<span class="operator"> == </span>null) &#123;</span><br><span class="line">               <span class="comment">// No message indicates that the message queue is quitting.</span></span><br><span class="line">               return;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></span><br><span class="line">           final Printer logging = me.mLogging;</span><br><span class="line">           <span class="keyword">if</span> (logging != null) &#123;</span><br><span class="line">               logging.println(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt; Dispatching to &quot;</span> + msg.target + <span class="string">&quot; &quot;</span> +</span><br><span class="line">                       msg.callback + <span class="string">&quot;: &quot;</span> + msg.what);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           final long traceTag = me.mTraceTag;</span><br><span class="line">           <span class="keyword">if</span> (traceTag != <span class="number">0</span><span class="operator"> &amp;&amp; </span><span class="module-access"><span class="module"><span class="identifier">Trace</span>.</span></span>is<span class="constructor">TagEnabled(<span class="params">traceTag</span>)</span>) &#123;</span><br><span class="line">               <span class="module-access"><span class="module"><span class="identifier">Trace</span>.</span></span>trace<span class="constructor">Begin(<span class="params">traceTag</span>, <span class="params">msg</span>.<span class="params">target</span>.<span class="params">getTraceName</span>(<span class="params">msg</span>)</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               msg.target.dispatch<span class="constructor">Message(<span class="params">msg</span>)</span>;</span><br><span class="line">           &#125; finally &#123;</span><br><span class="line">               <span class="keyword">if</span> (traceTag != <span class="number">0</span>) &#123;</span><br><span class="line">                   <span class="module-access"><span class="module"><span class="identifier">Trace</span>.</span></span>trace<span class="constructor">End(<span class="params">traceTag</span>)</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (logging != null) &#123;</span><br><span class="line">               logging.println(<span class="string">&quot;&lt;&lt;&lt;&lt;&lt; Finished to &quot;</span> + msg.target + <span class="string">&quot; &quot;</span> + msg.callback);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Make sure that during the course of dispatching the</span></span><br><span class="line">           <span class="comment">// identity of the thread wasn&#x27;t corrupted.</span></span><br><span class="line">           final long newIdent = <span class="module-access"><span class="module"><span class="identifier">Binder</span>.</span></span>clear<span class="constructor">CallingIdentity()</span>;</span><br><span class="line">           <span class="keyword">if</span> (ident != newIdent) &#123;</span><br><span class="line">               <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>wtf(TAG, <span class="string">&quot;Thread identity changed from 0x&quot;</span></span><br><span class="line">                       + <span class="module-access"><span class="module"><span class="identifier">Long</span>.</span></span><span class="keyword">to</span><span class="constructor">HexString(<span class="params">ident</span>)</span> + <span class="string">&quot; to 0x&quot;</span></span><br><span class="line">                       + <span class="module-access"><span class="module"><span class="identifier">Long</span>.</span></span><span class="keyword">to</span><span class="constructor">HexString(<span class="params">newIdent</span>)</span> + <span class="string">&quot; while dispatching to &quot;</span></span><br><span class="line">                       + msg.target.get<span class="constructor">Class()</span>.get<span class="constructor">Name()</span> + <span class="string">&quot; &quot;</span></span><br><span class="line">                       + msg.callback + <span class="string">&quot; what=&quot;</span> + msg.what);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           msg.recycle<span class="constructor">Unchecked()</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>通过 Message msg = queue.next();　获取消息，然后用<code>  msg.target.dispatchMessage(msg);</code>把消息往哪发呢 ?</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle system messages here.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    public void dispatch<span class="constructor">Message(Message <span class="params">msg</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.callback != null) &#123;</span><br><span class="line">            handle<span class="constructor">Callback(<span class="params">msg</span>)</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mCallback != null) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mCallback.handle<span class="constructor">Message(<span class="params">msg</span>)</span>) &#123;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            handle<span class="constructor">Message(<span class="params">msg</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>点开　handleMesage(msg),msg.target 就是Handler</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Subclasses must implement this to receive messages.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里就清楚了，消息就传到了　Hanlder里面handleMessage的实现方法<br>从上面分析handler消息传递基本了解了，借张图看下整片森林</p>
<h6 id="异步消息"><a href="#异步消息" class="headerlink" title="异步消息"></a>异步消息</h6><p>Android系统16ms会刷新一次屏幕，如果主线程的消息过多，在16ms之内没有执行完，必然会造成卡顿或者掉帧。那怎么才能不排队，没有延时的处理呢？这个时候就需要异步消息，在处理异步消息的时候，我们就需要同步屏障，让异步消息不用排队等候处理。可以理解为同步屏障是一堵墙，把同步消息队列拦住，先处理异步消息，等异步消息处理完了，这堵墙就会取消，然后继续处理同步消息。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ly502541243/article/details/109091386">https://blog.csdn.net/ly502541243/article/details/109091386</a></p>
<p>查找异步消息方法</p>
<p>MessageQueue.java </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Message <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">           <span class="keyword">if</span> (nextPollTimeoutMillis != <span class="number">0</span>) &#123;</span><br><span class="line">               Binder.flushPendingCommands();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           nativePollOnce(ptr, nextPollTimeoutMillis);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">               <span class="comment">// Try to retrieve the next message.  Return if found.</span></span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">               Message prevMsg = <span class="keyword">null</span>;</span><br><span class="line">               Message msg = mMessages;</span><br><span class="line">               <span class="keyword">if</span> (msg != <span class="keyword">null</span> &amp;&amp; msg.target == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="comment">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span></span><br><span class="line">                   <span class="keyword">do</span> &#123;</span><br><span class="line">                       prevMsg = msg;</span><br><span class="line">                       msg = msg.next;</span><br><span class="line">                   &#125; <span class="keyword">while</span> (msg != <span class="keyword">null</span> &amp;&amp; !msg.isAsynchronous()); <span class="comment">//循环查找 直到找到异步消息为止.</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ly502541243/article/details/109091386">https://blog.csdn.net/ly502541243/article/details/109091386</a></p>
<h5 id="发送延时消息"><a href="#发送延时消息" class="headerlink" title="发送延时消息"></a>发送延时消息</h5><p>看下面问题:handler如何实现延时发消息postdelay()</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/260661053">https://zhuanlan.zhihu.com/p/260661053</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/thh159/article/details/103644489">https://blog.csdn.net/thh159/article/details/103644489</a></p>
<h5 id="IdleHandler使用"><a href="#IdleHandler使用" class="headerlink" title="IdleHandler使用"></a>IdleHandler使用</h5><p>当消息队列空闲时会执行IdleHandler的queueIdle()方法，该方法返回一个boolean值，如果为false则执行完毕之后移除这条消息，如果为true则保留，等到下次空闲时会再次执行，下面看下MessageQueue的next()方法可以发现确实是这样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Message <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Run the idle handlers.</span></span><br><span class="line">            <span class="comment">// We only ever reach this code block during the first iteration.</span></span><br><span class="line"> 	keep = idler.queueIdle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>Activity启动优化：onCreate，onStart，onResume中耗时较短但非必要的代码可以放到IdleHandler中执行，减少启动时间</p>
</li>
<li><p>想要在一个View绘制完成之后添加其他依赖于这个View的View，当然这个用View#post()也能实现，区别就是前者会在消息队列空闲时执行</p>
</li>
<li><p>一些第三方库中有使用，比如LeakCanary，Glide中有使用到，具体可以自行去查看</p>
</li>
<li><p>以前我们在Activity中获取某个控件的宽高的时候总是得到的是0，那是因为view的测量还未完成。通常的做法是监听ViewTreeObserver，它是在ViewRootImpl测量完成之后调用ViewTreeObserver.dispatchOnGlobalLayout()方法，这时候在onGlobalLayout回调中获取的控件宽高都是正确的数据。</p>
</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Looper.myQueue().addIdleHandler &#123;</span><br><span class="line">    Log.i(<span class="string">&quot;HandlerActivity&quot;</span>, <span class="string">&quot;width <span class="subst">$&#123;btFive.width&#125;</span>  height <span class="subst">$&#123;btFive.height&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ZYJWR/article/details/103086664">https://blog.csdn.net/ZYJWR/article/details/103086664</a></p>
<p><a target="_blank" rel="noopener" href="https://www.wanandroid.com/wenda/show/8723">https://www.wanandroid.com/wenda/show/8723</a></p>
<h5 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h5><h6 id="handler的是怎样实现的？"><a href="#handler的是怎样实现的？" class="headerlink" title="handler的是怎样实现的？"></a>handler的是怎样实现的？</h6><p>新线程中执行了一个耗时操作，然后把该结果塞给message，handler将发送这个messageQueue，Loop不停的从消息队列中取出消息。Handler 分发给Ui.</p>
<h6 id="Handler是怎么切换线程的"><a href="#Handler是怎么切换线程的" class="headerlink" title="Handler是怎么切换线程的"></a>Handler是怎么切换线程的</h6><p>我们在不同的线程发送消息，线程之间的资源是共享的</p>
<h6 id="Handler机制了解吗？一个线程有几个Looper？为什么？"><a href="#Handler机制了解吗？一个线程有几个Looper？为什么？" class="headerlink" title="Handler机制了解吗？一个线程有几个Looper？为什么？"></a>Handler机制了解吗？一个线程有几个Looper？为什么？</h6><p>只能有一个，不然调用Looper.prepare()会抛出运行时异常，提示“Only one Looper may be created per thread”</p>
<h6 id="handler如何实现延时发消息postdelay"><a href="#handler如何实现延时发消息postdelay" class="headerlink" title="handler如何实现延时发消息postdelay(),"></a>handler如何实现延时发消息postdelay(),</h6><p>可以看到这里也是一个for循环遍历队列，核心变量就是nextPollTimeoutMillis。可以看到，计算出nextPollTimeoutMillis后就调用nativiePollOnce这个native方法。这里的话大概可以猜到他的运行机制，因为他是根据执行时间进行排序的，那传入的这个nextPollTimeoutMillis应该就是休眠时间，类似于java的sleep(time)。休眠到下一次message的时候就执行。那如果我在这段时间又插入了一个新的message怎么办，所以handler每次插入message都会唤醒线程，重新计算插入后，再走一次这个休眠流程。</p>
<p>值得注意的是这个方法没有开启子线程，只是调用了run(), 在<code> msg.target.dispatchMessage(msg)</code>可以看到，接着调用了handleCallback().</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/68083d432b3f">https://www.jianshu.com/p/68083d432b3f</a></p>
<h6 id="如果移除一个延时消息会解除休眠吗"><a href="#如果移除一个延时消息会解除休眠吗" class="headerlink" title="如果移除一个延时消息会解除休眠吗"></a>如果移除一个延时消息会解除休眠吗</h6><h6 id="主线程死循环不会卡死吗"><a href="#主线程死循环不会卡死吗" class="headerlink" title="主线程死循环不会卡死吗"></a>主线程死循环不会卡死吗</h6><p>从前面的主线程、子线程的分析可以看出，Looper会在线程中不断的检索消息，如果是子线程的Looper死循环，一旦任务完成，用户应该手动退出，而不是让其一直休眠等待。（引用自Gityuan）线程其实就是一段可执行的代码，当可执行的代码执行完成后，线程的生命周期便该终止了，线程退出。而对于主线程，我们是绝不希望会被运行一段时间，自己就退出，那么如何保证能一直存活呢？简单做法就是可执行代码是能一直执行下去的，死循环便能保证不会被退出，例如，binder 线程也是采用死循环的方法，通过循环方式不同与 Binder 驱动进行读写操作，当然并非简单地死循环，无消息时会休眠。<strong>Android是基于消息处理机制的，用户的行为都在这个Looper循环中，我们在休眠时点击屏幕，便唤醒主线程继续进行工作</strong>。</p>
<p>主线程的死循环一直运行是不是特别消耗 CPU 资源呢？ 其实不然，这里就涉及到 Linux pipe/epoll机制，简单说就是在主线程的 MessageQueue 没有消息时，便阻塞在 loop 的 queue.next() 中的 nativePollOnce() 方法里，此时主线程会释放 CPU 资源进入休眠状态，直到下个消息到达或者有事务发生，通过往 pipe 管道写端写入数据来唤醒主线程工作。这里采用的 epoll 机制，是一种IO多路复用机制，可以同时监控多个描述符，当某个描述符就绪(读或写就绪)，则立刻通知相应程序进行读或写操作，本质同步I/O，即读写是阻塞的。 所以说，主线程大多数时候都是处于休眠状态，并不会消耗大量CPU资源。</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/a7969d73c120">https://www.jianshu.com/p/a7969d73c120</a></p>
<h6 id="handler内存泄露问题"><a href="#handler内存泄露问题" class="headerlink" title="handler内存泄露问题"></a>handler内存泄露问题</h6><h6 id="说说你对Handler机制的了解，同步消息，异步消息等"><a href="#说说你对Handler机制的了解，同步消息，异步消息等" class="headerlink" title="说说你对Handler机制的了解，同步消息，异步消息等"></a>说说你对Handler机制的了解，同步消息，异步消息等</h6><h6 id="IdleHandler用过吗-IdleHandler应用场景？"><a href="#IdleHandler用过吗-IdleHandler应用场景？" class="headerlink" title="IdleHandler用过吗,IdleHandler应用场景？"></a>IdleHandler用过吗,IdleHandler应用场景？</h6><p> 见上面IdleHandler使用</p>
<p>handler如何实现延时发消息postdelay()。callback，runnable，msg的执行优先级。阻塞是怎么实现的？为什么不会阻塞主线程？</p>
<h6 id=""><a href="#" class="headerlink" title=""></a></h6><h6 id="Handler休眠是怎样的？epoll的原理是什么？"><a href="#Handler休眠是怎样的？epoll的原理是什么？" class="headerlink" title="Handler休眠是怎样的？epoll的原理是什么？"></a>Handler休眠是怎样的？epoll的原理是什么？</h6><h6 id="如何实现延时消息，如果移除一个延时消息会解除休眠吗？"><a href="#如何实现延时消息，如果移除一个延时消息会解除休眠吗？" class="headerlink" title="如何实现延时消息，如果移除一个延时消息会解除休眠吗？"></a>如何实现延时消息，如果移除一个延时消息会解除休眠吗？</h6><p>Handler内存泄漏的GCRoot是什么？</p>
<p>epoll的时候算是卡顿吗</p>
<p>怎么样算是卡顿了</p>
<p>怎么利用消息机制检测卡顿</p>
<p>除了这种方式还有别的监测卡顿的方式吗</p>
<h6 id="Android中为什么主线程不会因为Looper-loop-里的死循环卡死？"><a href="#Android中为什么主线程不会因为Looper-loop-里的死循环卡死？" class="headerlink" title="Android中为什么主线程不会因为Looper.loop()里的死循环卡死？"></a>Android中为什么主线程不会因为Looper.loop()里的死循环卡死？</h6><p>对于线程即是一段可执行的代码，当可执行代码执行完成后，线程生命周期便该终止了，线程退出。而对于主线程，我们是绝不希望会被运行一段时间，自己就退出，那么如何保证能一直存活呢？简单做法就是可执行代码是能一直执行下去的，死循环便能保证不会被退出，例如，binder线程也是采用死循环的方法，通过循环方式不同与Binder驱动进行读写操作，当然并非简单地死循环，无消息时会休眠。但这里可能又引发了另一个问题，既然是死循环又如何去处理其他事务呢？通过创建新线程的方式。真正会卡死主线程的操作是在回调方法<code>onCreate/onStart/onResume</code>等操作时间过长，会导致掉帧，甚至发生ANR，looper.loop本身不会导致应用卡死。</p>
<p>主线程的死循环一直运行是不是特别消耗CPU资源呢？ 其实不然，这里就涉及到<code>Linux pipe/epoll</code>机制，简单说就是在主线程的<code>MessageQueue</code>没有消息时，便阻塞在loop的<code>queue.next()</code>中的<code>nativePollOnce()</code>方法里，此时主线程会释放CPU资源进入休眠状态，直到下个消息到达或者有事务发生，通过往pipe管道写端写入数据来唤醒主线程工作。这里采用的epoll机制，是一种IO多路复用机制，可以同时监控多个描述符，当某个描述符就绪(读或写就绪)，则立刻通知相应程序进行读或写操作，本质同步I/O，即读写是阻塞的。 所以说，主线程大多数时候都是处于休眠状态，并不会消耗大量CPU资源。 Gityuan–Handler(Native层)</p>
<p>Handler通信，Binder通信</p>
<h6 id="Handler同步屏障"><a href="#Handler同步屏障" class="headerlink" title="Handler同步屏障"></a>Handler同步屏障</h6><p>Handler发送的消息分为普通消息、屏障消息、异步消息，一旦Looper在处理消息时遇到屏障消息，那么就不再处理普通的消息，而仅仅处理异步的消息。不再使用屏障后，需要撤销屏障，不然就再也执行不到普通消息了。</p>
<p>为什么需要这样？它是设计来为了让某些特殊的消息得以更快被执行的机制。比如绘制界面，这种消息可能会明显的被用户感知到，稍有不慎就会引起卡顿、掉帧之类的，所以需要及时处理（可能消息队列中有大量的消息，如果像平时一样挨个进行处理，那绘制界面这个消息就得等很久，这是不想看到的）。</p>
<p>屏障消息仅仅是起一个屏障的作用，本身一般不附带其他东西，它需要配合其他Handler组件才能发挥作用。  </p>
<p>1、Handler问题三连：是什么？有什么用？为什么要用，不用行不行？</p>
<p>2、Android UI更新机制(GUI) 为何设计成了单线程的？</p>
<p>3、真的只能在主(UI)线程中更新UI吗？</p>
<p>4、真的不能在主(UI)线程中执行网络操作吗？</p>
<p>6、为什么建议使用Message.obtain()来创建Message实例？</p>
<p>7、为什么子线程中不可以直接new Handler()而主线程中可以？</p>
<p>8、主线程给子线程的Handler发送消息怎么写？</p>
<p>9、HandlerThread实现的核心原理？</p>
<p>10、当你用Handler发送一个Message，发生了什么？</p>
<p>11、Looper是怎么拣队列里的消息的？</p>
<p>12、分发给Handler的消息是怎么处理的？</p>
<p>14、Looper在主线程中死循环，为啥不会ANR？</p>
<p>15、Handler泄露的原因及正确写法</p>
<p>16、Handler中的同步屏障机制</p>
<p>17、Android 11 Handler相关变更</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904150140977165">https://juejin.cn/post/6844904150140977165</a></p>
<p>handler post和handleMesage区别</p>
<p>​    <strong>post的runnable会直接在callback中调用run方法执行，而sendMessage方法要用户主动重写mCallback或者handleMessage方法来处理</strong></p>
<hr>
<p><img src="/2017/08/21/Handler/handler/2021-07-31_4.42_hanlder_qustion.png"></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1A7411M7zQ?from=search&amp;seid=14693797999095810218">https://www.bilibili.com/video/BV1A7411M7zQ?from=search&amp;seid=14693797999095810218</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/6844904150140977165">https://juejin.im/post/6844904150140977165</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/guolin_blog/article/details/9991569">http://blog.csdn.net/guolin_blog/article/details/9991569</a></p>
<p><a target="_blank" rel="noopener" href="https://xiaozhuanlan.com/topic/0843791256">https://xiaozhuanlan.com/topic/0843791256</a></p>
<p>glide handler </p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1FU4y1V7HE">https://www.bilibili.com/video/BV1FU4y1V7HE</a></p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000039809784">https://segmentfault.com/a/1190000039809784</a></p>

	
	</div>
  <a type="button" href="/2017/08/21/Handler/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/08/16/AnimationResource/" >AnimationResource</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-08-16  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/resources/animation-resource.html">https://developer.android.com/guide/topics/resources/animation-resource.html</a></p>
<p>Android动画简介,直接copy了</p>
<blockquote>
<p>The Android framework provides two animation systems: property animation and view animation. Both animation systems are viable options, but the property animation system, in general, is the preferred method to use, because it is more flexible and offers more features. In addition to these two systems, you can utilize Drawable animation, which allows you to load drawable resources and display them one frame after another.</p>
</blockquote>
<p>可以看出官方更推崇 Property Animiation,更灵活而且提供更多的功能,看下３种动画方式</p>
<ul>
<li><p>Drawable Animation (Frame动画，帧动画)</p>
<blockquote>
<p>Drawable animation involves displaying Drawable resources one after another, like a roll of film. This method of animation is useful if you want to animate things that are easier to represent with Drawable resources, such as a progression of bitmaps.</p>
</blockquote>
<p>通过人视觉的延迟，把图片一张连接一张，类似放电影</p>
</li>
<li><p>View Animation(Tween动画)</p>
<blockquote>
<p>View Animation is the older system and can only be used for Views. It is relatively easy to setup and offers enough capabilities to meet many application’s needs.</p>
</blockquote>
</li>
<li><p>Property Animation</p>
<blockquote>
<p>Introduced in Android 3.0 (API level 11), the property animation system lets you animate properties of any object, including ones that are not rendered to the screen. The system is extensible and lets you animate properties of custom types as well.</p>
</blockquote>
</li>
</ul>
<blockquote>
</blockquote>
<p>view动画示例:　文件位置放哪呢？　在官网确认了了位置</p>
<blockquote>
<p>The animation XML file belongs in the <strong>res/anim/</strong> directory of your Android project. The file must have a single root element: this will be either a single <alpha>, <scale>, <translate>, <rotate>, interpolator element, or <set> element that holds groups of these elements (which may include another <set>). By default, all animation instructions are applied simultaneously. To make them occur sequentially, you must specify the startOffset attribute, as shown in the example below.</set></set></rotate></translate></scale></alpha></p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">set</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:duration</span>=<span class="string">&quot;1000&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:fillAfter</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:interpolator</span>=<span class="string">&quot;@android:anim/accelerate_decelerate_interpolator&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:shareInterpolator</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 位置移动--&gt;</span></span><br><span class="line">    &lt;translate</span><br><span class="line">        android:fromXDelta=&quot;0.0&quot;</span><br><span class="line">        android:fromYDelta=&quot;0.0&quot;</span><br><span class="line">        android:toXDelta=&quot;500.0&quot;</span><br><span class="line">        android:toYDelta=&quot;500.0&quot; /&gt;</span><br><span class="line">    <span class="comment">&lt;!-- 放大或缩小 --&gt;</span></span><br><span class="line">    &lt;scale</span><br><span class="line">        android:fromXScale=&quot;0.0&quot;</span><br><span class="line">        android:fromYScale=&quot;0.0&quot;</span><br><span class="line">        android:pivotX=&quot;50%&quot;</span><br><span class="line">        android:pivotY=&quot;50%&quot;</span><br><span class="line">        android:toXScale=&quot;1.0&quot;</span><br><span class="line">        android:toYScale=&quot;1.0&quot; /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;rotate</span><br><span class="line">        android:fromDegrees=&quot;0.0&quot;</span><br><span class="line">        android:pivotX=&quot;50%&quot;</span><br><span class="line">        android:pivotY=&quot;50%&quot;</span><br><span class="line">        android:toDegrees=&quot;30.0&quot; /&gt;</span><br><span class="line">    &lt;alpha</span><br><span class="line">        android:fromAlpha=&quot;0.0&quot;</span><br><span class="line">        android:toAlpha=&quot;0.5&quot; /&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/BlogForMe/AndroidDemo/blob/master/lern/src/main/java/com/hyhy/lern/AnimationActivity.java">演示代码:</a><br>参考：<a target="_blank" rel="noopener" href="http://www.jianshu.com/p/b7aa2a4a9787">http://www.jianshu.com/p/b7aa2a4a9787</a><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/yanbober/article/details/46481171">http://blog.csdn.net/yanbober/article/details/46481171</a><br> 跑完代码后，点击动画结束后的图片，没反应，实际上按钮还是停留在屏幕左上角，只不过view动画把图片绘制到了新的位置。所以说　View动画是对View的影像做操作，它并不能改变View的位置参数</p>
<h1 id="Property-Animation"><a href="#Property-Animation" class="headerlink" title="Property Animation"></a>Property Animation</h1><p>　属性动画就是对　对象的属性进行实质的改变了，而不只是投影了，比如刚才的图片修改后是可以点击的</p>
<ul>
<li><p>　ValueAnimator: 通过不断的对值进行操作来实现的，初始值盒结束值之间的动画过渡就是由ValueAnimator来负责计算的，除此之外，还负责管理动画的播放次数，播放模式，以及监听等。</p>
<pre><code>  /**
   * 300 ms内,value值从0 平滑的过渡到了1
   */
</code></pre>
<p>//        ValueAnimator anim = ValueAnimator.ofFloat(0f, 1f);<br>//        anim.setDuration(300);</p>
<pre><code>  /**
   *  value值从0过渡到５，再到３最后到10的过程
   */
</code></pre>
<p>//        ValueAnimator anim = ValueAnimator.ofFloat(0f, 5f, 3f, 10f);</p>
<pre><code>  //整形数从 0到 100
  ValueAnimator anim = ValueAnimator.ofInt(0, 100);
  anim.setDuration(5000);
  anim.addUpdateListener(new ValueAnimator.AnimatorUpdateListener() &#123;
      @Override
      public void onAnimationUpdate(ValueAnimator valueAnimator) &#123;
          Object currentValue = valueAnimator.getAnimatedValue();
          Log.d(TAG, &quot; current value is &quot; + currentValue);
      &#125;
  &#125;);
  anim.start();
</code></pre>
</li>
<li><p>ObjectAnimator<br>ObjectAnimator继承ValueAnimator，它可以直接对任意对象的任意属性进行动画操作<br>演示示例
　　</p>
<pre><code>  /**
   * 透明:　５秒内从常规变换成全　透明,再从透明变成常规
   */
</code></pre>
<p>//        ObjectAnimator animator = ObjectAnimator.ofFloat(v, “alpha”, 1f, 0f, 1f);</p>
<pre><code>  /**
   *  旋转 : 对按钮进行旋转 360
   */
</code></pre>
<p>//        ObjectAnimator animator = ObjectAnimator.ofFloat(v, “rotation”, 0f, 360f);</p>
<pre><code>  /**
   * 位置移动: Button向左移动再回来
   */
</code></pre>
<p>//        float curTranslationX = v.getTranslationX(); //获取当前Button的translationX位置<br>//        ObjectAnimator animator = ObjectAnimator.ofFloat(v, “translationX”,<br>//                curTranslationX, -500f, curTranslationX); //传入translationX，后面３个参数告诉它怎么移动</p>
<pre><code>  /**
   * 缩放： 参数改为 scaleY,表示再垂直方向上放大３倍再还原
   */
  ObjectAnimator animator = ObjectAnimator.ofFloat(v, &quot;scaleY&quot;, 1f, 3f, 1f);
  animator.setDuration(5000);
  animator.start();
</code></pre>
<p>ObjectAnimator传入参数是根据Ｖiew的属性进行操作的，如setRotation()、getRotation()、setTranslationX()、getTranslationX()、setScaleY()、getScaleY()</p>
</li>
</ul>
<hr>
<p>＃ 组合动画 : 就是属性动画组合起来,借助AnimatorSet<br>　　微风吹着，飘来周传雄的音乐… 敲着键盘　人生不过如此～～</p>
<ul>
<li>after(Animator anim) : 现有动画放在传入动画之后执行</li>
<li>after(long　delay)   : 將现有动画延迟　“delay” 后执行</li>
<li>before(Animator anim) :参考楼上</li>
<li>with(Animator anim)  :　现有动画盒传入动画同时执行  </li>
</ul>
<p> 示例<br> 　　<br>    　　<br>      ObjectAnimator moveIn = ObjectAnimator.ofFloat(v, “translationX”, -500f, 0f);<br>        ObjectAnimator rotation = ObjectAnimator.ofFloat(v, “rotation”, 0f, 360f);<br>        ObjectAnimator fadeInOut = ObjectAnimator.ofFloat(v, “alpha”, 1f, 0f, 1f);<br>        AnimatorSet animSet = new AnimatorSet();<br>        animSet.play(rotation).with(fadeInOut).after(moveIn);<br>        animSet.setDuration(5000);<br>        animSet.addListener(new Animator.AnimatorListener() {<br>            @Override<br>            public void onAnimationStart(Animator animation) {<br>                Log.d(TAG, “  onAnimationStart “);<br>            }</p>
<pre><code>        @Override
        public void onAnimationEnd(Animator animation) &#123;
            Log.d(TAG, &quot;  onAnimationEnd &quot;);
        &#125;

        @Override
        public void onAnimationCancel(Animator animation) &#123;
            Log.d(TAG, &quot;  onAnimationCancel &quot;);
        &#125;

        @Override
        public void onAnimationRepeat(Animator animation) &#123;
            Log.d(TAG, &quot;  onAnimationRepeat &quot;);
        &#125;
    &#125;);
    animSet.start();
</code></pre>
<p>　　下面是监听器，也可以用AnimatorListenerAdapter 选择想要重写的方法</p>
<h1 id="XML支持的Property-Animation-tags"><a href="#XML支持的Property-Animation-tags" class="headerlink" title="XML支持的Property Animation　tags"></a>XML支持的Property Animation　tags</h1><ul>
<li>对应代码中的ValueAnimator - <animator></animator></li>
<li>ObjectAnimator -  <objectAnimator></objectAnimator></li>
<li>AnimatorSet   - <set></set></li>
</ul>
<p>这里也需要建个文件夹存放</p>
<blockquote>
<p>The property animation system lets you declare property animations with XML instead of doing it programmatically. By defining your animations in XML, you can easily reuse your animations in multiple activities and more easily edit the animation sequence.</p>
</blockquote>
<blockquote>
<p>To distinguish animation files that use the new property animation APIs from those that use the legacy view animation framework, starting with Android 3.1, you should save the XML files for property animations in the **res/animator/ **directory.</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">animator</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:valueFrom</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:valueTo</span>=<span class="string">&quot;100&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:valueType</span>=<span class="string">&quot;intType&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">加载</span><br><span class="line">Animator anim = AnimatorInflater.loadAnimator(this, R.animator.propery_first);</span><br><span class="line">        anim.setTarget(v);</span><br><span class="line">　       anim.start();</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>根据官方例子,也可以强转ValueAnimator，添加监听器,其他形式的xml文件也类似</p>
<ul>
<li><p>设置动画参数</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//</span> ValueAnimator采用&lt;animator&gt;  标签</span><br><span class="line">&lt;animator xmlns<span class="function">:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>  </span><br><span class="line">    android<span class="function">:valueFrom</span>=<span class="string">&quot;0&quot;</span>   <span class="string">//</span> 初始值</span><br><span class="line">    android<span class="function">:valueTo</span>=<span class="string">&quot;100&quot;</span>  <span class="string">//</span> 结束值</span><br><span class="line">    android<span class="function">:valueType</span>=<span class="string">&quot;intType&quot;</span> <span class="string">//</span> 变化值类型 ：floatType &amp; intType</span><br><span class="line"></span><br><span class="line">    android<span class="function">:duration</span>=<span class="string">&quot;3000&quot;</span> <span class="string">//</span> 动画持续时间（ms），必须设置，动画才有效果</span><br><span class="line">    android<span class="function">:startOffset</span> =<span class="string">&quot;1000&quot;</span> <span class="string">//</span> 动画延迟开始时间（ms）</span><br><span class="line">    android<span class="function">:fillBefore</span> = “<span class="literal">true</span>” <span class="string">//</span> 动画播放完后，视图是否会停留在动画开始的状态，默认为<span class="literal">true</span></span><br><span class="line">    android<span class="function">:fillAfter</span> = “<span class="literal">false</span>” <span class="string">//</span> 动画播放完后，视图是否会停留在动画结束的状态，优先于fillBefore值，默认为<span class="literal">false</span></span><br><span class="line">    android<span class="function">:fillEnabled</span>= “<span class="literal">true</span>” <span class="string">//</span> 是否应用fillBefore值，对fillAfter值无影响，默认为<span class="literal">true</span></span><br><span class="line">    android<span class="function">:repeatMode</span>= “restart” <span class="string">//</span> 选择重复播放动画模式，restart代表正序重放，reverse代表倒序回放，默认为restart|</span><br><span class="line">    android<span class="function">:repeatCount</span> = “0” <span class="string">//</span> 重放次数（所以动画的播放次数=重放次数+1），为infinite时无限重复</span><br><span class="line">    android<span class="function">:interpolator</span> = @[package:]anim/interpolator_resource <span class="string">//</span> 插值器，即影响动画的播放速度,下面会详细讲</span><br><span class="line"></span><br><span class="line">/&gt; </span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/carson_ho/article/details/72909894">https://blog.csdn.net/carson_ho/article/details/72909894</a> </p>
</li>
</ul>
<p>参考：<a target="_blank" rel="noopener" href="http://blog.csdn.net/guolin_blog/article/details/43536355">http://blog.csdn.net/guolin_blog/article/details/43536355</a></p>

	
	</div>
  <a type="button" href="/2017/08/16/AnimationResource/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/08/16/PerformancePatterns/" >PerformancePatterns</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-08-16  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p><a target="_blank" rel="noopener" href="https://developer.android.com/topic/performance/vitals">https://developer.android.com/topic/performance/vitals</a></p>
<h4 id="Vitals"><a href="#Vitals" class="headerlink" title="Vitals"></a>Vitals</h4><p>根据vitas提示确认解决方案</p>
<p><a target="_blank" rel="noopener" href="https://support.google.com/googleplay/android-developer/answer/9844486?visit_id=637902898856761718-3795427085&amp;rd=1&amp;hl=zh-Hans#zippy=">https://support.google.com/googleplay/android-developer/answer/9844486?visit_id=637902898856761718-3795427085&amp;rd=1&amp;hl=zh-Hans#zippy=</a></p>
<p><a target="_blank" rel="noopener" href="https://play.google.com/console/u/0/developers/5313279702199603526/app/4975846927718251228/vitals/metrics/overview?days=30">https://play.google.com/console/u/0/developers/5313279702199603526/app/4975846927718251228/vitals/metrics/overview?days=30</a></p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/playlist?list=PLWz5rJ2EKKc9CBxr3BVjPTPoDPLdPIFCE">https://www.youtube.com/playlist?list=PLWz5rJ2EKKc9CBxr3BVjPTPoDPLdPIFCE</a></p>
<h5 id="Vitals-vs-firebase"><a href="#Vitals-vs-firebase" class="headerlink" title="Vitals vs firebase"></a>Vitals vs firebase</h5><p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/distribute/best-practices/launch/debug-crashes?hl=zh-cn">https://developer.android.google.cn/distribute/best-practices/launch/debug-crashes?hl=zh-cn</a></p>
<h4 id="红橙"><a href="#红橙" class="headerlink" title="红橙"></a>红橙</h4><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/888d959683a4">https://www.jianshu.com/p/888d959683a4</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6950608825942868004">https://juejin.cn/post/6950608825942868004</a></p>
<p>图片处理</p>
<p><a target="_blank" rel="noopener" href="https://developer.android.com/topic/performance/graphics/index.html">https://developer.android.com/topic/performance/graphics/index.html</a><br><a target="_blank" rel="noopener" href="https://developer.android.com/topic/performance/graphics/load-bitmap.html#read-bitmap">https://developer.android.com/topic/performance/graphics/load-bitmap.html#read-bitmap</a></p>
<p>性能优化</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/ceXsH06fUFa7y4lzi4uXzw">https://mp.weixin.qq.com/s/ceXsH06fUFa7y4lzi4uXzw</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/xqrGukIqA2zpGsGzah2EzA">https://mp.weixin.qq.com/s/xqrGukIqA2zpGsGzah2EzA</a></p>
<p>包体积优化</p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/6854573210408189960">https://juejin.im/post/6854573210408189960</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/jnZpgaRFQT5ULk9tHWMAGg">https://mp.weixin.qq.com/s/jnZpgaRFQT5ULk9tHWMAGg</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/fba7b43bdc9c">https://www.jianshu.com/p/fba7b43bdc9c</a></p>
<h5 id="布局优化"><a href="#布局优化" class="headerlink" title="布局优化"></a>布局优化</h5><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/ee9e4b8cb95f">https://www.jianshu.com/p/ee9e4b8cb95f</a></p>
<h4 id="strict-mode"><a href="#strict-mode" class="headerlink" title="strict mode"></a>strict mode</h4><img src="/2017/08/16/PerformancePatterns/PerformanceMemory/strictmode-20220608103750.jpg" alt="strictmode-20220608103750" style="zoom: 25%;">



<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1wh411H78Z?p=7">https://www.bilibili.com/video/BV1wh411H78Z?p=7</a></p>
<p>Troubleshooting app performance issues with System Trace in Android Studio</p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=EjmIit_amnE">https://www.youtube.com/watch?v=EjmIit_amnE</a></p>
<h3 id="硬件加速原理"><a href="#硬件加速原理" class="headerlink" title="硬件加速原理"></a>硬件加速原理</h3><img src="/2017/08/16/PerformancePatterns/20220610102409.jpg" alt="20220610102409" style="zoom:50%;">

<p>相信经常看到有的文章说开启硬件加速解决卡的问题，但硬件加速是什么呢？</p>
<p>硬件加速的主要原理是通多底层逻辑，将CPU不擅长的图形计算转换成GPU专用指令，让更擅长图形计算的GPU来完成渲染。</p>
<p>硬件加速过程中包含两个步骤 ：</p>
<p>构建阶段 ： 遍历所有视图，将需要绘制的操作缓存下来，交给单独的Render线程使用GPU进行硬件加速渲染。(这一阶段在主线程中使用CPU构建)</p>
<p>绘制阶段 ： 调用OpenGL（即使用GPU）对构建好的视图进行绘制渲染，绘制的内容保存在Graphic Buffer 并交由  SurfaceFlinger 显示。(Android 5.0+ 使用Render Thread线程，专门负责 UI 渲染和动画显示。)</p>
<p>以上证得硬件加速具有不错的优点，但它不是万能的。</p>
<p>我们平时用的时候可能是直接在Application中用，一锅端，这并不严谨，因为硬件加速还没法做到支持所有的绘制操作（比如复杂的自定义View），这样的话就会造成一定的影响：</p>
<p>\1. 像素错位等视觉问题</p>
<p>\2. 不同设备版本API兼容问题</p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000041325538">https://segmentfault.com/a/1190000041325538</a></p>
<p>Apk瘦身</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_32175491/article/details/80071987">https://blog.csdn.net/qq_32175491/article/details/80071987</a></p>
<p>也有不建议删SO库的说法</p>
<p><a target="_blank" rel="noopener" href="http://kaedea.com/2016/06/04/android-dynamical-loading-04-so-problems/">http://kaedea.com/2016/06/04/android-dynamical-loading-04-so-problems/</a></p>
<h4 id="Code-Check"><a href="#Code-Check" class="headerlink" title="Code Check"></a>Code Check</h4><p>Code Review之前可以做的事情.</p>
<p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/studio/write/annotations">https://developer.android.google.cn/studio/write/annotations</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/cf1b97941856">https://www.jianshu.com/p/cf1b97941856</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/endv/p/12541442.html">https://www.cnblogs.com/endv/p/12541442.html</a></p>

	
	</div>
  <a type="button" href="/2017/08/16/PerformancePatterns/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2017/08/13/TouchEvent2/" >TouchEvent2</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2017-08-13  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p> <strong>Android touch Event</strong></p>
<p> 事件分发其实就是对MotionEvent事件得分发过程,当MotionEvet产生后，系统需要把这个事件传递给一个具体得View,而这个传递得过程就是分发过程</p>
<p>概述</p>
<p><strong>为什么会有事件分发机制?</strong></p>
<p>Android得View是树形结构，绘制得时候遍历子View,他们必定是会重合分布，那么当我<br>们点击得时候，是应该谁来响应这个事件呢? 然后才有事件分发</p>
<blockquote>
<p>Activity －&gt; PhoneWindow －&gt; DecorView －&gt; ViewGroup －&gt; … －&gt; View</p>
</blockquote>
<p>整个分发的宏观过程,<em>Android群英传</em>　这本书描述的很清晰,然后配合　Android开发艺术探索，的源码分析，简直天作之合．</p>
<p>主要方法</p>
<h4 id="method"><a href="#method" class="headerlink" title="method"></a>method</h4><p>事件分发机制事由　Activity -&gt; ViewGroup -&gt; View　方向上得传递<br>通过三个很重要得方法共同完成 dispatchTouchEvent、onInterceptTouchEvent、onTouchEvent</p>
<ul>
<li>dispatchTouchEvent()</li>
</ul>
<table>
<thead>
<tr>
<th>属性</th>
<th>介绍</th>
</tr>
</thead>
<tbody><tr>
<td>使用对象</td>
<td>Activity、ViewGroup、View</td>
</tr>
<tr>
<td>作用</td>
<td>事件分发</td>
</tr>
</tbody></table>
<ul>
<li>onInterceptTouchEvent()</li>
</ul>
<table>
<thead>
<tr>
<th>属性</th>
<th>介绍</th>
</tr>
</thead>
<tbody><tr>
<td>作用</td>
<td>拦截事件</td>
</tr>
<tr>
<td>调用时刻</td>
<td>在ViewGroup的dispatchTouchEvent()内部调用</td>
</tr>
</tbody></table>
<ul>
<li>onTouchEvent()</li>
</ul>
<table>
<thead>
<tr>
<th>属性</th>
<th>介绍</th>
</tr>
</thead>
<tbody><tr>
<td>使用对象</td>
<td>Activity、ViewGroup、View</td>
</tr>
<tr>
<td>作用</td>
<td>事件消费</td>
</tr>
<tr>
<td>调用时刻</td>
<td>在dispatchTouchEvent()内部调用</td>
</tr>
</tbody></table>
<p>三个方法的关系</p>
<p>  可以用 singwhatiwanna 写的伪代码表示:</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public boolean dispatch<span class="constructor">TouchEvent(MotionEvent <span class="params">ev</span>)</span>&#123;</span><br><span class="line">    boolean consume = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span>(on<span class="constructor">InterceptTouchEvent(<span class="params">ev</span>)</span>)&#123;</span><br><span class="line">        	consume = on<span class="constructor">TouchEvent(<span class="params">ev</span>)</span>;	    </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">     	 consume = child.dispatch<span class="constructor">TouchEvent(<span class="params">ev</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    return consume;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>  dispatchTouchEvent　：对于ViewGroup，点击事件产生后首先会传递给它，</li>
<li>  onInterceptTouchEvent(ev）: 如果方法返回true,则拦截事件,事件就交给当前ViewGroup处理,接着调用当前<br>　　　　ViewGroup的onTouchEvent.如果返回flase,就交给它的子元素,子元素的dispatchTouchEvent就会调用</li>
<li> onTouchEvent : 如果返回false，那么父容器的onTouchEvent将会被调用.</li>
</ul>
<h4 id="Activity-ViewGroup-View"><a href="#Activity-ViewGroup-View" class="headerlink" title="Activity ViewGroup View"></a>Activity ViewGroup View</h4><h5 id="source-code"><a href="#source-code" class="headerlink" title="source code"></a>source code</h5><ul>
<li><p>Activity</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public boolean dispatch<span class="constructor">TouchEvent(MotionEvent <span class="params">ev</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ev.get<span class="constructor">Action()</span><span class="operator"> == </span>MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">        on<span class="constructor">UserInteraction()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (get<span class="constructor">Window()</span>.super<span class="constructor">DispatchTouchEvent(<span class="params">ev</span>)</span>) &#123;</span><br><span class="line">        return <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    return on<span class="constructor">TouchEvent(<span class="params">ev</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>ViewGroup</p>
</li>
</ul>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mInputEventConsistencyVerifier.onTouchEvent(ev, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the event targets the accessibility focused view and this is it, start</span></span><br><span class="line">        <span class="comment">// normal event dispatch. Maybe a descendant is what will handle the click.</span></span><br><span class="line">        <span class="keyword">if</span> (ev.isTargetAccessibilityFocus() &amp;&amp; isAccessibilityFocusedViewOrHost()) &#123;</span><br><span class="line">            ev.setTargetAccessibilityFocus(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> handled = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (onFilterTouchEventForSecurity(ev)) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> action = ev.getAction();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> actionMasked = action &amp; MotionEvent.ACTION_MASK;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Handle an initial down.</span></span><br><span class="line">            <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">                <span class="comment">// Throw away all previous state when starting a new touch gesture.</span></span><br><span class="line">                <span class="comment">// The framework may have dropped the up or cancel event for the previous gesture</span></span><br><span class="line">                <span class="comment">// due to an app switch, ANR, or some other state change.</span></span><br><span class="line">                cancelAndClearTouchTargets(ev);</span><br><span class="line">                resetTouchState();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check for interception.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> intercepted;</span><br><span class="line">            <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class="line">                    || mFirstTouchTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (!disallowIntercept) &#123;</span><br><span class="line">                    intercepted = onInterceptTouchEvent(ev);</span><br><span class="line">                    ev.setAction(action); <span class="comment">// restore action in case it was changed</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    intercepted = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// There are no touch targets and this action is not an initial down</span></span><br><span class="line">                <span class="comment">// so this view group continues to intercept touches.</span></span><br><span class="line">                intercepted = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If intercepted, start normal event dispatch. Also if there is already</span></span><br><span class="line">            <span class="comment">// a view that is handling the gesture, do normal event dispatch.</span></span><br><span class="line">            <span class="keyword">if</span> (intercepted || mFirstTouchTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ev.setTargetAccessibilityFocus(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check for cancelation.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> canceled = resetCancelNextUpFlag(<span class="keyword">this</span>)</span><br><span class="line">                    || actionMasked == MotionEvent.ACTION_CANCEL;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Update list of touch targets for pointer down, if needed.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> split = (mGroupFlags &amp; FLAG_SPLIT_MOTION_EVENTS) != <span class="number">0</span>;</span><br><span class="line">            TouchTarget newTouchTarget = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">boolean</span> alreadyDispatchedToNewTouchTarget = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (!canceled &amp;&amp; !intercepted) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// If the event is targeting accessibility focus we give it to the</span></span><br><span class="line">                <span class="comment">// view that has accessibility focus and if it does not handle it</span></span><br><span class="line">                <span class="comment">// we clear the flag and dispatch the event to all children as usual.</span></span><br><span class="line">                <span class="comment">// We are looking up the accessibility focused host to avoid keeping</span></span><br><span class="line">                <span class="comment">// state since these events are very rare.</span></span><br><span class="line">                View childWithAccessibilityFocus = ev.isTargetAccessibilityFocus()</span><br><span class="line">                        ? findChildWithAccessibilityFocus() : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class="line">                        || (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN)</span><br><span class="line">                        || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> actionIndex = ev.getActionIndex(); <span class="comment">// always 0 for down</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> idBitsToAssign = split ? <span class="number">1</span> &lt;&lt; ev.getPointerId(actionIndex)</span><br><span class="line">                            : TouchTarget.ALL_POINTER_IDS;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Clean up earlier touch targets for this pointer id in case they</span></span><br><span class="line">                    <span class="comment">// have become out of sync.</span></span><br><span class="line">                    removePointersFromTouchTargets(idBitsToAssign);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> childrenCount = mChildrenCount;</span><br><span class="line">                    <span class="keyword">if</span> (newTouchTarget == <span class="keyword">null</span> &amp;&amp; childrenCount != <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(actionIndex);</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(actionIndex);</span><br><span class="line">                        <span class="comment">// Find a child that can receive the event.</span></span><br><span class="line">                        <span class="comment">// Scan children from front to back.</span></span><br><span class="line">                        <span class="keyword">final</span> ArrayList&lt;View&gt; preorderedList = buildTouchDispatchChildList();</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">boolean</span> customOrder = preorderedList == <span class="keyword">null</span></span><br><span class="line">                                &amp;&amp; isChildrenDrawingOrderEnabled();</span><br><span class="line">                        <span class="keyword">final</span> View[] children = mChildren;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = childrenCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                            <span class="keyword">final</span> <span class="keyword">int</span> childIndex = getAndVerifyPreorderedIndex(</span><br><span class="line">                                    childrenCount, i, customOrder);</span><br><span class="line">                            <span class="keyword">final</span> View child = getAndVerifyPreorderedView(</span><br><span class="line">                                    preorderedList, children, childIndex);</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// If there is a view that has accessibility focus we want it</span></span><br><span class="line">                            <span class="comment">// to get the event first and if not handled we will perform a</span></span><br><span class="line">                            <span class="comment">// normal dispatch. We may do a double iteration but this is</span></span><br><span class="line">                            <span class="comment">// safer given the timeframe.</span></span><br><span class="line">                            <span class="keyword">if</span> (childWithAccessibilityFocus != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (childWithAccessibilityFocus != child) &#123;</span><br><span class="line">                                    <span class="keyword">continue</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                childWithAccessibilityFocus = <span class="keyword">null</span>;</span><br><span class="line">                                i = childrenCount - <span class="number">1</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (!child.canReceivePointerEvents()</span><br><span class="line">                                    || !isTransformedTouchPointInView(x, y, child, <span class="keyword">null</span>)) &#123;</span><br><span class="line">                                ev.setTargetAccessibilityFocus(<span class="keyword">false</span>);</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            newTouchTarget = getTouchTarget(child);</span><br><span class="line">                            <span class="keyword">if</span> (newTouchTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// Child is already receiving touch within its bounds.</span></span><br><span class="line">                                <span class="comment">// Give it the new pointer in addition to the ones it is handling.</span></span><br><span class="line">                                newTouchTarget.pointerIdBits |= idBitsToAssign;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            resetCancelNextUpFlag(child);</span><br><span class="line">                            <span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, <span class="keyword">false</span>, child, idBitsToAssign)) &#123;</span><br><span class="line">                                <span class="comment">// Child wants to receive touch within its bounds.</span></span><br><span class="line">                                mLastTouchDownTime = ev.getDownTime();</span><br><span class="line">                                <span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    <span class="comment">// childIndex points into presorted list, find original index</span></span><br><span class="line">                                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; childrenCount; j++) &#123;</span><br><span class="line">                                        <span class="keyword">if</span> (children[childIndex] == mChildren[j]) &#123;</span><br><span class="line">                                            mLastTouchDownIndex = j;</span><br><span class="line">                                            <span class="keyword">break</span>;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    mLastTouchDownIndex = childIndex;</span><br><span class="line">                                &#125;</span><br><span class="line">                                mLastTouchDownX = ev.getX();</span><br><span class="line">                                mLastTouchDownY = ev.getY();</span><br><span class="line">                                newTouchTarget = addTouchTarget(child, idBitsToAssign);</span><br><span class="line">                                alreadyDispatchedToNewTouchTarget = <span class="keyword">true</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// The accessibility focus didn&#x27;t handle the event, so clear</span></span><br><span class="line">                            <span class="comment">// the flag and do a normal dispatch to all children.</span></span><br><span class="line">                            ev.setTargetAccessibilityFocus(<span class="keyword">false</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) preorderedList.clear();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (newTouchTarget == <span class="keyword">null</span> &amp;&amp; mFirstTouchTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// Did not find a child to receive the event.</span></span><br><span class="line">                        <span class="comment">// Assign the pointer to the least recently added target.</span></span><br><span class="line">                        newTouchTarget = mFirstTouchTarget;</span><br><span class="line">                        <span class="keyword">while</span> (newTouchTarget.next != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            newTouchTarget = newTouchTarget.next;</span><br><span class="line">                        &#125;</span><br><span class="line">                        newTouchTarget.pointerIdBits |= idBitsToAssign;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Dispatch to touch targets.</span></span><br><span class="line">            <span class="keyword">if</span> (mFirstTouchTarget == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// No touch targets so treat this as an ordinary view.</span></span><br><span class="line">                handled = dispatchTransformedTouchEvent(ev, canceled, <span class="keyword">null</span>,</span><br><span class="line">                        TouchTarget.ALL_POINTER_IDS);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Dispatch to touch targets, excluding the new touch target if we already</span></span><br><span class="line">                <span class="comment">// dispatched to it.  Cancel touch targets if necessary.</span></span><br><span class="line">                TouchTarget predecessor = <span class="keyword">null</span>;</span><br><span class="line">                TouchTarget <span class="keyword">target</span> = mFirstTouchTarget;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">target</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> TouchTarget next = <span class="keyword">target</span>.next;</span><br><span class="line">                    <span class="keyword">if</span> (alreadyDispatchedToNewTouchTarget &amp;&amp; <span class="keyword">target</span> == newTouchTarget) &#123;</span><br><span class="line">                        handled = <span class="keyword">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">boolean</span> cancelChild = resetCancelNextUpFlag(<span class="keyword">target</span>.child)</span><br><span class="line">                                || intercepted;</span><br><span class="line">                        <span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, cancelChild,</span><br><span class="line">                                <span class="keyword">target</span>.child, <span class="keyword">target</span>.pointerIdBits)) &#123;</span><br><span class="line">                            handled = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (cancelChild) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (predecessor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                mFirstTouchTarget = next;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                predecessor.next = next;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">target</span>.recycle();</span><br><span class="line">                            <span class="keyword">target</span> = next;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    predecessor = <span class="keyword">target</span>;</span><br><span class="line">                    <span class="keyword">target</span> = next;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Update list of touch targets for pointer up or cancel, if needed.</span></span><br><span class="line">            <span class="keyword">if</span> (canceled</span><br><span class="line">                    || actionMasked == MotionEvent.ACTION_UP</span><br><span class="line">                    || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</span><br><span class="line">                resetTouchState();</span><br><span class="line">            &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_UP)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> actionIndex = ev.getActionIndex();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> idBitsToRemove = <span class="number">1</span> &lt;&lt; ev.getPointerId(actionIndex);</span><br><span class="line">                removePointersFromTouchTargets(idBitsToRemove);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!handled &amp;&amp; mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mInputEventConsistencyVerifier.onUnhandledEvent(ev, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> handled;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>View</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">public boolean dispatch<span class="constructor">TouchEvent(MotionEvent <span class="params">event</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// If the event should be handled by accessibility focus first.</span></span><br><span class="line">    <span class="keyword">if</span> (event.is<span class="constructor">TargetAccessibilityFocus()</span>) &#123;</span><br><span class="line">        <span class="comment">// We don&#x27;t have focus or no virtual descendant has it, do not handle the event.</span></span><br><span class="line">        <span class="keyword">if</span> (!is<span class="constructor">AccessibilityFocusedViewOrHost()</span>) &#123;</span><br><span class="line">            return <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// We have focus and got the event, then use normal event dispatch.</span></span><br><span class="line">        event.set<span class="constructor">TargetAccessibilityFocus(<span class="params">false</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    boolean result = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mInputEventConsistencyVerifier != null) &#123;</span><br><span class="line">        mInputEventConsistencyVerifier.on<span class="constructor">TouchEvent(<span class="params">event</span>, 0)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final <span class="built_in">int</span> actionMasked = event.get<span class="constructor">ActionMasked()</span>;</span><br><span class="line">    <span class="keyword">if</span> (actionMasked<span class="operator"> == </span>MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">        <span class="comment">// Defensive cleanup for new gesture</span></span><br><span class="line">        stop<span class="constructor">NestedScroll()</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (on<span class="constructor">FilterTouchEventForSecurity(<span class="params">event</span>)</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((mViewFlags &amp; ENABLED_MASK)<span class="operator"> == </span>ENABLED<span class="operator"> &amp;&amp; </span>handle<span class="constructor">ScrollBarDragging(<span class="params">event</span>)</span>) &#123;</span><br><span class="line">            result = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//noinspection SimplifiableIfStatement</span></span><br><span class="line">        ListenerInfo li = mListenerInfo;</span><br><span class="line">        <span class="keyword">if</span> (li != null<span class="operator"> &amp;&amp; </span>li.mOnTouchListener != null</span><br><span class="line"><span class="operator">                &amp;&amp; </span>(mViewFlags &amp; ENABLED_MASK)<span class="operator"> == </span>ENABLED</span><br><span class="line"><span class="operator">                &amp;&amp; </span>li.mOnTouchListener.on<span class="constructor">Touch(<span class="params">this</span>, <span class="params">event</span>)</span>) &#123;</span><br><span class="line">            result = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!result<span class="operator"> &amp;&amp; </span>on<span class="constructor">TouchEvent(<span class="params">event</span>)</span>) &#123;</span><br><span class="line">            result = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!result<span class="operator"> &amp;&amp; </span>mInputEventConsistencyVerifier != null) &#123;</span><br><span class="line">        mInputEventConsistencyVerifier.on<span class="constructor">UnhandledEvent(<span class="params">event</span>, 0)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clean up after nested scrolls if this is the end of a gesture;</span></span><br><span class="line">    <span class="comment">// also cancel it if we tried an ACTION_DOWN but we didn&#x27;t want the rest</span></span><br><span class="line">    <span class="comment">// of the gesture.</span></span><br><span class="line">    <span class="keyword">if</span> (actionMasked<span class="operator"> == </span>MotionEvent.ACTION_UP <span class="pattern-match"><span class="operator">||</span></span></span><br><span class="line"><span class="pattern-match">            action<span class="constructor">Masked</span> <span class="operator">==</span> <span class="constructor">MotionEvent</span>.<span class="constructor">ACTION_CANCEL</span> <span class="operator">||</span></span></span><br><span class="line"><span class="pattern-match">            (action<span class="constructor">Masked</span> <span class="operator">==</span> <span class="constructor">MotionEvent</span>.<span class="constructor">ACTION_DOWN</span> <span class="operator">&amp;&amp;</span> !result)) &#123;</span></span><br><span class="line"><span class="pattern-match">        stop<span class="constructor">NestedScroll()</span>;</span></span><br><span class="line"><span class="pattern-match">    &#125;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">    return result;</span></span><br><span class="line"><span class="pattern-match">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="图ACTION-DOWN分析"><a href="#图ACTION-DOWN分析" class="headerlink" title="图ACTION_DOWN分析"></a>图ACTION_DOWN分析</h5><p>1.MotionEvent.ACTION_DOWN 都不拦截    </p>
<p> Activity              dispatchTouchEvent()    1 =&gt; 5</p>
<p> RootView       dispatchTouchEvent()    29 =&gt;     (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT)==0</p>
<p>​                            =&gt; 33 =&gt; 58 =&gt; 68 =&gt; 122 =&gt;    dispatchTransformedTouchEvent有子view重复上面流程  =&gt; dispatchTransformedTouchEvent没有子View =&gt;</p>
<p>View1                    dispatchTouchEvent() 36 =&gt; 54 result=false =&gt;事件开始往回传=&gt;</p>
<p>ViewGroupA        122=&gt;163=&gt; 164 dispatchTransformedTouchEvent child传null =&gt;开始调用View dispatchTouchEvent()=false =&gt;  事件继续回传=&gt; </p>
<p>RootView            =&gt;重复上面ViewGroupA的流程 =&gt; 164 handled=false =&gt;</p>
<p>Activity                    =&gt;5  getWindow().superDispatchTouchEvent(ev)   =&gt; onTouchEvent(ev);</p>
<h5 id="图ACTION-MOVE-UP分析-RootView-onInterceptTouchEvent-true"><a href="#图ACTION-MOVE-UP分析-RootView-onInterceptTouchEvent-true" class="headerlink" title="图ACTION_MOVE UP分析 RootView  onInterceptTouchEvent =true"></a>图ACTION_MOVE UP分析 RootView  onInterceptTouchEvent =true</h5><p> Activity              dispatchTouchEvent()    1 =&gt; 5</p>
<p> RootView       dispatchTouchEvent()    29 =&gt;     (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT)==0 =&gt; 164 &gt;handler = false =&gt;</p>
<p> Activity                    =&gt;5  getWindow().superDispatchTouchEvent(ev)   =&gt; onTouchEvent(ev);</p>
<h5 id="图ACTION-MOVE-UP分析-View-touchevent-true"><a href="#图ACTION-MOVE-UP分析-View-touchevent-true" class="headerlink" title="图ACTION_MOVE UP分析 View touchevent = true"></a>图ACTION_MOVE UP分析 View touchevent = true</h5><p> Activity              dispatchTouchEvent()    1 =&gt; 5</p>
<p> RootView       dispatchTouchEvent()    29 =&gt;    41 =&gt; 170 =&gt; 183 遍历查找消费event的View =&gt; handled = true</p>
<p> Activity                    =&gt;5  getWindow().superDispatchTouchEvent(ev)   =&gt; onTouchEvent(ev);</p>
<h2 id="View点击事件处理-不是ViewGroup"><a href="#View点击事件处理-不是ViewGroup" class="headerlink" title="View点击事件处理(不是ViewGroup)"></a>View点击事件处理(不是ViewGroup)</h2><ul>
<li>  onTouch返回false</li>
</ul>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">button2.set<span class="constructor">OnTouchListener(<span class="params">new</span> View.OnTouchListener()</span> &#123;</span><br><span class="line">      @Override</span><br><span class="line">      public boolean on<span class="constructor">Touch(View <span class="params">v</span>, MotionEvent <span class="params">event</span>)</span> &#123;</span><br><span class="line">          <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>d(TAG, <span class="string">&quot;执行 button2 onTouch() 动作&quot;</span> + event.get<span class="constructor">Action()</span>);</span><br><span class="line">          return <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  button2.set<span class="constructor">OnClickListener(<span class="params">new</span> View.OnClickListener()</span> &#123;</span><br><span class="line">      @Override</span><br><span class="line">      public void on<span class="constructor">Click(View <span class="params">v</span>)</span> &#123;</span><br><span class="line">          <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>d(TAG, <span class="string">&quot;you clicked button2&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>打印结果:</p>
<blockquote>
<p>D/DispatchActivity: 执行 button2 onTouch() 动作0<br> D/DispatchActivity: 执行 button2 onTouch() 动作1<br> D/DispatchActivity: you clicked button2</p>
</blockquote>
<ul>
<li>onTouch返回true<br>Log打印结果:<blockquote>
<p>D/DispatchActivity: 执行 button2 onTouch() 动作0<br>D/DispatchActivity: 执行 button2 onTouch() 动作1</p>
</blockquote>
</li>
</ul>
<p>不同得返回值,得到不同得结果　看下为什么<br>看下　View的dispatchTouchEvent（）　API  23 源码的事件分发流程<br>点击 Button寻找dispatchTouchEvent() <code>Button -&gt; dispatchTouchEvent() -&gt;  TextView-&gt;View </code><br> (点击Button后就会找 dispatchTouchEvent()，Button没有，然后就去父类TextView还是没找到，最后在View找到了)</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Pass the touch screen motion event down to the target view, or this</span></span><br><span class="line"><span class="comment">   * view if it is the target.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @param event The motion event to be dispatched.</span></span><br><span class="line"><span class="comment">   * @return True if the event was handled by the view, false otherwise.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  public boolean dispatch<span class="constructor">TouchEvent(MotionEvent <span class="params">event</span>)</span> &#123;</span><br><span class="line">      <span class="comment">// If the event should be handled by accessibility focus first.</span></span><br><span class="line">      <span class="keyword">if</span> (event.is<span class="constructor">TargetAccessibilityFocus()</span>) &#123;</span><br><span class="line">          <span class="comment">// We don&#x27;t have focus or no virtual descendant has it, do not handle the event.</span></span><br><span class="line">          <span class="keyword">if</span> (!is<span class="constructor">AccessibilityFocusedViewOrHost()</span>) &#123;</span><br><span class="line">              return <span class="literal">false</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// We have focus and got the event, then use normal event dispatch.</span></span><br><span class="line">          event.set<span class="constructor">TargetAccessibilityFocus(<span class="params">false</span>)</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      boolean result = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (mInputEventConsistencyVerifier != null) &#123;</span><br><span class="line">          mInputEventConsistencyVerifier.on<span class="constructor">TouchEvent(<span class="params">event</span>, 0)</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      final <span class="built_in">int</span> actionMasked = event.get<span class="constructor">ActionMasked()</span>;</span><br><span class="line">      <span class="keyword">if</span> (actionMasked<span class="operator"> == </span>MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">          <span class="comment">// Defensive cleanup for new gesture</span></span><br><span class="line">          stop<span class="constructor">NestedScroll()</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (on<span class="constructor">FilterTouchEventForSecurity(<span class="params">event</span>)</span>) &#123;</span><br><span class="line">          <span class="comment">//noinspection SimplifiableIfStatement</span></span><br><span class="line">          ListenerInfo li = mListenerInfo;</span><br><span class="line">          <span class="keyword">if</span> (li != null<span class="operator"> &amp;&amp; </span>li.mOnTouchListener != null</span><br><span class="line"><span class="operator">                  &amp;&amp; </span>(mViewFlags &amp; ENABLED_MASK)<span class="operator"> == </span>ENABLED</span><br><span class="line"><span class="operator">                  &amp;&amp; </span>li.mOnTouchListener.on<span class="constructor">Touch(<span class="params">this</span>, <span class="params">event</span>)</span>) &#123;</span><br><span class="line">              result = <span class="literal">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (!result<span class="operator"> &amp;&amp; </span>on<span class="constructor">TouchEvent(<span class="params">event</span>)</span>) &#123;</span><br><span class="line">              result = <span class="literal">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!result<span class="operator"> &amp;&amp; </span>mInputEventConsistencyVerifier != null) &#123;</span><br><span class="line">          mInputEventConsistencyVerifier.on<span class="constructor">UnhandledEvent(<span class="params">event</span>, 0)</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Clean up after nested scrolls if this is the end of a gesture;</span></span><br><span class="line">      <span class="comment">// also cancel it if we tried an ACTION_DOWN but we didn&#x27;t want the rest</span></span><br><span class="line">      <span class="comment">// of the gesture.</span></span><br><span class="line">      <span class="keyword">if</span> (actionMasked<span class="operator"> == </span>MotionEvent.ACTION_UP <span class="pattern-match"><span class="operator">||</span></span></span><br><span class="line"><span class="pattern-match">              action<span class="constructor">Masked</span> <span class="operator">==</span> <span class="constructor">MotionEvent</span>.<span class="constructor">ACTION_CANCEL</span> <span class="operator">||</span></span></span><br><span class="line"><span class="pattern-match">              (action<span class="constructor">Masked</span> <span class="operator">==</span> <span class="constructor">MotionEvent</span>.<span class="constructor">ACTION_DOWN</span> <span class="operator">&amp;&amp;</span> !result)) &#123;</span></span><br><span class="line"><span class="pattern-match">          stop<span class="constructor">NestedScroll()</span>;</span></span><br><span class="line"><span class="pattern-match">      &#125;</span></span><br><span class="line"><span class="pattern-match"></span></span><br><span class="line"><span class="pattern-match">      return result;</span></span><br><span class="line"><span class="pattern-match">  &#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>分析<br>第34行,result默认为false,li.mOnTouchListener.onTouch(this, event))默认也是false,接着<br>第40行,onTouchEvent(event)) 方法也会得到执行 -&gt;  performClick()会给点击事件  一个回调;</li>
</ul>
<p><strong>以下内容参考</strong>: <a target="_blank" rel="noopener" href="http://www.gcssloop.com/customview/dispatch-touchevent-theory">gcssloop</a><br>ViewGroup的　<a target="_blank" rel="noopener" href="http://wangkuiwu.github.io/2015/01/04/TouchEvent-ViewGroup/">dispatchTouchEvent()解析</a><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/guolin_blog/article/details/9097463">http://blog.csdn.net/guolin_blog/article/details/9097463</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/KU32XpwDFBOl8ueXIaA8Tw">https://mp.weixin.qq.com/s/KU32XpwDFBOl8ueXIaA8Tw</a></p>

	
	</div>
  <a type="button" href="/2017/08/13/TouchEvent2/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">

   
    
     <a href="/page/19/" type="button" class="btn btn-default"><i class="fa fa-arrow-circle-o-left"></i> Prev</a>
      

        <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
 
       <a href="/page/21/" type="button" class="btn btn-default ">Next<i class="fa fa-arrow-circle-o-right"></i></a>     
        

  
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categories</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/ANDROID/">ANDROID<span>58</span></a></li>
		
			<li><a href="/categories/BLE/">BLE<span>4</span></a></li>
		
			<li><a href="/categories/DataStructure/">DataStructure<span>16</span></a></li>
		
			<li><a href="/categories/DesignPatterns/">DesignPatterns<span>9</span></a></li>
		
			<li><a href="/categories/ENGLISH/">ENGLISH<span>1</span></a></li>
		
			<li><a href="/categories/JAVA/">JAVA<span>27</span></a></li>
		
			<li><a href="/categories/Jetpack/">Jetpack<span>5</span></a></li>
		
			<li><a href="/categories/Kotlin/">Kotlin<span>11</span></a></li>
		
			<li><a href="/categories/LINUX/">LINUX<span>5</span></a></li>
		
			<li><a href="/categories/Mathematics/">Mathematics<span>1</span></a></li>
		
			<li><a href="/categories/OS/">OS<span>2</span></a></li>
		
			<li><a href="/categories/Organization/">Organization<span>2</span></a></li>
		
			<li><a href="/categories/SOURCE/">SOURCE<span>1</span></a></li>
		
			<li><a href="/categories/TEST/">TEST<span>4</span></a></li>
		
			<li><a href="/categories/TOOL/">TOOL<span>11</span></a></li>
		
			<li><a href="/categories/VIEW/">VIEW<span>12</span></a></li>
		
			<li><a href="/categories/anim/">anim<span>4</span></a></li>
		
			<li><a href="/categories/flutter/">flutter<span>5</span></a></li>
		
		</ul>
	</div>

		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/proguard/">proguard<span>1</span></a></li>
		
			<li><a href="/tags/Activity/">Activity<span>1</span></a></li>
		
			<li><a href="/tags/Test/">Test<span>4</span></a></li>
		
			<li><a href="/tags/DB/">DB<span>2</span></a></li>
		
			<li><a href="/tags/RxJava/">RxJava<span>4</span></a></li>
		
			<li><a href="/tags/coroutie/">coroutie<span>7</span></a></li>
		
			<li><a href="/tags/Git/">Git<span>2</span></a></li>
		
			<li><a href="/tags/AOSP/">AOSP<span>7</span></a></li>
		
			<li><a href="/tags/keyboard/">keyboard<span>1</span></a></li>
		
			<li><a href="/tags/ConstraintLayout/">ConstraintLayout<span>1</span></a></li>
		
			<li><a href="/tags/XML/">XML<span>1</span></a></li>
		
			<li><a href="/tags/TouchEvent/">TouchEvent<span>3</span></a></li>
		
			<li><a href="/tags/VIEW/">VIEW<span>2</span></a></li>
		
			<li><a href="/tags/compose/">compose<span>2</span></a></li>
		
			<li><a href="/tags/JVM/">JVM<span>8</span></a></li>
		
			<li><a href="/tags/TOOL/">TOOL<span>2</span></a></li>
		
			<li><a href="/tags/inter/">inter<span>8</span></a></li>
		
			<li><a href="/tags/concurrency/">concurrency<span>4</span></a></li>
		
			<li><a href="/tags/anim/">anim<span>1</span></a></li>
		
			<li><a href="/tags/TabLayout/">TabLayout<span>1</span></a></li>
		
		
		   <li><a href="/tags">...<span>31</span></a></li>
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2023/09/04/Android_interview organize/" ><i class="fa fa-file-o"></i>Android_itnerview_organize</a>
      </li>
    
      <li>
        <a href="/2023/09/03/Android-itnerview-algorithm/" ><i class="fa fa-file-o"></i>Android_itnerview_algorithm</a>
      </li>
    
      <li>
        <a href="/2023/08/20/compose-layout/" ><i class="fa fa-file-o"></i>compose_layout</a>
      </li>
    
      <li>
        <a href="/2023/08/19/compose/" ><i class="fa fa-file-o"></i>compose</a>
      </li>
    
      <li>
        <a href="/2023/08/09/LC-DP-BAG/" ><i class="fa fa-file-o"></i>LC_DP_BAG</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="false"></i><a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" title="" target="_blank"]);">hexo-theme-bithack</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2023 Jon's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



</body>
   </html>
