<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Jon&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Jon&#039;s Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Jon&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Jon&#039;s Blog"><meta property="og:url" content="https://noteforme.github.io/"><meta property="og:site_name" content="Jon&#039;s Blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://noteforme.github.io/img/og_image.png"><meta property="article:author" content="Jon"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://noteforme.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://noteforme.github.io"},"headline":"Jon's Blog","image":["https://noteforme.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Jon"},"publisher":{"@type":"Organization","name":"Jon's Blog","logo":{"@type":"ImageObject","url":"https://noteforme.github.io/img/logo.svg"}},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Jon&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-04-18T14:19:42.000Z" title="4/18/2020, 10:19:42 PM">2020-04-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-07-16T15:07:08.240Z" title="7/16/2022, 11:07:08 PM">2022-07-16</time></span><span class="level-item"><a class="link-muted" href="/categories/JAVA/">JAVA</a></span><span class="level-item">a few seconds read (About 106 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/04/18/JVM/">JVM</a></p><div class="content"><p><a href="https://noteforme.github.io/2020/01/04/JVM-METHOD/">JVM方法区-第六章</a></p>
<img src="/2020/04/18/JVM/2020-04-16_8.22.33.png" alt="2020-04-16_8.22.33" style="zoom:50%;">



<p><img src="/2020/04/18/JVM/2020-04-16_8.29.39.png" alt="2020-04-16_8.29.39"></p>
<p><img src="/2020/04/18/JVM/2020-04-16_8.41.39.png" alt="2020-04-16_8.41.39"></p>
<p><img src="/2020/04/18/JVM/2020-04-16_8.43.41.png" alt="2020-04-16_8.43.41"></p>
<p><a target="_blank" rel="noopener" href="https://www.iteye.com/blog/rednaxelafx-656951">https://www.iteye.com/blog/rednaxelafx-656951</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/av75247289?p=2">https://www.bilibili.com/video/av75247289?p=2</a></p>
<p>这种情况全局变量 b: B是否会造成内存泄漏</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">val</span> b = B.getInstance()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> b = B()</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">getInstance</span><span class="params">()</span></span>: B &#123;</span><br><span class="line">            <span class="keyword">return</span> b</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我觉得不会,B 并不指向A</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1GA4y197VR?spm_id_from=333.337.search-card.all.click&amp;vd_source=d4c5260002405798a57476b318eccac9">https://www.bilibili.com/video/BV1GA4y197VR?spm_id_from=333.337.search-card.all.click&amp;vd_source=d4c5260002405798a57476b318eccac9</a></p>
<p>mOpenEnv  加</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-04-11T08:35:50.000Z" title="4/11/2020, 4:35:50 PM">2020-04-11</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-01-23T14:37:49.945Z" title="1/23/2024, 10:37:49 PM">2024-01-23</time></span><span class="level-item"><a class="link-muted" href="/categories/TOOL/">TOOL</a></span><span class="level-item">3 minutes read (About 376 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/04/11/tool-mac/">tool_mac</a></p><div class="content"><h5 id="JDK环境变量"><a href="#JDK环境变量" class="headerlink" title="JDK环境变量"></a>JDK环境变量</h5><h5 id="adb-环境变量"><a href="#adb-环境变量" class="headerlink" title="adb 环境变量"></a>adb 环境变量</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs routeros">sudo touch ~/.zshrc<br>sudo vi ~/.zshrc<br><br>复制<br><br><span class="hljs-built_in">export</span> <span class="hljs-attribute">ANDROID_HOME</span>=/Users/m/Library/Android/sdk<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">PATH</span>=<span class="hljs-variable">$ANDROID_HOME</span>/platform-tools:$PATH<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">PATH</span>=<span class="hljs-variable">$ANDROID_HOME</span>/tools:$PATH<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">PATH</span>=<span class="hljs-variable">$ANDROID_HOME</span>/tools/bin:$PATH<br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://dev.to/ravics09/solution-of-command-not-found-adb-error-29e7">https://dev.to/ravics09/solution-of-command-not-found-adb-error-29e7</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/10/install/installation-jdk-and-jre-macos.htm#JSJIG-GUID-F575EB4A-70D3-4AB4-A20E-DBE95171AB5F">Installation of the JDK and the JRE on macOS</a></p>
<p>Mac系统的环境变量，加载顺序为：<br>/etc/profile /etc/paths ~/.bash_profile ~/.bash_login ~/.profile ~/.bashrc</p>
<h5 id="IntelliJ-idea-clion"><a href="#IntelliJ-idea-clion" class="headerlink" title="IntelliJ idea clion"></a>IntelliJ idea clion</h5><p>clion激活: CLion-2019.2.5.dmg 下载完成后,先使用再打开,jetbrains-agent-20200227.zip直接拖入就好了。</p>
<p>some tool for mac</p>
<p>查看当前环境变量 : env</p>
<h5 id="Packet-Sender"><a href="#Packet-Sender" class="headerlink" title="Packet Sender"></a>Packet Sender</h5><p>tcp ip tool</p>
<img src="/2020/04/11/tool-mac//Screen Shot 2020-04-11 at 4.40.59 PM.png" alt="Screen Shot 2020-04-11 at 4.40.59 PM" style="zoom:67%;">

<h5 id="HomeBrew安装"><a href="#HomeBrew安装" class="headerlink" title="HomeBrew安装"></a>HomeBrew安装</h5><ol>
<li>下载</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/Homebrew/install/master/install.sh">https://raw.githubusercontent.com/Homebrew/install/master/install.sh</a></p>
<ol start="2">
<li><p>更换源</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs abnf">BREW_REPO<span class="hljs-operator">=</span><span class="hljs-string">&quot;https://github.com/Homebrew/brew&quot;</span><br>   换成  <br>BREW_REPO<span class="hljs-operator">=</span><span class="hljs-string">&quot;git://mirrors.ustc.edu.cn/brew.git&quot;</span> <br></code></pre></td></tr></table></figure></li>
<li><p>权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> 755 install.sh <br>./install.sh <br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43635647/article/details/104249968">https://blog.csdn.net/weixin_43635647/article/details/104249968</a></p>
</li>
</ol>
<h5 id="set-environment-variable-mac"><a href="#set-environment-variable-mac" class="headerlink" title="set environment variable mac"></a>set environment variable mac</h5><ol>
<li>Flutter<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">vi ~/.bash_profile<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-string">&quot;<span class="hljs-variable">$PATH</span>:/Users/john/development/flutter/bin&quot;</span><br><br><span class="hljs-built_in">which</span> flutter<br></code></pre></td></tr></table></figure></li>
</ol>
<h5 id="mac-terminal"><a href="#mac-terminal" class="headerlink" title="mac terminal"></a>mac terminal</h5><ol>
<li><p>download and install iterm2</p>
</li>
<li><p>Download iterm2-finder-tools-1.0.0  open Open iTerm.workflow install</p>
</li>
<li><p>file top 右键 customize toolbar then move opem iTerm into toolbar</p>
</li>
<li><p>Ignore</p>
<p><code>Command + Shift + .</code></p>
</li>
<li><p>Environment set</p>
<p>AppledeMacBook-Pro:~ apple$ cat ~/.bash_profile</p>
<p>export PATH=”$PATH:/Users/john/development/flutter/bin”</p>
<p>export PUB_HOSTED_URL=<a target="_blank" rel="noopener" href="https://pub.flutter-io.cn/">https://pub.flutter-io.cn</a></p>
<p>export FLUTTER_STORAGE_BASE_URL=<a target="_blank" rel="noopener" href="https://storage.flutter-io.cn/">https://storage.flutter-io.cn</a> </p>
</li>
</ol>
<h5 id="gradle-阿里云镜像"><a href="#gradle-阿里云镜像" class="headerlink" title="gradle 阿里云镜像"></a>gradle 阿里云镜像</h5><p>/Users/john/.gradle 目录添加 init.gradle</p>
<h5 id="鼠须管默认简繁体"><a href="#鼠须管默认简繁体" class="headerlink" title="鼠须管默认简繁体"></a>鼠须管默认简繁体</h5><p>control 加上 ~ 快捷键</p>
<h5 id="屏幕录制"><a href="#屏幕录制" class="headerlink" title="屏幕录制"></a>屏幕录制</h5><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43428139/article/details/109038098">https://blog.csdn.net/qq_43428139/article/details/109038098</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hi3254014978/p/15084851.html#:~:text=%E8%A7%A3%E5%86%B3Mac%E7%AC%94%E8%AE%B0%E6%9C%AC%E7%94%B5%E8%84%91%E8%87%AA%E5%B8%A6%E5%BD%95%E5%B1%8F%E8%BD%AF%E4%B">https://www.cnblogs.com/hi3254014978/p/15084851.html#:~:text=%E8%A7%A3%E5%86%B3Mac%E7%AC%94%E8%AE%B0%E6%9C%AC%E7%94%B5%E8%84%91%E8%87%AA%E5%B8%A6%E5%BD%95%E5%B1%8F%E8%BD%AF%E4%B</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-04-05T02:37:04.000Z" title="4/5/2020, 10:37:04 AM">2020-04-05</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-04-28T13:56:27.518Z" title="4/28/2024, 9:56:27 PM">2024-04-28</time></span><span class="level-item"><a class="link-muted" href="/categories/Kotlin/">Kotlin</a></span><span class="level-item">2 minutes read (About 273 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/04/05/Corouties/">Corouties</a></p><div class="content"><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6953441828100112392">https://juejin.cn/post/6953441828100112392</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/joy99/p/15805916.html">https://www.cnblogs.com/joy99/p/15805916.html</a></p>
<p><img src="/2020/04/05/Corouties//2022-03-20_5.39.31.png" alt="2022-03-20_5.39.31"></p>
<p><img src="/2020/04/05/Corouties//2022-03-20_5.39.55.png" alt="2022-03-20_5.39.55"></p>
<h4 id="协程启动模式"><a href="#协程启动模式" class="headerlink" title="协程启动模式"></a>协程启动模式</h4><p><img src="/2020/04/05/Corouties//20220529215120.jpg" alt="20220529215120"></p>
<p>DEFAULT</p>
<p><a target="_blank" rel="noopener" href="https://codelabs.developers.google.com/codelabs/kotlin-coroutines/#1">https://codelabs.developers.google.com/codelabs/kotlin-coroutines/#1</a></p>
<h5 id="Dispatchers"><a href="#Dispatchers" class="headerlink" title="Dispatchers"></a>Dispatchers</h5><p>By default, Kotlin coroutines provides three Dispatchers: <a target="_blank" rel="noopener" href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-dispatchers/-main.html"><code>Main</code></a>, <a target="_blank" rel="noopener" href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-dispatchers/-i-o.html"><code>IO</code></a>, and <a target="_blank" rel="noopener" href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-dispatchers/-default.html"><code>Default</code></a>. </p>
<p>The IO dispatcher is optimized for IO work like reading from the network or disk,</p>
<p> while the Default dispatcher is optimized for CPU intensive tasks.</p>
<h1 id="runBlocking-vs-CoroutineScope"><a href="#runBlocking-vs-CoroutineScope" class="headerlink" title="runBlocking vs CoroutineScope"></a>runBlocking vs CoroutineScope</h1><p>runBlocking is also a coroutine builder that bridges the non-coroutine world of a regular fun main() and the code with coroutines inside of runBlocking { … } curly braces. This is highlighted in an IDE by this: CoroutineScope hint right after the runBlocking opening curly brace.</p>
<p><a target="_blank" rel="noopener" href="https://kotlinlang.org/docs/coroutines-basics.html#your-first-coroutine">https://kotlinlang.org/docs/coroutines-basics.html#your-first-coroutine</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6883652600462327821">https://juejin.cn/post/6883652600462327821</a></p>
<p>runBlocking 只会等待相同作用域的协程完成才会退出</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> main&#123;</span><br>	runBlocking&#123; <span class="hljs-comment">// 不会阻塞正常的调用，阻塞主线程，让内部的程序执行完</span><br>		GlobalScope.launch&#123;<br>      println(<span class="hljs-string">&quot;hello world&quot;</span>)<br>    &#125;<br>	&#125;	<br>&#125;<br></code></pre></td></tr></table></figure>









<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1uo4y1y7ZF/?p=101">https://www.bilibili.com/video/BV1uo4y1y7ZF/?p=101</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Yu411X73j?p=5">https://www.bilibili.com/video/BV1Yu411X73j?p=5</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV164411C7FK?from=search&seid=2446477518780731765">https://www.bilibili.com/video/BV164411C7FK?from=search&amp;seid=2446477518780731765</a></p>
<p><a target="_blank" rel="noopener" href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-scope/index.html">https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-scope/index.html</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-03-31T21:52:42.000Z" title="4/1/2020, 5:52:42 AM">2020-04-01</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-08-19T11:11:44.298Z" title="8/19/2021, 7:11:44 PM">2021-08-19</time></span><span class="level-item"><a class="link-muted" href="/categories/Jetpack/">Jetpack</a></span><span class="level-item">2 minutes read (About 350 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/04/01/databinding/">databinding</a></p><div class="content"><p>layout expression of the language</p>
<p><a target="_blank" rel="noopener" href="https://codelabs.developers.google.com/codelabs/android-databinding/#0">https://codelabs.developers.google.com/codelabs/android-databinding/#0</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.android.com/topic/libraries/data-binding">https://developer.android.com/topic/libraries/data-binding</a></p>
<h4 id="Create-first-layout-expression"><a href="#Create-first-layout-expression" class="headerlink" title="Create first layout expression"></a>Create first layout expression</h4><ol>
<li> when you want to use it in your own projects the first step is to enable the library in the modules that will use it:</li>
</ol>
   <figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">android</span> &#123;</span><br><span class="line">...</span><br><span class="line">    dataBinding &#123;</span><br><span class="line">       <span class="literal">enabled</span> <span class="keyword">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>Convert to data binding layout</p>
<p>打开布局文件，选中根布局的 <strong>ViewGroup</strong>，按住 <strong>option + 回车键</strong>，点击 “<strong>Convert to data binding layout</strong>”，就可以生成 DataBinding 需要的布局规则</p>
</li>
</ol>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span></span><br><span class="line"><span class="xml">        xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;</span></span><br><span class="line"><span class="xml">        xmlns:tools=&quot;http://schemas.android.com/tools&quot;&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="xml">        &lt;variable</span></span><br><span class="line"><span class="xml">            name=&quot;name&quot;  //不能用下划线 &quot;_&quot;</span></span><br><span class="line"><span class="xml">            type=&quot;String&quot;/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="xml">        &lt;variable</span></span><br><span class="line"><span class="xml">            name=&quot;lastName&quot;</span></span><br><span class="line"><span class="xml">            type=&quot;String&quot;/&gt;</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="xml">    &lt;androidx.constraintlayout.widget.ConstraintLayout</span></span><br><span class="line"><span class="xml">        android:layout_width=&quot;match_parent&quot;</span></span><br><span class="line"><span class="xml">        android:layout_height=&quot;match_parent&quot;&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="xml">        &lt;TextView</span></span><br><span class="line"><span class="xml">            android:id=&quot;@+id/plain_name&quot;</span></span><br><span class="line"><span class="xml">            android:layout_width=&quot;0dp&quot;</span></span><br><span class="line"><span class="xml">            android:layout_height=&quot;wrap_content&quot;</span></span><br><span class="line"><span class="xml">            android:layout_marginStart=&quot;16dp&quot;</span></span><br><span class="line"><span class="xml">            android:layout_marginTop=&quot;8dp&quot;</span></span><br><span class="line"><span class="xml">            android:layout_marginEnd=&quot;128dp&quot;</span></span><br><span class="line"><span class="xml">            android:text=&quot;@</span><span class="template-variable">&#123;name&#125;</span><span class="xml">&quot;			</span></span><br><span class="line"><span class="xml">            android:textAppearance=&quot;@style/TextAppearance.AppCompat.Large&quot;</span></span><br><span class="line"><span class="xml">            app:layout_constraintEnd_toEndOf=&quot;parent&quot;</span></span><br><span class="line"><span class="xml">            app:layout_constraintStart_toStartOf=&quot;parent&quot;</span></span><br><span class="line"><span class="xml">            app:layout_constraintTop_toBottomOf=&quot;@+id/name_label&quot;/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="xml">        &lt;TextView</span></span><br><span class="line"><span class="xml">            android:id=&quot;@+id/plain_lastname&quot;</span></span><br><span class="line"><span class="xml">            android:layout_width=&quot;0dp&quot;</span></span><br><span class="line"><span class="xml">            android:layout_height=&quot;wrap_content&quot;</span></span><br><span class="line"><span class="xml">            android:layout_marginStart=&quot;16dp&quot;</span></span><br><span class="line"><span class="xml">            android:layout_marginTop=&quot;8dp&quot;</span></span><br><span class="line"><span class="xml">            android:layout_marginEnd=&quot;128dp&quot;</span></span><br><span class="line"><span class="xml">            android:text=&quot;@</span><span class="template-variable">&#123;lastName&#125;</span><span class="xml">&quot;</span></span><br><span class="line"><span class="xml">            android:textAppearance=&quot;@style/TextAppearance.AppCompat.Large&quot;</span></span><br><span class="line"><span class="xml">            app:layout_constraintEnd_toEndOf=&quot;parent&quot;</span></span><br><span class="line"><span class="xml">            app:layout_constraintStart_toStartOf=&quot;parent&quot;</span></span><br><span class="line"><span class="xml">            app:layout_constraintTop_toBottomOf=&quot;@+id/lastname_label&quot;/&gt;</span></span><br><span class="line"><span class="xml">            </span></span><br><span class="line"><span class="xml">       <span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span>    </span></span><br><span class="line"><span class="xml">   <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span></span><br></pre></td></tr></table></figure>



<ol start="3">
<li>Bind TextView</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlainOldActivitySolution2</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Obtain ViewModel from ViewModelProviders</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> viewModel <span class="keyword">by</span> lazy &#123; ViewModelProviders.of(<span class="keyword">this</span>).<span class="keyword">get</span>(SimpleViewModel::<span class="keyword">class</span>.java) &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> binding: PlainActivitySolution2Binding =</span><br><span class="line">            DataBindingUtil.setContentView(<span class="keyword">this</span>, R.layout.plain_activity_solution_2)</span><br><span class="line"></span><br><span class="line">        binding.name = <span class="string">&quot;John&quot;</span></span><br><span class="line">        binding.lastName = <span class="string">&quot;lice&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Explicitly setting initial values is a bad pattern. We&#x27;ll fix that later on.</span></span><br><span class="line">        updateLikes()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="Dealing-with-user-events-Observering-data"><a href="#Dealing-with-user-events-Observering-data" class="headerlink" title="Dealing with user events  Observering data"></a>Dealing with user events  Observering data</h4><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="class"><span class="keyword">data</span>&gt;</span></span><br><span class="line">     &lt;variable</span><br><span class="line">             name=<span class="string">&quot;viewmodel&quot;</span></span><br><span class="line">             <span class="class"><span class="keyword">type</span>=&quot;com.example.android.databinding.basicsample.<span class="keyword">data</span>.<span class="type">SimpleViewModel</span>&quot;/&gt;</span></span><br><span class="line"> &lt;/<span class="class"><span class="keyword">data</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">android:</span>onClick=<span class="string">&quot;@&#123;() -&gt; viewmodel.onLike()&#125;&quot;</span></span><br><span class="line">   </span><br><span class="line">binding.viewmodel = viewModel</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _likes =  <span class="constructor">MutableLiveData(0)</span></span><br><span class="line"> <span class="keyword">fun</span> on<span class="constructor">Like()</span> &#123;</span><br><span class="line">       <span class="module-access"><span class="module"><span class="identifier">_likes</span>.</span></span>value = (<span class="module-access"><span class="module"><span class="identifier">_likes</span>.</span></span>value ?: <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;TextView</span><br><span class="line">            android:<span class="built_in">id</span>=<span class="string">&quot;@+id/likes&quot;</span></span><br><span class="line">            android:<span class="built_in">text</span>=<span class="string">&quot;@&#123;Integer.toString(viewmodel.likes)&#125;&quot;</span></span><br></pre></td></tr></table></figure>





<h4 id="Using-Binding-Adapters"><a href="#Using-Binding-Adapters" class="headerlink" title="Using Binding Adapters"></a>Using Binding Adapters</h4><ol>
<li>One parameter</li>
</ol>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">BindingAdapter</span>(<span class="string">&quot;android:text&quot;</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(TextView view, CharSequence text)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// Some checks removed for clarity</span></span><br><span class="line"></span><br><span class="line">      view.<span class="built_in">setText</span>(text);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindingAdapter(<span class="meta-string">&quot;app:hideIfZero&quot;</span>)</span></span><br><span class="line"> <span class="function"><span class="keyword">fun</span> <span class="title">hideIfZero</span><span class="params">(view: <span class="type">View</span>, number: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">     view.visibility = <span class="keyword">if</span> (number == <span class="number">0</span>) View.GONE <span class="keyword">else</span> View.VISIBLE</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;ProgressBar</span><br><span class="line">            android:<span class="attribute">id</span>=<span class="string">&quot;@+id/progressBar&quot;</span></span><br><span class="line">            app:<span class="attribute">hideIfZero</span>=<span class="string">&quot;@&#123;viewmodel.likes&#125;&quot;</span></span><br></pre></td></tr></table></figure>



<ol start="2">
<li><p>Create a Binding Adapter with multiple parameters   </p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;ProgressBar</span><br><span class="line">               android:<span class="attribute">id</span>=<span class="string">&quot;@+id/progressBar&quot;</span></span><br><span class="line">               app:<span class="attribute">hideIfZero</span>=<span class="string">&quot;@&#123;viewmodel.likes&#125;&quot;</span></span><br><span class="line">               app:<span class="attribute">progressScaled</span>=<span class="string">&quot;@&#123;viewmodel.likes&#125;&quot;</span></span><br><span class="line">               android:<span class="attribute">max</span>=<span class="string">&quot;@&#123;100&#125;&quot;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="oberver-class-field"><a href="#oberver-class-field" class="headerlink" title="oberver class field"></a>oberver class field</h4><p><a target="_blank" rel="noopener" href="https://developer.android.com/topic/libraries/data-binding/observability#observable_fields">https://developer.android.com/topic/libraries/data-binding/observability#observable_fields</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.android.com/topic/libraries/data-binding/observability#observable_objects">https://developer.android.com/topic/libraries/data-binding/observability#observable_objects</a></p>
<h5 id="Using-Binding-Adapters-to-create-custom-attributes"><a href="#Using-Binding-Adapters-to-create-custom-attributes" class="headerlink" title="Using Binding Adapters to create custom attributes"></a>Using Binding Adapters to create custom attributes</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindingAdapter(value=[<span class="meta-string">&quot;app:setSleepData&quot;</span>])</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setSleepData</span><span class="params">(viewBodySleep: <span class="type">ViewBodySleep</span>, sleepData: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">    viewBodySleep.setSleepData(sleepData)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;com.android.util.view.ViewBodySleep</span><br><span class="line">    android:<span class="attribute">id</span>=<span class="string">&quot;@+id/view_body_sleep&quot;</span></span><br><span class="line">    android:<span class="attribute">layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span><br><span class="line">    android:<span class="attribute">layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span><br><span class="line">    android:<span class="attribute">paddingLeft</span>=<span class="string">&quot;55dp&quot;</span></span><br><span class="line">    android:<span class="attribute">paddingRight</span>=<span class="string">&quot;48dp&quot;</span></span><br><span class="line">    app:<span class="attribute">setSleepData</span>=<span class="string">&quot;@&#123;vmBodyFragment.spData&#125;&quot;</span></span><br><span class="line">    app:<span class="attribute">layout_constraintTop_toTopOf</span>=<span class="string">&quot;parent&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://developer.android.com/topic/libraries/data-binding/expressions#expression_language">https://developer.android.com/topic/libraries/data-binding/expressions#expression_language</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.android.com/topic/libraries/data-binding/observability">Work with observable data objects</a></p>
<ul>
<li><p>isNull</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">android:</span><span class="keyword">text</span>=<span class="comment">&#x27;@&#123;viewModel.patientInfo.remoteCheckReceiveName??&quot;&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><p>visible</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindingAdapter(<span class="meta-string">&quot;app:goneUnless&quot;</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">goneUnless</span><span class="params">(view: <span class="type">View</span>, visible: <span class="type">Boolean</span>)</span></span> &#123;</span><br><span class="line">    view.visibility = <span class="keyword">if</span> (visible) View.VISIBLE <span class="keyword">else</span> View.GONE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/googlecodelabs/android-databinding">android-databinding</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzAwODY4OTk2Mg==&amp;mid=2652046992&amp;idx=1&amp;sn=b8b4c47537be1227eecd01c1eaee2550&amp;chksm=808ca6d5b7fb2fc32d9ec361c91a2958e51a2db1c6b20370e7ef6493bb5cb20314cda6ab059c&amp;scene=38#wechat_redirect">https://mp.weixin.qq.com/s?__biz=MzAwODY4OTk2Mg==&amp;mid=2652046992&amp;idx=1&amp;sn=b8b4c47537be1227eecd01c1eaee2550&amp;chksm=808ca6d5b7fb2fc32d9ec361c91a2958e51a2db1c6b20370e7ef6493bb5cb20314cda6ab059c&amp;scene=38#wechat_redirect</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/5d2be05ff265da1bd605d49a">https://juejin.im/post/5d2be05ff265da1bd605d49a</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/4UP-pDs0FK66g1QUQvRN6A">https://mp.weixin.qq.com/s/4UP-pDs0FK66g1QUQvRN6A</a></p>
<p>定义xml背景</p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/5b95c6a0e51d450e664b0aa0">https://juejin.im/post/5b95c6a0e51d450e664b0aa0</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/741103ba2ff1">https://www.jianshu.com/p/741103ba2ff1</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cs.usfca.edu/~galles/visualization/RedBlack.html">https://www.cs.usfca.edu/~galles/visualization/RedBlack.html</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-03-23T09:47:11.000Z" title="3/23/2020, 5:47:11 PM">2020-03-23</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-09-03T07:04:03.894Z" title="9/3/2023, 3:04:03 PM">2023-09-03</time></span><span class="level-item"><a class="link-muted" href="/categories/JAVA/">JAVA</a></span><span class="level-item">a minute read (About 120 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/03/23/Java-Queue/">Android_itnerview2</a></p><div class="content"><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/bn493235694/article/details/79600634">https://blog.csdn.net/bn493235694/article/details/79600634</a></p>
<p><em>队列是一个先进先出的的数据结构</em></p>
<img src="/2020/03/23/Java-Queue/16d7ddc81e9f954f.jpg" alt="16d7ddc81e9f954f">





<h5 id="Deque"><a href="#Deque" class="headerlink" title="Deque"></a>Deque</h5><p><strong>I need to have a thread-safe LIFO structure</strong></p>
<p>Use LinkedBlockingDeque if at a time you want only single thread can operate your data.</p>
<p>Use ConcurrentLinkedDeque if you want that each thread can access the shared data</p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ConcurrentLinkedDeque.html">https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ConcurrentLinkedDeque.html</a></p>
<ul>
<li><p>ConcurrentLinkedDeque</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/hello_worldee/article/details/77880532">https://blog.csdn.net/hello_worldee/article/details/77880532</a></p>
</li>
</ul>
<p>Deque : <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/7/docs/api/java/util/Deque.html">https://docs.oracle.com/javase/7/docs/api/java/util/Deque.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.liaoxuefeng.com/wiki/1252599548343744/1265122668445536">https://www.liaoxuefeng.com/wiki/1252599548343744/1265122668445536</a></p>
<p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/deque-interface-java-example/">https://www.geeksforgeeks.org/deque-interface-java-example/</a></p>
<ul>
<li>LinkedList 线程安全处理</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/d380025303/article/details/81010980">https://blog.csdn.net/d380025303/article/details/81010980</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-03-22T14:45:17.000Z" title="3/22/2020, 10:45:17 PM">2020-03-22</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-08-19T11:11:43.525Z" title="8/19/2021, 7:11:43 PM">2021-08-19</time></span><span class="level-item"><a class="link-muted" href="/categories/ANDROID/">ANDROID</a></span><span class="level-item">a few seconds read (About 83 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/03/22/ActivityRender01/">ActivityRender01</a></p><div class="content"><p><a target="_blank" rel="noopener" href="https://juejin.im/post/5baf275f5188255c9a7740ba">https://juejin.im/post/5baf275f5188255c9a7740ba</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/SusionSuc/AdvancedAndroid/blob/master/AndroidFramework%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/Android%E8%A7%86%E5%9B%BE%E5%B1%82%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/README.md">https://github.com/SusionSuc/AdvancedAndroid/blob/master/AndroidFramework%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/Android%E8%A7%86%E5%9B%BE%E5%B1%82%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/README.md</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/luoshengyang/article/details/8170307">https://blog.csdn.net/luoshengyang/article/details/8170307</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/6844904146227691527">https://juejin.im/post/6844904146227691527</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/sKJCG1AjhIRRQL9tQTrLZg">https://mp.weixin.qq.com/s/sKJCG1AjhIRRQL9tQTrLZg</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-01-18T13:53:41.000Z" title="1/18/2020, 9:53:41 PM">2020-01-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-08-19T11:11:43.526Z" title="8/19/2021, 7:11:43 PM">2021-08-19</time></span><span class="level-item"><a class="link-muted" href="/categories/ANDROID/">ANDROID</a></span><span class="level-item">an hour read (About 7553 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/01/18/ActivityStart01/">ActivityStart01</a></p><div class="content"><p>　Activity创建</p>
<p>​    生命周期方法调用</p>
<p>本篇文章将根据源码解剖Android的Activity的启动流程，需注意的是下列的分析均基于Android7.0, 7.0版本相较于之前几个版本做了许多改动和重构，但是整体的流程是变化不大。根据启动Activity时机的不同，可分为根Activity的启动流程和普通Activity启动流程，根Activity启动流程又可以称为应用程序启动流程，即在桌面上点击一个应用图标到进入到应用第一个Activity的流程。而普通Activity的启动流程就是在一个应用里开启另外一个Activity的流程。由于两种启动流程是有重叠的，而根Activity的启动流程更加复杂，所以接下来我们重点分析根Activity的启动流程，而普通Activity的启动流程在涉及的地方会稍微提一下。由于考虑到篇幅较长，这里将分为两篇来介绍。</p>
<p>这篇将分析启动流程中的应用进程的创建：</p>
<ul>
<li>Launcher进程请求AMS</li>
<li>AMS发送创建应用进程请求</li>
<li>Zygote进程接受请求并孵化应用进程</li>
<li>应用进程启动ActivityThread</li>
</ul>
<p>MainActivity组件是由Launcher 组件来启动的，而Launcher组件又是通过Activity管理服务ActivityManagerServ ice来启动Main Activity组件的’。MainActivity组件、Launcher组件和 ActivityManagerService是分别运行在不同的进程中的，因此，MainActivity组件的启动过程就涉及到了三个进程。这三个进程是通过Binder进程间通信机制来完成MainActivity组件的启动过程的。 Launcher组件启动MainActivity组件的过程如下所示。</p>
<p> (1)Launcher组件向ActivityManagerService发送一个启动MainActivity组件的进程间通信请求。</p>
<p> ( 2 ) ActivityManagerService首先将要启动的MainActivity组件的信息保存下来，然后再向Launcher 组件发送一个进入中止状态的进程间通信请求。</p>
<p> ( 3 ) Launcher组件进入到中止状态之后，就会向ActivityManagerService发送一个已进人中止状态 的进程间通信请求，以便ActivityManagerServ ice可以继续执行启动MainActivity组件的操作。</p>
<p> (4) ActivityManagerService发现用来运行MairiActivity组件的应用程序进程不存在，因此，它就会 先启动一个新的应用程序进程。</p>
<p> (5）新的应用程序进程启动完成之后，就会向ActivityManagerServi(e发送一个启动完成的进程间 通信请求，以便ActivityManagerService可以继续执行启动MainActivity组件的操作。</p>
<p> (6) ActivityManagerService将第2步保存下来的MainActivity组件的信息发送给第4步创建的应用程序进程，以便它可以将MainActivity组件启动起来。 </p>
<h1 id="一、Launcher进程请求AMS"><a href="#一、Launcher进程请求AMS" class="headerlink" title="一、Launcher进程请求AMS"></a>一、Launcher进程请求AMS</h1><p>上面我们提到根Activity的启动流程其实就是桌面上点击一个应用图标进入到应用的第一个Activity的流程，其实桌面也可以看成一个程序，即Launcher。当系统开机后，Launcher也随之被启动，然后将已经安装的应用程序图标显示到桌面上，所以当我们点击一个应用图标其实就是相当于点击Activity中的一个button,其相应事件就是Launcher进程请求AMS来启动该应用程序。</p>
<h2 id="1-时序图"><a href="#1-时序图" class="headerlink" title="1. 时序图"></a>1. 时序图</h2><p><img src="/2020/01/18/ActivityStart01/RootActivityStart01.png" alt="在这里插入图片描述"></p>
<h2 id="2-详细过程"><a href="#2-详细过程" class="headerlink" title="2. 详细过程"></a>2. 详细过程</h2><p>请求的入口就是Launcher的startActivitySafe方法，如下：</p>
<blockquote>
<p>packages/apps/Launcher3/src/com/android/launcher3/Launcher.java</p>
</blockquote>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">bool</span>ean startActivitySafely(View v, Intent <span class="built_in">int</span>ent, ItemInfo item) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 根Activity会在新的任务栈中启动</span></span><br><span class="line">    <span class="built_in">int</span>ent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (isShortcut) &#123;</span><br><span class="line">            <span class="comment">// Shortcuts need some special checks due to legacy reasons.</span></span><br><span class="line">            startShortcutIntentSafely(<span class="built_in">int</span>ent, optsBundle, item);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (user == <span class="literal">null</span> || user.equals(Process.myUserHandle())) &#123;</span><br><span class="line">            <span class="comment">// 调用startActivity</span></span><br><span class="line">            startActivity(<span class="built_in">int</span>ent, optsBundle);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LauncherAppsCompat.getInstance(<span class="keyword">this</span>).startActivityForProfile(</span><br><span class="line">                    <span class="built_in">int</span>ent.getComponent(), user, <span class="built_in">int</span>ent.getSourceBounds(), optsBundle);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ActivityNotFoundException|SecurityException e) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以发现该方法为根Activity设置了flag，即根Activity会在新的任务栈中启动。然后会调用我们熟悉的startActivity方法,而在Launcher并没有这个方法，所以我们自然想到了应该是父类的方法，然后让我们来看看Launcher继承了哪些类？</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Launcher</span> <span class="keyword">extends</span> <span class="title">BaseDraggingActivity</span> <span class="title">implements</span> <span class="title">LauncherExterns</span>,</span></span><br><span class="line"><span class="class">        <span class="title">LauncherModel</span>.<span class="title">Callbacks</span>, <span class="title">LauncherProviderChangeListener</span>, <span class="title">UserEventDelegate</span></span>&#123;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseDraggingActivity</span> <span class="keyword">extends</span> <span class="title">BaseActivity</span></span></span><br><span class="line"><span class="class">        <span class="title">implements</span> <span class="title">WallpaperColorInfo</span>.<span class="title">OnChangeListener</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        &#125;</span><br><span class="line">public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="title">implements</span> <span class="title">UserEventDelegate</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其实一直追踪下去，你就会发现其实Launcher调用的startActivity其实就是Activity中的startActivity。从这里也可以证明Launcher其实也是个Activity。所以在Launcher启动一个app，和我们平时在startActivity基本是一样的（基本一样，不代表完全一样，通过后文分析你就会明白！），于是我们来看看我们熟悉的Activity中的startActivity的源码是如何的：</p>
<blockquote>
<p>源码：frameworks/base/core/java/android/app/Activity.java</p>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">startActivity</span>(<span class="params">Intent intent, <span class="meta">@Nullable</span> Bundle options</span>)</span> &#123;</span><br><span class="line">    <span class="comment">//第二个参数为-1表示Launcher不需要知道根Activity的启动结果</span></span><br><span class="line">    <span class="keyword">if</span> (options != <span class="literal">null</span>) &#123;</span><br><span class="line">        startActivityForResult(intent, -<span class="number">1</span>, options);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Note we want to go through this call for compatibility with</span></span><br><span class="line">        <span class="comment">// applications that may have overridden the method.</span></span><br><span class="line">        startActivityForResult(intent, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="function"><span class="title">startActivityForResult</span>(<span class="params"><span class="meta">@RequiresPermission</span> Intent intent, int requestCode</span>)</span> &#123;</span><br><span class="line">    startActivityForResult(intent, requestCode, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> startActivityForResult(<span class="meta">@RequiresPermission</span> Intent intent, int requestCode,</span><br><span class="line">        <span class="meta">@Nullable</span> Bundle options) &#123;</span><br><span class="line">    <span class="comment">//mParent表示当前Activity的父类，当根活动还没创建则mParent==null    </span></span><br><span class="line">    <span class="keyword">if</span> (mParent == <span class="literal">null</span>) &#123;</span><br><span class="line">        options = transferSpringboardActivityOptions(options);</span><br><span class="line">        Instrumentation.ActivityResult ar =</span><br><span class="line">            mInstrumentation.execStartActivity(</span><br><span class="line">                <span class="built_in">this</span>, mMainThread.getApplicationThread(), mToken, <span class="built_in">this</span>,</span><br><span class="line">                intent, requestCode, options);</span><br><span class="line">       ... </span><br><span class="line">    &#125; </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从上面代码可以发现startActivity的最终实现是startActivityForResult，startActivity()第二个参数为-1表示Launcher不需要知道根Activity的启动结果,然后在startActivityForResult中由于此时根Activity还没有创建，故mParent=null,所以我们只需要关注mParent=null的情况。在这种情况中会调用Instrumentation的execStartActivity。这时候也许你就会问这个Instrumentation是什么？为什么要交给它处理？其实Instrumentation这个类很重要，重要体现在对Activity生命周期的调用。每个Activity都持有Instrumentation对象的一个引用，但是整个进程只会存在一个Instrumentation对象。看看Instrumentation的execStartActivity这个方法。</p>
<blockquote>
<p>frameworks/base/core/java/android/app/Instrumentation.java</p>
</blockquote>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ActivityResult execStartActivity(</span><br><span class="line">        Context who, IBinder contextThread, IBinder token, Activity <span class="keyword">target</span>,</span><br><span class="line">        Intent intent, <span class="keyword">int</span> requestCode, Bundle options) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"> ...</span><br><span class="line">  <span class="comment">//获取AMS的代理对象</span></span><br><span class="line">        <span class="keyword">int</span> result = ActivityManager.getService()</span><br><span class="line">            .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                    intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                    token, <span class="keyword">target</span> != <span class="keyword">null</span> ? <span class="keyword">target</span>.mEmbeddedID : <span class="keyword">null</span>,</span><br><span class="line">                    requestCode, 0, <span class="keyword">null</span>, options);</span><br><span class="line">        checkStartActivityResult(result, intent);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Failure from system&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在这个方法会调用ActivityManager的getService方法来得到AMS的代理对象，然后调用这个代理对象的</p>
<p>startActivity方法，那么这个代理对象是谁呢？让我们一探究竟</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">IActivityManager <span class="title">getService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">return</span> IActivityManagerSingleton.<span class="title">get</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; IActivityManagerSingleton =</span><br><span class="line">        <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="function">IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">//得到activity的service引用，即IBinder类型的AMS引用</span></span><br><span class="line">                <span class="keyword">final</span> IBinder b = ServiceManager.getService(Context.ACTIVITY_SERVICE);</span><br><span class="line">	<span class="comment">//转换成IActivityManager对象</span></span><br><span class="line">                <span class="keyword">final</span> IActivityManager am = IActivityManager.Stub.asInterface(b);</span><br><span class="line">                <span class="keyword">return</span> am;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以发现在Singleton中的create方法中由于b是AMS引用作为服务端处于SystemServer进程中，与当前Launcher进程作为客户端与服务端不在同一个进程，所以am返回的是IActivityManager.Stub的代理对象，此时如果要实现客户端与服务端进程间的通信，只需要在AMS继承了IActivityManager.Stub类并实现了相应的方法，而通过下面的代码可以发现AMS刚好是继承了IActivityManager.Stub类的，这样Launcher进程作为客户端就拥有了服务端AMS的代理对象，然后就可以调用AMS的方法来实现具体功能了，就这样Launcher的工作就交给AMS实现了。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerService</span> <span class="keyword">extends</span> <span class="title">IActivityManager</span>.<span class="title">Stub</span></span></span><br><span class="line"><span class="class">        <span class="title">implements</span> <span class="title">Watchdog</span>.<span class="title">Monitor</span>, <span class="title">BatteryStatsImpl</span>.<span class="title">BatteryCallback</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        &#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h1 id="二、AMS发送创建应用进程请求"><a href="#二、AMS发送创建应用进程请求" class="headerlink" title="二、AMS发送创建应用进程请求"></a>二、AMS发送创建应用进程请求</h1><p>通过上面的分析，我们已经知道现在任务已经交给了AMS，入口是AMS的startActivity。</p>
<h2 id="1-时序图-1"><a href="#1-时序图-1" class="headerlink" title="1. 时序图"></a>1. 时序图</h2><p><img src="/2020/01/18/ActivityStart01/RootActivityStart02.png" alt="在这里插入图片描述"></p>
<h2 id="2-详细过程-1"><a href="#2-详细过程-1" class="headerlink" title="2. 详细过程"></a>2. 详细过程</h2><h3 id="2-1-AMS将请求任务转移给Process"><a href="#2-1-AMS将请求任务转移给Process" class="headerlink" title="2.1 AMS将请求任务转移给Process"></a>2.1 AMS将请求任务转移给Process</h3><p>首先来看看在AMS中的startActivity方法：</p>
<blockquote>
<p>源码：frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</p>
</blockquote>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, <span class="keyword">String</span> callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent, <span class="keyword">String</span> resolvedType, IBinder resultTo, <span class="keyword">String</span> resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">startActivityAsUser</span>(caller, callingPackage, intent, resolvedType, resultTo,</span><br><span class="line">            resultWho, requestCode, startFlags, profilerInfo, bOptions,</span><br><span class="line">            UserHandle.<span class="built_in">getCallingUserId</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, <span class="keyword">String</span> callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent, <span class="keyword">String</span> resolvedType, IBinder resultTo, <span class="keyword">String</span> resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">startActivityAsUser</span>(caller, callingPackage, intent, resolvedType, resultTo,</span><br><span class="line">            resultWho, requestCode, startFlags, profilerInfo, bOptions, userId,</span><br><span class="line">            <span class="literal">true</span> <span class="comment">/*validateIncomingUser*/</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, <span class="keyword">String</span> callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent, <span class="keyword">String</span> resolvedType, IBinder resultTo, <span class="keyword">String</span> resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> validateIncomingUser)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">			</span><br><span class="line">    <span class="comment">//判断调用者的进程是否隔离</span></span><br><span class="line">    <span class="built_in">enforceNotIsolatedCaller</span>(<span class="string">&quot;startActivity&quot;</span>);</span><br><span class="line">    <span class="comment">//检查调用者权限</span></span><br><span class="line">    userId = mActivityStartController.<span class="built_in">checkTargetUser</span>(userId, validateIncomingUser,</span><br><span class="line">            Binder.<span class="built_in">getCallingPid</span>(), Binder.<span class="built_in">getCallingUid</span>(), <span class="string">&quot;startActivityAsUser&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></span><br><span class="line">    <span class="keyword">return</span> mActivityStartController.<span class="built_in">obtainStarter</span>(intent, <span class="string">&quot;startActivityAsUser&quot;</span>)</span><br><span class="line">            .<span class="built_in">setCaller</span>(caller)</span><br><span class="line">            .<span class="built_in">setCallingPackage</span>(callingPackage)</span><br><span class="line">            .<span class="built_in">setResolvedType</span>(resolvedType)</span><br><span class="line">            .<span class="built_in">setResultTo</span>(resultTo)</span><br><span class="line">            .<span class="built_in">setResultWho</span>(resultWho)</span><br><span class="line">            .<span class="built_in">setRequestCode</span>(requestCode)</span><br><span class="line">            .<span class="built_in">setStartFlags</span>(startFlags)</span><br><span class="line">            .<span class="built_in">setProfilerInfo</span>(profilerInfo)</span><br><span class="line">            .<span class="built_in">setActivityOptions</span>(bOptions)</span><br><span class="line">            .<span class="built_in">setMayWait</span>(userId)</span><br><span class="line">            .<span class="built_in">execute</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>startActivity方法经过多个方法调用会去执行startActivityAsUser方法，在startActivityAsUser方法最后会返回mActivityStartController的一长串链式调用方法，如果AlertDialog的话，应该不难看出这链式方法肯定都是返回一个类型的对象的，我们只需要看看obtainStarter的返回类型就可以知道这个对象是什么类型了。</p>
<blockquote>
<p>frameworks/base/services/core/java/com/android/server/am/ActivityStartController.java</p>
</blockquote>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ActivityStarter obtain<span class="constructor">Starter(Intent <span class="params">intent</span>, String <span class="params">reason</span>)</span> &#123;</span><br><span class="line">    return mFactory.obtain<span class="literal">()</span>.set<span class="constructor">Intent(<span class="params">intent</span>)</span>.set<span class="constructor">Reason(<span class="params">reason</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以发现这个obtainStarter返回的是ActivityStarter类型的，所以链式方法就是对ActivityStarter对象设置了要启动的活动的相关信息，最后再调用ActivityStarter对象execute方法。所以我们下一步所需要看的就是这个execute方法。</p>
<blockquote>
<p>frameworks/base/services/core/java/com/android/server/am/ActivityStarter.java</p>
</blockquote>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">int execute() &#123;</span><br><span class="line">    <span class="attribute">try &#123;</span></span><br><span class="line"><span class="attribute">        // TODO(b/64750076)</span>: Look into passing request directly to these methods to allow</span><br><span class="line">        // for transactional diffs and preprocessing.</span><br><span class="line">        if (mRequest<span class="variable">.mayWait</span>) &#123;</span><br><span class="line">            return startActivityMayWait(mRequest<span class="variable">.caller</span>, mRequest<span class="variable">.callingUid</span>,</span><br><span class="line">                    mRequest<span class="variable">.callingPackage</span>, mRequest<span class="variable">.intent</span>, mRequest<span class="variable">.resolvedType</span>,</span><br><span class="line">                    mRequest<span class="variable">.voiceSession</span>, mRequest<span class="variable">.voiceInteractor</span>, mRequest<span class="variable">.resultTo</span>,</span><br><span class="line">                    mRequest<span class="variable">.resultWho</span>, mRequest<span class="variable">.requestCode</span>, mRequest<span class="variable">.startFlags</span>,</span><br><span class="line">                    mRequest<span class="variable">.profilerInfo</span>, mRequest<span class="variable">.waitResult</span>, mRequest<span class="variable">.globalConfig</span>,</span><br><span class="line">                    mRequest<span class="variable">.activityOptions</span>, mRequest<span class="variable">.ignoreTargetSecurity</span>, mRequest<span class="variable">.userId</span>,</span><br><span class="line">                    mRequest<span class="variable">.inTask</span>, mRequest<span class="variable">.reason</span>,</span><br><span class="line">                    mRequest<span class="variable">.allowPendingRemoteAnimationRegistryLookup</span>,</span><br><span class="line">                    mRequest<span class="variable">.originatingPendingIntent</span>);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return startActivity(mRequest.caller, mRequest.intent, mRequest.ephemeralIntent,</span><br><span class="line">                    mRequest.resolvedType, mRequest.activityInfo, mRequest.resolveInfo,</span><br><span class="line">                    mRequest.voiceSession, mRequest.voiceInteractor, mRequest.resultTo,</span><br><span class="line">                    mRequest.resultWho, mRequest.requestCode, mRequest.callingPid,</span><br><span class="line">                    mRequest.callingUid, mRequest.callingPackage, mRequest.realCallingPid,</span><br><span class="line">                    mRequest.realCallingUid, mRequest.startFlags, mRequest.activityOptions,</span><br><span class="line">                    mRequest.ignoreTargetSecurity, mRequest.componentSpecified,</span><br><span class="line">                    mRequest.outActivity, mRequest.inTask, mRequest.reason,</span><br><span class="line">                    mRequest.allowPendingRemoteAnimationRegistryLookup,</span><br><span class="line">                    mRequest.originatingPendingIntent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        onExecutionComplete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因为在startActivityAsUser的链式方法中我们调用了setMayWait这个方法，所以这里的mRequest.mayWait为true，故会继续调用startActivityMayWait方法。</p>
<blockquote>
<p>ActivityStarter#startActivityMayWait</p>
</blockquote>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">String</span> callingPackage, Intent intent, <span class="keyword">String</span> resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">          IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">          IBinder resultTo, <span class="keyword">String</span> resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">          ProfilerInfo profilerInfo, WaitResult outResult,</span></span></span><br><span class="line"><span class="function"><span class="params">          Configuration globalConfig, SafeActivityOptions options, <span class="keyword">boolean</span> ignoreTargetSecurity,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">int</span> userId, TaskRecord inTask, <span class="keyword">String</span> reason,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">boolean</span> allowPendingRemoteAnimationRegistryLookup,</span></span></span><br><span class="line"><span class="function"><span class="params">          PendingIntentRecord originatingPendingIntent)</span> </span>&#123;</span><br><span class="line">      .....</span><br><span class="line">      <span class="comment">//根据intent在系统中找到合适的应用的activity，如果有多个activity可选择，</span></span><br><span class="line"><span class="comment">//则会弹出ResolverActivity让用户选择合适的应用。</span></span><br><span class="line">      ActivityInfo aInfo = mSupervisor.<span class="built_in">resolveActivity</span>(intent, rInfo, startFlags, profilerInfo);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="keyword">int</span> res = <span class="built_in">startActivity</span>(caller, intent, ephemeralIntent, resolvedType, aInfo, rInfo,</span><br><span class="line">                  voiceSession, voiceInteractor, resultTo, resultWho, requestCode, callingPid,</span><br><span class="line">                  callingUid, callingPackage, realCallingPid, realCallingUid, startFlags, options,</span><br><span class="line">                  ignoreTargetSecurity, componentSpecified, outRecord, inTask, reason,</span><br><span class="line">                  allowPendingRemoteAnimationRegistryLookup, originatingPendingIntent);</span><br><span class="line">      ....</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">String</span> resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">          IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">          IBinder resultTo, <span class="keyword">String</span> resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">String</span> callingPackage, <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">          SafeActivityOptions options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified,</span></span></span><br><span class="line"><span class="function"><span class="params">          ActivityRecord[] outActivity, TaskRecord inTask, <span class="keyword">String</span> reason,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">boolean</span> allowPendingRemoteAnimationRegistryLookup)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">      mLastStartActivityResult = <span class="built_in">startActivity</span>(caller, intent, ephemeralIntent, resolvedType,</span><br><span class="line">              aInfo, rInfo, voiceSession, voiceInteractor, resultTo, resultWho, requestCode,</span><br><span class="line">              callingPid, callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,</span><br><span class="line">              options, ignoreTargetSecurity, componentSpecified, mLastStartActivityRecord,</span><br><span class="line">              inTask, allowPendingRemoteAnimationRegistryLookup);</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">getExternalResult</span>(mLastStartActivityResult);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">String</span> resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">          IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">          IBinder resultTo, <span class="keyword">String</span> resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">String</span> callingPackage, <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">          SafeActivityOptions options,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified, ActivityRecord[] outActivity,</span></span></span><br><span class="line"><span class="function"><span class="params">          TaskRecord inTask, <span class="keyword">boolean</span> allowPendingRemoteAnimationRegistryLookup)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">startActivity</span>(r, sourceRecord, voiceSession, voiceInteractor, startFlags,</span><br><span class="line">              <span class="literal">true</span> <span class="comment">/* doResume */</span>, checkedOptions, inTask, outActivity);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">              IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">              <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask,</span></span></span><br><span class="line"><span class="function"><span class="params">              ActivityRecord[] outActivity)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">          result = <span class="built_in">startActivityUnchecked</span>(r, sourceRecord, voiceSession, voiceInteractor,</span><br><span class="line">                  startFlags, doResume, options, inTask, outActivity);</span><br><span class="line">      ...</span><br><span class="line"></span><br><span class="line">      <span class="built_in">postStartActivityProcessing</span>(r, result, mTargetStack);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>startActivityMayWait方法经过调用多次的startActivity方法后会调用到startActivityUnchecked这个方法，那这个方法是干啥的呢？这个方法会根据启动标志位和Activity启动模式来决定如何启动一个Activity以及是否要调用deliverNewIntent方法通知Activity有一个Intent试图重新启动它。比如我们在一开始将活动设置了FLAG_ACTIVITY_NEW_TASK后将创建一个任务栈，其它的就自行看代码。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> startActivityUnchecked(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span><br><span class="line">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span><br><span class="line">            <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask,</span><br><span class="line">            ActivityRecord[] outActivity) &#123;</span><br><span class="line">...</span><br><span class="line"> <span class="keyword">if</span> (mStartActivity.resultTo == <span class="keyword">null</span> &amp;&amp; mInTask == <span class="keyword">null</span> &amp;&amp; !mAddingToTask</span><br><span class="line">                &amp;&amp; (mLaunchFlags &amp; FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span>) &#123;</span><br><span class="line">            newTask = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">//创建新的TaskRecord</span></span><br><span class="line">            result = setTaskFromReuseOrCreateNewTask(</span><br><span class="line">                    taskToAffiliate, preferredLaunchStackId, topStack);</span><br><span class="line">        &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(mSourceRecord != <span class="keyword">null</span>)</span> </span>&#123;</span><br><span class="line">            result = setTaskFromSourceRecord();</span><br><span class="line">        &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(mInTask != <span class="keyword">null</span>)</span> </span>&#123;</span><br><span class="line">            result = setTaskFromInTask();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            setTaskToCurrentTopOrCreateNewTask();</span><br><span class="line">        &#125;</span><br><span class="line">       ...</span><br><span class="line"> <span class="keyword">if</span> (mDoResume) &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityRecord topTaskActivity =</span><br><span class="line">                    mStartActivity.getTask().topRunningActivityLocked();</span><br><span class="line">            <span class="keyword">if</span> (!mTargetStack.isFocusable()</span><br><span class="line">                    || (topTaskActivity != <span class="keyword">null</span> &amp;&amp; topTaskActivity.mTaskOverlay</span><br><span class="line">                    &amp;&amp; mStartActivity != topTaskActivity)) &#123;</span><br><span class="line">               ...</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (mTargetStack.isFocusable() &amp;&amp; !mSupervisor.isFocusedStack(mTargetStack)) &#123;</span><br><span class="line">                    mTargetStack.moveToFront(<span class="string">&quot;startActivityUnchecked&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                mSupervisor.resumeFocusedStackTopActivityLocked(mTargetStack, mStartActivity,</span><br><span class="line">                        mOptions);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mTargetStack.addRecentActivityLocked(mStartActivity);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后无论以何种模式启动最终都会调用ActivityStackSupervisor.resumeFocusedStackTopActivityLocked方法。</p>
<blockquote>
<p>frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</p>
</blockquote>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> resumeFocusedStackTopActivityLocked(</span><br><span class="line">        ActivityStack targetStack, ActivityRecord <span class="keyword">target</span>, ActivityOptions targetOptions) &#123;</span><br><span class="line">    ....</span><br><span class="line">    <span class="keyword">if</span> (targetStack != <span class="keyword">null</span> &amp;&amp; isFocusedStack(targetStack)) &#123;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> targetStack.<span class="title">resumeTopActivityUncheckedLocked</span><span class="params">(<span class="keyword">target</span>, targetOptions)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>于是又调用了ActivityStack的resumeTopActivityUncheckedLocked</p>
<blockquote>
<p>frameworks/base/services/core/java/com/android/server/am/ActivityStack.java</p>
</blockquote>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    @<span class="constructor">GuardedBy(<span class="string">&quot;mService&quot;</span>)</span></span><br><span class="line">    boolean resume<span class="constructor">TopActivityUncheckedLocked(ActivityRecord <span class="params">prev</span>, ActivityOptions <span class="params">options</span>)</span> &#123;</span><br><span class="line">       ...</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Protect against recursion.</span></span><br><span class="line">            mStackSupervisor.inResumeTopActivity = <span class="literal">true</span>;</span><br><span class="line">            result = resume<span class="constructor">TopActivityInnerLocked(<span class="params">prev</span>, <span class="params">options</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">       ...</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> boolean resume<span class="constructor">TopActivityInnerLocked(ActivityRecord <span class="params">prev</span>, ActivityOptions <span class="params">options</span>)</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">           mStackSupervisor.start<span class="constructor">SpecificActivityLocked(<span class="params">next</span>, <span class="params">true</span>, <span class="params">true</span>)</span>;</span><br><span class="line">       &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_STACK) mStackSupervisor.validate<span class="constructor">TopActivitiesLocked()</span>;</span><br><span class="line">       return <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>emmmm…..，看到这估计都懵逼了，几个类跳来跳去也不知道干了些什么，不慌，让我们坚持看下ActivityStackSupervisor.startSpecificActivityLocked,因为这个方法很重要。这个方法将是普通Activity和根Activity启动流程的分岔路口。</p>
<blockquote>
<p>ActivityStackSupervisor#startSpecificActivityLocked</p>
</blockquote>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">  <span class="literal">void</span> startSpecificActivityLocked(ActivityRecord r,</span><br><span class="line">          <span class="built_in">boolean</span> andResume, <span class="built_in">boolean</span> checkConfig) &#123;</span><br><span class="line">      <span class="comment">//获取即将要启动的Activity的所在的应用程序进程</span></span><br><span class="line">      ProcessRecord app = mService.getProcessRecordLocked(r.processName,</span><br><span class="line">              r.info.applicationInfo.uid, <span class="literal">true</span>);</span><br><span class="line">      <span class="comment">//如果应用进程已经存在</span></span><br><span class="line">      <span class="keyword">if</span> (app != <span class="built_in">null</span> &amp;&amp; app.<span class="keyword">thread</span> != <span class="built_in">null</span>) &#123;</span><br><span class="line">          try &#123;</span><br><span class="line">              <span class="keyword">if</span> ((r.info.flags&amp;ActivityInfo.FLAG_MULTIPROCESS) == <span class="number">0</span></span><br><span class="line">                      || !<span class="string">&quot;android&quot;</span>.<span class="keyword">equals</span>(r.info.packageName)) &#123;</span><br><span class="line">                  <span class="comment">// Don&#x27;t add this if it is a platform component that is marked</span></span><br><span class="line">                  <span class="comment">// to run in multiple processes, because this is actually</span></span><br><span class="line">                  <span class="comment">// part of the framework so doesn&#x27;t make sense to track as a</span></span><br><span class="line">                  <span class="comment">// separate apk in the process.</span></span><br><span class="line">                  app.addPackage(r.info.packageName, r.info.applicationInfo.longVersionCode,</span><br><span class="line">                          mService.mProcessStats);</span><br><span class="line">              &#125;</span><br><span class="line">              realStartActivityLocked(r, app, andResume, checkConfig);</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125; catch (RemoteException e) &#123;</span><br><span class="line">              Slog.w(<span class="built_in">TAG</span>, <span class="string">&quot;Exception when starting activity &quot;</span></span><br><span class="line">                      + r.intent.getComponent().flattenToShortString(), e);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// If a dead object exception was thrown -- fall through to</span></span><br><span class="line">          <span class="comment">// restart the application.</span></span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//应用进程还未创建，则通过AMS调用startProcessLocked向Zygote进程发送请求</span></span><br><span class="line">      mService.startProcessLocked(r.processName, r.info.applicationInfo, <span class="literal">true</span>, <span class="number">0</span>,</span><br><span class="line">              <span class="string">&quot;activity&quot;</span>, r.intent.getComponent(), <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>阅读上面的代码我们可以知道在方法中首先获取到了即将要启动的Activity所在的应用进程，假如是普通的Activity的启动流程的活，这个进程肯定是存在的，所以将执行realStartActivityLocked的方法。但是我们现在讨论的是根Activity的启动流程，由于应用都还未启动，意味着根Activity所在的应用进程还未创建，而mService其实就是AMS，所以这里将调用AMS的startProcessLocked。于是我们又回到了最初的起点AMS。</p>
<blockquote>
<p>ActivityManagerService.java</p>
</blockquote>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ProcessRecord startProcessLocked(<span class="keyword">String</span> processName,</span><br><span class="line">        ApplicationInfo info, <span class="built_in">boolean</span> knownToBeDead, <span class="built_in">int</span> intentFlags,</span><br><span class="line">        <span class="keyword">String</span> hostingType, ComponentName hostingName, <span class="built_in">boolean</span> allowWhileBooting,</span><br><span class="line">        <span class="built_in">boolean</span> isolated, <span class="built_in">boolean</span> keepIfLarge) &#123;</span><br><span class="line">    <span class="keyword">return</span> startProcessLocked(processName, info, knownToBeDead, intentFlags, hostingType,</span><br><span class="line">            hostingName, allowWhileBooting, isolated, <span class="number">0</span> <span class="comment">/* isolatedUid */</span>, keepIfLarge,</span><br><span class="line">            <span class="keyword">null</span> <span class="comment">/* ABI override */</span>, <span class="keyword">null</span> <span class="comment">/* entryPoint */</span>, <span class="keyword">null</span> <span class="comment">/* entryPointArgs */</span>,</span><br><span class="line">            <span class="keyword">null</span> <span class="comment">/* crashHandler */</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> ProcessRecord startProcessLocked(<span class="keyword">String</span> processName, ApplicationInfo info,</span><br><span class="line">        <span class="built_in">boolean</span> knownToBeDead, <span class="built_in">int</span> intentFlags, <span class="keyword">String</span> hostingType, ComponentName hostingName,</span><br><span class="line">        <span class="built_in">boolean</span> allowWhileBooting, <span class="built_in">boolean</span> isolated, <span class="built_in">int</span> isolatedUid, <span class="built_in">boolean</span> keepIfLarge,</span><br><span class="line">        <span class="keyword">String</span> abiOverride, <span class="keyword">String</span> entryPoint, <span class="keyword">String</span>[] entryPointArgs, Runnable crashHandler) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">boolean</span> success = startProcessLocked(app, hostingType, hostingNameStr, abiOverride);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@GuardedBy(<span class="string">&quot;this&quot;</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="built_in">boolean</span> startProcessLocked(ProcessRecord app,</span><br><span class="line">        <span class="keyword">String</span> hostingType, <span class="keyword">String</span> hostingNameStr, <span class="keyword">String</span> abiOverride) &#123;</span><br><span class="line">    <span class="keyword">return</span> startProcessLocked(app, hostingType, hostingNameStr,</span><br><span class="line">            <span class="keyword">false</span> <span class="comment">/* disableHiddenApiChecks */</span>, abiOverride);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="built_in">boolean</span> startProcessLocked(ProcessRecord app, <span class="keyword">String</span> hostingType,</span><br><span class="line">        <span class="keyword">String</span> hostingNameStr, <span class="built_in">boolean</span> disableHiddenApiChecks, <span class="keyword">String</span> abiOverride) &#123;</span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">        <span class="built_in">int</span> uid = app.uid; <span class="comment">//创建应用进程的用户ID</span></span><br><span class="line">        <span class="built_in">int</span>[] gids = <span class="keyword">null</span>;</span><br><span class="line">        <span class="built_in">int</span> mountExternal = Zygote.MOUNT_EXTERNAL_NONE;</span><br><span class="line">        <span class="keyword">if</span> (!app.isolated) &#123;</span><br><span class="line">            <span class="built_in">int</span>[] permGids = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                checkTime(startTime, <span class="string">&quot;startProcess: getting gids from package manager&quot;</span>);</span><br><span class="line">                <span class="keyword">final</span> IPackageManager pm = AppGlobals.getPackageManager();</span><br><span class="line">                permGids = pm.getPackageGids(app.info.packageName,</span><br><span class="line">                        MATCH_DEBUG_TRIAGED_MISSING, app.userId);</span><br><span class="line">                StorageManagerInternal storageManagerInternal = LocalServices.getService(</span><br><span class="line">                        StorageManagerInternal.class);</span><br><span class="line">                mountExternal = storageManagerInternal.getExternalStorageMountMode(uid,</span><br><span class="line">                        app.info.packageName);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e.rethrowAsRuntimeException();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * 对用户组进行创建和赋值</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (ArrayUtils.isEmpty(permGids)) &#123;</span><br><span class="line">                gids = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">3</span>];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                gids = <span class="keyword">new</span> <span class="built_in">int</span>[permGids.length + <span class="number">3</span>];</span><br><span class="line">                System.arraycopy(permGids, <span class="number">0</span>, gids, <span class="number">3</span>, permGids.length);</span><br><span class="line">            &#125;</span><br><span class="line">            gids[<span class="number">0</span>] = UserHandle.getSharedAppGid(UserHandle.getAppId(uid));</span><br><span class="line">            gids[<span class="number">1</span>] = UserHandle.getCacheAppGid(UserHandle.getAppId(uid));</span><br><span class="line">            gids[<span class="number">2</span>] = UserHandle.getUserGid(UserHandle.getUserId(uid));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Replace any invalid GIDs</span></span><br><span class="line">            <span class="keyword">if</span> (gids[<span class="number">0</span>] == UserHandle.ERR_GID) gids[<span class="number">0</span>] = gids[<span class="number">2</span>];</span><br><span class="line">            <span class="keyword">if</span> (gids[<span class="number">1</span>] == UserHandle.ERR_GID) gids[<span class="number">1</span>] = gids[<span class="number">2</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//这个参数后文会提到</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">String</span> entryPoint = <span class="string">&quot;android.app.ActivityThread&quot;</span>;    </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> startProcessLocked(hostingType, hostingNameStr, entryPoint, app, uid, gids,</span><br><span class="line">                runtimeFlags, mountExternal, seInfo, requiredAbi, instructionSet, invokeWith,</span><br><span class="line">                startTime);        </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="built_in">boolean</span> startProcessLocked(<span class="keyword">String</span> hostingType, <span class="keyword">String</span> hostingNameStr, <span class="keyword">String</span> entryPoint,</span><br><span class="line">        ProcessRecord app, <span class="built_in">int</span> uid, <span class="built_in">int</span>[] gids, <span class="built_in">int</span> runtimeFlags, <span class="built_in">int</span> mountExternal,</span><br><span class="line">        <span class="keyword">String</span> seInfo, <span class="keyword">String</span> requiredAbi, <span class="keyword">String</span> instructionSet, <span class="keyword">String</span> invokeWith,</span><br><span class="line">        <span class="keyword">long</span> startTime) &#123;</span><br><span class="line">    ....</span><br><span class="line">	<span class="comment">//重点关注</span></span><br><span class="line">                <span class="keyword">final</span> ProcessStartResult startResult = startProcess(app.hostingType, entryPoint,</span><br><span class="line">                        app, app.startUid, gids, runtimeFlags, mountExternal, app.seInfo,</span><br><span class="line">                        requiredAbi, instructionSet, invokeWith, app.startTime);</span><br><span class="line">          </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ProcessStartResult startProcess(<span class="keyword">String</span> hostingType, <span class="keyword">String</span> entryPoint,</span><br><span class="line">        ProcessRecord app, <span class="built_in">int</span> uid, <span class="built_in">int</span>[] gids, <span class="built_in">int</span> runtimeFlags, <span class="built_in">int</span> mountExternal,</span><br><span class="line">        <span class="keyword">String</span> seInfo, <span class="keyword">String</span> requiredAbi, <span class="keyword">String</span> instructionSet, <span class="keyword">String</span> invokeWith,</span><br><span class="line">        <span class="keyword">long</span> startTime) &#123;</span><br><span class="line">        ....</span><br><span class="line">        <span class="keyword">if</span> (hostingType.equals(<span class="string">&quot;webview_service&quot;</span>)) &#123;</span><br><span class="line">            startResult = startWebView(entryPoint,</span><br><span class="line">                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,</span><br><span class="line">                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class="line">                    app.info.dataDir, <span class="keyword">null</span>,</span><br><span class="line">                    <span class="keyword">new</span> <span class="keyword">String</span>[] &#123;PROC_START_SEQ_IDENT + app.startSeq&#125;);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">			</span><br><span class="line"><span class="comment">//通过Process.start方法来为应用创建进程</span></span><br><span class="line">            startResult = Process.start(entryPoint,</span><br><span class="line">                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,</span><br><span class="line">                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class="line">                    app.info.dataDir, invokeWith,</span><br><span class="line">                    <span class="keyword">new</span> <span class="keyword">String</span>[] &#123;PROC_START_SEQ_IDENT + app.startSeq&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        checkTime(startTime, <span class="string">&quot;startProcess: returned from zygote!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> startResult;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过调用多个startProcessLocked方法后最终将调用startProcess方法，不过需要重点看一下上面的第四个startProcessLocked，在该方法中有个entryPoint参数为 “android.app.ActivityThread”，这个参数将在后文讲到创建应用进程后启动ActivityThread会用到。然后在startProcess方法里将调用Process.start来发送应用创建进程的请求。这样AMS就将发送请求的事交给了Process</p>
<h3 id="2-2-Process向Zygote进程发送创建应用进程请求"><a href="#2-2-Process向Zygote进程发送创建应用进程请求" class="headerlink" title="2.2 Process向Zygote进程发送创建应用进程请求"></a>2.2 Process向Zygote进程发送创建应用进程请求</h3><blockquote>
<p>frameworks/base/core/java/android/os/Process.java</p>
</blockquote>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ProcessStartResult <span class="title">start</span><span class="params">(<span class="keyword">final</span> <span class="keyword">String</span> processClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">final</span> <span class="keyword">String</span> niceName,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> uid, <span class="keyword">int</span> gid, <span class="keyword">int</span>[] gids,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> runtimeFlags, <span class="keyword">int</span> mountExternal,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">int</span> targetSdkVersion,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">String</span> seInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">String</span> abi,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">String</span> instructionSet,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">String</span> appDataDir,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">String</span> invokeWith,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">String</span>[] zygoteArgs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ZYGOTE_PROCESS.<span class="built_in">start</span>(processClass, niceName, uid, gid, gids,</span><br><span class="line">                runtimeFlags, mountExternal, targetSdkVersion, seInfo,</span><br><span class="line">                abi, instructionSet, appDataDir, invokeWith,</span><br><span class="line">                <span class="comment">/*useBlastulaPool=*/</span> <span class="literal">true</span>, zygoteArgs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="built_in">Process</span>.<span class="function">ProcessStartResult <span class="title">start</span><span class="params">(<span class="keyword">final</span> <span class="keyword">String</span> processClass,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">final</span> <span class="keyword">String</span> niceName,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">int</span> uid, <span class="keyword">int</span> gid, <span class="keyword">int</span>[] gids,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">int</span> runtimeFlags, <span class="keyword">int</span> mountExternal,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">int</span> targetSdkVersion,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">String</span> seInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">String</span> abi,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">String</span> instructionSet,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">String</span> appDataDir,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">String</span> invokeWith,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">boolean</span> useBlastulaPool,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">String</span>[] zygoteArgs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//重点关注</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">startViaZygote</span>(processClass, niceName, uid, gid, gids,</span><br><span class="line">                runtimeFlags, mountExternal, targetSdkVersion, seInfo,</span><br><span class="line">                abi, instructionSet, appDataDir, invokeWith,</span><br><span class="line">                <span class="comment">/*startChildZygote=*/</span><span class="literal">false</span>,</span><br><span class="line">                useBlastulaPool, zygoteArgs);</span><br><span class="line">    &#125; <span class="built_in"><span class="keyword">catch</span></span> (ZygoteStartFailedEx ex) &#123;</span><br><span class="line">        Log.<span class="built_in">e</span>(LOG_TAG,</span><br><span class="line">                <span class="string">&quot;Starting VM process through Zygote failed&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(</span><br><span class="line">                <span class="string">&quot;Starting VM process through Zygote failed&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从上面可以发现，Process中的start方法的实现是startViaZygote方法，所以我们重点观察下这个方法。</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Process.ProcessStartResult startViaZygote(<span class="keyword">final</span> <span class="keyword">String</span> processClass,</span><br><span class="line">                                                  <span class="keyword">final</span> <span class="keyword">String</span> niceName,</span><br><span class="line">                                                  <span class="keyword">final</span> <span class="built_in">int</span> uid, <span class="keyword">final</span> <span class="built_in">int</span> gid,</span><br><span class="line">                                                  <span class="keyword">final</span> <span class="built_in">int</span>[] gids,</span><br><span class="line">                                                  <span class="built_in">int</span> runtimeFlags, <span class="built_in">int</span> mountExternal,</span><br><span class="line">                                                  <span class="built_in">int</span> targetSdkVersion,</span><br><span class="line">                                                  <span class="keyword">String</span> seInfo,</span><br><span class="line">                                                  <span class="keyword">String</span> abi,</span><br><span class="line">                                                  <span class="keyword">String</span> instructionSet,</span><br><span class="line">                                                  <span class="keyword">String</span> appDataDir,</span><br><span class="line">                                                  <span class="keyword">String</span> invokeWith,</span><br><span class="line">                                                  <span class="built_in">boolean</span> startChildZygote,</span><br><span class="line">                                                  <span class="built_in">boolean</span> useBlastulaPool,</span><br><span class="line">                                                  <span class="keyword">String</span>[] extraArgs)</span><br><span class="line">                                                  <span class="keyword">throws</span> ZygoteStartFailedEx &#123;</span><br><span class="line">    ArrayList&lt;<span class="keyword">String</span>&gt; argsForZygote = <span class="keyword">new</span> ArrayList&lt;<span class="keyword">String</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --runtime-args, --setuid=, --setgid=,</span></span><br><span class="line">    <span class="comment">//创建字符串列表argsForZygote，并将启动应用进程的启动参数保存在这个列表中</span></span><br><span class="line">    argsForZygote.<span class="built_in">add</span>(<span class="string">&quot;--runtime-args&quot;</span>);</span><br><span class="line">    argsForZygote.<span class="built_in">add</span>(<span class="string">&quot;--setuid=&quot;</span> + uid);</span><br><span class="line">    argsForZygote.<span class="built_in">add</span>(<span class="string">&quot;--setgid=&quot;</span> + gid);</span><br><span class="line">    argsForZygote.<span class="built_in">add</span>(<span class="string">&quot;--runtime-flags=&quot;</span> + runtimeFlags);</span><br><span class="line">    <span class="keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_DEFAULT) &#123;</span><br><span class="line">        argsForZygote.<span class="built_in">add</span>(<span class="string">&quot;--mount-external-default&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_READ) &#123;</span><br><span class="line">        argsForZygote.<span class="built_in">add</span>(<span class="string">&quot;--mount-external-read&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_WRITE) &#123;</span><br><span class="line">        argsForZygote.<span class="built_in">add</span>(<span class="string">&quot;--mount-external-write&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    argsForZygote.<span class="built_in">add</span>(<span class="string">&quot;--target-sdk-version=&quot;</span> + targetSdkVersion);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">synchronized</span>(mLock) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//重点关注</span></span><br><span class="line">        <span class="keyword">return</span> zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi),</span><br><span class="line">                                          useBlastulaPool,</span><br><span class="line">                                          argsForZygote);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在startViaZygote中会创建字符串列表argsForZygote来保存将要创建的应用进程的启动参数，然后最后会调用zygoteSendArgsAndGetResult方法，而在这个方法中第一个参数会调用openZygoteSocketIfNeeded方法，第三个参数就是启动参数列表。所以我们先看看openZygoteSocketIfNeeded这个方法的实现。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> ZygoteState <span class="keyword">open</span><span class="constructor">ZygoteSocketIfNeeded(String <span class="params">abi</span>)</span></span><br><span class="line">          throws ZygoteStartFailedEx &#123;</span><br><span class="line"></span><br><span class="line">      <span class="module-access"><span class="module"><span class="identifier">Preconditions</span>.</span></span>check<span class="constructor">State(Thread.<span class="params">holdsLock</span>(<span class="params">mLock</span>)</span>, <span class="string">&quot;ZygoteProcess lock not held&quot;</span>);</span><br><span class="line"><span class="comment">//64位进程中的</span></span><br><span class="line">      <span class="keyword">if</span> (primaryZygoteState<span class="operator"> == </span>null<span class="operator"> || </span>primaryZygoteState.is<span class="constructor">Closed()</span>) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	    <span class="comment">//调用ZygoteState的connect函数与mZygoteSocketAddress建立连接，</span></span><br><span class="line">              <span class="comment">//这里mZygoteSocketAddress的值为“zygote”</span></span><br><span class="line">              primaryZygoteState =</span><br><span class="line">                  <span class="module-access"><span class="module"><span class="identifier">ZygoteState</span>.</span></span>connect(mZygoteSocketAddress, mBlastulaPoolSocketAddress);</span><br><span class="line">          &#125; catch (IOException ioe) &#123;</span><br><span class="line">              throw <span class="keyword">new</span> <span class="constructor">ZygoteStartFailedEx(<span class="string">&quot;Error connecting to primary zygote&quot;</span>, <span class="params">ioe</span>)</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          maybe<span class="constructor">SetApiBlacklistExemptions(<span class="params">primaryZygoteState</span>, <span class="params">false</span>)</span>;</span><br><span class="line">          maybe<span class="constructor">SetHiddenApiAccessLogSampleRate(<span class="params">primaryZygoteState</span>)</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (primaryZygoteState.matches(abi)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Socket进行连接成功并匹配abi后会返回ZygoteState类型对象</span></span><br><span class="line">          return primaryZygoteState;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 32位Zygote进程中</span></span><br><span class="line">      <span class="keyword">if</span> (secondaryZygoteState<span class="operator"> == </span>null<span class="operator"> || </span>secondaryZygoteState.is<span class="constructor">Closed()</span>) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              secondaryZygoteState =</span><br><span class="line">                  <span class="module-access"><span class="module"><span class="identifier">ZygoteState</span>.</span></span>connect(mZygoteSecondarySocketAddress,</span><br><span class="line">                                      mBlastulaPoolSecondarySocketAddress);</span><br><span class="line">          &#125; catch (IOException ioe) &#123;</span><br><span class="line">              throw <span class="keyword">new</span> <span class="constructor">ZygoteStartFailedEx(<span class="string">&quot;Error connecting to secondary zygote&quot;</span>, <span class="params">ioe</span>)</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          maybe<span class="constructor">SetApiBlacklistExemptions(<span class="params">secondaryZygoteState</span>, <span class="params">false</span>)</span>;</span><br><span class="line">          maybe<span class="constructor">SetHiddenApiAccessLogSampleRate(<span class="params">secondaryZygoteState</span>)</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (secondaryZygoteState.matches(abi)) &#123;</span><br><span class="line">          return secondaryZygoteState;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      throw <span class="keyword">new</span> <span class="constructor">ZygoteStartFailedEx(<span class="string">&quot;Unsupported zygote ABI: &quot;</span> + <span class="params">abi</span>)</span>;</span><br><span class="line">  &#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>openZygoteSocketIfNeeded这个方法从方法名就可以推测出这个方法的作用，大概就是与Zygote建立Socket连接。而从代码中也证实了这一点，在代码中会根据Zygote进程的位数来建立相应的Socket连接，然后返回ZygoteState类型的对象。既然与Zygote建立好Socket连接后，接下来当然是发送请求！我们来看看zygoteSendArgsAndGetResult这个方法中是如何发送请求的！</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将传入的应用进程的启动参数argsForZygote写入到ZygoteState</span></span><br><span class="line">   @<span class="built_in">GuardedBy</span>(<span class="string">&quot;mLock&quot;</span>)</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">Process</span>.<span class="function">ProcessStartResult <span class="title">zygoteSendArgsAndGetResult</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">           ZygoteState zygoteState, <span class="keyword">boolean</span> useBlastulaPool, ArrayList&lt;<span class="keyword">String</span>&gt; args)</span></span></span><br><span class="line"><span class="function">           throws ZygoteStartFailedEx </span>&#123;</span><br><span class="line">       <span class="keyword">String</span> msgStr = Integer.<span class="built_in">toString</span>(args.<span class="built_in">size</span>()) + <span class="string">&quot;\n&quot;</span></span><br><span class="line">                       + <span class="keyword">String</span>.<span class="built_in">join</span>(<span class="string">&quot;\n&quot;</span>, args) + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Should there be a timeout on this?</span></span><br><span class="line">       <span class="built_in">Process</span>.ProcessStartResult result = <span class="keyword">new</span> <span class="built_in">Process</span>.<span class="built_in">ProcessStartResult</span>();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// TODO (chriswailes): Move branch body into separate function.</span></span><br><span class="line">       <span class="keyword">if</span> (useBlastulaPool &amp;&amp; Zygote.BLASTULA_POOL_ENABLED &amp;&amp; <span class="built_in">isValidBlastulaCommand</span>(args)) &#123;</span><br><span class="line">           LocalSocket blastulaSessionSocket = null;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               blastulaSessionSocket = zygoteState.<span class="built_in">getBlastulaSessionSocket</span>();</span><br><span class="line"></span><br><span class="line">               <span class="keyword">final</span> BufferedWriter blastulaWriter =</span><br><span class="line">                       <span class="keyword">new</span> <span class="built_in">BufferedWriter</span>(</span><br><span class="line">                               <span class="keyword">new</span> <span class="built_in">OutputStreamWriter</span>(blastulaSessionSocket.<span class="built_in">getOutputStream</span>()),</span><br><span class="line">                               Zygote.SOCKET_BUFFER_SIZE);</span><br><span class="line">               <span class="keyword">final</span> DataInputStream blastulaReader =</span><br><span class="line">                       <span class="keyword">new</span> <span class="built_in">DataInputStream</span>(blastulaSessionSocket.<span class="built_in">getInputStream</span>());</span><br><span class="line"></span><br><span class="line">               blastulaWriter.<span class="built_in">write</span>(msgStr);</span><br><span class="line">               blastulaWriter.<span class="built_in">flush</span>();</span><br><span class="line"></span><br><span class="line">               result.pid = blastulaReader.<span class="built_in">readInt</span>();</span><br><span class="line">               <span class="comment">// Blastulas can&#x27;t be used to spawn processes that need wrappers.</span></span><br><span class="line">               result.usingWrapper = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (result.pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">ZygoteStartFailedEx</span>(<span class="string">&quot;Blastula specialization failed&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">return</span> result;</span><br><span class="line">           &#125; <span class="built_in"><span class="keyword">catch</span></span> (IOException ex) &#123;</span><br><span class="line">               <span class="comment">// If there was an IOException using the blastula pool we will log the error and</span></span><br><span class="line">               <span class="comment">// attempt to start the process through the Zygote.</span></span><br><span class="line">               Log.<span class="built_in">e</span>(LOG_TAG, <span class="string">&quot;IO Exception while communicating with blastula pool - &quot;</span></span><br><span class="line">                              + ex.<span class="built_in">toString</span>());</span><br><span class="line">           &#125; finally &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   blastulaSessionSocket.<span class="built_in">close</span>();</span><br><span class="line">               &#125; <span class="built_in"><span class="keyword">catch</span></span> (IOException ex) &#123;</span><br><span class="line">                   Log.<span class="built_in">e</span>(LOG_TAG, <span class="string">&quot;Failed to close blastula session socket: &quot;</span> + ex.<span class="built_in">getMessage</span>());</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">final</span> BufferedWriter zygoteWriter = zygoteState.mZygoteOutputWriter;</span><br><span class="line">           <span class="keyword">final</span> DataInputStream zygoteInputStream = zygoteState.mZygoteInputStream;</span><br><span class="line"></span><br><span class="line">           zygoteWriter.<span class="built_in">write</span>(msgStr);</span><br><span class="line">           zygoteWriter.<span class="built_in">flush</span>();</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Always read the entire result from the input stream to avoid leaving</span></span><br><span class="line">           <span class="comment">// bytes in the stream for future process starts to accidentally stumble</span></span><br><span class="line">           <span class="comment">// upon.</span></span><br><span class="line">           result.pid = zygoteInputStream.<span class="built_in">readInt</span>();</span><br><span class="line">           result.usingWrapper = zygoteInputStream.<span class="built_in">readBoolean</span>();</span><br><span class="line">       &#125; <span class="built_in"><span class="keyword">catch</span></span> (IOException ex) &#123;</span><br><span class="line">           zygoteState.<span class="built_in">close</span>();</span><br><span class="line">           Log.<span class="built_in">e</span>(LOG_TAG, <span class="string">&quot;IO Exception while communicating with Zygote - &quot;</span></span><br><span class="line">                   + ex.<span class="built_in">toString</span>());</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">ZygoteStartFailedEx</span>(ex);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (result.pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">ZygoteStartFailedEx</span>(<span class="string">&quot;fork() failed&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因为在openZygoteSocketIfNeeded中我们已经与Zygote进程建立了Socket连接，所以在这个方法中将传入的应用进程的启动参数argsForZygote写入到ZygoteState。这样AMS就完成了向Zygote进程发送创建应用进程的请求的任务。</p>
<h1 id="三、Zygote进程接受请求并孵化应用进程"><a href="#三、Zygote进程接受请求并孵化应用进程" class="headerlink" title="三、Zygote进程接受请求并孵化应用进程"></a>三、Zygote进程接受请求并孵化应用进程</h1><p>从上面我们知道，AMS已经与Zygote进程建立Socket连接并发送了创建应用进程的请求，那么Zygote进程是在哪里收到请求，收到请求后又是怎么处理的呢？通过阅读后我们知道Zygote进程是在ZygoteInit的main方法中接受请求的。所以现在的入口就是ZygoteInit的main方法。</p>
<h2 id="1-时序图-2"><a href="#1-时序图-2" class="headerlink" title="1. 时序图"></a>1. 时序图</h2><p><img src="/2020/01/18/ActivityStart01/RootActivityStart02.png" alt="在这里插入图片描述"></p>
<h2 id="2-详细过程-2"><a href="#2-详细过程-2" class="headerlink" title="2. 详细过程"></a>2. 详细过程</h2><p>从时序图与上面的分析我们知道现在Zygote进程接受请求是在main方法，就让我们来看看这个main方法</p>
<blockquote>
<p>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</p>
</blockquote>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    public static void main(String argv<span class="literal">[]</span>) &#123;</span><br><span class="line">        ZygoteServer zygoteServer = <span class="keyword">new</span> <span class="constructor">ZygoteServer()</span>;</span><br><span class="line">        Runnable caller;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">			<span class="comment">//创建名为zygote的Socket</span></span><br><span class="line">            zygoteServer.create<span class="constructor">ZygoteSocket(<span class="params">socketName</span>)</span>;</span><br><span class="line">            ....</span><br><span class="line">			<span class="comment">//由于在init.rc中设置了start-system-server参数,因此</span></span><br><span class="line">			<span class="comment">//这里将启动SystemServer,可见SystemServer由Zygote创建的第一个进程</span></span><br><span class="line">            <span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">                Runnable r = fork<span class="constructor">SystemServer(<span class="params">abiList</span>, <span class="params">socketName</span>, <span class="params">zygoteServer</span>)</span>;</span><br><span class="line">                <span class="keyword">if</span> (r != null) &#123;</span><br><span class="line">                    r.run<span class="literal">()</span>;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">           </span><br><span class="line">            caller = <span class="module-access"><span class="module"><span class="identifier">Zygote</span>.</span></span>init<span class="constructor">BlastulaPool()</span>;</span><br><span class="line">            <span class="keyword">if</span> (caller<span class="operator"> == </span>null) &#123;</span><br><span class="line">                <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>i(TAG, <span class="string">&quot;Accepting command socket connections&quot;</span>);</span><br><span class="line">                <span class="comment">//等待AMS的请求</span></span><br><span class="line">                run<span class="constructor">SelectLoop(<span class="params">abiList</span>)</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Throwable ex) &#123;</span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span></span>e(TAG, <span class="string">&quot;System zygote died with exception&quot;</span>, ex);</span><br><span class="line">            throw ex;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            zygoteServer.close<span class="constructor">ServerSocket()</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We&#x27;re in the child process and have exited the select loop. Proceed to execute the</span></span><br><span class="line">        <span class="comment">// command.</span></span><br><span class="line">        <span class="keyword">if</span> (caller != null) &#123;</span><br><span class="line">            caller.run<span class="literal">()</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>通过main方法，我们可以知道在这个main方法首先要创建一个Server端的Socket，这个name为”zygote”的Socket用来等待ActivityManagerService来请求Zygote来创建新的应用程序进程,在上面AMS请求的分析中我们也知道客户端将根据这个name来与Zygote的Socket建立连接。接下去会启动SystemServer进程，这个进程会启动各种系统服务，比如与Activity启动息息相关的AMS。最后会调用ZygoteServer.runSelectLoop(abiList)来使创建的Socket进入无限循环，等待AMS请求。让我们来看看这个runSelectLoop</p>
<blockquote>
<p>frameworks/base/core/java/com/android/internal/os/ZygoteServer.java</p>
</blockquote>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">    Runnable runSelectLoop(<span class="keyword">String</span> abiList) &#123;</span><br><span class="line">   </span><br><span class="line">        ArrayList&lt;ZygoteConnection&gt; peers = <span class="keyword">new</span> <span class="type">ArrayList</span>&lt;ZygoteConnection&gt;();</span><br><span class="line">        peers.add(<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (--pollIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((pollFDs[pollIndex].revents &amp; POLLIN) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (pollIndex == <span class="number">0</span>) &#123;</span><br><span class="line">				  <span class="comment">//监听Socket连接，充当服务端Socket</span></span><br><span class="line">                    ZygoteConnection <span class="keyword">new</span><span class="type">Peer</span> = acceptCommandPeer(abiList);</span><br><span class="line">                    peers.add(<span class="keyword">new</span><span class="type">Peer</span>);</span><br><span class="line">                    socketFDs.add(<span class="keyword">new</span><span class="type">Peer</span>.getFileDescriptor());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pollIndex &lt; blastulaPoolEventFDIndex) &#123; </span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">						<span class="comment">//不断处理客户端的AMS的请求，然后交给processOneCommand</span></span><br><span class="line">                        ZygoteConnection connection = peers.<span class="keyword">get</span>(pollIndex);</span><br><span class="line">                        final Runnable command = connection.processOneCommand(<span class="built_in">this</span>);</span><br><span class="line">                    &#125; </span><br><span class="line">                    ....</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>可以发现这个方法是死循环表示不停的监听着Socket连接。acceptCommandPeer方法就是监听是否收到了请求，如果收到了请求就交给processOneCommand来实现</p>
<blockquote>
<p>frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">    Runnable <span class="function"><span class="title">processOneCommand</span>(<span class="params">ZygoteServer zygoteServer</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">String</span> args[];</span><br><span class="line">        ZygoteArguments parsedArgs = <span class="literal">null</span>;</span><br><span class="line">        FileDescriptor[] descriptors;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">		    <span class="comment">//获取应用程序进程的启动参数</span></span><br><span class="line">            args = Zygote.readArgumentList(mSocketReader);</span><br><span class="line">            <span class="comment">// TODO (chriswailes): Remove this and add an assert.</span></span><br><span class="line">            descriptors = mSocket.getAncillaryFileDescriptors();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;IOException on command socket&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        ....</span><br><span class="line">        parsedArgs = <span class="keyword">new</span> ZygoteArguments(args);</span><br><span class="line">        ....</span><br><span class="line">		<span class="comment">//fork当前进程创建一个子进程</span></span><br><span class="line">        pid = Zygote.forkAndSpecialize(parsedArgs.mUid, parsedArgs.mGid, parsedArgs.mGids,</span><br><span class="line">                parsedArgs.mRuntimeFlags, rlimits, parsedArgs.mMountExternal, parsedArgs.mSeInfo,</span><br><span class="line">                parsedArgs.mNiceName, fdsToClose, fdsToIgnore, parsedArgs.mStartChildZygote,</span><br><span class="line">                parsedArgs.mInstructionSet, parsedArgs.mAppDataDir, parsedArgs.mTargetSdkVersion);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">		    <span class="comment">//pid为0则代表这个进程为子进程，即新创建的应用程序进程</span></span><br><span class="line">            <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">                zygoteServer.setForkChild();</span><br><span class="line">                zygoteServer.closeServerSocket();</span><br><span class="line">                IoUtils.closeQuietly(serverPipeFd);</span><br><span class="line">                serverPipeFd = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> handleChildProc(parsedArgs, descriptors, childPipeFd,</span><br><span class="line">                        parsedArgs.mStartChildZygote);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// In the parent. A pid &lt; 0 indicates a failure and will be handled in</span></span><br><span class="line">                <span class="comment">// handleParentProc.</span></span><br><span class="line">                IoUtils.closeQuietly(childPipeFd);</span><br><span class="line">                childPipeFd = <span class="literal">null</span>;</span><br><span class="line">                handleParentProc(pid, descriptors, serverPipeFd);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            IoUtils.closeQuietly(childPipeFd);</span><br><span class="line">            IoUtils.closeQuietly(serverPipeFd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>在这个方法中将对请求进行处理，首先获取到将要启动的应用进程的启动参数，然后调用forkAndSpecialize来创建应用进程。</p>
<blockquote>
<p>frameworks/base/core/java/com/android/internal/os/Zygote.java</p>
</blockquote>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">forkAndSpecialize</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> gid, <span class="keyword">int</span>[] gids, <span class="keyword">int</span> runtimeFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span>[][] rlimits, <span class="keyword">int</span> mountExternal, <span class="keyword">String</span> seInfo, <span class="keyword">String</span> niceName, <span class="keyword">int</span>[] fdsToClose,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span>[] fdsToIgnore, <span class="keyword">boolean</span> startChildZygote, <span class="keyword">String</span> instructionSet, <span class="keyword">String</span> appDataDir,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> targetSdkVersion)</span> </span>&#123;</span><br><span class="line">        ZygoteHooks.<span class="built_in">preFork</span>();</span><br><span class="line">        <span class="comment">// Resets nice priority for zygote process.</span></span><br><span class="line">        <span class="built_in">resetNicePriority</span>();</span><br><span class="line">        <span class="keyword">int</span> pid = <span class="built_in">nativeForkAndSpecialize</span>(</span><br><span class="line">                uid, gid, gids, runtimeFlags, rlimits, mountExternal, seInfo, niceName, fdsToClose,</span><br><span class="line">                fdsToIgnore, startChildZygote, instructionSet, appDataDir);</span><br><span class="line">        <span class="comment">// Enable tracing as soon as possible for the child process.</span></span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">            Zygote.<span class="built_in">disableExecuteOnly</span>(targetSdkVersion);</span><br><span class="line">            Trace.<span class="built_in">setTracingEnabled</span>(<span class="literal">true</span>, runtimeFlags);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Note that this event ends at the end of handleChildProc,</span></span><br><span class="line">            Trace.<span class="built_in">traceBegin</span>(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;PostFork&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ZygoteHooks.<span class="built_in">postForkCommon</span>();</span><br><span class="line">        <span class="keyword">return</span> pid;</span><br><span class="line">    &#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>在forkAndSpecialize中，最终将创建应用进程的任务交给nativeForkAndSpecialize，而这个方法可以看出来应该是本地方法，所以具体如何创建的我们就不深究了，在这里我们这需要知道nativeForkAndSpecialize最终是通过fork当前线程来创建一个子线程，而fork后会有返回值给pid:</p>
<ul>
<li>父进程中，fork返回新创建的子进程pid;</li>
<li>子进程中，fork返回0；</li>
<li>出现错误时，fork返回负数。</li>
</ul>
<p>于是到这里子线程也就是应用进程就被孵化出来了。你以为这样就结束了？其实还早呢！别忘了我们的最终使命是根Activity的启动，而现在只是有了根Activity所需要的应用进程，革命尚未成功，仍需要努力！</p>
<h1 id="四、应用进程启动ActivityThread"><a href="#四、应用进程启动ActivityThread" class="headerlink" title="四、应用进程启动ActivityThread"></a>四、应用进程启动ActivityThread</h1><h2 id="1-时序图-3"><a href="#1-时序图-3" class="headerlink" title="1. 时序图"></a>1. 时序图</h2><p><img src="/2020/01/18/ActivityStart01/RootActivityStart03.png" alt="在这里插入图片描述"></p>
<h2 id="2-详细过程-3"><a href="#2-详细过程-3" class="headerlink" title="2. 详细过程"></a>2. 详细过程</h2><p>从上面我们知道应用进程已经被创建，那创建后呢？这就需要我们回头看上面的processOneCommand方法，细心的你肯定会发现再孵化出应用进程后，还是有返回值的。</p>
<blockquote>
<p>frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</p>
</blockquote>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">  Runnable processOneCommand<span class="params">(ZygoteServer zygoteServer)</span> &#123;</span><br><span class="line">      <span class="string">....</span></span><br><span class="line"><span class="string">//fork</span>当前进程创建一个子进程</span><br><span class="line">      pid = Zygote.forkAndSpecialize<span class="params">(parsedArgs.mUid, parsedArgs.mGid, parsedArgs.mGids,</span></span><br><span class="line"><span class="params">              parsedArgs.mRuntimeFlags, rlimits, parsedArgs.mMountExternal, parsedArgs.mSeInfo,</span></span><br><span class="line"><span class="params">              parsedArgs.mNiceName, fdsToClose, fdsToIgnore, parsedArgs.mStartChildZygote,</span></span><br><span class="line"><span class="params">              parsedArgs.mInstructionSet, parsedArgs.mAppDataDir, parsedArgs.mTargetSdkVersion)</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="string">//pid</span>为0则代表这个进程为子进程，即新创建的应用程序进程</span><br><span class="line">          <span class="keyword">if</span> <span class="params">(<span class="attr">pid</span> == 0)</span> &#123;</span><br><span class="line">              <span class="string">....</span></span><br><span class="line">              return handleChildProc<span class="params">(parsedArgs, descriptors, childPipeFd,</span></span><br><span class="line"><span class="params">                      parsedArgs.mStartChildZygote)</span>;</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">              <span class="string">...</span></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="string">....</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在上面我们分析了当pid=0的时候，则代表了当前进程已经是子进程了，即应用进程。所以下一步将执行handleChildProc方法。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Runnable handleChildProc(ZygoteArguments parsedArgs, FileDescriptor[] descriptors,</span><br><span class="line">        FileDescriptor pipeFd, <span class="keyword">boolean</span> isZygote) &#123;</span><br><span class="line">        .....</span><br><span class="line">        <span class="keyword">if</span> (!isZygote) &#123;</span><br><span class="line">            <span class="keyword">return</span> ZygoteInit.zygoteInit(parsedArgs.mTargetSdkVersion,</span><br><span class="line">                    parsedArgs.mRemainingArgs, <span class="keyword">null</span> <span class="comment">/* classLoader */</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           ....</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>而handleChildProc最终又会调用ZygoteInit.zygoteInit方法。如下</p>
<blockquote>
<p>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</p>
</blockquote>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  <span class="selector-tag">public</span> <span class="selector-tag">static</span> <span class="selector-tag">final</span> <span class="selector-tag">Runnable</span> <span class="selector-tag">zygoteInit</span>(int targetSdkVersion, String[] argv,</span><br><span class="line">          ClassLoader classLoader) &#123;</span><br><span class="line">      <span class="selector-tag">if</span> (RuntimeInit.DEBUG) &#123;</span><br><span class="line">          <span class="selector-tag">Slog</span><span class="selector-class">.d</span>(RuntimeInit.TAG, <span class="string">&quot;RuntimeInit: Starting application from zygote&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="selector-tag">Trace</span><span class="selector-class">.traceBegin</span>(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;ZygoteInit&quot;</span>);</span><br><span class="line">      <span class="selector-tag">RuntimeInit</span><span class="selector-class">.redirectLogStreams</span>();</span><br><span class="line"><span class="comment">//为当前的VM设置未捕获异常器</span></span><br><span class="line">      <span class="selector-tag">RuntimeInit</span><span class="selector-class">.commonInit</span>();</span><br><span class="line"><span class="comment">//Binder驱动初始化，该方法完成后，可通过Binder进行进程通信</span></span><br><span class="line">      <span class="selector-tag">ZygoteInit</span><span class="selector-class">.nativeZygoteInit</span>();</span><br><span class="line"><span class="comment">//主要调用SystemServer的main方法</span></span><br><span class="line">      <span class="selector-tag">return</span> <span class="selector-tag">RuntimeInit</span><span class="selector-class">.applicationInit</span>(targetSdkVersion, argv, classLoader);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在这个方法里会创建当前进程的Binder线程池，便于后续与其它进程通信，然后调用了RuntimeInit的applicationInit方法，如下：</p>
<blockquote>
<p>frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</p>
</blockquote>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> Runnable <span class="title">applicationInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, <span class="keyword">String</span>[] argv,</span></span></span><br><span class="line"><span class="function"><span class="params">         ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">     ...</span><br><span class="line">     <span class="keyword">final</span> Arguments args = <span class="keyword">new</span> <span class="built_in">Arguments</span>(argv);</span><br><span class="line">     <span class="comment">// Remaining arguments are passed to the start class&#x27;s static main</span></span><br><span class="line">     <span class="keyword">return</span> <span class="built_in">findStaticMain</span>(args.startClass, args.startArgs, classLoader);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个方法最终会调用findStaticMain方法，不过需注意的是方法的第一个参数args.startClass其实就是我们上文AMS将请求任务转移给Process中在最后强调的那个参数：android.app.ActivityThread。然后我们看看findStaticMain的实现</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="built_in">static</span> Runnable findStaticMain(<span class="keyword">String</span> className, <span class="keyword">String</span>[] argv,</span><br><span class="line">        ClassLoader classLoader) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">Class</span>&lt;?&gt; <span class="title">cl</span>;</span></span><br><span class="line"><span class="class">    <span class="title">try</span> </span>&#123;</span><br><span class="line">        cl = <span class="keyword">Class</span>.forName(className, <span class="literal">true</span>, classLoader);<span class="comment">//1</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">       ....</span><br><span class="line">    &#125;</span><br><span class="line">    Method m;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        m = cl.getMethod(<span class="string">&quot;main&quot;</span>, <span class="keyword">new</span> <span class="class"><span class="keyword">Class</span>[] </span>&#123; <span class="keyword">String</span>[].<span class="keyword">class</span> &#125;);<span class="comment">//2</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SecurityException ex) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MethodAndArgsCaller(m, argv);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在这个方法中首先在注释1通过反射获取到android.app.ActivityThread类，然后在注释2获取到ActivityThread的main方法，最后通过main方法来构造MethodAndArgsCaller。而这个MethodAndArgsCaller是什么呢？如下：</p>
<blockquote>
<p>frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodAndArgsCaller</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="comment">/** method to call */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Method mMethod;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** argument array */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">String</span>[] mArgs;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> MethodAndArgsCaller(Method method, <span class="keyword">String</span>[] args) &#123;</span><br><span class="line">            mMethod = method;</span><br><span class="line">            mArgs = args;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> run() &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mMethod.invoke(<span class="literal">null</span>, <span class="keyword">new</span> <span class="keyword">Object</span>[] &#123; mArgs &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(ex);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">                <span class="built_in">Throwable</span> cause = ex.getCause();</span><br><span class="line">                <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> <span class="built_in">RuntimeException</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (<span class="built_in">RuntimeException</span>) cause;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> <span class="built_in">Error</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (<span class="built_in">Error</span>) cause;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RuntimeException</span>(ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>追踪下去，MethodAndArgsCaller其实是RuntimeInit的一个内部类并且继承了Runnable,然后在run方法中会通过反射调用了mMethod方法，此时mMethod是ActivityThread的main方法，即run方法中将会执行ActivityThread的main方法，在这里你可能会有疑问了，那这个run方法什么时候执行呢？让我们来看看最开始的ZygoteInit的main方法。</p>
<blockquote>
<p>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</p>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="function"><span class="title">main</span>(<span class="params"><span class="built_in">String</span> argv[]</span>)</span> &#123;</span><br><span class="line">    Runnable caller;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">       ....</span><br><span class="line">        caller = Zygote.initBlastulaPool();</span><br><span class="line">        <span class="keyword">if</span> (caller == <span class="literal">null</span>) &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">&quot;Accepting command socket connections&quot;</span>);</span><br><span class="line">            <span class="comment">//等待AMS的请求</span></span><br><span class="line">            caller = zygoteServer.runSelectLoop(abiList);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;System zygote died with exception&quot;</span>, ex);</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        zygoteServer.closeServerSocket();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (caller != <span class="literal">null</span>) &#123;</span><br><span class="line">        caller.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从分析Zygote进程接受请求并孵化应用进程的一开始，我们就是分析runSelectLoop(abiList)这个方法，而分析到最后findStaticMain方法将返回MethodAndArgsCaller对象（继承Runnable）,所以这时候在ZygoteInit的main方法caller会等于这个MethodAndArgsCaller对象，显然caller不等于null，故最后会执行caller.run方法，即执行ActivityThread的main方法。于是应用进程成功启动ActivityThread。</p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/5d9d948de51d45782c23fabc">https://juejin.im/post/5d9d948de51d45782c23fabc</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/5a936c5a6fb9a0633229ca74">https://juejin.im/post/5a936c5a6fb9a0633229ca74</a></p>
<p><a target="_blank" rel="noopener" href="http://codemx.cn/2018/01/26/AndroidOS008-Activity/">http://codemx.cn/2018/01/26/AndroidOS008-Activity/</a></p>
<p><a target="_blank" rel="noopener" href="http://liuwangshu.cn/framework/booting/2-zygote.html">Android系统启动流程（二）解析Zygote进程启动过程</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/6867744083809419277">https://juejin.im/post/6867744083809419277</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/6887431834041483271">https://juejin.im/post/6887431834041483271</a></p>
<p>启动流程目的</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6897892195483779080">https://juejin.cn/post/6897892195483779080</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-01-13T02:49:39.000Z" title="1/13/2020, 10:49:39 AM">2020-01-13</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-08-19T11:11:43.527Z" title="8/19/2021, 7:11:43 PM">2021-08-19</time></span><span class="level-item"><a class="link-muted" href="/categories/ANDROID/">ANDROID</a></span><span class="level-item">10 minutes read (About 1551 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/01/13/ActivityStart02/">ActivityStart02</a></p><div class="content"><h5 id="Application-OnCreate"><a href="#Application-OnCreate" class="headerlink" title="Application OnCreate()"></a>Application OnCreate()</h5><p><img src="/2020/01/13/ActivityStart02/ActivityThradmain1.png" alt="ActivityThradmain1"></p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">String</span>[] args)</span> </span>&#123;</span><br><span class="line">		   Looper.<span class="built_in">prepareMainLooper</span>();		<span class="comment">//创建消息循环</span></span><br><span class="line"></span><br><span class="line">        ActivityThread thread = <span class="keyword">new</span> <span class="built_in">ActivityThread</span>();  </span><br><span class="line">        thread.<span class="built_in">attach</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sMainThreadHandler == null) &#123;</span><br><span class="line">            sMainThreadHandler = thread.<span class="built_in">getHandler</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">false</span>) &#123;</span><br><span class="line">            Looper.<span class="built_in">myLooper</span>().<span class="built_in">setMessageLogging</span>(<span class="keyword">new</span></span><br><span class="line">                    <span class="built_in">LogPrinter</span>(Log.DEBUG, <span class="string">&quot;ActivityThread&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// End of event ActivityThreadMain.</span></span><br><span class="line">        Trace.<span class="built_in">traceEnd</span>(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">        Looper.<span class="built_in">loop</span>();					<span class="comment">//使当前进程进入消息循环</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里我们就不再详细分析prepareMainLooper和loop方法，其主要功能就是准备好主线程的Looper以及消息队列，最后再开启主线程的消息循环。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> void attach(boolean system) &#123;</span><br><span class="line"></span><br><span class="line"> IActivityManager mgr = <span class="module-access"><span class="module"><span class="identifier">ActivityManagerNative</span>.</span></span>get<span class="constructor">Default()</span>; <span class="comment">//获得ApplicationThreadNative</span></span><br><span class="line"> 																									<span class="comment">//代理类ActivityManagerProxy </span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mgr.attach<span class="constructor">Application(<span class="params">mAppThread</span>)</span>;</span><br><span class="line">            &#125; catch (RemoteException ex) &#123;</span><br><span class="line">                throw ex.rethrow<span class="constructor">FromSystemServer()</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Watch for getting close to heap limit.</span></span><br><span class="line">            <span class="module-access"><span class="module"><span class="identifier">BinderInternal</span>.</span></span>add<span class="constructor">GcWatcher(<span class="params">new</span> Runnable()</span> &#123;</span><br><span class="line">                @Override public void run<span class="literal">()</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!mSomeActivitiesChanged) &#123;</span><br><span class="line">                        return;</span><br><span class="line">                    &#125;</span><br><span class="line">                    Runtime runtime = <span class="module-access"><span class="module"><span class="identifier">Runtime</span>.</span></span>get<span class="constructor">Runtime()</span>;</span><br><span class="line">                    long dalvikMax = runtime.max<span class="constructor">Memory()</span>;</span><br><span class="line">                    long dalvikUsed = runtime.total<span class="constructor">Memory()</span> - runtime.free<span class="constructor">Memory()</span>;</span><br><span class="line">                    <span class="keyword">if</span> (dalvikUsed &gt; ((<span class="number">3</span>*dalvikMax)/<span class="number">4</span>)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_MEMORY_TRIM) <span class="module-access"><span class="module"><span class="identifier">Slog</span>.</span></span>d(TAG, <span class="string">&quot;Dalvik max=&quot;</span> + (dalvikMax/<span class="number">1024</span>)</span><br><span class="line">                                + <span class="string">&quot; total=&quot;</span> + (runtime.total<span class="constructor">Memory()</span>/<span class="number">1024</span>)</span><br><span class="line">                                + <span class="string">&quot; used=&quot;</span> + (dalvikUsed/<span class="number">1024</span>));</span><br><span class="line">                        mSomeActivitiesChanged = <span class="literal">false</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            mgr.release<span class="constructor">SomeActivities(<span class="params">mAppThread</span>)</span>;</span><br><span class="line">                        &#125; catch (RemoteException e) &#123;</span><br><span class="line">                            throw e.rethrow<span class="constructor">FromSystemServer()</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到由于在ActivityThread的attach中我们传入的是false，故在attach方法中将执行!system里的代码，通过调用AMS的attachApplication来将ActivityThread中的内部类ApplicationThread对象绑定至AMS，这样AMS就可以通过这个代理对象 来控制应用进程。接着为这个进程添加垃圾回收观察者，每当系统触发垃圾回收的时候就在run方法中计算应用使用了多大的内存，如果超过总量的3/4就尝试释放内存。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">public</span> void attachApplication(<span class="type">IApplicationThread</span> app) throws <span class="type">RemoteException</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">Parcel</span> <span class="class"><span class="keyword">data</span> = <span class="type">Parcel</span>.obtain();</span></span><br><span class="line">    <span class="type">Parcel</span> reply = <span class="type">Parcel</span>.obtain();</span><br><span class="line">    <span class="class"><span class="keyword">data</span>.writeInterfaceToken(<span class="type">IActivityManager</span>.<span class="title">descriptor</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">data</span>.writeStrongBinder(<span class="title">app</span>.<span class="title">asBinder</span>());</span></span><br><span class="line">    mRemote.transact(<span class="type">ATTACH_APPLICATION_TRANSACTION</span>, <span class="class"><span class="keyword">data</span>, reply, 0);</span></span><br><span class="line">    reply.readException();</span><br><span class="line">    <span class="class"><span class="keyword">data</span>.recycle();</span></span><br><span class="line">    reply.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">boolean</span> onTransact(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span><br><span class="line">        <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">    	  <span class="keyword">case</span> ATTACH_APPLICATION_TRANSACTION: &#123;</span><br><span class="line">            data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">            IApplicationThread app = ApplicationThreadNative.asInterface(</span><br><span class="line">                    data.readStrongBinder()); <span class="comment">//得到代理类ApplicationThreadProxy </span></span><br><span class="line">            <span class="keyword">if</span> (app != <span class="keyword">null</span>) &#123;</span><br><span class="line">                attachApplication(app);</span><br><span class="line">            &#125;</span><br><span class="line">            reply.writeNoException();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public final void attach<span class="constructor">Application(IApplicationThread <span class="params">thread</span>)</span> &#123;</span><br><span class="line">    synchronized (this) &#123;</span><br><span class="line">        <span class="built_in">int</span> callingPid = <span class="module-access"><span class="module"><span class="identifier">Binder</span>.</span></span>get<span class="constructor">CallingPid()</span>;</span><br><span class="line">        final long origId = <span class="module-access"><span class="module"><span class="identifier">Binder</span>.</span></span>clear<span class="constructor">CallingIdentity()</span>;</span><br><span class="line">        attach<span class="constructor">ApplicationLocked(<span class="params">thread</span>, <span class="params">callingPid</span>)</span>;</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">Binder</span>.</span></span>restore<span class="constructor">CallingIdentity(<span class="params">origId</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>​    将应用进程的ApplicationThread对象绑定到AMS，即AMS获得ApplicationThread的代理对象 </p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private final boolean attachApplicationLocked(IApplicationThread thread,</span><br><span class="line">        int pid) &#123;</span><br><span class="line">        	<span class="comment">//创建Application</span></span><br><span class="line">          thread.bindApplication(processName, appInfo, providers, <span class="keyword">app</span>.instrumentationClass,</span><br><span class="line">                    profilerInfo, <span class="keyword">app</span>.instrumentationArguments, <span class="keyword">app</span>.instrumentationWatcher,</span><br><span class="line">                    <span class="keyword">app</span>.instrumentationUiAutomationConnection, testMode,</span><br><span class="line">                    mBinderTransactionTrackingEnabled, enableTrackAllocation,</span><br><span class="line">                    isRestrictedBackupMode || !normalMode, <span class="keyword">app</span>.persistent,</span><br><span class="line">                    new Configuration(mConfiguration), <span class="keyword">app</span>.compat,</span><br><span class="line">                    getCommonServicesLocked(<span class="keyword">app</span>.isolated),</span><br><span class="line">                                   mCoreSettingsObserver.getCoreSettingsLocked());</span><br><span class="line">        </span><br><span class="line">         <span class="comment">//创建Activity</span></span><br><span class="line">         <span class="keyword">if</span> (mStackSupervisor.attachApplicationLocked(<span class="keyword">app</span>)) &#123;</span><br><span class="line">                    didSomething = true;</span><br><span class="line">         &#125;</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="create-Application"><a href="#create-Application" class="headerlink" title="create Application"></a>create Application</h5><p><img src="/2020/01/13/ActivityStart02/ActivityThradmain3.png" alt="ActivityThradmain3"></p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@<span class="type">Override</span></span><br><span class="line"><span class="title">public</span> final void bindApplication(<span class="type">String</span> packageName, <span class="type">ApplicationInfo</span> info,</span><br><span class="line">        <span class="type">List</span>&lt;<span class="type">ProviderInfo</span>&gt; providers, <span class="type">ComponentName</span> testName, <span class="type">ProfilerInfo</span> profilerInfo,</span><br><span class="line">        <span class="type">Bundle</span> testArgs, <span class="type">IInstrumentationWatcher</span> testWatcher,</span><br><span class="line">        <span class="type">IUiAutomationConnection</span> uiAutomationConnection, int debugMode,</span><br><span class="line">        boolean enableBinderTracking, boolean trackAllocation, boolean restrictedBackupMode,</span><br><span class="line">        boolean persistent, <span class="type">Configuration</span> config, <span class="type">CompatibilityInfo</span> compatInfo,</span><br><span class="line">        <span class="type">Map</span>&lt;<span class="type">String</span>, <span class="type">IBinder</span>&gt; services, <span class="type">Bundle</span> coreSettings) throws <span class="type">RemoteException</span> &#123;</span><br><span class="line">   </span><br><span class="line">    <span class="class"><span class="keyword">data</span>.writeInt(<span class="title">restrictedBackupMode</span> ? 1 : 0);</span></span><br><span class="line">    <span class="class"><span class="keyword">data</span>.writeInt(<span class="title">persistent</span> ? 1 : 0);</span></span><br><span class="line">    config.writeToParcel(<span class="class"><span class="keyword">data</span>, 0);</span></span><br><span class="line">    compatInfo.writeToParcel(<span class="class"><span class="keyword">data</span>, 0);</span></span><br><span class="line">    <span class="class"><span class="keyword">data</span>.writeMap(<span class="title">services</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">data</span>.writeBundle(<span class="title">coreSettings</span>);</span></span><br><span class="line">    mRemote.transact(<span class="type">BIND_APPLICATION_TRANSACTION</span>, <span class="class"><span class="keyword">data</span>, null,</span></span><br><span class="line">            <span class="type">IBinder</span>.<span class="type">FLAG_ONEWAY</span>);</span><br><span class="line">    <span class="class"><span class="keyword">data</span>.recycle();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> @<span class="type">Override</span></span><br><span class="line">    public boolean onTransact(int code, <span class="type">Parcel</span> <span class="class"><span class="keyword">data</span>, <span class="type">Parcel</span> reply, int flags)</span></span><br><span class="line">            throws <span class="type">RemoteException</span> &#123;</span><br><span class="line">        switch (code) &#123;</span><br><span class="line">					<span class="keyword">case</span> <span class="type">BIND_APPLICATION_TRANSACTION</span>:</span><br><span class="line"></span><br><span class="line">   					 boolean trackAllocation = <span class="class"><span class="keyword">data</span>.readInt() != 0;</span></span><br><span class="line">    boolean restrictedBackupMode = (<span class="class"><span class="keyword">data</span>.readInt() != 0);</span></span><br><span class="line">    boolean persistent = (<span class="class"><span class="keyword">data</span>.readInt() != 0);</span></span><br><span class="line">    <span class="type">Configuration</span> config = <span class="type">Configuration</span>.<span class="type">CREATOR</span>.createFromParcel(<span class="class"><span class="keyword">data</span>);</span></span><br><span class="line">    <span class="type">CompatibilityInfo</span> compatInfo = <span class="type">CompatibilityInfo</span>.<span class="type">CREATOR</span>.createFromParcel(<span class="class"><span class="keyword">data</span>);</span></span><br><span class="line">    <span class="type">HashMap</span>&lt;<span class="type">String</span>, <span class="type">IBinder</span>&gt; services = <span class="class"><span class="keyword">data</span>.readHashMap(<span class="title">null</span>);</span></span><br><span class="line">    <span class="type">Bundle</span> coreSettings = <span class="class"><span class="keyword">data</span>.readBundle();</span></span><br><span class="line">    bindApplication(packageName, info, providers, testName, profilerInfo, testArgs,</span><br><span class="line">            testWatcher, uiAutomationConnection, testMode, enableBinderTracking,</span><br><span class="line">            trackAllocation, restrictedBackupMode, persistent, config, compatInfo, services,</span><br><span class="line">            coreSettings);</span><br><span class="line">    return true;</span><br><span class="line">	</span><br><span class="line">	      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> final <span class="literal">void</span> bindApplication(<span class="built_in">String</span> processName, ApplicationInfo appInfo,</span><br><span class="line">        <span class="built_in">List</span>&lt;ProviderInfo&gt; providers, ComponentName instrumentationName,</span><br><span class="line">        ProfilerInfo profilerInfo, Bundle instrumentationArgs,</span><br><span class="line">        IInstrumentationWatcher instrumentationWatcher,</span><br><span class="line">        IUiAutomationConnection instrumentationUiConnection, int debugMode,</span><br><span class="line">        <span class="built_in">boolean</span> enableBinderTracking, <span class="built_in">boolean</span> trackAllocation,</span><br><span class="line">        <span class="built_in">boolean</span> isRestrictedBackupMode, <span class="built_in">boolean</span> persistent, Configuration config,</span><br><span class="line">        CompatibilityInfo compatInfo, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, IBinder&gt; services, Bundle coreSettings) &#123;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">    <span class="built_in">data</span>.restrictedBackupMode = isRestrictedBackupMode;</span><br><span class="line">    <span class="built_in">data</span>.persistent = persistent;</span><br><span class="line">    <span class="built_in">data</span>.config = config;</span><br><span class="line">    <span class="built_in">data</span>.compatInfo = compatInfo;</span><br><span class="line">    <span class="built_in">data</span>.initProfilerInfo = profilerInfo;</span><br><span class="line">    sendMessage(H.BIND_APPLICATION, <span class="built_in">data</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">case BIND_APPLICATION:</span><br><span class="line">    <span class="module-access"><span class="module"><span class="identifier">Trace</span>.</span></span>trace<span class="constructor">Begin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;bindApplication&quot;</span>)</span>;</span><br><span class="line">    AppBindData data = (AppBindData)msg.obj;</span><br><span class="line">    handle<span class="constructor">BindApplication(<span class="params">data</span>)</span>;</span><br><span class="line">    <span class="module-access"><span class="module"><span class="identifier">Trace</span>.</span></span>trace<span class="constructor">End(Trace.TRACE_TAG_ACTIVITY_MANAGER)</span>;</span><br></pre></td></tr></table></figure>



<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> void handle<span class="constructor">BindApplication(AppBindData <span class="params">data</span>)</span> &#123;</span><br><span class="line">      <span class="comment">// If the app is being launched for full backup or restore, bring it up in</span></span><br><span class="line">            <span class="comment">// a restricted environment with the base application class.</span></span><br><span class="line">            Application app = data.info.make<span class="constructor">Application(<span class="params">data</span>.<span class="params">restrictedBackupMode</span>, <span class="params">null</span>)</span>;</span><br><span class="line">            mInitialApplication = app;</span><br><span class="line">	</span><br><span class="line">					</span><br><span class="line">					  mInstrumentation.call<span class="constructor">ApplicationOnCreate(<span class="params">app</span>)</span>; <span class="comment">//调用Application的create方法</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Application makeApplication(<span class="built_in">boolean</span> forceDefaultAppClass,</span><br><span class="line">        Instrumentation instrumentation) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mApplication != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mApplication;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">        Application app = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">String</span> appClass = mApplicationInfo.className;</span><br><span class="line">        <span class="keyword">if</span> (forceDefaultAppClass || (appClass == <span class="literal">null</span>)) &#123;</span><br><span class="line">            appClass = <span class="string">&quot;android.app.Application&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            java.lang.ClassLoader cl = getClassLoader();</span><br><span class="line">            <span class="keyword">if</span> (!mPackageName.equals(<span class="string">&quot;android&quot;</span>)) &#123;</span><br><span class="line">                Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER,</span><br><span class="line">                        <span class="string">&quot;initializeJavaContextClassLoader&quot;</span>);</span><br><span class="line">                initializeJavaContextClassLoader();</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">            &#125;</span><br><span class="line">            ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, <span class="built_in">this</span>);</span><br><span class="line">            app = mActivityThread.mInstrumentation.newApplication(</span><br><span class="line">                    cl, appClass, appContext);</span><br><span class="line">            appContext.setOuterContext(app);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/2020/01/13/ActivityStart02/ActivityThradmain2.png" alt="ActivityThradmain2"></p>
<h5 id="LaunchActivity"><a href="#LaunchActivity" class="headerlink" title="LaunchActivity"></a>LaunchActivity</h5><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">// we use token <span class="keyword">to</span> identify this activity without having <span class="keyword">to</span> send the</span><br><span class="line">        // activity itself back <span class="keyword">to</span> the activity manager. (matters more with ipc)</span><br><span class="line">        @Override</span><br><span class="line">   public final void scheduleLaunchActivity(Intent intent, IBinder token, int ident,</span><br><span class="line">                ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</span><br><span class="line">                CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</span><br><span class="line">                int procState, Bundle <span class="keyword">state</span>, PersistableBundle persistentState,</span><br><span class="line">                List<span class="variable">&lt;ResultInfo&gt;</span> pendingResults, List<span class="variable">&lt;ReferrerIntent&gt;</span> pendingNewIntents,</span><br><span class="line">                boolean notResumed, boolean isForward, ProfilerInfo profilerInfo) &#123;</span><br><span class="line">                </span><br><span class="line">            ActivityClientRecord r = new ActivityClientRecord();</span><br><span class="line">            r.token = token;</span><br><span class="line">            r.ident = ident;</span><br><span class="line">            r.intent = intent;</span><br><span class="line">            r.referrer = referrer;</span><br><span class="line">            r.voiceInteractor = voiceInteractor;</span><br><span class="line">            r.activityInfo = info;</span><br><span class="line">            r.compatInfo = compatInfo;</span><br><span class="line">            r.<span class="keyword">state</span> = <span class="keyword">state</span>;</span><br><span class="line">            r.persistentState = persistentState;</span><br><span class="line"></span><br><span class="line">            r.pendingResults = pendingResults;</span><br><span class="line">            r.pendingIntents = pendingNewIntents;</span><br><span class="line"></span><br><span class="line">            r.startsNotResumed = notResumed;</span><br><span class="line">            r.isForward = isForward;</span><br><span class="line"></span><br><span class="line">            r.profilerInfo = profilerInfo;</span><br><span class="line"></span><br><span class="line">            r.overrideConfig = overrideConfig;</span><br><span class="line">            updatePendingConfiguration(curConfig);</span><br><span class="line"></span><br><span class="line">            sendMessage(H.LAUNCH_ACTIVITY, r);</span><br><span class="line">                </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(TAG, <span class="string">&quot;&gt;&gt;&gt; handling: &quot;</span> + codeToString(msg.what));</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">&quot;activityStart&quot;</span>);</span><br><span class="line">            <span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;</span><br><span class="line"></span><br><span class="line">            r.packageInfo = getPackageInfoNoCheck(</span><br><span class="line">                    r.activityInfo.applicationInfo, r.compatInfo);</span><br><span class="line">            handleLaunchActivity(r, <span class="keyword">null</span>, <span class="string">&quot;LAUNCH_ACTIVITY&quot;</span>);</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="literal">void</span> handleLaunchActivity(ActivityClientRecord r, Intent customIntent, <span class="built_in">String</span> reason) &#123;</span><br><span class="line">  <span class="comment">//通过Activity所在的应用程序信息及该Activity对应的CompatibilityInfo信息从PMS服务中查询当前Activity的包信息  </span></span><br><span class="line">    ActivityInfo aInfo = r.activityInfo;</span><br><span class="line">    <span class="keyword">if</span> (r.packageInfo == <span class="built_in">null</span>) &#123;</span><br><span class="line">        r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</span><br><span class="line">                Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取当前Activity的组件信息  </span></span><br><span class="line">    ComponentName component = r.intent.getComponent();</span><br><span class="line">    <span class="keyword">if</span> (component == <span class="built_in">null</span>) &#123;</span><br><span class="line">        component = r.intent.resolveActivity(</span><br><span class="line">            mInitialApplication.getPackageManager());</span><br><span class="line">        r.intent.setComponent(component);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//packageName为启动Activity的包名，targetActivity为Activity的类名  </span></span><br><span class="line">    <span class="keyword">if</span> (r.activityInfo.targetActivity != <span class="built_in">null</span>) &#123;</span><br><span class="line">        component = <span class="literal">new</span> ComponentName(r.activityInfo.packageName,</span><br><span class="line">                r.activityInfo.targetActivity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//通过类反射方式加载即将启动的Activity</span></span><br><span class="line">    Activity activity = <span class="built_in">null</span>;</span><br><span class="line">    try &#123;</span><br><span class="line">        java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">        activity = mInstrumentation.newActivity(</span><br><span class="line">                cl, component.getClassName(), r.intent);</span><br><span class="line">        StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">        r.intent.setExtrasClassLoader(cl);</span><br><span class="line">        r.intent.prepareToEnterProcess();</span><br><span class="line">        <span class="keyword">if</span> (r.state != <span class="built_in">null</span>) &#123;</span><br><span class="line">            r.state.setClassLoader(cl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="params">...</span><span class="params">...</span></span><br><span class="line">    try &#123;</span><br><span class="line">        <span class="comment">//通过单例模式为应用程序进程创建Application对象  </span></span><br><span class="line">        Application app = r.packageInfo.makeApplication(<span class="literal">false</span>, mInstrumentation);</span><br><span class="line"></span><br><span class="line">       <span class="params">...</span><span class="params">...</span></span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="built_in">null</span>) &#123;</span><br><span class="line">            <span class="comment">//为当前Activity创建上下文对象ContextImpl  </span></span><br><span class="line">            Context appContext = createBaseContextForActivity(r, activity);</span><br><span class="line">            <span class="params">...</span><span class="params">...</span></span><br><span class="line">            <span class="comment">//将当前启动的Activity和上下文ContextImpl、Application绑定</span></span><br><span class="line">            activity.attach(appContext, this, getInstrumentation(), r.token,</span><br><span class="line">                    r.ident, app, r.intent, r.activityInfo, title, r.<span class="keyword">parent</span>,</span><br><span class="line">                    r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                    r.<span class="keyword">referrer</span>, r.voiceInteractor, window);</span><br><span class="line"></span><br><span class="line">            <span class="params">...</span><span class="params">...</span></span><br><span class="line">            <span class="comment">//将Activity保存到ActivityClientRecord中，ActivityClientRecord为Activity在应用程序进程中的描述符  </span></span><br><span class="line">            r.activity = activity;</span><br><span class="line">            activity.mCalled = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="params">...</span><span class="params">...</span></span><br><span class="line">            <span class="comment">//生命周期onStart、onresume</span></span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                activity.performStart();</span><br><span class="line">                r.stopped = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//ActivityThread的成员变量mActivities保存了当前应用程序进程中的所有Activity的描述符</span></span><br><span class="line">            mActivities.put(r.token, r);</span><br><span class="line">            <span class="params">...</span><span class="params">...</span></span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在上述方法中将调用performLaunchActivity来启动Activity，如下</p>
<p>应用程序进程通过performLaunchActivity函数将即将要启动的Activity加载到当前进程空间来，同时为启动Activity做准备。 [ActivityThread.java #performLaunchActivity()]</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;</span><br><span class="line">		 	<span class="comment">//用类加载器来创建该Activity的实例</span></span><br><span class="line">     activity = mInstrumentation.<span class="keyword">new</span><span class="type">Activity</span>(</span><br><span class="line">                    cl, component.getClassName(), r.intent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> Activity <span class="keyword">new</span><span class="type">Activity</span>(ClassLoader cl, <span class="keyword">String</span> className,</span><br><span class="line">            Intent intent)</span><br><span class="line">            throws InstantiationException, IllegalAccessException,</span><br><span class="line">            ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">return</span> (Activity)cl.loadClass(className).<span class="keyword">new</span><span class="type">Instance</span>();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>





<h5 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h5><p>Application Activity创建流程 </p>
<p>Launch app启动问题 </p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/5baf275f5188255c9a7740ba">https://juejin.im/post/5baf275f5188255c9a7740ba</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-01-06T09:37:17.000Z" title="1/6/2020, 5:37:17 PM">2020-01-06</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-05-06T11:24:51.250Z" title="5/6/2022, 7:24:51 PM">2022-05-06</time></span><span class="level-item"><a class="link-muted" href="/categories/JAVA/">JAVA</a></span><span class="level-item">10 minutes read (About 1492 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/01/06/JVM-HEAP/">JVM_HEAP</a></p><div class="content"><h3 id="堆内存细分"><a href="#堆内存细分" class="headerlink" title="堆内存细分"></a><a target="_blank" rel="noopener" href="https://youthlql.gitee.io/javayouth/#/docs/Java/JVM/JVM%E7%B3%BB%E5%88%97-%E7%AC%AC5%E7%AB%A0-%E5%A0%86?id=%E5%A0%86%E5%86%85%E5%AD%98%E7%BB%86%E5%88%86">堆内存细分</a></h3><p>现代垃圾收集器大部分都基于分代收集理论设计，堆空间细分为：</p>
<ol>
<li>Java7 及之前堆内存逻辑上分为三部分：新生区+养老区+永久区<ul>
<li>Young Generation Space    新生区      Young/New<ul>
<li>又被划分为Eden区和Survivor区</li>
</ul>
</li>
<li>Old generation space    养老区           Old/Tenure</li>
<li>Permanent Space   永久区                   Perm</li>
</ul>
</li>
<li>Java 8及之后堆内存逻辑上分为三部分：新生区+养老区+元空间<ul>
<li>Young Generation Space 新生区，又被划分为Eden区和Survivor区</li>
<li>Old generation space 养老区</li>
<li>Meta Space 元空间 Meta</li>
</ul>
</li>
</ol>
<p>约定：新生区 &lt;–&gt; 新生代 &lt;–&gt; 年轻代 、 养老区 &lt;–&gt; 老年区 &lt;–&gt; 老年代、 永久区 &lt;–&gt; 永久代</p>
<img src="/2020/01/06/JVM-HEAP/heap0003.png">

<ol>
<li>堆空间内部结构，JDK1.8之前从永久代 替换成 元空间</li>
</ol>
<p><img src="/2020/01/06/JVM-HEAP/java80004.png"></p>
<h2 id="堆是分配对象的唯一选择么？"><a href="#堆是分配对象的唯一选择么？" class="headerlink" title="堆是分配对象的唯一选择么？"></a><a target="_blank" rel="noopener" href="https://youthlql.gitee.io/javayouth/#/docs/Java/JVM/JVM%E7%B3%BB%E5%88%97-%E7%AC%AC5%E7%AB%A0-%E5%A0%86?id=%E5%A0%86%E6%98%AF%E5%88%86%E9%85%8D%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%94%AF%E4%B8%80%E9%80%89%E6%8B%A9%E4%B9%88%EF%BC%9F">堆是分配对象的唯一选择么？</a></h2><p><strong>在《深入理解Java虚拟机》中关于Java堆内存有这样一段描述：</strong></p>
<ol>
<li>随着JIT编译期的发展与<strong>逃逸分析技术</strong>逐渐成熟，<strong>栈上分配、标量替换</strong>优化技术将会导致一些微妙的变化，所有的对象都分配到堆上也渐渐变得不那么“绝对”了。</li>
<li>在Java虚拟机中，对象是在Java堆中分配内存的，这是一个普遍的常识。但是，有一种特殊情况，那就是<strong>如果经过逃逸分析（Escape Analysis）后发现，一个对象并没有逃逸出方法的话，那么就可能被优化成栈上分配</strong>。这样就无需在堆上分配内存，也无须进行垃圾回收了。这也是最常见的堆外存储技术。</li>
<li>此外，前面提到的基于OpenJDK深度定制的TaoBao VM，其中创新的GCIH（GC invisible  heap）技术实现off-heap，将生命周期较长的Java对象从heap中移至heap外，并且GC不能管理GCIH内部的Java对象，以此达到降低GC的回收频率和提升GC的回收效率的目的。</li>
</ol>
<h3 id="逃逸分析"><a href="#逃逸分析" class="headerlink" title="逃逸分析"></a><a target="_blank" rel="noopener" href="https://youthlql.gitee.io/javayouth/#/docs/Java/JVM/JVM%E7%B3%BB%E5%88%97-%E7%AC%AC5%E7%AB%A0-%E5%A0%86?id=%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90">逃逸分析</a></h3><ol>
<li>如何将堆上的对象分配到栈，需要使用逃逸分析手段。</li>
<li>这是一种可以有效减少Java程序中同步负载和内存堆分配压力的跨函数全局数据流分析算法。</li>
<li>通过逃逸分析，Java Hotspot编译器能够分析出一个新的对象的引用的使用范围从而决定是否要将这个对象分配到堆上。</li>
<li>逃逸分析的基本行为就是分析对象动态作用域：<ul>
<li><strong>当一个对象在方法中被定义后，对象只在方法内部使用，则认为没有发生逃逸。</strong></li>
<li>当一个对象在方法中被定义后，它被外部方法所引用，则认为发生逃逸。例如作为调用参数传递到其他地方中。</li>
</ul>
</li>
</ol>
<p><strong>逃逸分析举例</strong></p>
<p>1、没有发生逃逸的对象，则可以分配到栈（无线程安全问题）上，随着方法执行的结束，栈空间就被移除（也就无需GC）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">my_method</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    V v = <span class="keyword">new</span> V();</span><br><span class="line">    <span class="comment">// use v</span></span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line">    v = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、下面代码中的 StringBuffer sb 发生了逃逸，不能在栈上分配</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> StringBuffer <span class="title">createStringBuffer</span><span class="params">(String s1, String s2)</span> </span>&#123;</span><br><span class="line">    StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    sb.append(s1);</span><br><span class="line">    sb.append(s2);</span><br><span class="line">    <span class="keyword">return</span> sb;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、如果想要StringBuffer sb不发生逃逸，可以这样写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">createStringBuffer</span><span class="params">(String s1, String s2)</span> </span>&#123;</span><br><span class="line">    StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    sb.append(s1);</span><br><span class="line">    sb.append(s2);</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 逃逸分析</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  如何快速的判断是否发生了逃逸分析，大家就看new的对象实体是否有可能在方法外被调用。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EscapeAnalysis</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> EscapeAnalysis obj;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    方法返回EscapeAnalysis对象，发生逃逸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EscapeAnalysis <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> obj == <span class="keyword">null</span>? <span class="keyword">new</span> EscapeAnalysis() : obj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    为成员属性赋值，发生逃逸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setObj</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.obj = <span class="keyword">new</span> EscapeAnalysis();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//思考：如果当前的obj引用声明为static的？仍然会发生逃逸。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    对象的作用域仅在当前方法中有效，没有发生逃逸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">useEscapeAnalysis</span><span class="params">()</span></span>&#123;</span><br><span class="line">        EscapeAnalysis e = <span class="keyword">new</span> EscapeAnalysis();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    引用成员变量的值，发生逃逸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">useEscapeAnalysis1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        EscapeAnalysis e = getInstance();</span><br><span class="line">        <span class="comment">//getInstance().xxx()同样会发生逃逸</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>逃逸分析参数设置</strong></p>
<ol>
<li>在JDK 1.7 版本之后，HotSpot中默认就已经开启了逃逸分析</li>
<li>如果使用的是较早的版本，开发人员则可以通过：<ul>
<li>选项“-XX:+DoEscapeAnalysis”显式开启逃逸分析</li>
<li>通过选项“-XX:+PrintEscapeAnalysis”查看逃逸分析的筛选结果</li>
</ul>
</li>
</ol>
<p><strong>总结</strong></p>
<p>开发中能使用局部变量的，就不要使用在方法外定义。</p>
<h3 id="代码优化"><a href="#代码优化" class="headerlink" title="代码优化"></a><a target="_blank" rel="noopener" href="https://youthlql.gitee.io/javayouth/#/docs/Java/JVM/JVM%E7%B3%BB%E5%88%97-%E7%AC%AC5%E7%AB%A0-%E5%A0%86?id=%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96">代码优化</a></h3><p>使用逃逸分析，编译器可以对代码做如下优化：</p>
<ol>
<li><strong>栈上分配</strong>：将堆分配转化为栈分配。如果一个对象在子程序中被分配，要使指向该对象的指针永远不会发生逃逸，对象可能是栈上分配的候选，而不是堆上分配</li>
<li><strong>同步省略</strong>：如果一个对象被发现只有一个线程被访问到，那么对于这个对象的操作可以不考虑同步。</li>
<li><strong>分离对象或标量替换</strong>：有的对象可能不需要作为一个连续的内存结构存在也可以被访问到，那么对象的部分（或全部）可以不存储在内存，而是存储在CPU寄存器中。</li>
</ol>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-01-05T13:50:30.000Z" title="1/5/2020, 9:50:30 PM">2020-01-05</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-01-02T03:31:39.093Z" title="1/2/2023, 11:31:39 AM">2023-01-02</time></span><span class="level-item"><a class="link-muted" href="/categories/JAVA/">JAVA</a></span><span class="level-item">4 minutes read (About 573 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/01/05/List/">List</a></p><div class="content"><h4 id="Colletion"><a href="#Colletion" class="headerlink" title="Colletion"></a>Colletion</h4><p>容器继承图</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1683525-e44bb50cb9a67f49.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1008/format/webp"></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/31ed50ab01e3">https://www.jianshu.com/p/31ed50ab01e3</a></p>
<h4 id="Java-List"><a href="#Java-List" class="headerlink" title="Java List"></a>Java List</h4><p>List  &lt;– ArrayList  LinkedList</p>
<h5 id="ArrayList"><a href="#ArrayList" class="headerlink" title="ArrayList"></a>ArrayList</h5><ol>
<li><p>```<br>ArrayList<Integer>  arrayList = new ArrayList&lt;&gt;();</Integer></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> 得到一个object数组 &#96;private static final Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA &#x3D; &#123;&#125;;&#96;</span><br><span class="line"></span><br><span class="line">source</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>public ArrayList() {</p>
<pre><code>this.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;
</code></pre>
<p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. &#96;&#96;&#96;</span><br><span class="line">   arrayList.add(1);</span><br><span class="line">   arrayList.add(2);</span><br></pre></td></tr></table></figure>

<p> source </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public boolean add(E e) &#123;</span><br><span class="line">    ensureCapacityInternal(size + 1);  &#x2F;&#x2F; Increments modCount!!</span><br><span class="line">    elementData[size++] &#x3D; e;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"> private void ensureCapacityInternal(int minCapacity) &#123;</span><br><span class="line">     ensureExplicitCapacity(calculateCapacity(elementData, minCapacity));</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<ul>
<li><p>先看看calculateCapacity</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">private static final Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA &#x3D; &#123;&#125;;</span><br><span class="line">private static final int DEFAULT_CAPACITY &#x3D; 10;</span><br><span class="line"></span><br><span class="line">private static int calculateCapacity(Object[] elementData, int minCapacity) &#123;</span><br><span class="line">    if (elementData &#x3D;&#x3D; DEFAULTCAPACITY_EMPTY_ELEMENTDATA) &#123;</span><br><span class="line">        return Math.max(DEFAULT_CAPACITY, minCapacity);</span><br><span class="line">    &#125;</span><br><span class="line">    return minCapacity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <code>if (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA)</code> minCapacity==10</p>
</li>
<li><p>ensureExplicitCapacity()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private void ensureExplicitCapacity(int minCapacity) &#123;</span><br><span class="line">    modCount++;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; overflow-conscious code</span><br><span class="line">    if (minCapacity - elementData.length &gt; 0)</span><br><span class="line">        grow(minCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> private void grow(int minCapacity) &#123;</span><br><span class="line">        &#x2F;&#x2F; overflow-conscious code</span><br><span class="line">        int oldCapacity &#x3D; elementData.length;</span><br><span class="line">        int newCapacity &#x3D; oldCapacity + (oldCapacity &gt;&gt; 1);</span><br><span class="line">        if (newCapacity - minCapacity &lt; 0)</span><br><span class="line">            newCapacity &#x3D; minCapacity;</span><br><span class="line">        if (newCapacity - MAX_ARRAY_SIZE &gt; 0)</span><br><span class="line">            newCapacity &#x3D; hugeCapacity(minCapacity);</span><br><span class="line">        &#x2F;&#x2F; minCapacity is usually close to size, so this is a win:</span><br><span class="line">        elementData &#x3D; Arrays.copyOf(elementData, newCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>添加<code>arrayList.add(1);</code>时，size 为10的数组， elementData[size++] = e; 注意size初始化值==0，程序先 执行elementData[0]=1,然后是size++;</p>
<p>当添加的数是11时，<code>        int newCapacity = oldCapacity + (oldCapacity &gt;&gt; 1);</code>开始执行 10 + 1010&gt;&gt;1 = 10+5,申请了5个空间</p>
<p>然后get()可以获取element</p>
</li>
<li><p>源码简写</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">int size &#x3D;0;</span><br><span class="line">Object[] elementData&#x3D; &#123;&#125;;</span><br><span class="line">Object[] elementArr &#x3D; Arrays.copyOf(elementData, 10);</span><br><span class="line">elementArr[size++] &#x3D; 5;</span><br><span class="line">elementArr[size++] &#x3D; 7;</span><br><span class="line">for ( Object el :elementArr)&#123;</span><br><span class="line">    System.out.print(el+&quot;  &quot;);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(elementArr[0]);</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h5 id="LinkedList"><a href="#LinkedList" class="headerlink" title="LinkedList"></a>LinkedList</h5><p> 源码功能如图所示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">void linkLast(E e) &#123;</span><br><span class="line">    final Node&lt;E&gt; l &#x3D; last;</span><br><span class="line">    final Node&lt;E&gt; newNode &#x3D; new Node&lt;&gt;(l, e, null);</span><br><span class="line">    last &#x3D; newNode;</span><br><span class="line">    if (l &#x3D;&#x3D; null)</span><br><span class="line">        first &#x3D; newNode;</span><br><span class="line">    else</span><br><span class="line">        l.next &#x3D; newNode;</span><br><span class="line">    size++;</span><br><span class="line">    modCount++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private static class Node&lt;E&gt; &#123;</span><br><span class="line">        E item;</span><br><span class="line">        Node&lt;E&gt; next;</span><br><span class="line">        Node&lt;E&gt; prev;</span><br><span class="line"></span><br><span class="line">        Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) &#123;</span><br><span class="line">            this.item &#x3D; element;</span><br><span class="line">            this.next &#x3D; next;</span><br><span class="line">            this.prev &#x3D; prev;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<img src="/2020/01/05/List/linkedlist.png" alt="linkedlist" style="zoom:50%;">





<h5 id="List-iterator"><a href="#List-iterator" class="headerlink" title="List iterator"></a>List iterator</h5><p>  List<String> crunchifyList = <strong>new</strong> ArrayList<String>();</String></String></p>
<p>​    // add 4 different values to list</p>
<p>​    crunchifyList.add(“Facebook”);</p>
<p>​    crunchifyList.add(“Paypal”);</p>
<p>​    crunchifyList.add(“Google”);</p>
<p>​    crunchifyList.add(“Yahoo”);</p>
<p>​    // Other way to define list is - we will not use this list :)</p>
<p>​    List<String> crunchifyListNew = Arrays.asList(“Facebook”, “Paypal”, “Google”, “Yahoo”);</String></p>
<ul>
<li><p>​      Iterator - Returns an iterator over the elements in this list in proper sequence.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Iterator&lt;String&gt; crunchifyIterator &#x3D; crunchifyList.iterator();</span><br><span class="line">  </span><br><span class="line"> while(crunchifyIterator.hasNext()) &#123;</span><br><span class="line">  </span><br><span class="line">   System.out.println(crunchifyIterator.next());</span><br><span class="line">  </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
<li><p> // ListIterator - traverse a list of elements in either forward or backward order</p>
</li>
</ul>
<p>  ​    // An iterator for lists that allows the programmer to traverse the list in either direction, modify the list during iteration,</p>
<p>  ​    // and obtain the iterator’s current position in the list.</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ListIterator&lt;String&gt; crunchifyListIterator &#x3D; crunchifyList.listIterator();</span><br><span class="line">      while (crunchifyListIterator.hasNext()) &#123;</span><br><span class="line">          System.out.println(crunchifyListIterator.next());</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Iterable.forEach() util: Returns a sequential Stream with this collection as its source</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">crunchifyList.forEach((temp) -&gt; &#123;</span><br><span class="line">  </span><br><span class="line">  System.out.println(temp);</span><br><span class="line">  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
<li><p> collection Stream.forEach() util: Returns a sequential Stream with this collection as its source</p>
</li>
</ul>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crunchifyList.stream().forEach((crunchifyTemp) -&gt; System.out.println(crunchifyTemp));</span><br></pre></td></tr></table></figure>

<h4 id="kotlin-List"><a href="#kotlin-List" class="headerlink" title="kotlin List"></a>kotlin List</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var mPatientList &#x3D; patientList.filter &#123; it.patientCode &#x3D;&#x3D; patientCode &#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">return mQnList?.let &#123; it -&gt;</span><br><span class="line">    it.filter &#123; it.type &#x3D;&#x3D; type &#125;.map &#123; it.value &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="sequence"><a href="#sequence" class="headerlink" title="sequence"></a>sequence</h4><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/38258597">https://zhuanlan.zhihu.com/p/38258597</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7022429745874731045">https://juejin.cn/post/7022429745874731045</a></p>
<p><a target="_blank" rel="noopener" href="https://winterbe.com/posts/2018/07/23/kotlin-sequence-tutorial/">https://winterbe.com/posts/2018/07/23/kotlin-sequence-tutorial/</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/38258597">https://zhuanlan.zhihu.com/p/38258597</a></p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/13/">Previous</a></div><div class="pagination-next"><a href="/page/15/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/13/">13</a></li><li><a class="pagination-link is-current" href="/page/14/">14</a></li><li><a class="pagination-link" href="/page/15/">15</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/24/">24</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Your name"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Your name</p><p class="is-size-6 is-block">Your title</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Your location</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">240</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">30</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">33</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ppoffice" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ppoffice"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/ANDROID/"><span class="level-start"><span class="level-item">ANDROID</span></span><span class="level-end"><span class="level-item tag">54</span></span></a></li><li><a class="level is-mobile" href="/categories/Architecture/"><span class="level-start"><span class="level-item">Architecture</span></span><span class="level-end"><span class="level-item tag">2</span></span></a><ul><li><a class="level is-mobile" href="/categories/Architecture/DesignPattern/"><span class="level-start"><span class="level-item">DesignPattern</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/BLE/"><span class="level-start"><span class="level-item">BLE</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/C/"><span class="level-start"><span class="level-item">C++</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/COROUTINE/"><span class="level-start"><span class="level-item">COROUTINE</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Computer-Composition-principles/"><span class="level-start"><span class="level-item">Computer Composition principles</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/DataStructure/"><span class="level-start"><span class="level-item">DataStructure</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/categories/DesignPattern/"><span class="level-start"><span class="level-item">DesignPattern</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/DesignPatterns/"><span class="level-start"><span class="level-item">DesignPatterns</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/ENGLISH/"><span class="level-start"><span class="level-item">ENGLISH</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/INTERVIEW/"><span class="level-start"><span class="level-item">INTERVIEW</span></span><span class="level-end"><span class="level-item tag">9</span></span></a><ul><li><a class="level is-mobile" href="/categories/INTERVIEW/NETWORK/"><span class="level-start"><span class="level-item">NETWORK</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/JAVA/"><span class="level-start"><span class="level-item">JAVA</span></span><span class="level-end"><span class="level-item tag">27</span></span></a></li><li><a class="level is-mobile" href="/categories/JETPACK/"><span class="level-start"><span class="level-item">JETPACK</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Jetpack/"><span class="level-start"><span class="level-item">Jetpack</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Kotlin/"><span class="level-start"><span class="level-item">Kotlin</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/LIFE/"><span class="level-start"><span class="level-item">LIFE</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/LINUX/"><span class="level-start"><span class="level-item">LINUX</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/Library/"><span class="level-start"><span class="level-item">Library</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Mathematics/"><span class="level-start"><span class="level-item">Mathematics</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/NETWORK/"><span class="level-start"><span class="level-item">NETWORK</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/OS/"><span class="level-start"><span class="level-item">OS</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Organization/"><span class="level-start"><span class="level-item">Organization</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/SOURCE/"><span class="level-start"><span class="level-item">SOURCE</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/TEST/"><span class="level-start"><span class="level-item">TEST</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/TOOL/"><span class="level-start"><span class="level-item">TOOL</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile" href="/categories/VIEW/"><span class="level-start"><span class="level-item">VIEW</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/categories/anim/"><span class="level-start"><span class="level-item">anim</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/flutter/"><span class="level-start"><span class="level-item">flutter</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-10-01T10:08:19.000Z">2024-10-01</time></p><p class="title"><a href="/2024/10/01/BEACKEND/">BEACKEND</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-07-04T07:57:26.000Z">2024-07-04</time></p><p class="title"><a href="/2024/07/04/DesignPatterns-State/">DesignPatterns_State</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-07-03T05:51:25.000Z">2024-07-03</time></p><p class="title"><a href="/2024/07/03/glide/">glide</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-06-28T09:37:49.000Z">2024-06-28</time></p><p class="title"><a href="/2024/06/28/bitmap/">Bitmap</a></p><p class="categories"><a href="/categories/Computer-Composition-principles/">Computer Composition principles</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-06-28T08:04:14.000Z">2024-06-28</time></p><p class="title"><a href="/2024/06/28/bits-and-bytes/">Bits and Bytes</a></p><p class="categories"><a href="/categories/Computer-Composition-principles/">Computer Composition principles</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/10/"><span class="level-start"><span class="level-item">October 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/07/"><span class="level-start"><span class="level-item">July 2024</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/06/"><span class="level-start"><span class="level-item">June 2024</span></span><span class="level-end"><span class="level-item tag">14</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/05/"><span class="level-start"><span class="level-item">May 2024</span></span><span class="level-end"><span class="level-item tag">27</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/11/"><span class="level-start"><span class="level-item">November 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/08/"><span class="level-start"><span class="level-item">August 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/04/"><span class="level-start"><span class="level-item">April 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">January 2023</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/12/"><span class="level-start"><span class="level-item">December 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">October 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/09/"><span class="level-start"><span class="level-item">September 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">August 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">July 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">June 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">May 2022</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">April 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">March 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/02/"><span class="level-start"><span class="level-item">February 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">January 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">December 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">November 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">October 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/09/"><span class="level-start"><span class="level-item">September 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">August 2021</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">June 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">May 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">April 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">March 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">February 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">January 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">December 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">November 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">October 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">September 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">August 2020</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">July 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">June 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">May 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">April 2020</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">March 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">January 2020</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/12/"><span class="level-start"><span class="level-item">December 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">November 2019</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/09/"><span class="level-start"><span class="level-item">September 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">August 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">July 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/06/"><span class="level-start"><span class="level-item">June 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">April 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">March 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">January 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/11/"><span class="level-start"><span class="level-item">November 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">August 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/07/"><span class="level-start"><span class="level-item">July 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/06/"><span class="level-start"><span class="level-item">June 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/05/"><span class="level-start"><span class="level-item">May 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">April 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">March 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">February 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">January 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">December 2017</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/11/"><span class="level-start"><span class="level-item">November 2017</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/10/"><span class="level-start"><span class="level-item">October 2017</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">September 2017</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/08/"><span class="level-start"><span class="level-item">August 2017</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/07/"><span class="level-start"><span class="level-item">July 2017</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ANDROID/"><span class="tag">ANDROID</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AOSP/"><span class="tag">AOSP</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Activity/"><span class="tag">Activity</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AndroidNewFeatures/"><span class="tag">AndroidNewFeatures</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Assembly/"><span class="tag">Assembly</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BLOG/"><span class="tag">BLOG</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ConstraintLayout/"><span class="tag">ConstraintLayout</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DB/"><span class="tag">DB</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DesignPattern/"><span class="tag">DesignPattern</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Drawer/"><span class="tag">Drawer</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Fragment/"><span class="tag">Fragment</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JVM/"><span class="tag">JVM</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LEETCODE/"><span class="tag">LEETCODE</span><span class="tag">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Library/"><span class="tag">Library</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Operators/"><span class="tag">Operators</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Performance/"><span class="tag">Performance</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RecyclerView/"><span class="tag">RecyclerView</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RxJava/"><span class="tag">RxJava</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/THINK/"><span class="tag">THINK</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TOOL/"><span class="tag">TOOL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TabLayout/"><span class="tag">TabLayout</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Test/"><span class="tag">Test</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TouchEvent/"><span class="tag">TouchEvent</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/VIEW/"><span class="tag">VIEW</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/XML/"><span class="tag">XML</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/anim/"><span class="tag">anim</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/compose/"><span class="tag">compose</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/concurrency/"><span class="tag">concurrency</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/coroutie/"><span class="tag">coroutie</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/inter/"><span class="tag">inter</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/keyboard/"><span class="tag">keyboard</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/permission/"><span class="tag">permission</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/proguard/"><span class="tag">proguard</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Jon&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2024 Jon</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2019</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>