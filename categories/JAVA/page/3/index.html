<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>Category: JAVA - Jon&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Jon&#039;s Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Jon&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Jon&#039;s Blog"><meta property="og:url" content="https://noteforme.github.io/"><meta property="og:site_name" content="Jon&#039;s Blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://noteforme.github.io/img/og_image.png"><meta property="article:author" content="Jon"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://noteforme.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://noteforme.github.io"},"headline":"Jon's Blog","image":["https://noteforme.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Jon"},"publisher":{"@type":"Organization","name":"Jon's Blog","logo":{"@type":"ImageObject","url":"https://noteforme.github.io/img/logo.svg"}},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Jon&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/categories">Categories</a></li><li class="is-active"><a href="#" aria-current="page">JAVA</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-07-11T06:23:20.000Z" title="7/11/2018, 2:23:20 PM">2018-07-11</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-08-19T11:11:44.095Z" title="8/19/2021, 7:11:44 PM">2021-08-19</time></span><span class="level-item"><a class="link-muted" href="/categories/JAVA/">JAVA</a></span><span class="level-item">a few seconds read (About 74 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/07/11/Lambda/">Lambda</a></p><div class="content"><p><a target="_blank" rel="noopener" href="http://blog.oneapm.com/apm-tech/226.html">http://blog.oneapm.com/apm-tech/226.html</a></p>
<p>android </p>
<p><a target="_blank" rel="noopener" href="https://maxwell-nc.github.io/android/retrolambda.html">https://maxwell-nc.github.io/android/retrolambda.html</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1526621">https://cloud.tencent.com/developer/article/1526621</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/6844903668592934925">https://juejin.im/post/6844903668592934925</a></p>
<p>kotlin  lambda</p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/6844903604613021703">https://juejin.im/post/6844903604613021703</a></p>
<p>Video</p>
<h4 id="Java-lambda"><a href="#Java-lambda" class="headerlink" title="Java lambda"></a>Java lambda</h4><p>函数式编程</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/av54941486/">https://www.bilibili.com/video/av54941486/</a></p>
<p><a target="_blank" rel="noopener" href="http://www.chilangedu.com/sectionq/2132352424">http://www.chilangedu.com/sectionq/2132352424</a></p>
<h5 id="map"><a href="#map" class="headerlink" title="map"></a>map</h5><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;R&gt; Stream&lt;R&gt; <span class="keyword">map</span>(<span class="built_in">Function</span>&lt;? <span class="built_in">super</span> T, ? <span class="keyword">extends</span> R&gt; mapper);</span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="symbol">Function</span>&lt;<span class="symbol">T</span>, <span class="symbol">R</span>&gt; &#123;</span><br><span class="line">	    R apply(T t); <span class="comment">//将T类型转为R</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-05-31T14:54:44.000Z" title="5/31/2018, 10:54:44 PM">2018-05-31</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-01-02T03:31:39.076Z" title="1/2/2023, 11:31:39 AM">2023-01-02</time></span><span class="level-item"><a class="link-muted" href="/categories/JAVA/">JAVA</a></span><span class="level-item">13 minutes read (About 1990 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/05/31/HashMap/">HashMap</a></p><div class="content"><h4 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h4><p>Hash函数是指把⼀个⼤范围映射到⼀个⼩范围。把⼤范围映射到⼀个⼩范围的⽬的往往是为了 节省空间，使得数据容易保存。</p>
<h5 id="HashMap扩容机制"><a href="#HashMap扩容机制" class="headerlink" title="HashMap扩容机制"></a>HashMap扩容机制</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">     <span class="keyword">int</span> threshold;             <span class="comment">// 所能容纳的key-value对极限 </span></span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">float</span> loadFactor;    <span class="comment">// 负载因子</span></span><br><span class="line">     <span class="keyword">int</span> modCount;  </span><br><span class="line">     <span class="keyword">int</span> size;  </span><br><span class="line"><span class="keyword">new</span> HashMap&lt;Integer,String&gt;(<span class="number">2</span>,<span class="number">0.75f</span>)</span><br></pre></td></tr></table></figure>



<p>Node[] table的初始化长度length(默认值是16)，Load  factor为负载因子(默认值是0.75)，threshold是HashMap所能容纳的最大数据量的Node(键值对)个数。threshold = length * Load factor。也就是说，在数组定义好长度之后，负载因子越大，所能容纳的键值对个数越多。</p>
<p>map初始化为一个长度为2的数组，loadFactor=0.75，threshold=2*0.75=1，也就是说当put第二个key的时候，map就需要进行resize。</p>
<p><a target="_blank" rel="noopener" href="https://tech.meituan.com/2016/06/24/java-hashmap.html">https://tech.meituan.com/2016/06/24/java-hashmap.html</a></p>
<h5 id="HashMap和HashTable的区别"><a href="#HashMap和HashTable的区别" class="headerlink" title="HashMap和HashTable的区别"></a>HashMap和HashTable的区别</h5><ol>
<li>HashTable是线程安全的    </li>
<li>HashTable key不能为空，HashMap可以.存在数组为0的位置</li>
</ol>
<h5 id="HashMap的实现原理-HashMap数据结构？"><a href="#HashMap的实现原理-HashMap数据结构？" class="headerlink" title="HashMap的实现原理 HashMap数据结构？"></a>HashMap的实现原理 HashMap数据结构？</h5><ol>
<li><p>JDK1.7 Table数组+ Entry链表</p>
</li>
<li><p>JDK1.8 Table数组+ Entry链表/红黑树（ 为什么用红黑树）</p>
<p><strong>红黑树有自平衡</strong>的特点，可以防止不平衡情况的发生，所以可以始终将查找的<strong>时间复杂度控制在 O(log(n))</strong></p>
</li>
</ol>
<img src="https://pic1.zhimg.com/80/v2-3e203e5dcf8c12e7ebf137c344615aa4_1440w.jpg" style="zoom: 67%;">



<p>​    HashMap采用Entry数组存放key-value,每个 key value组成一个实体，Entry类实际上是一个单向的链表结构，它有next指针指向下一    个实体， 1.8中链表大于8时会转成红黑树.长度降到 6 就转换回去.</p>
<p>​    </p>
<p>HashMap源码理解</p>
<h5 id="HashMap如何"><a href="#HashMap如何" class="headerlink" title="HashMap如何"></a>HashMap如何</h5><h5 id="put数据（从HashMap源码角度讲解）？"><a href="#put数据（从HashMap源码角度讲解）？" class="headerlink" title="put数据（从HashMap源码角度讲解）？"></a>put数据（从HashMap源码角度讲解）？</h5><ol>
<li><p>对key的Dashcode()做hash运算，计算index.</p>
</li>
<li><p>如果没碰撞直接放到bucket⾥</p>
</li>
<li><p>如果碰撞了，以链表的形式存在buckets后</p>
</li>
<li><p>如果节点已经存在就替换old value(保证key的唯⼀性)</p>
</li>
<li><p>如果bucket满了(超过load factor*current capacity)，就要resize</p>
</li>
</ol>
<p>get数据</p>
<ol>
<li><p>对key的hashCode()做hash运算，计算index;</p>
</li>
<li><p>如果在bucket⾥的第⼀个节点⾥直接命中，则直接返回；</p>
</li>
<li><p>如果有冲突，则通过key.equals(k)去查找对应的Entry;分为下面两种方式.</p>
</li>
<li><p>若为树，则在树中通过key.equals(k)查找，O(logn)；</p>
</li>
<li><p>若为链表，则在链表中通过key.equals(k)查找，O(n)。</p>
</li>
</ol>
<p>HashMap怎么手写实现？</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/985534b21089">https://www.jianshu.com/p/985534b21089</a></p>
<p>HashTable实现原理</p>
<p>ConcurrentHashMap的实现原理</p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h5 id="HashTable-ConcurrentHashMap-区别"><a href="#HashTable-ConcurrentHashMap-区别" class="headerlink" title="HashTable  ConcurrentHashMap 区别"></a>HashTable  ConcurrentHashMap 区别</h5><p>Hashtable的实现是基于Dictionary抽象类的。Java5提供了ConcurrentHashMap，它是HashTable的替代，比HashTable的扩展性更好。</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1kJ411C7hC?p=9&amp;spm_id_from=pageDriver">https://www.bilibili.com/video/BV1kJ411C7hC?p=9&amp;spm_id_from=pageDriver</a></p>
<h5 id="TreeMap具体实现"><a href="#TreeMap具体实现" class="headerlink" title="TreeMap具体实现"></a>TreeMap具体实现</h5><p>TreeMap是一个有序的key-value集合，是非线程安全的，基于红黑树（Red-Black tree）实现。其映射根据<strong>键的自然顺序</strong>进行排序，或者根据<strong>创建映射时提供的 Comparator</strong> 进行排序，具体取决于使用的构造方法。其基本操作 containsKey、get、put 和 remove 的时间复杂度是 log(n) 。TreeMap是非同步的。 它的iterator 方法返回的迭代器是fail-fastl的。</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/nananana/p/10426377.html">https://www.cnblogs.com/nananana/p/10426377.html</a></p>
<h5 id="HashMap与HashSet的区别"><a href="#HashMap与HashSet的区别" class="headerlink" title="HashMap与HashSet的区别"></a>HashMap与HashSet的区别</h5><ol>
<li><p>基于 HashMap 实现的，底层采用 HashMap 来保存元素</p>
</li>
<li><p>HashSet实现了Set接口，它不允许集合中有重复的值</p>
</li>
</ol>
<p>HashSet与HashMap怎么判断集合元素重复？</p>
<h5 id="l-nn为什么不一开始就使用红黑树"><a href="#l-nn为什么不一开始就使用红黑树" class="headerlink" title="l nn为什么不一开始就使用红黑树"></a>l nn为什么不一开始就使用红黑树</h5><p>因为红⿊树需要进⾏左旋，右旋，变⾊这些操作来保持平衡，⽽单链表不需要。<br>当元素⼩于8个当时候，此时做查询操作，链表结构已经能保证查询性能。<br>当元素⼤于8个的时候，此时需要红⿊树来加快查 询速度，但是新增节点的效率变慢了。<br>因此，如果⼀开始就⽤红⿊树结构，元素太少，新增效率⼜⽐较慢，⽆疑这是浪费性能的。</p>
<h5 id="什么时候退化为链表"><a href="#什么时候退化为链表" class="headerlink" title="什么时候退化为链表"></a>什么时候退化为链表</h5><p>为6的时候退转为链表。中间有个差值7可以防⽌链表和树之间频繁的转换。<br>假设⼀下，如果设计成链表个数超过8则链表转 换成树结构，链表个数⼩于8则树结构转换成链表，<br>如果⼀个HashMap不停的插⼊、删除元素，链表个数在8左右徘徊，就会 频繁的发⽣树转链表、链表转树，效率会很低。</p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=jwL1W8zEuX4">https://www.youtube.com/watch?v=jwL1W8zEuX4</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1if4y167eE?p=4">https://www.bilibili.com/video/BV1if4y167eE?p=4</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/127147909">https://zhuanlan.zhihu.com/p/127147909</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/348756860">https://zhuanlan.zhihu.com/p/348756860</a></p>
<h4 id="ArrayMap"><a href="#ArrayMap" class="headerlink" title="ArrayMap"></a>ArrayMap</h4><p>ArrayMap类有两个非常重要的静态成员变量mBaseCache和mTwiceBaseCacheSize，用于ArrayMap所在进程的全局缓存功能：</p>
<p><img src="http://gityuan.com/images/arraymap/cache_add.jpg"></p>
<p>传入ArrayMap(4) 或者ArrayMap(8),性能会有变化吗</p>
<h5 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayMap</span><span class="params">(<span class="keyword">int</span> capacity, <span class="keyword">boolean</span> identityHashCode)</span> </span>&#123; <span class="comment">// 如果传入一个 capacity =4</span></span><br><span class="line">    mIdentityHashCode = identityHashCode;</span><br><span class="line">    <span class="keyword">if</span> (capacity &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        mHashes = EMPTY_IMMUTABLE_INTS;</span><br><span class="line">        mArray = EmptyArray.OBJECT;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (capacity == <span class="number">0</span>) &#123;</span><br><span class="line">        mHashes = EmptyArray.INT;</span><br><span class="line">        mArray = EmptyArray.OBJECT;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        allocArrays(capacity); <span class="comment">// 走到这里</span></span><br><span class="line">    &#125;</span><br><span class="line">    mSize = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">allocArrays</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mHashes == EMPTY_IMMUTABLE_INTS) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">&quot;ArrayMap is immutable&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (size == (BASE_SIZE*<span class="number">2</span>)) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (ArrayMap.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mTwiceBaseCache != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Object[] array = mTwiceBaseCache;</span><br><span class="line">                mArray = array;</span><br><span class="line">                mTwiceBaseCache = (Object[])array[<span class="number">0</span>];</span><br><span class="line">                mHashes = (<span class="keyword">int</span>[])array[<span class="number">1</span>];</span><br><span class="line">                array[<span class="number">0</span>] = array[<span class="number">1</span>] = <span class="keyword">null</span>;</span><br><span class="line">                mTwiceBaseCacheSize--;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">&quot;Retrieving 2x cache &quot;</span> + mHashes</span><br><span class="line">                        + <span class="string">&quot; now have &quot;</span> + mTwiceBaseCacheSize + <span class="string">&quot; entries&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (size == BASE_SIZE) &#123; <span class="comment">// 走到这里</span></span><br><span class="line">        <span class="keyword">synchronized</span> (ArrayMap.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mBaseCache != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Object[] array = mBaseCache;</span><br><span class="line">                mArray = array;</span><br><span class="line">                mBaseCache = (Object[])array[<span class="number">0</span>];</span><br><span class="line">                mHashes = (<span class="keyword">int</span>[])array[<span class="number">1</span>];</span><br><span class="line">                array[<span class="number">0</span>] = array[<span class="number">1</span>] = <span class="keyword">null</span>;</span><br><span class="line">                mBaseCacheSize--;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">&quot;Retrieving 1x cache &quot;</span> + mHashes</span><br><span class="line">                        + <span class="string">&quot; now have &quot;</span> + mBaseCacheSize + <span class="string">&quot; entries&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mHashes = <span class="keyword">new</span> <span class="keyword">int</span>[size];</span><br><span class="line">    mArray = <span class="keyword">new</span> Object[size&lt;&lt;<span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7049631659116888094">https://juejin.cn/post/7049631659116888094</a></p>
<p><a target="_blank" rel="noopener" href="http://gaozhipeng.me/posts/arraymap/">http://gaozhipeng.me/posts/arraymap/</a></p>
<p><a target="_blank" rel="noopener" href="http://gityuan.com/2019/01/13/arraymap/">http://gityuan.com/2019/01/13/arraymap/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=I16lz26WyzQ">https://www.youtube.com/watch?v=I16lz26WyzQ</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904119098982414">https://juejin.cn/post/6844904119098982414</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903762470060045">https://juejin.cn/post/6844903762470060045</a></p>
<h4 id="ArrayMap和HashMap的区别"><a href="#ArrayMap和HashMap的区别" class="headerlink" title="ArrayMap和HashMap的区别"></a>ArrayMap和HashMap的区别</h4><p>ArrayMap相比传统的HashMap速度更慢，因为其查找方法是二分法，并且当删除或添加数据时，会对空间重新调整，可以说ArrayMap是牺牲了时间来换空间，ArrayMap与HashMap的区别主要在：</p>
<p>存储方式不同：HashMap内部有一个HashMapEntry&lt;K,V&gt;[ ]对象，而ArrayMap是一个&lt;key,value&gt;映射的数据结构，内部使用两个数组进行数据存储，一个数组记录key的hash值，另一个数组记录value值。</p>
<p>添加数据时扩容的处理不一样：HashMap进行了new操作，重新创建对象，开销很大，而ArrayMap用的是copy数据，效率相对高很多。</p>
<p>ArrayMap提供了数组收缩的功能，在clear或remove之后，会重新收缩数组，释放空间。</p>
<p>ArrayMap采用的是二分法查找。</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7049631659116888094">https://juejin.cn/post/7049631659116888094</a></p>
<h4 id="SparseArray"><a href="#SparseArray" class="headerlink" title="SparseArray"></a>SparseArray</h4><p> key是int类型的Map，Android再次提供效率更高的数据结构SparseArray，可避免自动装箱过程,SparseArray不需要保存key所对应的哈希值，所以比ArrayMap还能再节省1/3的内存。</p>
<p><img src="http://gityuan.com/images/arraymap/SparseArray.jpg"></p>
<p>SparseArray构造mKeys     mValues两个数组，默认长度10，也可以自己定义initialCapacity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SparseArray</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (initialCapacity == <span class="number">0</span>) &#123;</span><br><span class="line">          mKeys = EmptyArray.INT;</span><br><span class="line">          mValues = EmptyArray.OBJECT;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          mValues = ArrayUtils.newUnpaddedObjectArray(initialCapacity);</span><br><span class="line">          mKeys = <span class="keyword">new</span> <span class="keyword">int</span>[mValues.length];</span><br><span class="line">      &#125;</span><br><span class="line">      mSize = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">int</span> key, E value)</span> </span>&#123;</span><br><span class="line">   	<span class="comment">// 二分查找,key在mKeys列表中对应的index,注意binarySearch返回做了 ~操作.</span></span><br><span class="line">  	<span class="comment">//如果没找到，返回的是当前元素将要插入的位置</span></span><br><span class="line">    <span class="keyword">int</span> i = ContainerHelpers.binarySearch(mKeys, mSize, key); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        mValues[i] = value;  <span class="comment">//找到后给对应的value数组赋值</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        i = ~i;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i &lt; mSize &amp;&amp; mValues[i] == DELETED) &#123;</span><br><span class="line">            mKeys[i] = key;</span><br><span class="line">            mValues[i] = value;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mGarbage &amp;&amp; mSize &gt;= mKeys.length) &#123;</span><br><span class="line">            gc();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Search again because indices may have changed.</span></span><br><span class="line">            i = ~ContainerHelpers.binarySearch(mKeys, mSize, key);</span><br><span class="line">        &#125;</span><br><span class="line">				<span class="comment">//插入数据，内部做了排序</span></span><br><span class="line">        mKeys = GrowingArrayUtils.insert(mKeys, mSize, i, key);</span><br><span class="line">        mValues = GrowingArrayUtils.insert(mValues, mSize, i, value);</span><br><span class="line">        mSize++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = ContainerHelpers.binarySearch(mKeys, mSize, key);</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mValues[i] != DELETED) &#123;</span><br><span class="line">            mValues[i] = DELETED;  <span class="comment">//标记该数据为DELETE</span></span><br><span class="line">            mGarbage = <span class="keyword">true</span>; <span class="comment">// 设置存在GC</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zxt0601/article/details/78333328">https://blog.csdn.net/zxt0601/article/details/78333328</a></p>
<p><a target="_blank" rel="noopener" href="http://www.jcodecraeer.com/a/anzhuokaifa/2017/0912/8504.html">http://www.jcodecraeer.com/a/anzhuokaifa/2017/0912/8504.html</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-05-24T14:31:57.000Z" title="5/24/2018, 10:31:57 PM">2018-05-24</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-08-19T11:11:43.765Z" title="8/19/2021, 7:11:43 PM">2021-08-19</time></span><span class="level-item"><a class="link-muted" href="/categories/JAVA/">JAVA</a></span><span class="level-item">an hour read (About 7163 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/05/24/Concurrency_Locking/">Concurrency_Locking</a></p><div class="content"><h4 id="锁的7大类"><a href="#锁的7大类" class="headerlink" title="锁的7大类"></a>锁的7大类</h4><h5 id="偏向锁-轻量级锁-重量级锁；"><a href="#偏向锁-轻量级锁-重量级锁；" class="headerlink" title="偏向锁/轻量级锁/重量级锁；"></a>偏向锁/轻量级锁/重量级锁；</h5><p><img src="/2018/05/24/Concurrency_Locking/2021-07-06_12-19-34.png"></p>
<ul>
<li><p>偏向锁</p>
<p>​    如果自始至终，对于这把锁都不存在竞争，那么其实就没必要上锁，只需要打个标记就行了，这就是偏向锁的思想。</p>
</li>
<li><p>轻量级锁</p>
<p>​    JVM 开发者发现在很多情况下，synchronized 中的代码是被多个线程交替执行的，而不是同时执行的，也就是说并不存在实际的    竞争，或者是只有短时间的锁竞争，用 CAS 就可以解决，这种情况下，用完全互斥的重量级锁是没必要的。</p>
</li>
<li><p>重量级锁</p>
<p>​    重量级锁是互斥锁，它是利用操作系统的同步机制实现的，所以开销相对比较大。当多个线程直接有实际竞争，且锁竞争时间长的时候，轻量级锁不能满足需求，锁就会膨胀为重量级锁。重量级锁会让其他申请却拿不到锁的线程进入阻塞状态。</p>
<h5 id="锁升级"><a href="#锁升级" class="headerlink" title="锁升级"></a>锁升级</h5><p><img src="https://s0.lgstatic.com/i/image3/M01/58/E4/CgpOIF35yCGAGFBbAAAO9n9VgTQ034.png"></p>
<ul>
<li><p>synchronized锁升级</p>
<p>偏向锁： markword记录这个线程ID -》如果线程争用升级为自旋锁 -》10次以后升级为重量级锁</p>
</li>
</ul>
<h4 id="synchronized的monitor-锁"><a href="#synchronized的monitor-锁" class="headerlink" title="synchronized的monitor 锁"></a>synchronized的monitor 锁</h4><h5 id="同步代码块"><a href="#同步代码块" class="headerlink" title="同步代码块"></a>同步代码块</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">synBlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;lagou&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>反编译后的字节码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">synBlock</span><span class="params">()</span></span>;</span><br><span class="line">   descriptor: ()V</span><br><span class="line">   flags: ACC_PUBLIC</span><br><span class="line">   Code:</span><br><span class="line">     stack=<span class="number">2</span>, locals=<span class="number">3</span>, args_size=<span class="number">1</span></span><br><span class="line">        <span class="number">0</span>: aload_0</span><br><span class="line">        <span class="number">1</span>: dup</span><br><span class="line">        <span class="number">2</span>: astore_1</span><br><span class="line">        <span class="number">3</span>: monitorenter</span><br><span class="line">        4: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">        7: ldc           #3                      // String lagou</span><br><span class="line">        9: invokevirtual #4               // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">       <span class="number">12</span>: aload_1</span><br><span class="line">       <span class="number">13</span>: monitorexit</span><br><span class="line">       <span class="number">14</span>: goto          <span class="number">22</span></span><br><span class="line">       <span class="number">17</span>: astore_2</span><br><span class="line">       <span class="number">18</span>: aload_1</span><br><span class="line">       <span class="number">19</span>: monitorexit</span><br><span class="line">       <span class="number">20</span>: aload_2</span><br><span class="line">       <span class="number">21</span>: athrow</span><br><span class="line">       <span class="number">22</span>: <span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<p>synchronized 代码块实际上多了 monitorenter 和 monitorexit 指令，标红的第3、13、19行指令分别对应的是 monitorenter 和 monitorexit.可以把执行 monitorenter 理解为加锁，执行 monitorexit 理解为释放锁，每个对象维护着一个记录着被锁次数的计数器。未被锁定的对象的该计数器为 0。</p>
<ol>
<li>monitorenter</li>
</ol>
<p>执行 monitorenter 的线程尝试获得 monitor 的所有权，会发生以下这三种情况之一：</p>
<p>a. 如果该 monitor 的计数为 0，则线程获得该 monitor 并将其计数设置为 1。然后，该线程就是这个 monitor 的所有者。</p>
<p>b. 如果线程已经拥有了这个 monitor ，则它将重新进入，并且累加计数。</p>
<p>c. 如果其他线程已经拥有了这个 monitor，那个这个线程就会被阻塞，直到这个 monitor 的计数变成为 0，代表这个 monitor 已经被释放了，于是当前这个线程就会再次尝试获取这个 monitor。</p>
<ol start="2">
<li>monitorexit<br>monitorexit 的作用是将 monitor 的计数器减 1，直到减为 0 为止。代表这个 monitor 已经被释放了，已经没有任何线程拥有它了，也就代表着解锁，所以，其他正在等待这个 monitor 的线程，此时便可以再次尝试获取这个 monitor 的所有权。</li>
</ol>
<p>从上面也可看到  <strong>synchronized是可重入锁</strong></p>
<h6 id="synchronized-方法"><a href="#synchronized-方法" class="headerlink" title="synchronized 方法"></a>synchronized 方法</h6><p>​        同步代码块是使用 monitorenter 和 monitorexit 指令实现的。而对于 synchronized 方法，并不是依靠 monitorenter 和 monitorexit 指令实现的，被 javap 反汇编后可以看到，synchronized 方法和普通方法大部分是一样的，不同在于，这个方法会有一个叫作 ACC_SYNCHRONIZED 的 flag 修饰符，来表明它是同步方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    method body</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>反编译后的指令</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">synMethod</span><span class="params">()</span></span>;</span><br><span class="line">   </span><br><span class="line">       descriptor: ()V</span><br><span class="line">   </span><br><span class="line">       flags: ACC_PUBLIC, ACC_SYNCHRONIZED</span><br><span class="line">   </span><br><span class="line">       Code:</span><br><span class="line">   </span><br><span class="line">         stack=<span class="number">0</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">   </span><br><span class="line">            <span class="number">0</span>: <span class="keyword">return</span></span><br><span class="line">   </span><br><span class="line">         LineNumberTable:</span><br><span class="line">   </span><br><span class="line">           line <span class="number">16</span>: <span class="number">0</span></span><br><span class="line">   </span><br></pre></td></tr></table></figure>



<p>被 synchronized 修饰的方法会有一个 ACC_SYNCHRONIZED 标志。当某个线程要访问某个方法的时候，会首先检查方法是否有 ACC_SYNCHRONIZED 标志，如果有则需要先获得 monitor 锁，然后才能开始执行方法，方法执行之后再释放 monitor 锁。其他方面， synchronized 方法和刚才的 synchronized 代码块是很类似的，例如这时如果其他线程来请求执行方法，也会因为无法获得 monitor 锁而被阻塞。</p>
<h6 id="synchronized-和-Lock选择"><a href="#synchronized-和-Lock选择" class="headerlink" title="synchronized 和 Lock选择"></a>synchronized 和 Lock选择</h6><ol>
<li><p>如果能不用最好既不使用 Lock 也不使用 synchronized。因为在许多情况下你可以使用 java.util.concurrent 包中的机制，它会为你处理所有的加锁和解锁操作，也就是推荐优先使用工具类来加解锁。</p>
</li>
<li><p>如果 synchronized 关键字适合你的程序， 那么请尽量使用它，这样可以减少编写代码的数量，减少出错的概率。因为一旦忘记在 finally 里 unlock，代码可能会出很大的问题，而使用 synchronized 更安全。</p>
</li>
<li><p>如果特别需要 Lock 的特殊功能，比如尝试获取锁、可中断、超时功能等，才使用 Lock。</p>
</li>
</ol>
<h6 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Lock</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(<span class="keyword">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">Condition <span class="title">newCondition</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>lock() </p>
<p>lock() 是最基础的获取锁的方法,获取锁和释放锁都是显式的，不像 synchronized 那样是隐式的，所以 Lock 不会像 synchronized 一样在异常时自动释放锁（synchronized 即使不写对应的代码也可以释放）,使用 lock() 时必须由我们自己主动去释放锁，因此最佳实践是执行 lock() 后，首先在 try{} 中操作同步资源，如果有必要就用 catch{} 块捕获异常，然后在 finally{} 中释放锁，以保证发生异常时锁一定被释放.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Lock lock = ...;</span><br><span class="line">lock.lock();</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="comment">//获取到了被本锁保护的资源，处理任务</span></span><br><span class="line">    <span class="comment">//捕获异常</span></span><br><span class="line">&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">    lock.unlock();   <span class="comment">//释放锁</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>tryLock()</p>
<p>​    尝试获取锁，如果当前锁没有被其他线程占用，则获取成功，返回 true，否则返回 false，代表获取锁失败。该方法会立即返回，即便在拿不到锁时也不会一直等待，所以通常情况下，我们用 if 语句判断 tryLock() 的返回结果.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Lock lock = ...;</span><br><span class="line"><span class="keyword">if</span>(lock.tryLock()) &#123;</span><br><span class="line">     <span class="keyword">try</span>&#123;</span><br><span class="line">         <span class="comment">//处理任务</span></span><br><span class="line">     &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">         lock.unlock();   <span class="comment">//释放锁</span></span><br><span class="line">     &#125; </span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//如果不能获取锁，则做其他事情</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法可以方便的解决死锁问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tryLock</span><span class="params">(Lock lock1, Lock lock2)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">       <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (lock1.tryLock()) &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   <span class="keyword">if</span> (lock2.tryLock()) &#123;</span><br><span class="line">                       <span class="keyword">try</span> &#123;</span><br><span class="line">                           System.out.println(<span class="string">&quot;获取到了两把锁，完成业务逻辑&quot;</span>);</span><br><span class="line">                           <span class="keyword">return</span>;</span><br><span class="line">                       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                           lock2.unlock();</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                   lock1.unlock();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               Thread.sleep(<span class="keyword">new</span> Random().nextInt(<span class="number">1000</span>));</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>如果代码中我们不用 tryLock() 方法,比如有两个线程同时调用这个方法，传入的 lock1 和 lock2 恰好是相反的，那么如果第一个线程获取了 lock1 的同时，第二个线程获取了 lock2，它们接下来便会尝试获取对方持有的那把锁，但是又获取不到，于是便会陷入死锁，使用tryLock()后，如果获取到了 lock1 但没有获取到 lock2，那么也会释放掉 lock1</p>
</li>
<li><p>tryLock(long time, TimeUnit unit)</p>
<p>使用 tryLock(long time, TimeUnit unit) 时，在等待了一段指定的超时时间后，线程会主动放弃这把锁的获取，避免永久等待；在等待的期间，也可以随时中断线程，这就避免了死锁的发生。</p>
</li>
<li><p>lockInterruptibly()</p>
<p>如果这个锁当前是可以获得的，那么这个方法会立刻返回,，但是如果这个锁当前是不能获得的（被其他线程持有），那么当前线程便会开始等待，除非它等到了这把锁或者是在等待的过程中被Thread的interrupt()方法中断了，否则这个线程便会一直在这里执行这行代码。一直尝试获取直到获取到为止。</p>
<p>相比于不能响应中断的 synchronized 锁，lockInterruptibly() 可以让程序更灵活，可以在获取锁的同时，保持对中断的响应。我们可以把这个方法理解为超时时间是无穷长的 tryLock(long time, TimeUnit unit)，因为 tryLock(long time, TimeUnit unit) 和 lockInterruptibly() 都能响应中断，只不过 lockInterruptibly() 永远不会超时。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lockInterruptibly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           lock.lockInterruptibly();</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               System.out.println(<span class="string">&quot;操作资源&quot;</span>);</span><br><span class="line">           &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">               lock.unlock();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>unlock()</p>
<p>最后要介绍的方法是 unlock() 方法，是用于解锁的，u方法比较简单，对于 ReentrantLock 而言，执行 unlock() 的时候，内部会把锁的“被持有计数器”减 1，直到减到 0 就代表当前这把锁已经完全释放了，如果减 1 后计数器不为 0，说明这把锁之前被“重入”了，那么锁并没有真正释放，仅仅是减少了持有的次数。</p>
</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://www.yinxiang.com/everhub/note/c27d346d-ed4d-4e7b-aef9-0b501a44deb7">https://www.yinxiang.com/everhub/note/c27d346d-ed4d-4e7b-aef9-0b501a44deb7</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1NT4y1G7WE?p=5">https://www.bilibili.com/video/BV1NT4y1G7WE?p=5</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1qE411q7fk?p=10">https://www.bilibili.com/video/BV1qE411q7fk?p=10</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/aspirant/p/11470858.html">https://www.cnblogs.com/aspirant/p/11470858.html</a></p>
</li>
</ul>
<h5 id="可重入锁-非可重入锁；"><a href="#可重入锁-非可重入锁；" class="headerlink" title="可重入锁/非可重入锁；"></a>可重入锁/非可重入锁；</h5><p>​    可重入锁 ： 可重入锁指的是线程当前已经持有这把锁了，能在不释放这把锁的情况下，再次获取这把锁。    </p>
<p>​    synchronized是可冲入锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span>  <span class="title">m1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;m1 start&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        m2();</span><br><span class="line">        System.out.println(<span class="string">&quot;m1 end&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">m2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;m2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> T().m1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="name">m1</span> start</span><br><span class="line"><span class="name">m2</span></span><br><span class="line"><span class="name">m1</span> e<span class="symbol">nd</span></span><br></pre></td></tr></table></figure>

<p>如果synchronized不是可重入锁，执行m1()执行m2()会发生死锁,</p>
<p>为什么synchronized必须是可重入锁呢?</p>
<p>如果父类m2()是synchronized方法,子类重写m2()方法，调用子类m2(),接着调用super.m2()就会发生死锁</p>
<h5 id="共享锁-独占锁"><a href="#共享锁-独占锁" class="headerlink" title="共享锁/独占锁"></a>共享锁/独占锁</h5><ul>
<li><p>共享锁</p>
<p>共享锁指的是我们同一把锁可以被多个线程同时获得</p>
</li>
<li><p>独占锁 </p>
<p>这把锁只能同时被一个线程获得</p>
<p>读写锁就最好地诠释了共享锁和独占锁的理念。读写锁中的读锁，是共享锁，而写锁是独占锁。读锁可以被同时读，可以同时被多个线程持有，而写锁最多只能同时被一个线程持有。</p>
</li>
</ul>
<p>整体思路是它有两把锁，第 1 把锁是写锁，获得写锁之后，既可以读数据又可以修改数据，而第 2 把锁是读锁，获得读锁之后，只能查看数据，不能修改数据。读锁可以被多个线程同时持有，所以多个线程可以同时查看数据。</p>
<p>我们在使用读写锁时遵守下面的获取规则：</p>
<ol>
<li>如果有一个线程已经占用了读锁，则此时其他线程如果要申请读锁，可以申请成功。</li>
<li>如果有一个线程已经占用了读锁，则此时其他线程如果要申请写锁，则申请写锁的线程会一直等待释放读锁，因为读写不能同时操作。</li>
<li>如果有一个线程已经占用了写锁，则此时其他线程如果申请写锁或者读锁，都必须等待之前的线程释放写锁，同样也因为读写不能同时，并且两个线程不应该同时写。</li>
</ol>
<p>所以我们用一句话总结：要么是一个或多个线程同时有读锁，要么是一个线程有写锁，但是两者不会同时出现。也可以总结为：读读共享、其他都互斥（写写互斥、读写互斥、写读互斥）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 描述：     演示读写锁用法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadWriteLockDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ReentrantReadWriteLock reentrantReadWriteLock = <span class="keyword">new</span> ReentrantReadWriteLock(</span><br><span class="line">            <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ReentrantReadWriteLock.ReadLock readLock = reentrantReadWriteLock</span><br><span class="line">            .readLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ReentrantReadWriteLock.WriteLock writeLock = reentrantReadWriteLock</span><br><span class="line">            .writeLock();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        readLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;得到读锁，正在读取&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;释放读锁&quot;</span>);</span><br><span class="line">            readLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        writeLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;得到写锁，正在写入&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;释放写锁&quot;</span>);</span><br><span class="line">            writeLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; read()).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; read()).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; write()).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; write()).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Thread</span>-<span class="number">0</span>得到读锁，正在读取</span><br><span class="line"><span class="attribute">Thread</span>-<span class="number">1</span>得到读锁，正在读取</span><br><span class="line"><span class="attribute">Thread</span>-<span class="number">0</span>释放读锁</span><br><span class="line"><span class="attribute">Thread</span>-<span class="number">1</span>释放读锁</span><br><span class="line"><span class="attribute">Thread</span>-<span class="number">2</span>得到写锁，正在写入</span><br><span class="line"><span class="attribute">Thread</span>-<span class="number">2</span>释放写锁</span><br><span class="line"><span class="attribute">Thread</span>-<span class="number">3</span>得到写锁，正在写入</span><br><span class="line"><span class="attribute">Thread</span>-<span class="number">3</span>释放写锁</span><br></pre></td></tr></table></figure>

<p>读锁可以同时被多个线程获得，而写锁不能。</p>
<p>为什么要对读加锁 :  读本身是线程安全的，加读锁，主要是为了让写锁感知到，在有人读取的时候，不要同时写入。</p>
<p>ReentrantReadWriteLockTest.java</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> static ReentrantReadWriteLock reentrantLock = <span class="keyword">new</span> <span class="constructor">ReentrantReadWriteLock()</span>;</span><br><span class="line"><span class="keyword">private</span> static ReentrantReadWriteLock.ReadLock readLock = reentrantLock.read<span class="constructor">Lock()</span>;</span><br><span class="line"><span class="keyword">private</span> static ReentrantReadWriteLock.WriteLock writeLock = reentrantLock.write<span class="constructor">Lock()</span>;</span><br><span class="line"></span><br><span class="line">public static void read<span class="literal">()</span> &#123;</span><br><span class="line">    readLock.lock<span class="literal">()</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>out.println(<span class="module-access"><span class="module"><span class="identifier">Thread</span>.</span></span>current<span class="constructor">Thread()</span>.get<span class="constructor">Name()</span> + <span class="string">&quot;获取读锁，开始执行&quot;</span>);</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">Thread</span>.</span></span>sleep(<span class="number">2000</span>);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.print<span class="constructor">StackTrace()</span>;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        readLock.unlock<span class="literal">()</span>;</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>out.println(<span class="module-access"><span class="module"><span class="identifier">Thread</span>.</span></span>current<span class="constructor">Thread()</span>.get<span class="constructor">Name()</span> + <span class="string">&quot;释放读锁&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">public static void write<span class="literal">()</span> &#123;</span><br><span class="line">    writeLock.lock<span class="literal">()</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>out.println(<span class="module-access"><span class="module"><span class="identifier">Thread</span>.</span></span>current<span class="constructor">Thread()</span>.get<span class="constructor">Name()</span> + <span class="string">&quot;获取写锁，开始执行&quot;</span>);</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">Thread</span>.</span></span>sleep(<span class="number">2000</span>);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.print<span class="constructor">StackTrace()</span>;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        writeLock.unlock<span class="literal">()</span>;</span><br><span class="line">        <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>out.println(<span class="module-access"><span class="module"><span class="identifier">Thread</span>.</span></span>current<span class="constructor">Thread()</span>.get<span class="constructor">Name()</span> + <span class="string">&quot;释放写锁&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void main(String<span class="literal">[]</span> args) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="constructor">Thread(()</span> -&gt; read<span class="literal">()</span>, <span class="string">&quot;Thread1&quot;</span>).start<span class="literal">()</span>;</span><br><span class="line">    <span class="keyword">new</span> <span class="constructor">Thread(()</span> -&gt; read<span class="literal">()</span>, <span class="string">&quot;Thread2&quot;</span>).start<span class="literal">()</span>;</span><br><span class="line">    <span class="keyword">new</span> <span class="constructor">Thread(()</span> -&gt; write<span class="literal">()</span>, <span class="string">&quot;Thread3&quot;</span>).start<span class="literal">()</span>;</span><br><span class="line">    <span class="keyword">new</span> <span class="constructor">Thread(()</span> -&gt; write<span class="literal">()</span>, <span class="string">&quot;Thread4&quot;</span>).start<span class="literal">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果:</p>
<p><u>Thread1获取读锁，开始执行<br>Thread2获取读锁，开始执行<br>Thread1释放读锁<br>Thread2释放读锁<br>Thread3获取写锁，开始执行<br>Thread3释放写锁<br>Thread4获取写锁，开始执行<br>Thread4释放写锁</u></p>
<p>线程1和线程2可以同时获取读锁，而线程3和线程4只能依次获取写锁，因为线程4必须等待线程3释放写锁后才能获取到锁</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/fanrenxiang/article/details/104312606">https://blog.csdn.net/fanrenxiang/article/details/104312606</a></p>
<h5 id="公平锁-非公平锁；"><a href="#公平锁-非公平锁；" class="headerlink" title="公平锁/非公平锁；"></a>公平锁/非公平锁；</h5><ul>
<li><p>公平锁 </p>
<p>线程就都会进入等待，开始排队，在等待队列里等待时间长的线程会优先拿到这把锁，有先来先得的意思，公平锁指的是按照线程请求的顺序，来分配锁</p>
</li>
<li><p>非公平锁</p>
<p>它会在一定情况下，忽略掉已经在排队的线程，发生插队现象，而非公平锁指的是不完全按照请求的顺序，在一定情况下，可以允许插队</p>
<p>公平锁 <code>new ReentrantLock(false);</code></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FairAndUnfair</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        PrintQueue printQueue = <span class="keyword">new</span> PrintQueue();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Thread thread[] = <span class="keyword">new</span> Thread[<span class="number">10</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            thread[i] = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Job(printQueue), <span class="string">&quot;Thread &quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            thread[i].start();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Job</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> PrintQueue printQueue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Job</span><span class="params">(PrintQueue printQueue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.printQueue = printQueue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;%s: Going to print a job\n&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">        printQueue.printJob(<span class="keyword">new</span> Object());</span><br><span class="line">        System.out.printf(<span class="string">&quot;%s: The document has been printed\n&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintQueue</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock queueLock = <span class="keyword">new</span> ReentrantLock(<span class="keyword">false</span>); <span class="comment">//非公平锁</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printJob</span><span class="params">(Object document)</span> </span>&#123;</span><br><span class="line">        queueLock.lock();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Long duration = (<span class="keyword">long</span>) (Math.random() * <span class="number">10000</span>);</span><br><span class="line">            System.out.printf(<span class="string">&quot;%s: PrintQueue: Printing a Job during %d seconds\n&quot;</span>,</span><br><span class="line">                    Thread.currentThread().getName(), (duration / <span class="number">1000</span>));</span><br><span class="line">            Thread.sleep(duration);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            queueLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        queueLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Long duration = (<span class="keyword">long</span>) (Math.random() * <span class="number">10000</span>);</span><br><span class="line">            System.out.printf(<span class="string">&quot;%s: PrintQueue: Printing a Job during %d seconds\n&quot;</span>,</span><br><span class="line">                    Thread.currentThread().getName(), (duration / <span class="number">1000</span>));</span><br><span class="line">            Thread.sleep(duration);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            queueLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>​        运行结果</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Thread</span> <span class="number">0</span>: Going to print a job</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">0</span>: PrintQueue: Printing a Job during <span class="number">8</span> seconds</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">1</span>: Going to print a job</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">2</span>: Going to print a job</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">3</span>: Going to print a job</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">4</span>: Going to print a job</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">5</span>: Going to print a job</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">6</span>: Going to print a job</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">7</span>: Going to print a job</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">8</span>: Going to print a job</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">9</span>: Going to print a job</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">0</span>: PrintQueue: Printing a Job during <span class="number">2</span> seconds</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">0</span>: The document has been printed</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">1</span>: PrintQueue: Printing a Job during <span class="number">8</span> seconds</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">1</span>: PrintQueue: Printing a Job during <span class="number">8</span> seconds</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">1</span>: The document has been printed</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">2</span>: PrintQueue: Printing a Job during <span class="number">7</span> seconds</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">2</span>: PrintQueue: Printing a Job during <span class="number">5</span> seconds</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">2</span>: The document has been printed</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">3</span>: PrintQueue: Printing a Job during <span class="number">5</span> seconds</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">3</span>: PrintQueue: Printing a Job during <span class="number">0</span> seconds</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">3</span>: The document has been printed</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">4</span>: PrintQueue: Printing a Job during <span class="number">5</span> seconds</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">4</span>: PrintQueue: Printing a Job during <span class="number">9</span> seconds</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">4</span>: The document has been printed</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">5</span>: PrintQueue: Printing a Job during <span class="number">6</span> seconds</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">5</span>: PrintQueue: Printing a Job during <span class="number">6</span> seconds</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">5</span>: The document has been printed</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">6</span>: PrintQueue: Printing a Job during <span class="number">1</span> seconds</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">6</span>: PrintQueue: Printing a Job during <span class="number">5</span> seconds</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">6</span>: The document has been printed</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">7</span>: PrintQueue: Printing a Job during <span class="number">1</span> seconds</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">7</span>: PrintQueue: Printing a Job during <span class="number">1</span> seconds</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">7</span>: The document has been printed</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">8</span>: PrintQueue: Printing a Job during <span class="number">6</span> seconds</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">8</span>: PrintQueue: Printing a Job during <span class="number">1</span> seconds</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">8</span>: The document has been printed</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">9</span>: PrintQueue: Printing a Job during <span class="number">1</span> seconds</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">9</span>: PrintQueue: Printing a Job during <span class="number">0</span> seconds</span><br><span class="line"><span class="attribute">Thread</span> <span class="number">9</span>: The document has been printed</span><br></pre></td></tr></table></figure>

<p>可以看到thread1释放锁后又重新获取到锁</p>
<p>​    ReentrantLockTest.java</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="keyword">COUNT</span> = <span class="number">100</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> start = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">static</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(String[] args) &#123;</span><br><span class="line">    Runnable <span class="keyword">task</span> = () -&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (start &lt;= <span class="keyword">COUNT</span>) &#123;</span><br><span class="line">                    System.out.<span class="keyword">println</span>(Thread.currentThread().getName() + <span class="string">&quot;=&gt; &quot;</span> + start++);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    System.exit(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">new</span> Thread(<span class="keyword">task</span>).start();</span><br><span class="line">    <span class="keyword">new</span> Thread(<span class="keyword">task</span>).start();</span><br></pre></td></tr></table></figure>

<p>运行结果:</p>
<br>

<p>Thread-0=&gt; 1<br>Thread-1=&gt; 2<br>Thread-0=&gt; 3<br>Thread-1=&gt; 4<br>…<br>Thread-1=&gt; 36<br>Thread-1=&gt; 37<br>Thread-1=&gt; 38<br>Thread-1=&gt; 39</p>
<p>Thread-1=&gt; 40<br>Thread-1=&gt; 41<br>Thread-1=&gt; 42<br>Thread-1=&gt; 43<br>Thread-1=&gt; 44<br>Thread-1=&gt; 45<br>Thread-1=&gt; 46<br>Thread-1=&gt; 47<br>Thread-1=&gt; 48</p>
<br>

<p>Otherwise this lock does not guarantee any particular access order.可见公平锁不保证有序。</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903983308341261">https://juejin.cn/post/6844903983308341261</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/ReentrantLock.html">https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/ReentrantLock.html</a></p>
<h5 id="悲观锁-乐观锁；"><a href="#悲观锁-乐观锁；" class="headerlink" title="悲观锁/乐观锁；"></a>悲观锁/乐观锁；</h5><ol>
<li><p>悲观锁</p>
<blockquote>
<p>必须先拿到锁，以便达到“独占”的状态，当前线程在操作资源的时候，其他线程由于不能拿到锁.</p>
<p>它认为如果不锁住这个资源，别的线程就会来争抢，就会造成数据结果错误，所以悲观锁为了确保结果的正确性，会在每次获取并修改数据时，都把数据锁住，让其他线程无法访问该数据，这样就可以确保数据内容万无一失。</p>
<p>Java 中悲观锁的实现包括 synchronized 关键字和 Lock 相关类等，我们以 Lock 接口为例，例如 Lock 的实现类 ReentrantLock，类中的 lock() 等方法就是执行加锁，而 unlock() 方法是执行解锁。处理资源之前必须要先加锁并拿到锁，等到处理完了之后再解开锁，这就是非常典型的悲观锁思想。</p>
</blockquote>
<p>synchronized 关键字和 Lock 接口</p>
<p>大喜大悲：数据库</p>
<blockquote>
<p>数据库中同时拥有悲观锁和乐观锁的思想。例如，我们如果在 MySQL 选择 select for update 语句，那就是悲观锁，在提交之前不允许第三方来修改该数据，这当然会造成一定的性能损耗，在高并发的情况下是不可取的</p>
<p>相反，我们可以利用一个版本 version 字段在数据库中实现乐观锁。在获取及修改数据时都不需要加锁，但是我们在获取完数据并计算完毕，准备更新数据时，会检查版本号和获取数据时的版本号是否一致，如果一致就直接更新，如果不一致，说明计算期间已经有其他线程修改过这个数据了，那我就可以选择重新获取数据，重新计算，然后再次尝试更新数据。</p>
</blockquote>
</li>
</ol>
<ol start="2">
<li>乐观锁</li>
</ol>
<p>利用 CAS 理念，在不独占资源的情况下，完成了对资源的修改。</p>
<p>为了确保数据正确性，在更新之前，会去对比在我修改数据期间，数据有没有被其他线程修改过：如果没被修改过，就说明真的只有我自己在操作，那我就可以正常的修改数据；如果发现数据和我一开始拿到的不一样了，说明其他线程在这段时间内修改过数据，那说明我迟了一步，所以我会放弃这次修改，并选择报错、重试等策略。</p>
<p>​    </p>
<h5 id="自旋锁-非自旋锁；"><a href="#自旋锁-非自旋锁；" class="headerlink" title="自旋锁/非自旋锁；"></a>自旋锁/非自旋锁；</h5><ul>
<li><p>自旋锁</p>
<p>自旋锁的理念是如果线程现在拿不到锁，并不直接陷入阻塞或者释放 CPU 资源，而是开始利用循环，不停地尝试获取锁，这个循环过程被形象地比喻为“自旋”</p>
<p>阻塞和唤醒线程都是需要高昂的开销的，如果同步代码块中的内容不复杂，那么可能转换线程带来的开销比实际业务代码执行的开销还要大。</p>
</li>
<li><p>非自旋锁</p>
<p>如果它发现此时获取不到锁，它就把自己的线程切换状态，让线程休眠，然后 CPU 就可以在这段时间去做很多其他的事情，直到之前持有这把锁的线程释放了锁，于是 CPU 再把之前的线程恢复回来，让这个线程再去尝试获取这把锁。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 持有锁的线程，null表示锁未被线程持有</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> AtomicReference&lt;Thread&gt; ref = <span class="keyword">new</span> AtomicReference&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Thread currentThread = Thread.currentThread();</span><br><span class="line">    <span class="keyword">while</span>(!ref.compareAndSet(<span class="keyword">null</span>, currentThread))&#123;</span><br><span class="line">        <span class="comment">//当ref为null的时候compareAndSet返回true，反之为false</span></span><br><span class="line">        <span class="comment">//通过循环不断的自旋判断锁是否被其他线程持有</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Thread cur = Thread.currentThread();</span><br><span class="line">    <span class="keyword">if</span>(ref.get() != cur)&#123;</span><br><span class="line">        <span class="comment">//exception ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    ref.set(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> count  = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">100</span>);</span><br><span class="line">    CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">100</span>);</span><br><span class="line">    SimpleSpinningLock simpleSpinningLock = <span class="keyword">new</span> SimpleSpinningLock();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">100</span> ; i++)&#123;</span><br><span class="line">        executorService.execute(() -&gt; &#123;</span><br><span class="line">            simpleSpinningLock.lock();</span><br><span class="line">            ++count;</span><br><span class="line">            simpleSpinningLock.unLock();</span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    countDownLatch.await();</span><br><span class="line">    System.out.println(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="可中断锁-不可中断锁。"><a href="#可中断锁-不可中断锁。" class="headerlink" title="可中断锁/不可中断锁。"></a>可中断锁/不可中断锁。</h5><p>第 7 种分类是可中断锁和不可中断锁。在 Java 中，synchronized 关键字修饰的锁代表的是不可中断锁，一旦线程申请了锁，就没有回头路了，只能等到拿到锁以后才能进行其他的逻辑处理。而我们的 ReentrantLock 是一种典型的可中断锁，例如使用 lockInterruptibly 方法在获取锁的过程中，突然不想获取了，那么也可以在中断之后去做其他的事情，不需要一直傻等到获取到锁才离开。</p>
<h4 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h4><ul>
<li>条件</li>
</ul>
<ol>
<li>互斥条件 :   任务使用的资源至少有一个是不能共享的；chopstick一次只能被一个Philosopher使用</li>
<li>请求保持条件:   至少有一个任务必须持有跟一个资源且正在等待获取一个当前被别的任务持有的资源</li>
<li>不可剥夺条件:  资源不能被任务抢占</li>
<li>环路等待条件:  必须有循环等待。一个任务等待其他任务所持有的资源，后者又等待另一个任务所持有的资源,使得大家都被锁住.</li>
</ol>
<p><strong>当两个（或多个）线程（或进程）相互持有对方所需要的资源，却又都不主动释放自己手中所持有的资源，导致大家都获取不到自己想要的资源</strong></p>
<p>那么为什么会产生死锁呢? 学过操作系统的朋友应该都知道，死锁的产生必须具备以<br>下四个条件 。</p>
<ol>
<li>互斥条件: 指线程对己经获取到的资源进行排它性使用 ，即该资源同时只由 一个线<br>程占用。如果 此时 还有其 他 线程请求获取该资源 ，则 请求者只能等待，直至占有资<br>源 的 线程释放该资源。</li>
<li>.请求并持有条件 : 指一个线程己经持有了至少一个资源，但又提出了新的资源请求，<br>而新资源己被其 他 线程占有，所 以 当前线程会被阻塞 ，但 阻塞 的同时 并不释放自 己<br>己经获取的资源。</li>
<li>不可剥夺条件 : 指线程获取到的资源在自己使用完之前不能被其他线程抢占 ， 只有在自己使用完 毕后才 由 自 己释放该资源。</li>
<li>环路等待条件 : 指在发生死锁时 ，必然存在一个线程→资源的环形链 ，即线程集合<br>{TO,TLT2，…，Tn}中的TO正在等待一个Tl占用的资源， Tl正在等待T2占 用的资源，……Tn正在等待己被 TO 占用的资源。</li>
</ol>
<h5 id="避免死锁"><a href="#避免死锁" class="headerlink" title="避免死锁"></a>避免死锁</h5><p>要想避免死锁，只需要破坏掉至少一个构造死锁的必要条件即可， 但是学过操作系统</p>
<p>的读者应该都知道，目前只有请求并持有和环路等待条件是可 以被破坏 的。<br>造成死锁的原因其实和申请资源的顺序有很大关系 ，</p>
<h4 id="经典的哲学家吃饭问题"><a href="#经典的哲学家吃饭问题" class="headerlink" title="经典的哲学家吃饭问题"></a>经典的哲学家吃饭问题</h4><p> 5位哲学家 ，5只筷子在他们之间.    </p>
<ul>
<li><p>筷子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Chopstick</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> taken = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNumber</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.number = number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> number;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">take</span><span class="params">(<span class="keyword">int</span> numChop)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (taken) &#123;</span><br><span class="line">            Print.print(numChop+<span class="string">&quot;   wait&quot;</span>);</span><br><span class="line">            wait();</span><br><span class="line">        &#125;</span><br><span class="line">        taken = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">drop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        taken = <span class="keyword">false</span>;</span><br><span class="line">        notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>哲学家 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Philosopher</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Chopstick left;</span><br><span class="line">    <span class="keyword">private</span> Chopstick right;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> ponderFactor;</span><br><span class="line">    <span class="keyword">private</span> Random rand = <span class="keyword">new</span> Random(<span class="number">47</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pause</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ponderFactor == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">        TimeUnit.MILLISECONDS.sleep(rand.nextInt(ponderFactor * <span class="number">250</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Philosopher</span><span class="params">(Chopstick left, Chopstick right, <span class="keyword">int</span> id, <span class="keyword">int</span> ponderFactor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.ponderFactor = ponderFactor;</span><br><span class="line">        <span class="keyword">this</span>.left = left;</span><br><span class="line">        <span class="keyword">this</span>.right = right;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!Thread.interrupted()) &#123;</span><br><span class="line">                Print.print(<span class="keyword">this</span> + <span class="string">&quot; &quot;</span> + <span class="string">&quot;need thinking &quot;</span> + ponderFactor + <span class="string">&quot;    毫秒&quot;</span>);</span><br><span class="line">                pause();</span><br><span class="line">                <span class="comment">//Philosopher becomes hungry</span></span><br><span class="line">                Print.print(<span class="keyword">this</span> + <span class="string">&quot;  &quot;</span> + <span class="string">&quot;grabbing right  第&quot;</span> + (id + <span class="number">1</span>) + <span class="string">&quot;  号筷子&quot;</span>);</span><br><span class="line">                right.take(id + <span class="number">1</span>);</span><br><span class="line"><span class="comment">//                if (id == 2) &#123;</span></span><br><span class="line"><span class="comment">//                    System.out.println(right.taken);</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line">                pause();            <span class="comment">//拿起右边的筷子进入等待状态</span></span><br><span class="line">                Print.print(<span class="keyword">this</span> + <span class="string">&quot; .&quot;</span> + <span class="string">&quot;try grabbing left   第  &quot;</span> + (id) + <span class="string">&quot;  号筷子&quot;</span>);  <span class="comment">//尝试拿起左边的筷子</span></span><br><span class="line">                left.take(id);</span><br><span class="line">                Print.print(<span class="keyword">this</span> + <span class="string">&quot; &quot;</span> + <span class="string">&quot;eating&quot;</span>);</span><br><span class="line">                pause();</span><br><span class="line">                right.drop();</span><br><span class="line">                left.drop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Print.print(<span class="keyword">this</span> + <span class="string">&quot; &quot;</span> + <span class="string">&quot;exiting via interrupt&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Philosopher&quot;</span> + id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>运行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeadlockingDiningPhilosophers</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> ponder = <span class="number">5</span>; <span class="comment">//默认 Philosopher思考的时间</span></span><br><span class="line">        <span class="keyword">if</span> (args.length &gt; <span class="number">0</span>)</span><br><span class="line">            ponder = Integer.parseInt(args[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">int</span> size = <span class="number">5</span>;  <span class="comment">//默认筷子的个数</span></span><br><span class="line">        <span class="keyword">if</span> (args.length &gt; <span class="number">1</span>)</span><br><span class="line">            size = Integer.parseInt(args[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line">        Chopstick[] sticks = <span class="keyword">new</span> Chopstick[size];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">            sticks[i] = <span class="keyword">new</span> Chopstick();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">            exec.execute(<span class="keyword">new</span> Philosopher(sticks[i], sticks[(i + <span class="number">1</span>) % size], i, ponder));</span><br><span class="line"></span><br><span class="line"><span class="comment">//        if (args.length == 3 &amp;&amp; args[2].equals(&quot;timeout&quot;))</span></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line"><span class="comment">//        else &#123;</span></span><br><span class="line"><span class="comment">//            System.out.println(&quot;Press &#x27;&#x27;Enter to quit&quot;);</span></span><br><span class="line"><span class="comment">//            System.in.read();</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">        exec.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>结果</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Philosopher0</span> need thinking <span class="number">5</span>    毫秒</span><br><span class="line"><span class="attribute">Philosopher3</span> need thinking <span class="number">5</span>    毫秒</span><br><span class="line"><span class="attribute">Philosopher2</span> need thinking <span class="number">5</span>    毫秒</span><br><span class="line"><span class="attribute">Philosopher1</span> need thinking <span class="number">5</span>    毫秒</span><br><span class="line"><span class="attribute">Philosopher4</span> need thinking <span class="number">5</span>    毫秒</span><br><span class="line"><span class="attribute">Philosopher0</span>  grabbing right  第<span class="number">1</span>  号筷子</span><br><span class="line"><span class="attribute">Philosopher3</span>  grabbing right  第<span class="number">4</span>  号筷子</span><br><span class="line"><span class="attribute">Philosopher2</span>  grabbing right  第<span class="number">3</span>  号筷子</span><br><span class="line"><span class="attribute">Philosopher1</span>  grabbing right  第<span class="number">2</span>  号筷子</span><br><span class="line"><span class="attribute">Philosopher4</span>  grabbing right  第<span class="number">5</span>  号筷子</span><br><span class="line"><span class="attribute">Philosopher0</span> .try grabbing left   第  <span class="number">0</span>  号筷子</span><br><span class="line"><span class="attribute">Philosopher3</span> .try grabbing left   第  <span class="number">3</span>  号筷子</span><br><span class="line"><span class="attribute">Philosopher2</span> .try grabbing left   第  <span class="number">2</span>  号筷子</span><br><span class="line"><span class="attribute">Philosopher1</span> .try grabbing left   第  <span class="number">1</span>  号筷子</span><br><span class="line"><span class="attribute">Philosopher4</span> .try grabbing left   第  <span class="number">4</span>  号筷子</span><br><span class="line"><span class="attribute">2</span>   wait</span><br><span class="line"><span class="attribute">3</span>   wait</span><br><span class="line"><span class="attribute">4</span>   wait</span><br><span class="line"><span class="attribute">0</span>   wait</span><br><span class="line"><span class="attribute">1</span>   wait</span><br><span class="line"><span class="attribute">Philosopher1</span> exiting via interrupt</span><br><span class="line"><span class="attribute">Philosopher4</span> exiting via interrupt</span><br><span class="line"><span class="attribute">Philosopher0</span> exiting via interrupt</span><br><span class="line"><span class="attribute">Philosopher3</span> exiting via interrupt</span><br><span class="line"><span class="attribute">Philosopher2</span> exiting via interrupt</span><br></pre></td></tr></table></figure>



<h4 id="银行转账问题"><a href="#银行转账问题" class="headerlink" title="银行转账问题"></a>银行转账问题</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransferMoney</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> flag;</span><br><span class="line">    <span class="keyword">static</span> Account a = <span class="keyword">new</span> Account(<span class="number">800</span>);</span><br><span class="line">    <span class="keyword">static</span> Account b = <span class="keyword">new</span> Account(<span class="number">600</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Account</span><span class="params">(<span class="keyword">int</span> balance)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.balance = balance;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> balance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (flag == <span class="number">1</span>) &#123;</span><br><span class="line">            transferMoney(a, b, <span class="number">200</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (flag == <span class="number">0</span>) &#123;</span><br><span class="line">            transferMoney(b, a, <span class="number">200</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">transferMoney</span><span class="params">(Account from, Account to, <span class="keyword">int</span> amount)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//先获取两把锁，然后开始转账</span></span><br><span class="line">        <span class="keyword">int</span> fromHash = System.identityHashCode(from);</span><br><span class="line">        <span class="keyword">int</span> toHash = System.identityHashCode(to);</span><br><span class="line">        System.out.println(Thread.currentThread().getName() +  <span class="string">&quot;  fromHash &lt; toHash &quot;</span>+(fromHash &lt; toHash));</span><br><span class="line">        <span class="keyword">if</span> (fromHash &lt; toHash) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (from) &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 获得锁A    &quot;</span> + from.balance);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (to) &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 获得锁B    &quot;</span> + to.balance);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (from.balance - amount &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 余额不足，转账失败。&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"><span class="comment">//                    from.balance -= amount;</span></span><br><span class="line"><span class="comment">//                    to.balance += amount;</span></span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 成功转账&quot;</span> + amount + <span class="string">&quot;元&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fromHash &gt; toHash) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (to) &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 获得锁A    &quot;</span> + to.balance);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (from) &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; 获得锁B    &quot;</span> + from.balance);</span><br><span class="line">                    <span class="keyword">if</span> (from.balance - amount &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;  余额不足，转账失败。&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"><span class="comment">//                    from.balance -= amount;</span></span><br><span class="line"><span class="comment">//                    to.balance += amount;</span></span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot;   成功转账&quot;</span> + amount + <span class="string">&quot;元&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        TransferMoney r1 = <span class="keyword">new</span> TransferMoney();</span><br><span class="line">        TransferMoney r2 = <span class="keyword">new</span> TransferMoney();</span><br><span class="line">        r1.flag = <span class="number">1</span>;</span><br><span class="line">        r2.flag = <span class="number">0</span>;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(r1, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(r2, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line"><span class="comment">//        System.out.println(&quot;a的余额&quot; + a.balance);</span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;b的余额&quot; + b.balance);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>打印结构</p>
<blockquote>
<p>t1 fromHash 1967932108 toHash 2072748565  fromHash &lt; toHash true<br>t2 fromHash 2072748565 toHash 1967932108  fromHash &lt; toHash false<br>t1 获得锁A<br>t1 获得锁B<br>t1 成功转账200元<br>t2 获得锁B<br>t2 获得锁A<br>t2   成功转账200元<br>a的余额500</p>
<h4 id="b的余额500"><a href="#b的余额500" class="headerlink" title="b的余额500"></a>b的余额500</h4></blockquote>
<ol>
<li><p><strong>使用 HashCode 的值来决定顺序</strong></p>
<p>主要思想是，两个线程都先获取 锁A,再获取锁B,这样就不会有死锁了</p>
</li>
<li><p><strong>主键 ID 具有唯一、不重复的特点</strong></p>
<p>由主键 ID 大小来决定获取锁的顺序，就可以确保避免死锁。</p>
</li>
</ol>
</li>
</ul>
<h5 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h5><p>AtomicStampedReference 在变量前面添加版本号，每次变量更新的时候都把版本号加1</p>
<h5 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h5><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/dennyzhangdd/p/7218510.html">https://www.cnblogs.com/dennyzhangdd/p/7218510.html</a></p>
<h5 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreTestMain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Semaphore sSemaphore = <span class="keyword">new</span> Semaphore(<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span>  </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> SemaphoreTestMain semaphoreTestMain = <span class="keyword">new</span> SemaphoreTestMain();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">1000</span>;i++)</span><br><span class="line">            &#123;</span><br><span class="line">               Thread myThread = <span class="keyword">new</span> Thread()</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">super</span>.run();</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            semaphoreTestMain.test();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">               myThread.setName(<span class="string">&quot;threat index:&quot;</span> + i);</span><br><span class="line">                myThread.start();</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        sSemaphore.acquire();</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;--in&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;--out&quot;</span> );</span><br><span class="line">        sSemaphore.release();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1B7411L7tE">https://www.bilibili.com/video/BV1B7411L7tE</a></p>
<p><a target="_blank" rel="noopener" href="https://tech.meituan.com/2018/11/15/java-lock.html">https://tech.meituan.com/2018/11/15/java-lock.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/javazejian/article/details/72828483#t2">https://blog.csdn.net/javazejian/article/details/72828483#t2</a></p>
<p><a target="_blank" rel="noopener" href="https://tech.meituan.com/2018/11/15/java-lock.html">https://tech.meituan.com/2018/11/15/java-lock.html</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-04-16T06:36:29.000Z" title="4/16/2018, 2:36:29 PM">2018-04-16</time></span><span class="level-item">Updated&nbsp;<time dateTime="2023-01-02T03:31:39.074Z" title="1/2/2023, 11:31:39 AM">2023-01-02</time></span><span class="level-item"><a class="link-muted" href="/categories/JAVA/">JAVA</a></span><span class="level-item">22 minutes read (About 3263 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/04/16/Generics/">Generics</a></p><div class="content"><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1T441117u8">https://www.bilibili.com/video/BV1T441117u8</a></p>
<h4 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h4><h5 id="继承类型"><a href="#继承类型" class="headerlink" title="继承类型"></a>继承类型</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Button</span> <span class="keyword">extends</span> <span class="title">TextView</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p> 不能把子类的List对象 ArrayList<Button>   赋值给父类的List引用 List<TextView></TextView></Button></p>
</blockquote>
<p>Java</p>
<h5 id="extends-TextView"><a href="#extends-TextView" class="headerlink" title="? extends TextView"></a>? extends TextView</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> List&lt;TextView&gt; textViews=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  </span><br><span class="line"> List&lt;TextView&gt; textViews=<span class="keyword">new</span> ArrayList&lt;Button&gt;(); <span class="comment">//报错</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 解决办法</span></span><br><span class="line"> List&lt;? extends TextView&gt; textViews =<span class="keyword">new</span> ArrayList&lt;Button&gt;(); <span class="comment">//解除了赋值限制</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//新增了限制，  只能消费使用,不能生产</span></span><br><span class="line"> TextView textView = <span class="keyword">new</span> TextView(<span class="keyword">this</span>);</span><br><span class="line"> textViews.add(textView); <span class="comment">//报错， 不能调用textViews的包含 类型参数的方法</span></span><br><span class="line"></span><br><span class="line"> TextView textView = textViews.get(<span class="number">0</span>); <span class="comment">// 没有问题</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> List&lt;Button&gt; buttons=<span class="keyword">new</span> ArrayList&lt;Button&gt;();</span><br><span class="line"> textView = buttons;<span class="comment">//报错</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="super-Button"><a href="#super-Button" class="headerlink" title="? super Button"></a>? super Button</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ArrayList&lt;Button&gt; textViews1 = <span class="keyword">new</span> ArrayList&lt;TextView&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ArrayList&lt;? <span class="keyword">super</span> Button&gt; textViews2 = <span class="keyword">new</span> ArrayList&lt;TextView&gt;();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//新增了限制</span></span><br><span class="line">Button button = textViews2.get(<span class="number">0</span>); <span class="comment">//报错, 不能使用，只能生产</span></span><br><span class="line"></span><br><span class="line">textViews1.add(<span class="keyword">new</span> Button(<span class="keyword">this</span>)); <span class="comment">// 没有问题</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="Java-kotlin对比"><a href="#Java-kotlin对比" class="headerlink" title="Java kotlin对比"></a>Java kotlin对比</h5><p>Java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;? extends TextView&gt; textViews;</span><br><span class="line"></span><br><span class="line">List&lt;? <span class="keyword">super</span> Button&gt; textViews;</span><br></pre></td></tr></table></figure>

<p>Kotlin</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> textVies: List&lt;<span class="keyword">out</span> TextView&gt;</span><br><span class="line"><span class="keyword">var</span> textVies: List&lt;<span class="keyword">in</span> TextView&gt;</span><br></pre></td></tr></table></figure>



<h5 id="kotlin新增用法"><a href="#kotlin新增用法" class="headerlink" title="kotlin新增用法"></a>kotlin新增用法</h5><p>表示我这个类型,这个类只用来输出或者输入</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Producer</span>&lt;<span class="type">out T</span>&gt;</span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">fun</span> <span class="title">produce</span><span class="params">()</span></span>: T</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Consumer</span>&lt;<span class="type">in T</span>&gt;</span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">fun</span> <span class="title">consume</span><span class="params">(product:<span class="type">T</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="用法"><a href="#用法" class="headerlink" title="*用法"></a>*用法</h5><p>Java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;?&gt; textViews;</span><br><span class="line">相当于</span><br><span class="line">List&lt;? extends Object&gt; textViews;</span><br></pre></td></tr></table></figure>



<p>Kotlin</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> textVies: List&lt;*&gt;</span><br><span class="line">相当于</span><br><span class="line"><span class="keyword">var</span> textVies: List&lt;<span class="keyword">out</span> Any&gt;</span><br></pre></td></tr></table></figure>



<p>如果类型声明里，已经有了out或者in,这个限制在变量声明时也依然存在,不会因为*去掉</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Counter</span>&lt;<span class="type">out T : Number</span>&gt;</span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">fun</span> <span class="title">count</span><span class="params">()</span></span>: T</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> counter: Counter&lt;*&gt; =;</span><br><span class="line">那么Counter&lt;*&gt;就相当于下面的情况 Counter&lt;<span class="keyword">out</span> Number&gt;</span><br><span class="line"><span class="keyword">var</span> counter: Counter&lt;<span class="keyword">out</span> Number&gt;</span><br></pre></td></tr></table></figure>



<h5 id="类型声明上界"><a href="#类型声明上界" class="headerlink" title="类型声明上界"></a>类型声明上界</h5><p>注意这里是T extend Animal ，和带? extend Animal  的声明不是一个东西</p>
<p>java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Monster</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Animal</span> &amp; <span class="title">Food</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>kotlin</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Monster</span>&lt;<span class="type">T : Animal</span>&gt;</span>&#123;&#125; <span class="comment">// 一个上界</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Monster</span>&lt;<span class="type">T</span>&gt; <span class="title">where</span> <span class="title">T</span> : <span class="type">Animal</span>, <span class="type">T : Food&#123;&#125; // 多个上界</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="refield"><a href="#refield" class="headerlink" title="refield"></a>refield</h5><p>java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">printIfTypeMatch</span><span class="params">(Object item)</span></span>&#123;</span><br><span class="line">   <span class="keyword">if</span>(item <span class="keyword">instanceof</span> T)&#123;&#125; <span class="comment">// 报错，不能检查一个对象,是不是一个T的实例</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>kotlin</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span>	<span class="type">&lt;T&gt;</span> void <span class="title">printIfTypeMatch</span><span class="params">(item : <span class="type">Any</span>)</span></span>&#123;</span><br><span class="line">   <span class="keyword">if</span>(item instanceof T)&#123;&#125; <span class="comment">// 报错，不能检查一个对象,是不是一个T的实例</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span>	<span class="type">&lt;<span class="keyword">reified</span> T&gt;</span> void <span class="title">printIfTypeMatch</span><span class="params">(item : <span class="type">Any</span>)</span></span>&#123;<span class="comment">//reified自身限制，只能用在inline</span></span><br><span class="line">   <span class="keyword">if</span>(item instanceof T)&#123;&#125; <span class="comment">// 正常编译</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<p><img src="/2018/04/16/Generics/20220724113155.jpg" alt="20220724113155"></p>
<h4 id="Java泛型类"><a href="#Java泛型类" class="headerlink" title="Java泛型类"></a>Java泛型类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    String orderName;</span><br><span class="line">    <span class="keyword">int</span> orderId;</span><br><span class="line"></span><br><span class="line">    T orderT;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Order</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Order</span><span class="params">(String orderName, <span class="keyword">int</span> orderId, T orderT)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.orderName = orderName;</span><br><span class="line">        <span class="keyword">this</span>.orderId = orderId;</span><br><span class="line">        <span class="keyword">this</span>.orderT = orderT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getOrderT</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> orderT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrderT</span><span class="params">(T orderT)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.orderT = orderT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="子类不是泛型类"><a href="#子类不是泛型类" class="headerlink" title="子类不是泛型类"></a>子类不是泛型类</h5><p> 父类指明类型,由于子类在继承带泛型的父类时，指明了泛型类型，则实例化子类对象时，不再需要指明泛型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubOrder</span> <span class="keyword">extends</span> <span class="title">Order</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span>  <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//由于子类在继承带泛型的父类时，指明了泛型类型，则实例化子类对象时，不再需要指明泛型。</span></span><br><span class="line">        SubOrder subOrder = <span class="keyword">new</span> SubOrder();</span><br><span class="line">        subOrder.setOrderT(<span class="number">1122</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<h5 id="子父类关系"><a href="#子父类关系" class="headerlink" title="子父类关系"></a>子父类关系</h5><p>类A是类B的父类，G<A>和G<B>二者不具备父子类关系,也不具任何关系。</B></A></p>
<p>类A是类B的父类，A<G>是 B<G>的父类。</G></G></p>
<p>反证法:</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1fi4y1b7NM?p=11">https://www.bilibili.com/video/BV1fi4y1b7NM?p=11</a></p>
<h5 id="子类是泛型类"><a href="#子类是泛型类" class="headerlink" title="子类是泛型类"></a>子类是泛型类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubOrder1</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Order</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SubOrder1&lt;String&gt; sub2 = <span class="keyword">new</span> SubOrder1&lt;&gt;();</span><br><span class="line">sub2.setOrderT(<span class="string">&quot;order...&quot;</span>);</span><br></pre></td></tr></table></figure>







<h4 id="泛型方法"><a href="#泛型方法" class="headerlink" title="泛型方法"></a>泛型方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person3</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//泛型普通方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(T name)</span> </span>&#123;</span><br><span class="line">        System.out.println(name + <span class="string">&quot;正在演讲&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> &lt;M&gt; <span class="function"><span class="keyword">void</span> <span class="title">show1</span><span class="params">(M name)</span> </span>&#123;</span><br><span class="line">        System.out.println(name + <span class="string">&quot;正在演讲&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//静态泛型方法中的类型占位符和类中的泛型占位符是没有关系的</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;W&gt; <span class="function"><span class="keyword">void</span> <span class="title">show2</span><span class="params">(W name)</span> </span>&#123;</span><br><span class="line">        System.out.println(name + <span class="string">&quot;：静态方法正在演讲!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;E&gt; <span class="function">E <span class="title">show3</span><span class="params">(E name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="泛型接口"><a href="#泛型接口" class="headerlink" title="泛型接口"></a>泛型接口</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">PerInt</span>&lt;<span class="type">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">show</span><span class="params">(name: <span class="type">T</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol>
<li> 泛型接口的实现类 可以指定具体的泛型接口的具体泛型类型</li>
</ol>
   <figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PerImtImpl</span> : <span class="type">PerInt</span>&lt;<span class="type">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">show</span><span class="params">(name: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>泛型接口的实现类，如果没有指定具体的泛型类型，必须要在这个实现类中声明一个泛型类型的占位符给接口用</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PerImtImpl01</span>&lt;<span class="type">T</span>&gt; : <span class="type">PerInt</span>&lt;<span class="type">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">show</span><span class="params">(name: <span class="type">T</span>)</span></span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="类型擦除"><a href="#类型擦除" class="headerlink" title="类型擦除"></a>类型擦除</h4><p>Java中的泛型基本上都是在编译器这个层次来实现的。在生成的Java字节码中是不包含泛型中的类型信息的。使用泛型的时候加上的类型参数，会在编译器在编译的时候去掉。这个过程就称为类型擦除。</p>
<p>泛型的作用是能在编译期间就提示错误，而不是运行时。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> p1 = PerImtImpl01&lt;String&gt;()</span><br><span class="line"><span class="keyword">val</span> p2 = PerImtImpl01&lt;<span class="built_in">Int</span>&gt;()</span><br><span class="line">println(p1.javaClass == p2.javaClass)</span><br><span class="line">println(p1.javaClass === p2.javaClass)</span><br></pre></td></tr></table></figure>



<h4 id="通配符"><a href="#通配符" class="headerlink" title="通配符"></a>通配符</h4><p>Java中的继承 ，在泛型中并不是父子类关系 </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PerImtImpl01</span>&lt;<span class="type">T</span>&gt; : <span class="type">PerInt</span>&lt;<span class="type">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name: T</span><br><span class="line">        <span class="keyword">get</span>() &#123;</span><br><span class="line">            <span class="keyword">return</span> name</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            name = value</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">show</span><span class="params">(name: <span class="type">T</span>)</span></span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">show</span><span class="params">(p: <span class="type">PerImtImpl01</span>&lt;*&gt;)</span></span> &#123;<span class="comment">//如果是T类型 编译报错，虽然Int:Number,但是在泛型中不存在继承关系</span></span><br><span class="line">        name = p.name <span class="keyword">as</span> T</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> p3 = PerImtImpl01&lt;Number&gt;()</span><br><span class="line"><span class="keyword">val</span> p4 = PerImtImpl01&lt;<span class="built_in">Int</span>&gt;()</span><br><span class="line">p3.name = <span class="number">111</span></span><br><span class="line">p4.show(p3)</span><br></pre></td></tr></table></figure>



<h5 id="符号区别"><a href="#符号区别" class="headerlink" title="符号区别"></a>符号区别</h5><p>Java用 ？  Kotlin 用 *</p>
<p>无界通配符 意味着可以使用任何对象，因此使用它类似于使用原生类型</p>
<p>类A是类B的父类，G<A>和G<B>的公共的父类是: G&lt;?&gt;</B></A></p>
<h5 id="遍历List"><a href="#遍历List" class="headerlink" title="遍历List"></a>遍历List</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span></span>&#123;</span><br><span class="line">      List&lt;Object&gt; list1 = <span class="keyword">null</span>;</span><br><span class="line">      List&lt;String&gt; list2 = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">      List&lt;?&gt; list = <span class="keyword">null</span>;</span><br><span class="line">      list = list1;</span><br><span class="line">      list = list2;</span><br><span class="line"></span><br><span class="line">      print(list1);</span><br><span class="line">      print(list2);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(List&lt;?&gt; list)</span></span>&#123;</span><br><span class="line">      Iterator&lt;?&gt; iterator = list.iterator();</span><br><span class="line">      <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">          Object o = iterator.next();</span><br><span class="line">          System.out.println(o);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      list.forEach(o -&gt; &#123;</span><br><span class="line">          System.out.println(o);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>对于List<?> 就不能向其添加数据。如果任何类型引用通过赋值给 List<?> 能添加数据，那定义泛型就没意义了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> 			  List&lt;?&gt; list = <span class="keyword">null</span>;</span><br><span class="line"> 		    ArrayList&lt;String&gt; list3 = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        list3.add(<span class="string">&quot;AA&quot;</span>);</span><br><span class="line">        list3.add(<span class="string">&quot;BB&quot;</span>);</span><br><span class="line">        list3.add(<span class="string">&quot;CC&quot;</span>);</span><br><span class="line">        list = list3;</span><br><span class="line">        <span class="comment">//添加(写入):对于List&lt;?&gt; 就不能向其添加数据，如果能添加数据，那定义泛型就没意义了。</span></span><br><span class="line">        <span class="comment">//除了添加null之外</span></span><br><span class="line"><span class="comment">//        list.add(&quot;MED&quot;);</span></span><br><span class="line"><span class="comment">//        list.add(&quot;?&quot;);</span></span><br><span class="line">        list.add(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//可以获取数据，读取的数据类型为Object</span></span><br><span class="line">        Object o = list.get(<span class="number">0</span>);</span><br><span class="line">        System.out.println(o);</span><br></pre></td></tr></table></figure>





<h4 id="上下界"><a href="#上下界" class="headerlink" title="上下界"></a>上下界</h4><p><strong>如果静态方法要使用泛型的话，必须将静态方法也定义成泛型方法</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticGenerator</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    ....</span><br><span class="line">    ....</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果在类中定义使用泛型的静态方法，需要添加额外的泛型声明（将这个方法定义成泛型方法）</span></span><br><span class="line"><span class="comment">     * 即使静态方法要使用泛型类中已经声明过的泛型也不可以。</span></span><br><span class="line"><span class="comment">     * 如：public static void show(T t)&#123;..&#125;,此时编译器会提示错误信息：</span></span><br><span class="line"><span class="comment">          &quot;StaticGenerator cannot be refrenced from static context&quot;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(T t)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>上界&lt;? extends T&gt;不能往里存，只能往外取，适合频繁往外面读取内容的场景。</li>
<li>下界&lt;? super T&gt;不影响往里存，但往外取只能放在Object对象里，适合经常往里面插入数据的场景。</li>
</ul>
<h5 id="上界通配符-lt-extends-T-gt"><a href="#上界通配符-lt-extends-T-gt" class="headerlink" title="上界通配符    &lt;? extends T&gt;"></a>上界通配符    &lt;? extends T&gt;</h5><p>泛型中的继承</p>
<p>泛型中的继承不是Java中的继承。也就是说java中的父子类关系， 在泛型中 并不是父子类关系。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">class Fruit &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Apple extends Fruit &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Plate&lt;T&gt; &#123;</span><br><span class="line">    T item;</span><br><span class="line">    </span><br><span class="line">	public Plate() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    public Plate(T item) &#123;</span><br><span class="line">        this.item &#x3D; item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public T get() &#123;</span><br><span class="line">        return item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void set(T item) &#123;</span><br><span class="line">        this.item &#x3D; item;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/2018/04/16/Generics/2020-09-13_at_9.33.25.png" alt="Screen Shot 2020-09-13 at 9.33.25 PM" style="zoom:67%;">

<h6 id="extends-Fruit赋值-，无法添加数据，不知道子类到底多小"><a href="#extends-Fruit赋值-，无法添加数据，不知道子类到底多小" class="headerlink" title="? extends Fruit赋值 ，无法添加数据，不知道子类到底多小."></a>? extends Fruit赋值 ，无法添加数据，不知道子类到底多小.</h6><p>? extends Fruit 可以理解为 &lt;= Fruit,</p>
<p>List&lt;? extends Fruit&gt; 可以作为 List<Apple> ， List<Fruit>的父类。</Fruit></Apple></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//        List&lt;Fruit&gt; list1 =  new ArrayList&lt;Apple&gt;();  //编译报错，泛型具体类型 List&lt;Fruit&gt; ,ArrayList&lt;Apple&gt; 不存在继承关系</span></span><br><span class="line">        <span class="comment">// ? extends Fruit 可以理解为 &lt;= Fruit</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// List&lt;? extends Fruit&gt;                        //  可以作为 List&lt;Apple&gt; ， List&lt;Fruit&gt;的父类。</span></span><br><span class="line">        List&lt;? extends Fruit&gt; list4 =  <span class="keyword">new</span> ArrayList&lt;Apple&gt;();</span><br><span class="line">        List&lt;? extends Fruit&gt; list5=  <span class="keyword">new</span> ArrayList&lt;Fruit&gt;();</span><br><span class="line"><span class="comment">//        List&lt;? extends Fruit&gt; list5 =new ArrayList&lt;Object&gt;();    //编译报错，Object类不在 &lt;= Fruit范围内</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 只能读取数据 , 不能修改数据</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        Fruit fruit = list4.get(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//        Apple apple =list2.get(0); //编译不通过， &lt;= Fruit范围，list1.get(0)实际类型可能是Fruit，是Apple的父类。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        list1.add(new Apple()); //编译报错，&lt;= Fruit范围， List&lt;? extends Fruit&gt;实际类型可能比是GreenApple,比Apple范围还小，随意存不了数据</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h6 id="读取数据"><a href="#读取数据" class="headerlink" title="读取数据"></a>读取数据</h6><p>? extends Fruit 所以泛型最大的父类就是Fruit,子类型可以直接复制给父类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 只能读取数据 , 不能修改数据</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        Fruit fruit = list4.get(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//        Apple apple =list2.get(0); //编译不通过， &lt;= Fruit范围，list1.get(0)实际类型可能是Fruit，是Apple的父类。</span></span><br><span class="line"><span class="comment">//        list1.add(new Apple()); //编译报错，&lt;= Fruit范围， List&lt;? extends Fruit&gt;实际类型可能比是GreenApple,比Apple范围还小，随意存不了数据</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<blockquote>
<p> <strong>你会发现无法往里面设置任何数据</strong>，按道理说我们将泛型类型设置为? extend Fruit。按理说我们往里面添加Fruit的子类应该是可以的。但是Java编译器不允许这样操作。&lt;? extends Fruit&gt;会使往盘子里放东西的set()方法失效。但取东西get()方法还有效</p>
</blockquote>
<blockquote>
<p> 原因是：Java编译期只知道容器里面存放的是Fruit和它的子类，具体是什么类型不知道，可能是Fruit？可能是Apple？也可能是Banana，RedApple，GreenApple？编译器在后面看到Plate&lt; Apple &gt;赋值以后，盘子里面没有标记为“苹果”。只是标记了一个占位符“CAP#1”，来表示捕获一个Fruit或者Fruit的派生类，具体是什么类型不知道。所有调用代码无论往容器里面插入Apple或者Meat或者Fruit编译器都不知道能不能和这个“CAP#1”匹配，所以这些操作都不允许。</p>
<p>一个Plate&lt;? extends Fruit&gt;的引用，可能是一个Plate <Apple>类型的盘子，要往这个盘子里放<Banana>当然是不被允许的.</Banana></Apple></p>
</blockquote>
<p>但是上界通配符是允许读取操作的。例如代码</p>
<p>这个我们很好理解，由于上界通配符设定容器中只能存放Fruit及其子类，那么获取出来的我们都可以隐式的转为Fruit基类。所以上界描述符Extends适合频繁读取的场景。</p>
<p>Java类型擦除只会擦除到Fruit类型,如果没有指明边界，那么类型参数将被擦除到Object.</p>
<h6 id="写入数据"><a href="#写入数据" class="headerlink" title="写入数据"></a>写入数据</h6><p>可以发现任何数据都不能存入。[-∞,Fruit]范围，-∞不知道具体的类型小到多少</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list1.add(<span class="keyword">new</span> Apple()); <span class="comment">//编译报错，&lt;= Fruit范围， List&lt;? extends Fruit&gt;实际类型可能比是GreenApple,比Apple范围还小，随意存不了数据</span></span><br></pre></td></tr></table></figure>





<h5 id="下界通配符-lt-super-T-gt"><a href="#下界通配符-lt-super-T-gt" class="headerlink" title="下界通配符 &lt;? super T&gt;"></a>下界通配符 &lt;? super T&gt;</h5><p><img src="/2018/04/16/Generics/2020-09-13_at_9.46.10.png" alt="Screen Shot 2020-09-13 at 9.46.10 PM"></p>
<h6 id="super-Fruit赋值-只能添加数据-。"><a href="#super-Fruit赋值-只能添加数据-。" class="headerlink" title="? super Fruit赋值,只能添加数据 。"></a>? super Fruit赋值,只能添加数据 。</h6><p> ? super Fruit 可以理解为 &gt;= Fruit</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">        <span class="comment">//只能修改数据，不能读取数据</span></span><br><span class="line">        <span class="comment">// &lt;? super Fruit&gt;</span></span><br><span class="line"></span><br><span class="line">        List&lt;? <span class="keyword">super</span> Fruit&gt; list6 = <span class="keyword">new</span> ArrayList&lt;Fruit&gt;();  <span class="comment">//   ? super Fruit 可以理解为 &gt;= Fruit</span></span><br><span class="line">        List&lt;? <span class="keyword">super</span> Fruit&gt;  list7 = <span class="keyword">new</span> ArrayList&lt;Object&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Object object = list6.get(<span class="number">0</span>); <span class="comment">//理论上不能读取，但是都到Object还是可以的</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        Food food = list2.get(0); //编译不通过，&gt;=Fruit范围，list2.get(0)实际类型可能是Object,不能赋值给小于它子类，所以只能是Object</span></span><br></pre></td></tr></table></figure>





<h6 id="读取数据-1"><a href="#读取数据-1" class="headerlink" title="读取数据"></a>读取数据</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">        Object object = list6.get(<span class="number">0</span>); <span class="comment">//理论上不能读取，但是都到Object还是可以的</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        Food food = list2.get(0); //编译不通过，&gt;=Fruit范围，list2.get(0)实际类型可能是Object,不能赋值给小于它子类，所以只能是Object</span></span><br></pre></td></tr></table></figure>



<h6 id="写入数据-1"><a href="#写入数据-1" class="headerlink" title="写入数据"></a>写入数据</h6><p> ? super Fruit范围是是 [Fruit,+∞), 所以Fruit范围内的都可以添加</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">        list6.add(<span class="keyword">new</span> Fruit());</span><br><span class="line">        list6.add(<span class="keyword">new</span> Apple()); <span class="comment">//</span></span><br><span class="line"><span class="comment">//        list6.add(new Food()); //   ? super Fruit范围是是 [Fruit,+∞), 所以Fruit范围内的都可以添加</span></span><br></pre></td></tr></table></figure>



<p>下界通配符&lt;? super Fruit&gt;不影响往里面存储，但是读取出来的数据只能是Object类型。</p>
<blockquote>
<p>下界通配符规定了元素最小的粒度，必须是Fruit或其基类，那么我往里面存储Fruit及其子类都是可以的，因为它都可以隐式的转化为Fruit类型。但是往外读就不好控制了，里面存储的都是Fruit及其基类，无法转型为任何一种类型，只有Object基类才能装下。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/5b614848e51d45355d51f792">https://juejin.im/post/5b614848e51d45355d51f792</a></p>
<p><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/dd34211f2565">www.jianshu.com/p/dd34211f2565</a></p>
<p><a target="_blank" rel="noopener" href="https://itimetraveler.github.io/2016/12/27/%E3%80%90Java%E3%80%91%E6%B3%9B%E5%9E%8B%E4%B8%AD%20extends%20%E5%92%8C%20super%20%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9F/">https://itimetraveler.github.io/2016/12/27/%E3%80%90Java%E3%80%91%E6%B3%9B%E5%9E%8B%E4%B8%AD%20extends%20%E5%92%8C%20super%20%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9F/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1xJ411n77R?p=7">https://www.bilibili.com/video/BV1xJ411n77R?p=7</a></p>
<h4 id="kotlin"><a href="#kotlin" class="headerlink" title="kotlin"></a>kotlin</h4><p>out in 和 extend super没关系</p>
<h5 id="out"><a href="#out" class="headerlink" title="out"></a>out</h5><p>只能获取 不能修改</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">var</span> list:MutableList&lt;<span class="keyword">out</span> Fruit&gt;  = ArrayList&lt;Apple&gt;() <span class="comment">// ? extends Fruit 实际类型可能比是Apple小</span></span><br><span class="line"><span class="comment">//    list.add(Apple()) 编译报错</span></span><br><span class="line">    <span class="keyword">var</span> list2: ArrayList&lt;<span class="keyword">in</span> Apple&gt; = ArrayList&lt;Fruit&gt;() <span class="comment">//  ? super Fruit  实际类型可能比是Apple大很多</span></span><br><span class="line"><span class="comment">//    list2.get(0)</span></span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1xv411k7Dd?p=4&amp;spm_id_from=pageDriver">https://www.bilibili.com/video/BV1xv411k7Dd?p=4&amp;spm_id_from=pageDriver</a></p>
<p><a href="https://noteforme.github.io/2021/08/21/kotlin-object/#Out-In">https://noteforme.github.io/2021/08/21/kotlin-object/#Out-In</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Hy4y1H7oS?p=7">https://www.bilibili.com/video/BV1Hy4y1H7oS?p=7</a></p>
<h4 id="泛型数组"><a href="#泛型数组" class="headerlink" title="泛型数组"></a>泛型数组</h4><ol>
<li><p>可以声明带泛型的数组引用，但是不能直接创建带泛型的数组对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ArrayList&lt;Integer&gt; intList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">intList.add(<span class="number">100</span>);</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">ArrayList&lt;String&gt; strList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">strList.add(<span class="string">&quot;abc&quot;</span>);</span><br><span class="line">listArr[<span class="number">0</span>] = strList;</span><br><span class="line">String s = listArr[<span class="number">0</span>].get(<span class="number">0</span>);</span><br><span class="line">System.out.println(s);</span><br></pre></td></tr></table></figure></li>
<li><p>可以通过java.lang.reflect.Array的newInstance(Class<T>,int) 创建T[]数组</T></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FruitArr</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> T[] array;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FruitArr</span><span class="params">(Class&lt;T&gt; clz, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.array = (T[]) Array.newInstance(clz, length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">int</span> index, T item)</span> </span>&#123;</span><br><span class="line">        array[index] = item;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> array[index];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T[] getArray()&#123;</span><br><span class="line">        <span class="keyword">return</span> array;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FruitArr&lt;String&gt; fruit = <span class="keyword">new</span> FruitArr&lt;&gt;(String.class,<span class="number">3</span>);</span><br><span class="line">fruit.put(<span class="number">0</span>,<span class="string">&quot;苹果&quot;</span>);</span><br><span class="line">fruit.put(<span class="number">1</span>,<span class="string">&quot;西瓜&quot;</span>);</span><br><span class="line">fruit.put(<span class="number">2</span>,<span class="string">&quot;香蕉&quot;</span>);</span><br><span class="line">String s1 = Arrays.toString(fruit.getArray());</span><br><span class="line">System.out.println(s1);</span><br></pre></td></tr></table></figure></li>
</ol>
<p>​    </p>
<h4 id="泛型与反射"><a href="#泛型与反射" class="headerlink" title="泛型与反射"></a>泛型与反射</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;Person&gt; personClass = Person.class;</span><br><span class="line">Constructor&lt;Person&gt; constructor = personClass.getConstructor();</span><br><span class="line">Person person = constructor.newInstance();</span><br></pre></td></tr></table></figure>

<p>​    <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1xJ411n77R?p=12">https://www.bilibili.com/video/BV1xJ411n77R?p=12</a></p>
<p>$i$f$withM 有时候看到$以为是操作符，其实就是$i$f$withM整体的变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Array&lt;out Any&gt;  对应于 Java 的 Array&lt;? extends Object&gt;</span><br><span class="line"></span><br><span class="line">Array&lt;in String&gt; 对应于 Java 的 Array&lt;? super String&gt;</span><br></pre></td></tr></table></figure>



</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2017-09-12T02:14:41.000Z" title="9/12/2017, 10:14:41 AM">2017-09-12</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-08-19T11:11:44.087Z" title="8/19/2021, 7:11:44 PM">2021-08-19</time></span><span class="level-item"><a class="link-muted" href="/categories/JAVA/">JAVA</a></span><span class="level-item">4 minutes read (About 526 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/09/12/JavaIo/">JavaIo</a></p><div class="content"><p>![Screen Shot 2020-09-12 at 5.20.14 PM](JavaIo/Screen Shot 2020-09-12 at 5.20.14 PM.png)</p>
<p>![Screen Shot 2020-09-12 at 5.22.29 PM](JavaIo/Screen Shot 2020-09-12 at 5.22.29 PM.png)</p>
<img src="/2017/09/12/JavaIo/java7-1535863955.jpg" alt="java7-1535863955">



<p>Byte Stream : 对于二进制文件或处理 数字字母之类的数据</p>
<p><a target="_blank" rel="noopener" href="https://www.javazhiyin.com/17362.html">https://www.javazhiyin.com/17362.html</a></p>
<h4 id="FileInputStream"><a href="#FileInputStream" class="headerlink" title="FileInputStream"></a>FileInputStream</h4><p>单个字节读</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    fis = <span class="keyword">new</span> FileInputStream(<span class="string">&quot;/Users/john/Documents/jywork/THINKJAVA/src/main/resource/a.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> data;</span><br><span class="line">    <span class="keyword">while</span> ((data = fis.<span class="keyword">read</span>()) != -<span class="number">1</span>) &#123;</span><br><span class="line">        System.out.<span class="keyword">print</span>((<span class="keyword">char</span>) data+<span class="string">&quot;  &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>读到bytes数组里面</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">FileInputStream fis = null;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">14</span>];</span><br><span class="line">    fis = <span class="keyword">new</span> <span class="built_in">FileInputStream</span>(<span class="string">&quot;/Users/john/Documents/jywork/THINKJAVA/src/main/resource/a.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> read = fis.<span class="built_in">read</span>(bytes);</span><br><span class="line">    <span class="keyword">String</span> s  = <span class="keyword">new</span> <span class="built_in"><span class="keyword">String</span></span>(bytes);</span><br><span class="line">    System.out.<span class="built_in">println</span>(s);</span><br><span class="line">    System.out.<span class="built_in">println</span>(read);</span><br><span class="line">&#125; <span class="built_in"><span class="keyword">catch</span></span> (FileNotFoundException e) &#123;</span><br><span class="line">    e.<span class="built_in">printStackTrace</span>();</span><br><span class="line">&#125; <span class="built_in"><span class="keyword">catch</span></span> (IOException e) &#123;</span><br><span class="line">    e.<span class="built_in">printStackTrace</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>读到bytes里面 ,限定读的字节个数</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">FileInputStream fis = null;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">14</span>];</span><br><span class="line">    fis = <span class="keyword">new</span> <span class="built_in">FileInputStream</span>(<span class="string">&quot;/Users/john/Documents/jywork/THINKJAVA/src/main/resource/a.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> read = fis.<span class="built_in">read</span>(bytes,<span class="number">0</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">String</span> s  = <span class="keyword">new</span> <span class="built_in"><span class="keyword">String</span></span>(bytes);</span><br><span class="line">    System.out.<span class="built_in">println</span>(s);</span><br><span class="line">    System.out.<span class="built_in">println</span>(read);</span><br><span class="line">&#125; <span class="built_in"><span class="keyword">catch</span></span> (FileNotFoundException e) &#123;</span><br><span class="line">    e.<span class="built_in">printStackTrace</span>();</span><br><span class="line">&#125; <span class="built_in"><span class="keyword">catch</span></span> (IOException e) &#123;</span><br><span class="line">    e.<span class="built_in">printStackTrace</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于为什么必须继承装饰器父类 FilterInputStream的思考</p>
<blockquote>
<p>实际上，如果去查看 JDK 的源码，你会发现，BufferedInputStream、DataInputStream 并非继承自 InputStream，而是另外一个叫 FilterInputStream 的类。那这又是出于什么样的设计意图，才引入这样一个类呢？我们再重新来看一下 BufferedInputStream 类的代码。InputStream 是一个抽象类而非接口，而且它的大部分函数（比如 read()、available()）都有默认实现，按理来说，我们只需要在 BufferedInputStream 类中重新实现那些需要增加缓存功能的函数就可以了，其他函数继承 InputStream 的默认实现。但实际上，这样做是行不通的。对于即便是不需要增加缓存功能的函数来说，BufferedInputStream 还是必须把它重新实现一遍，简单包裹对 InputStream 对象的函数调用。具体的代码示例如下所示。如果不重新实现，那 BufferedInputStream 类就无法将最终读取数据的任务，委托给传递进来的 InputStream 对象来完成。这一部分稍微有点不好理解，你自己多思考一下。</p>
</blockquote>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2017-08-27T02:40:55.000Z" title="8/27/2017, 10:40:55 AM">2017-08-27</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-08-19T14:06:15.145Z" title="8/19/2021, 10:06:15 PM">2021-08-19</time></span><span class="level-item"><a class="link-muted" href="/categories/JAVA/">JAVA</a></span><span class="level-item">25 minutes read (About 3766 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/08/27/ConcurrencyThreadPool/">ConcurrencyThreadPool</a></p><div class="content"><img src="/2017/08/27/ConcurrencyThreadPool/Screen Shot 2020-08-19 at 10.07.23 AM.png" alt="Screen Shot 2020-08-19 at 10.07.23 AM" style="zoom:50%;">



<h4 id="线程池状态切换"><a href="#线程池状态切换" class="headerlink" title="线程池状态切换"></a>线程池状态切换</h4><p><img src="https://img2020.cnblogs.com/blog/1208468/202102/1208468-20210219204031490-460634238.png"></p>
<p>1、RUNNING</p>
<p>(1) 状态说明：线程池处在RUNNING状态时，能够接收新任务，以及对已添加的任务进行处理。<br> (02) 状态切换：线程池的初始化状态是RUNNING。换句话说，线程池被一旦被创建，就处于RUNNING状态，并且线程池中的任务数为0！</p>
<ul>
<li>1</li>
</ul>
<p>2、 SHUTDOWN</p>
<p>(1) 状态说明：线程池处在SHUTDOWN状态时，不接收新任务，但能处理已添加的任务。<br> (2) 状态切换：调用线程池的shutdown()接口时，线程池由RUNNING -&gt; SHUTDOWN。</p>
<p>3、STOP</p>
<p>(1) 状态说明：线程池处在STOP状态时，不接收新任务，不处理已添加的任务，并且会中断正在处理的任务。<br> (2) 状态切换：调用线程池的shutdownNow()接口时，线程池由(RUNNING or SHUTDOWN ) -&gt; STOP。</p>
<p>4、TIDYING</p>
<p>(1)  状态说明：当所有的任务已终止，ctl记录的”任务数量”为0，线程池会变为TIDYING状态。当线程池变为TIDYING状态时，会执行钩子函数terminated()。terminated()在ThreadPoolExecutor类中是空的，若用户想在线程池变为TIDYING时，进行相应的处理；可以通过重载terminated()函数来实现。<br> (2) 状态切换：当线程池在SHUTDOWN状态下，阻塞队列为空并且线程池中执行的任务也为空时，就会由 SHUTDOWN -&gt; TIDYING。<br> 当线程池在STOP状态下，线程池中执行的任务为空时，就会由STOP -&gt; TIDYING。</p>
<p>5、 TERMINATED</p>
<p>(1) 状态说明：线程池彻底终止，就变成TERMINATED状态。<br> (2) 状态切换：线程池处在TIDYING状态时，执行完terminated()之后，就会由 TIDYING -&gt; TERMINATED。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/nmjhehe/article/details/115901549">https://blog.csdn.net/nmjhehe/article/details/115901549</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/east7/p/14417977.html">https://www.cnblogs.com/east7/p/14417977.html</a></p>
<h4 id="线程池工作原理"><a href="#线程池工作原理" class="headerlink" title="线程池工作原理"></a>线程池工作原理</h4><p><img src="https://s0.lgstatic.com/i/image2/M01/AD/A3/CgoB5l3eH8mAAoJCAACEOKMHtpw036.png"></p>
<h5 id="各参数含义"><a href="#各参数含义" class="headerlink" title="各参数含义"></a>各参数含义</h5><h6 id="corePoolSize"><a href="#corePoolSize" class="headerlink" title="corePoolSize"></a>corePoolSize</h6><p>线程池初始化时线程数默认为 0，当有新的任务提交后，会创建新线程执行任务，如果不做特殊设置，此后线程数通常不会再小于 corePoolSize ，因为它们是核心线程，即便未来可能没有可执行的任务也不会被销毁。</p>
<h6 id="maximumPoolSize"><a href="#maximumPoolSize" class="headerlink" title="maximumPoolSize"></a>maximumPoolSize</h6><p>​    maximumPoolSize 最大线程数，线程池会在 corePoolSize 核心线程数的基础上继续创建线程来执行任务，假设任务被不断提交，线程池会持续创建线程直到线程数达到 maximumPoolSize 最大线程数，如果依然有任务被提交，这就超过了线程池的最大处理能力，这个时候线程池就会拒绝这些任务，我们可以看到实际上任务进来之后，线程池会逐一判断 corePoolSize、workQueue、maximumPoolSize，如果依然不能满足需求，则会拒绝任务。</p>
<h6 id="keepAliveTime-时间单位"><a href="#keepAliveTime-时间单位" class="headerlink" title="keepAliveTime+时间单位"></a>keepAliveTime+时间单位</h6><p>​    当线程池中线程数量多于核心线程数时，而此时又没有任务可做，线程池就会检测线程的 keepAliveTime，如果超过规定的时间，无事可做的线程就会被销毁，以便减少内存的占用和资源消耗。但是要注意到了核心线程数就不会销毁了。</p>
<p><img src="/2017/08/27/ConcurrencyThreadPool/queueThreadWork.png"></p>
<p>如上图所示，当提交任务后，线程池首先会检查当前线程数，如果此时线程数小于核心线程数，比如最开始线程数量为 0，则新建线程并执行任务，随着任务的不断增加，线程数会逐渐增加并达到核心线程数，此时如果仍有任务被不断提交，就会被放入 workQueue 任务队列中，等待核心线程执行完当前任务后重新从 workQueue 中提取正在等待被执行的任务。</p>
<p>此时，假设我们的任务特别的多，已经达到了 workQueue 的容量上限，这时线程池就会启动后备力量，也就是 maximumPoolSize 最大线程数，线程池会在 corePoolSize 核心线程数的基础上继续创建线程来执行任务，假设任务被不断提交，线程池会持续创建线程直到线程数达到 maximumPoolSize 最大线程数，如果依然有任务被提交，这就超过了线程池的最大处理能力，这个时候线程池就会拒绝这些任务，我们可以看到实际上任务进来之后，线程池会逐一判断 corePoolSize、workQueue、maximumPoolSize，如果依然不能满足需求，则会拒绝任务。</p>
<h4 id="6-种线程池"><a href="#6-种线程池" class="headerlink" title="6 种线程池"></a>6 种线程池</h4><ol>
<li><p>FixedThreadPool</p>
<p>它的核心线程数和最大线程数是一样的</p>
</li>
<li><p>CachedThreadPool</p>
<p>它的特点在于线程数是几乎可以无限增加的（实际最大可以达到 Integer.MAX_VALUE，为 2^31-1),当我们提交一个任务后，线程池会判断已创建的线程中是否有空闲线程，如果有空闲线程则将任务直接指派给空闲线程，如果没有空闲线程，则新建线程去执行任务，这样就做到了动态地新增线程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService service = Executors.newCachedThreadPool();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123; </span><br><span class="line">        service.execute(<span class="keyword">new</span> Task() &#123; </span><br><span class="line">    &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>使用 for 循环提交 1000 个任务给 CachedThreadPool，假设这些任务处理的时间非常长，会发生什么情况呢？因为 for 循环提交任务的操作是非常快的，但执行任务却比较耗时，就可能导致 1000 个任务都提交完了但第一个任务还没有被执行完，所以此时 CachedThreadPool 就可以动态的伸缩线程数量，随着任务的提交，不停地创建 1000 个线程来执行任务，而当任务执行完之后，假设没有新的任务了，那么大量的闲置线程又会造成内存资源的浪费，这时线程池就会检测线程在 60 秒内有没有可执行任务，如果没有就会被销毁，最终线程数量会减为 0。</p>
</li>
<li><p>ScheduledThreadPool</p>
<p>周期性的执行任务</p>
</li>
<li><p>SingleThreadExecutor</p>
<p>它会使用唯一的线程去执行任务，原理和 FixedThreadPool 是一样的，只不过这里线程只有一个，如果线程在执行任务的过程中发生异常，线程池也会重新创建一个线程来执行后续的任务</p>
</li>
<li><p>SingleThreadScheduledExecutor</p>
<p>它实际和第三种 ScheduledThreadPool 线程池非常相似，它只是 ScheduledThreadPool 的一个特例，内部只有一个线程.</p>
</li>
<li><p>ForkJoinPool</p>
<p>我们有一个 Task，这个 Task 可以产生三个子任务，三个子任务并行执行完毕后将结果汇总给 Result。</p>
<img src="https://s0.lgstatic.com/i/image2/M01/AF/A0/CgotOV3kzomAflZxAAB99x9-MzI241.png" style="zoom:50%;"></li>
</ol>
<h4 id="拒绝策略"><a href="#拒绝策略" class="headerlink" title="拒绝策略"></a>拒绝策略</h4><ul>
<li><p>第一种拒绝策略是 AbortPolicy，这种拒绝策略在拒绝任务时，会直接抛出一个类型为 RejectedExecutionException 的 RuntimeException，让你感知到任务被拒绝了，于是你便可以根据业务逻辑选择重试或者放弃提交等策略。</p>
</li>
<li><p>第二种拒绝策略是 DiscardPolicy，这种拒绝策略正如它的名字所描述的一样，当新任务被提交后直接被丢弃掉，也不会给你任何的通知，相对而言存在一定的风险，因为我们提交的时候根本不知道这个任务会被丢弃，可能造成数据丢失。</p>
</li>
<li><p>第三种拒绝策略是 DiscardOldestPolicy，如果线程池没被关闭且没有能力执行，则会丢弃任务队列中的头结点，通常是存活时间最长的任务，这种策略与第二种不同之处在于它丢弃的不是最新提交的，而是队列中存活时间最长的，这样就可以腾出空间给新提交的任务，但同理它也存在一定的数据丢失风险。</p>
</li>
<li><p>第四种拒绝策略是 CallerRunsPolicy，相对而言它就比较完善了，当有新任务提交后，如果线程池没被关闭且没有能力执行，则把这个任务交于提交任务的线程执行，也就是谁提交任务，谁就负责执行任务。这样做主要有两点好处。<br>第一点新提交的任务不会被丢弃，这样也就不会造成业务损失。<br>第二点好处是，由于谁提交任务谁就要负责执行任务，这样提交任务的线程就得负责执行任务，而执行任务又是比较耗时的，在这段期间，提交任务的线程被占用，也就不会再提交新的任务，减缓了任务提交的速度，相当于是一个负反馈。在此期间，线程池中的线程也可以充分利用这段时间来执行掉一部分任务，腾出一定的空间，相当于是给了线程池一定的缓冲期。</p>
<p><strong>提交任务的线程是不固定的，取决于具体是哪个线程执行submit等方法的</strong></p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=16#/detail/pc?id=248">https://kaiwu.lagou.com/course/courseInfo.htm?courseId=16#/detail/pc?id=248</a></p>
<h4 id="线程数量和CPU核数关系"><a href="#线程数量和CPU核数关系" class="headerlink" title="线程数量和CPU核数关系"></a>线程数量和CPU核数关系</h4><p><code>线程数 = CPU 核心数 *（1+平均等待时间/平均工作时间）</code></p>
<ol>
<li><p>线程平均等待时间所占比例越高，就需要越多的线程</p>
<blockquote>
<p>耗时 IO 型任务 , 比如数据库、文件的读写，网络通信等任务，这种任务的特点是并不会特别消耗 CPU 资源，但是 IO 操作很耗时，总体会占用比较多的时间 , 因为 IO 读写速度相比于 CPU 的速度而言是比较慢的，如果我们设置过少的线程数，就可能导致 CPU 资源的浪费,而如果我们设置更多的线程数，那么当一部分线程正在等待 IO 的时候，它们此时并不需要 CPU 来计算，那么另外的线程便可以利用 CPU 去执行其他的任务，互不影响，这样的话在任务队列中等待的任务就会减少，可以更好地利用资源。</p>
</blockquote>
</li>
<li><p> 线程的平均工作时间所占比例越高，就需要越少的线程</p>
</li>
</ol>
<blockquote>
<p> 平均工作时间长 : CPU密集型任务，加密、解密、压缩、计算等一系列需要大量耗费 CPU 资源的任务。因为计算任务非常重，会占用大量的 CPU 资源，所以这时 CPU 的每个核心工作基本都是满负荷的，而我们又设置了过多的线程，每个线程都想去利用 CPU 资源来执行自己的任务，这就会造成不必要的上下文切换，此时线程数的增多并没有让性能提升，反而由于线程数量过多会导致性能下降。</p>
</blockquote>
<p>   可以通过写代码等办法统计到各部分语句的运行时长</p>
<p>如果我们执行的任务类型不是固定的，比如可能一段时间是 CPU 密集型，另一段时间是 IO 密集型，或是同时有两种任务相互混搭。那么在这种情况下，我们可以把最大线程数设置成核心线程数的几倍，以便应对任务突发情况。当然更好的办法是用不同的线程池执行不同类型的任务，让任务按照类型区分开，而不是混杂在一起，这样就可以按照上一课时估算的线程数或经过压测得到的结果来设置合理的线程数了，达到更好的性能。</p>
<p><a target="_blank" rel="noopener" href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=16#/detail/pc?id=254">https://kaiwu.lagou.com/course/courseInfo.htm?courseId=16#/detail/pc?id=254</a></p>
<h4 id="阻塞队列"><a href="#阻塞队列" class="headerlink" title="阻塞队列"></a>阻塞队列</h4><h5 id="5种常见的线程池"><a href="#5种常见的线程池" class="headerlink" title="5种常见的线程池"></a>5种常见的线程池</h5><img src="/2017/08/27/ConcurrencyThreadPool/blockQueue.png" alt="Screen Shot 2020-08-19 at 10.07.23 AM" style="zoom:50%;">



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService fixedThreadPool = Executors.newFixedThreadPool(<span class="number">1</span>);      <span class="comment">//LinkedBlockingQueue</span></span><br><span class="line">ExecutorService singleThreadExecutor = Executors.newSingleThreadExecutor();     <span class="comment">// LinkedBlockingQueue</span></span><br><span class="line">ExecutorService cachedThreadPool = Executors.newCachedThreadPool();             <span class="comment">// SynchronousQueue</span></span><br><span class="line">ScheduledExecutorService scheduledThreadPool = Executors.newScheduledThreadPool(<span class="number">1</span>); <span class="comment">//DelayedWorkQueue</span></span><br><span class="line">ScheduledExecutorService singleThreadScheduledExecutor = Executors.newSingleThreadScheduledExecutor(); <span class="comment">//DelayedWorkQueue</span></span><br></pre></td></tr></table></figure>



<p>上图 前面是线程池，后面是使用的阻塞队列</p>
<ol>
<li><p>LinkedBlockingQueue (FixedThreadPool,SingleThreadExector)</p>
<p>使用的有 FixedThreadPool ,SingleThreadExector,它们使用的阻塞队列是容量为 Integer.MAX_VALUE 的 LinkedBlockingQueue,可以认为是无界队列。由于 FixedThreadPool 线程池的线程数是固定的，所以没有办法增加特别多的线程来处理任务，这时就<em>需要 LinkedBlockingQueue 这样一个没有容量限制的阻塞队列来存放任务</em>。</p>
<p><em>缺点</em>: 最终大量堆积的任务会占用大量内存，并发生 OOM ，也就是OutOfMemoryError.</p>
</li>
<li><p>SynchronousQueue  (CachedThreadPool)</p>
<p>对应的线程池是 CachedThreadPool,线程池 CachedThreadPool 的最大线程数是 Integer 的最大值，可以理解为线程数是可以无限扩展的。和LinkedBlockingQueue阻塞队列重复相反，</p>
<p><em>缺点</em>: 当任务数量特别多的时候，就可能会导致创建非常多的线程，最终超过了操作系统的上限而无法创建新线程，或者导致内存不足。</p>
</li>
<li><p>DelayedWorkQueue (DelayedWorkQueue)</p>
<p>顾名思义，特点就是可以延迟执行任务</p>
<p><em>缺点</em>: 它采用的任务队列是 DelayedWorkQueue，这是一个延迟队列，同时也是一个无界队列，所以和 LinkedBlockingQueue 一样，如果队列中存放过多的任务，就可能导致 OOM</p>
</li>
</ol>
<h5 id="OkHttp线程池"><a href="#OkHttp线程池" class="headerlink" title="OkHttp线程池"></a>OkHttp线程池</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ThreadPoolExecutor executor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">        <span class="number">0</span>, Integer.MAX_VALUE, <span class="number">60</span>, TimeUnit.SECONDS, <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;());</span><br></pre></td></tr></table></figure>

<p>可以看到 corePoolSize  0 ,  MaxPoolSize Integer.MAX_VALUE</p>
<p>根据线程池执行流程： </p>
<ol>
<li>首先核心线程，corePoolSize 为0 。</li>
<li>把任务加入SynchronousQueue，但是这个队列加入就会失败。</li>
<li>创建非核心线程，数量为Integer.MAX_VALUE，可以创建。</li>
<li>当任务执行完后，3创建的非核心线程 根据keepAliveTime时间，逐步销毁。</li>
</ol>
<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>OkHttpThreadPool.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ThreadPoolExecutor executor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">        <span class="number">0</span>, Integer.MAX_VALUE, <span class="number">60</span>, TimeUnit.SECONDS, <span class="keyword">new</span> LinkedBlockingDeque&lt;&gt;());</span><br><span class="line">executor.execute(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;任务1&quot;</span>);</span><br><span class="line">    System.out.println(Thread.currentThread());</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">executor.execute(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;任务1&quot;</span>);</span><br><span class="line">    System.out.println(Thread.currentThread());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">executor.execute(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;任务1&quot;</span>);</span><br><span class="line">    System.out.println(Thread.currentThread());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>运行结果: </p>
<p>任务1<br>Thread[pool-1-thread-1,5,main]</p>
<p>如果 new LinkedBlockingDeque&lt;&gt;(1)能正常执行，因为LinkedBlockingDeque加入 任务1 就满了，后面的任务创建非核心线程</p>
<p>但是有点疑惑，我这里核心线程是0，任务都加入到LinkedBlockingDeque, 按照线程池流程，<strong>非核心就不应该创建呀？怎么任务1就执行了呢</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV15y4y1B7Rw?p=5">https://www.bilibili.com/video/BV15y4y1B7Rw?p=5</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/BHDrSgwUVXkzvswK1khidQ">https://mp.weixin.qq.com/s/BHDrSgwUVXkzvswK1khidQ</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Snailclimb/programmer-advancement">https://github.com/Snailclimb/programmer-advancement</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/6855586076132655118">https://juejin.im/post/6855586076132655118</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&amp;mid=2247485441&amp;idx=1&amp;sn=303a25ab02fa9f14a319923e6b0d9759&amp;chksm=cea247caf9d5cedc3a5e1d31f26c08d8ae4c11c349fbdc91ac1d90d8b35807517accb5f5d527&amp;token=2128752750&amp;lang=zh_CN#rd">https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&amp;mid=2247485441&amp;idx=1&amp;sn=303a25ab02fa9f14a319923e6b0d9759&amp;chksm=cea247caf9d5cedc3a5e1d31f26c08d8ae4c11c349fbdc91ac1d90d8b35807517accb5f5d527&amp;token=2128752750&amp;lang=zh_CN#rd</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2017-07-21T06:54:53.000Z" title="7/21/2017, 2:54:53 PM">2017-07-21</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-08-19T11:11:44.238Z" title="8/19/2021, 7:11:44 PM">2021-08-19</time></span><span class="level-item"><a class="link-muted" href="/categories/JAVA/">JAVA</a></span><span class="level-item">9 minutes read (About 1420 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/07/21/String/">String</a></p><div class="content"><p> 　字符串连接有两种方式，一种时  “ +  “,另一种是 StringBuilder方式</p>
<p>命令行运行java</p>
<p>平常用开发工具习惯了，都忘了怎么用命令行运行，特此记录下</p>
<p>新建 Concatenation.java文件，cmd到该目录下，写入代码</p>
<pre><code> public class Concatenation&#123;
    public static void main(String[] args)&#123;
     String mango = &quot;mango&quot;;
     String s = &quot;abc&quot; + mango + &quot;def&quot; + 47;
     System.out.print(s);    
    &#125;
 &#125;
</code></pre>
<p>生成 Concatenation.calss 文件</p>
<pre><code>  D:\DemoExo&gt;javac Concatenation.java
</code></pre>
<p>运行Concatenation.class文件,后面是运行结果</p>
<pre><code>   D:\DemoExo&gt;java Concatenation
   abcmangodef47
</code></pre>
<h4 id="String字符串连接方式"><a href="#String字符串连接方式" class="headerlink" title="String字符串连接方式"></a>String字符串连接方式</h4><p>回到主题</p>
<p>  查看JDK文档（不知道在哪），String 类中每一个看起来会修改String值的方法，实际上都是创建了一个全新的String对象,以包含修改后的字符串内容.</p>
<pre><code>public class Immutable&#123;
     public static String upcase(String s)&#123;
       return s.toUpperCase();
     &#125;
     public static void println(String q)&#123;
       System.out.println(q);
     &#125;
 
    public static void main(String[] args)&#123;
        String q = &quot;howdy&quot;;
        print(q);            // howdy
       String qq= upcase(q);
       print(qq);            //HOWDY
       print(q);             //howdy
    &#125;
&#125;
</code></pre>
<p>运行结果：<br>howdy<br>HOWDY<br>howdy<br>当把q传给upcase()时，实际传递的是引用的拷贝</p>
<h4 id="编译器运行过程"><a href="#编译器运行过程" class="headerlink" title="编译器运行过程"></a>编译器运行过程</h4><p>反编译Concatenation,生成JVM字节码</p>
<pre><code>   javap -c Concatenation.class
</code></pre>
<p>字节码是这样的</p>
<pre><code>C:\DemoExo&gt;javap -c Concatenation.class
 Compiled from &quot;Concatenation.java&quot;
public class Concatenation &#123;
  public Concatenation();
    Code:
       0: aload_0
       1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V
       4: return

  public static void main(java.lang.String[]);
    Code:
       0: ldc           #2                  // String mango
       2: astore_1
       3: new           #3                  // class java/lang/StringBuilder
       6: dup
       7: invokespecial #4                  // Method java/lang/StringBuilder.&quot;&lt;init&gt;&quot;:()V
      10: ldc           #5                  // String abc
      12: invokevirtual #6                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
      15: aload_1
      16: invokevirtual #6                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
      19: ldc           #7                  // String def
      21: invokevirtual #6                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
      24: bipush        47
      26: invokevirtual #8                  // Method java/lang/StringBuilder.append:(I)Ljava/lang/StringBuilder;
      29: invokevirtual #9                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;
      32: astore_2
      33: getstatic     #10                 // Field java/lang/System.out:Ljava/io/PrintStream;
      36: aload_2
      37: invokevirtual #11                 // Method java/io/PrintStream.print:(Ljava/lang/String;)V
      40: return
&#125;
</code></pre>
<p>可以看到，编译器创建了一个StringBuilder对象,用以构造最终的String，并四次调用了append(),最后使用命令astore_2生成 s对象。<br>这样来看，使用 “+” 连接符，是不会影响性能的咯，接着往下</p>
<h3 id="“-”连接符-和-StringBuilder对比"><a href="#“-”连接符-和-StringBuilder对比" class="headerlink" title="“+”连接符 和 StringBuilder对比"></a>“+”连接符 和 StringBuilder对比</h3><p>运行javap -c WhitherStringBuilder.class 看到两个方法对象的字节码，先看前半部分implicit()</p>
<pre><code>public class WhitherStringBuilder &#123;
  public WhitherStringBuilder();
    Code:
       0: aload_0
       1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V
       4: return

  public java.lang.String implicit(java.lang.String[]);
    Code:
       0: ldc           #2                  // String
       2: astore_2
       3: iconst_0
       4: istore_3
       5: iload_3
       6: aload_1
       7: arraylength
       8: if_icmpge     38
      11: new           #3                  // class java/lang/StringBuilder
      14: dup
      15: invokespecial #4                  // Method java/lang/StringBuilder.&quot;&lt;init&gt;&quot;:()V
      18: aload_2
      19: invokevirtual #5                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
      22: aload_1
      23: iload_3
      24: aaload
      25: invokevirtual #5                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
      28: invokevirtual #6                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;
      31: astore_2
      32: iinc          3, 1
      35: goto          5
      38: aload_2
      39: areturn
</code></pre>
<p>第8到35行，在for循环体内，每一次循环就创建了一个StringBuilder对象，接着看看explicit()</p>
<pre><code> public java.lang.String explicit(java.lang.String[]);
   Code:
      0: new           #3                  // class java/lang/StringBuilder
      3: dup
      4: invokespecial #4                  // Method java/lang/StringBuilder.&quot;&lt;init&gt;&quot;:()V
      7: astore_2
      8: iconst_0
      9: istore_3
     10: iload_3
     11: aload_1
     12: arraylength
     13: if_icmpge     30
     16: aload_2
     17: aload_1
     18: iload_3
     19: aaload
     20: invokevirtual #5                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
     23: pop
     24: iinc          3, 1
     27: goto          10
     30: aload_2
     31: invokevirtual #6                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;
</code></pre>
<p>第13到27行在for循环体内，StringBuilder只会生成一个对象</p>
<p>总结： 由此来看，如果字符串操作比较简单，就可以用“+”连接让编译器处理字符串<br>如果在循环中，那么自己创建一个StringBuilder对象</p>
<p>参考：<em>摘自ThinkInJava4   P286</em></p>
<h4 id="避免创建不必要的对象"><a href="#避免创建不必要的对象" class="headerlink" title="避免创建不必要的对象"></a>避免创建不必要的对象</h4><p>创建　String对象</p>
<p> 最好能重用对象而不是每次需要的时候就创建一个功能相同的新对象，重用方式即快速<br>又流行。如果对象是不可变的，它始终可以被重用。</p>
<p>极端的反面例子　｀Ｓtring s = new String(“stringette”);  //DON’T DO THIS ! ｀<br>该语句每次被执行的时候都创建一个新的String实例，传递给String构造器的参数”stringette’本身就是一个String实例，如果这种用法在一个循环中，或者在一个频繁<br>调用的方法中，就会创建出成千上万不必要的String  实例。</p>
<p>改进后的版本如下所示</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String s  = <span class="string">&quot;stringette&#x27;;</span></span><br></pre></td></tr></table></figure>
<p>这个版本只用了一个String实例，而且它可以保证，对于所有的同一台虚拟机中运行的代码<br>，只要包含相同的字符串字面常量，该对象就会被重用.</p>
<h2 id="返回数据处理"><a href="#返回数据处理" class="headerlink" title="返回数据处理"></a>返回数据处理</h2><p>对于同时提供静态工厂方法和构造器的不可变类，通常可以使用静态工厂方法，而不是构造器<br>以避免创建不必要的对象，例如，静态工厂方法Boolean.valueof(String)由于构造器Boolean(String),构造器每次调用的时候都会创建一个新的对象，而静态工厂方法则不会</p>
<p>我们平常解析回来后非String类型的数据，需要转换成String对象　<br>看到这里后就需要使用<code>String.valueof(String)</code> </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Returns the string representation of the &#123;<span class="doctag">@code </span>Object&#125; argument.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param   </span>obj   an &#123;<span class="doctag">@code </span>Object&#125;.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return  </span>if the argument is &#123;<span class="doctag">@code </span>null&#125;, then a string equal to</span></span><br><span class="line"><span class="comment">   *          &#123;<span class="doctag">@code </span>&quot;null&quot;&#125;; otherwise, the value of</span></span><br><span class="line"><span class="comment">   *          &#123;<span class="doctag">@code </span>obj.toString()&#125; is returned.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@see     </span>java.lang.Object#toString()</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">String</span> <span class="function"><span class="title">valueOf</span>(<span class="params"><span class="built_in">Object</span> obj</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> (obj == <span class="literal">null</span>) ? <span class="string">&quot;null&quot;</span> : obj.toString();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>从源码中看到对形参　做了　null判断，所以用这种方式页不用担心闪退的情况了<br>参考 Effective Java　page17</p>
<ul>
<li><p>java 8 获取对象数据</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private WchatMobile decodeMobile(<span class="built_in">String</span> encryptedData, <span class="built_in">String</span> iv, <span class="built_in">String</span> unionid) &#123;</span><br><span class="line">  WchatMiniAppSession miniAppSession = getWchatMiniAppSession(unionid);</span><br><span class="line">  <span class="built_in">String</span> sessionKey = Optional.ofNullable(miniAppSession)</span><br><span class="line">    .orElseThrow<span class="function"><span class="params">(() -&gt; <span class="keyword">new</span> ServiceExecutionException(<span class="string">&quot;用户小程序登录信息为空&quot;</span>))</span></span></span><br><span class="line"><span class="function">    .<span class="title">getSessionKey</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">  </span></span><br><span class="line"><span class="function">  <span class="title">return</span> <span class="title">Optional</span>.<span class="title">ofNullable</span><span class="params">(wchatMiniAppService)</span></span></span><br><span class="line"><span class="function">   .<span class="title">map</span><span class="params">(<span class="keyword">as</span> -&gt; <span class="keyword">as</span>.getWxMaService())</span></span></span><br><span class="line"><span class="function">   .<span class="title">map</span><span class="params">(s -&gt; s.getUserService())</span></span></span><br><span class="line"><span class="function">   .<span class="title">map</span><span class="params">(se -&gt; se.getPhoneNoInfo(sessionKey, encryptedData, iv))</span></span></span><br><span class="line"><span class="function">   .<span class="title">map</span><span class="params">(num -&gt; WchatMobile.<span class="keyword">from</span>(num))</span></span></span><br><span class="line"><span class="function">   .<span class="title">orElse</span><span class="params">(<span class="literal">null</span>)</span>;</span></span><br><span class="line"><span class="function"> &#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/209343">https://time.geekbang.org/column/article/209343</a></p>
<h4 id="亨元模式"><a href="#亨元模式" class="headerlink" title="亨元模式"></a>亨元模式</h4><pre><code>Integer a = 1;
Integer b = 2;
Integer c = 3;
Integer d = 3;
Integer e = 321;
Integer f = 321;
Long g = 3L;
System.out.println(c==d);
System.out.println(e==f);
System.out.println(c==(a+b));
System.out.println(c.equals(a+b));
System.out.println(g ==(a+b));
System.out.println(g.equals(a+b));
</code></pre>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/categories/JAVA/page/2/">Previous</a></div><div class="pagination-next is-invisible is-hidden-mobile"><a href="/categories/JAVA/page/4/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/categories/JAVA/">1</a></li><li><a class="pagination-link" href="/categories/JAVA/page/2/">2</a></li><li><a class="pagination-link is-current" href="/categories/JAVA/page/3/">3</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Your name"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Your name</p><p class="is-size-6 is-block">Your title</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Your location</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">239</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">30</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">33</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ppoffice" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ppoffice"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/ANDROID/"><span class="level-start"><span class="level-item">ANDROID</span></span><span class="level-end"><span class="level-item tag">54</span></span></a></li><li><a class="level is-mobile" href="/categories/Architecture/"><span class="level-start"><span class="level-item">Architecture</span></span><span class="level-end"><span class="level-item tag">2</span></span></a><ul><li><a class="level is-mobile" href="/categories/Architecture/DesignPattern/"><span class="level-start"><span class="level-item">DesignPattern</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/BLE/"><span class="level-start"><span class="level-item">BLE</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/C/"><span class="level-start"><span class="level-item">C++</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/COROUTINE/"><span class="level-start"><span class="level-item">COROUTINE</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Computer-Composition-principles/"><span class="level-start"><span class="level-item">Computer Composition principles</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/DataStructure/"><span class="level-start"><span class="level-item">DataStructure</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/categories/DesignPattern/"><span class="level-start"><span class="level-item">DesignPattern</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/DesignPatterns/"><span class="level-start"><span class="level-item">DesignPatterns</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/ENGLISH/"><span class="level-start"><span class="level-item">ENGLISH</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/INTERVIEW/"><span class="level-start"><span class="level-item">INTERVIEW</span></span><span class="level-end"><span class="level-item tag">9</span></span></a><ul><li><a class="level is-mobile" href="/categories/INTERVIEW/NETWORK/"><span class="level-start"><span class="level-item">NETWORK</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/JAVA/"><span class="level-start"><span class="level-item">JAVA</span></span><span class="level-end"><span class="level-item tag">27</span></span></a></li><li><a class="level is-mobile" href="/categories/JETPACK/"><span class="level-start"><span class="level-item">JETPACK</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Jetpack/"><span class="level-start"><span class="level-item">Jetpack</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Kotlin/"><span class="level-start"><span class="level-item">Kotlin</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/LIFE/"><span class="level-start"><span class="level-item">LIFE</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/LINUX/"><span class="level-start"><span class="level-item">LINUX</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/Library/"><span class="level-start"><span class="level-item">Library</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Mathematics/"><span class="level-start"><span class="level-item">Mathematics</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/NETWORK/"><span class="level-start"><span class="level-item">NETWORK</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/OS/"><span class="level-start"><span class="level-item">OS</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Organization/"><span class="level-start"><span class="level-item">Organization</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/SOURCE/"><span class="level-start"><span class="level-item">SOURCE</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/TEST/"><span class="level-start"><span class="level-item">TEST</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/TOOL/"><span class="level-start"><span class="level-item">TOOL</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile" href="/categories/VIEW/"><span class="level-start"><span class="level-item">VIEW</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/categories/anim/"><span class="level-start"><span class="level-item">anim</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/flutter/"><span class="level-start"><span class="level-item">flutter</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-07-04T07:57:26.000Z">2024-07-04</time></p><p class="title"><a href="/2024/07/04/DesignPatterns-State/">DesignPatterns_State</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-07-03T05:51:25.000Z">2024-07-03</time></p><p class="title"><a href="/2024/07/03/glide/">glide</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-06-28T09:37:49.000Z">2024-06-28</time></p><p class="title"><a href="/2024/06/28/bitmap/">Bitmap</a></p><p class="categories"><a href="/categories/Computer-Composition-principles/">Computer Composition principles</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-06-28T08:04:14.000Z">2024-06-28</time></p><p class="title"><a href="/2024/06/28/bits-and-bytes/">Bits and Bytes</a></p><p class="categories"><a href="/categories/Computer-Composition-principles/">Computer Composition principles</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-06-26T06:45:50.000Z">2024-06-26</time></p><p class="title"><a href="/2024/06/26/lifecycle/">LifeCycle</a></p><p class="categories"><a href="/categories/JETPACK/">JETPACK</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/07/"><span class="level-start"><span class="level-item">July 2024</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/06/"><span class="level-start"><span class="level-item">June 2024</span></span><span class="level-end"><span class="level-item tag">14</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/05/"><span class="level-start"><span class="level-item">May 2024</span></span><span class="level-end"><span class="level-item tag">27</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/11/"><span class="level-start"><span class="level-item">November 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/08/"><span class="level-start"><span class="level-item">August 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/04/"><span class="level-start"><span class="level-item">April 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">January 2023</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/12/"><span class="level-start"><span class="level-item">December 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">October 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/09/"><span class="level-start"><span class="level-item">September 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">August 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">July 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">June 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">May 2022</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">April 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">March 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/02/"><span class="level-start"><span class="level-item">February 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">January 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">December 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">November 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">October 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/09/"><span class="level-start"><span class="level-item">September 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">August 2021</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">June 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">May 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">April 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">March 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">February 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">January 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">December 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">November 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">October 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">September 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">August 2020</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">July 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">June 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">May 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">April 2020</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">March 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">January 2020</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/12/"><span class="level-start"><span class="level-item">December 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">November 2019</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/09/"><span class="level-start"><span class="level-item">September 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">August 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">July 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/06/"><span class="level-start"><span class="level-item">June 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">April 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">March 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">January 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/11/"><span class="level-start"><span class="level-item">November 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">August 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/07/"><span class="level-start"><span class="level-item">July 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/06/"><span class="level-start"><span class="level-item">June 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/05/"><span class="level-start"><span class="level-item">May 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">April 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">March 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">February 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">January 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">December 2017</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/11/"><span class="level-start"><span class="level-item">November 2017</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/10/"><span class="level-start"><span class="level-item">October 2017</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">September 2017</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/08/"><span class="level-start"><span class="level-item">August 2017</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/07/"><span class="level-start"><span class="level-item">July 2017</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ANDROID/"><span class="tag">ANDROID</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AOSP/"><span class="tag">AOSP</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Activity/"><span class="tag">Activity</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AndroidNewFeatures/"><span class="tag">AndroidNewFeatures</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Assembly/"><span class="tag">Assembly</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BLOG/"><span class="tag">BLOG</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ConstraintLayout/"><span class="tag">ConstraintLayout</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DB/"><span class="tag">DB</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DesignPattern/"><span class="tag">DesignPattern</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Drawer/"><span class="tag">Drawer</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Fragment/"><span class="tag">Fragment</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JVM/"><span class="tag">JVM</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LEETCODE/"><span class="tag">LEETCODE</span><span class="tag">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Library/"><span class="tag">Library</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Operators/"><span class="tag">Operators</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Performance/"><span class="tag">Performance</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RecyclerView/"><span class="tag">RecyclerView</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RxJava/"><span class="tag">RxJava</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/THINK/"><span class="tag">THINK</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TOOL/"><span class="tag">TOOL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TabLayout/"><span class="tag">TabLayout</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Test/"><span class="tag">Test</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TouchEvent/"><span class="tag">TouchEvent</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/VIEW/"><span class="tag">VIEW</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/XML/"><span class="tag">XML</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/anim/"><span class="tag">anim</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/compose/"><span class="tag">compose</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/concurrency/"><span class="tag">concurrency</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/coroutie/"><span class="tag">coroutie</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/inter/"><span class="tag">inter</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/keyboard/"><span class="tag">keyboard</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/permission/"><span class="tag">permission</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/proguard/"><span class="tag">proguard</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Jon&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2024 Jon</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2019</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>