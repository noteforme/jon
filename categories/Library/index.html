<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>Category: Library - Jon&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Jon&#039;s Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Jon&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Jon&#039;s Blog"><meta property="og:url" content="https://noteforme.github.io/"><meta property="og:site_name" content="Jon&#039;s Blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://noteforme.github.io/img/og_image.png"><meta property="article:author" content="Jon"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://noteforme.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://noteforme.github.io"},"headline":"Jon's Blog","image":["https://noteforme.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Jon"},"publisher":{"@type":"Organization","name":"Jon's Blog","logo":{"@type":"ImageObject","url":"https://noteforme.github.io/img/logo.svg"}},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Jon&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/categories">Categories</a></li><li class="is-active"><a href="#" aria-current="page">Library</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-06-18T05:50:06.000Z" title="6/18/2024, 1:50:06 PM">2024-06-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-13T21:02:22.000Z" title="9/14/2024, 5:02:22 AM">2024-09-14</time></span><span class="level-item"> Jon </span><span class="level-item"><a class="link-muted" href="/categories/Library/">Library</a></span><span class="level-item">21 minutes read (About 3092 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/06/18/glide/">Glide</a></p><div class="content"><div class="ez-toc-v2_0_66_1 ez-toc-wrap-right counter-hierarchy ez-toc-counter ez-toc-grey ez-toc-container-direction" id="ez-toc-container"><div class="ez-toc-title-container">Table of Contents

<p><span class="ez-toc-title-toggle"><a href="#"><span class="ez-toc-js-icon-con"><span class><span class="eztoc-hide" style="display:none;">Toggle</span><span class="ez-toc-icon-toggle-span"><svg class="list-377408" fill="none" height="20px" style="fill: #999;color:#999" viewbox="0 0 24 24" width="20px" xmlns="http://www.w3.org/2000/svg"><path d="M6 6H4v2h2V6zm14 0H8v2h12V6zM4 11h2v2H4v-2zm16 0H8v2h12v-2zM4 16h2v2H4v-2zm16 0H8v2h12v-2z" fill="currentColor"/></svg><svg baseprofile="tiny" class="arrow-unsorted-368013" height="10px" style="fill: #999;color:#999" version="1.2" viewbox="0 0 24 24" width="10px" xmlns="http://www.w3.org/2000/svg"><path d="M18.2 9.3l-6.2-6.3-6.2 6.3c-.2.2-.3.4-.3.7s.1.5.3.7c.2.2.4.3.7.3h11c.3 0 .5-.1.7-.3.2-.2.3-.5.3-.7s-.1-.5-.3-.7zM5.8 14.7l6.2 6.3 6.2-6.3c.2-.2.3-.5.3-.7s-.1-.5-.3-.7c-.2-.2-.4-.3-.7-.3h-11c-.3 0-.5.1-.7.3-.2.2-.3.5-.3.7s.1.5.3.7z"/></svg></span></span></span></a></span></p></div><nav>- <a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Question" title="Question">Question</a><p></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Glide_Flow" title="Glide Flow">Glide Flow</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#sequenceDiagram_StatusWAITING_FOR_SIZE" title="sequenceDiagram   Status.WAITING_FOR_SIZE">sequenceDiagram Status.WAITING_FOR_SIZE</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Bind_lifecycle" title="Bind lifecycle">Bind lifecycle</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Old_lifecycle_architecture" title="Old lifecycle architecture">Old lifecycle architecture</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#new_lifecycle_architecture" title="new lifecycle architecture">new lifecycle architecture</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Advantages_of_the_New_Approach" title="Advantages of the New Approach">Advantages of the New Approach</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#LifeCycle_flow_UML" title="LifeCycle flow UML">LifeCycle flow UML</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#connective_lifecycle_UML" title="connective lifecycle UML">connective lifecycle UML</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Glide_caching_strategy" title="Glide caching strategy">Glide caching strategy</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Concept" title="Concept">Concept</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Cache_Levels" title="Cache Levels">Cache Levels</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Caching_Keys" title="Caching Keys">Caching Keys</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Image_Requests" title="Image Requests">Image Requests</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Cache_Invalidation" title="Cache Invalidation">Cache Invalidation</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Disk_Cache" title="Disk Cache">Disk Cache</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#KEY" title="KEY">KEY</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Identifying_an_Object" title="Identifying an Object">Identifying an Object</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Example_Implementation" title="Example Implementation">Example Implementation</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Key_Points" title="Key Points">Key Points</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#equal_objects_cannot_have_different_hash_codes" title="equal objects cannot have different hash codes">equal objects cannot have different hash codes</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Key_Points-2" title="Key Points">Key Points</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Active_recyle" title="Active recyle">Active recyle</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#LruCache" title="LruCache">LruCache</a><ul>
<li><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#How_Glide_Uses_LruCache" title="How Glide Uses LruCache">How Glide Uses LruCache</a></li>
</ul>
</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Bitmap_Reuse" title="Bitmap Reuse">Bitmap Reuse</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#botain_bitmap" title="botain bitmap">botain bitmap</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#save_bitmap" title="save bitmap">save bitmap</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#bitmap_save_condition" title="bitmap save condition">bitmap save condition</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#decoded_VS_without_decode" title="decoded VS without decode">decoded VS without decode</a><br>- <a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Decoded_Cache" title="Decoded Cache">Decoded Cache</a><br>- <a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#Without_Decode_Encoded_Cache" title="Without Decode (Encoded Cache)">Without Decode (Encoded Cache)</a></li>
</ul>
</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/18/glide/#BUILD_PROJECT" title="BUILD PROJECT">BUILD PROJECT</a></li>
</ul>
</nav></div># <span class="ez-toc-section" id="Question"></span>Question<span class="ez-toc-section-end"></span>

<p>This article has many <strong>flowcharts</strong> to introduce the principles<br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/ZjKkTJ5GpP8e2BnttiJEiA">https://mp.weixin.qq.com/s/ZjKkTJ5GpP8e2BnttiJEiA</a><br><a target="_blank" rel="noopener" href="https://juejin.cn/post/6882536990400020494">https://juejin.cn/post/6882536990400020494</a></p>
<p>Glide使用什么缓存机制<br>LRUcache底层实现</p>
<p>glide和OkHttp的任务调度是怎么实现的（比如同时发起很多请求）<br>自己去实现图片库，怎么做？<br>Glide内存缓存如何控制大小？</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6956090846470995975">https://juejin.cn/post/6956090846470995975</a></p>
<p>bitmap decode<br><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904161327185927">https://juejin.cn/post/6844904161327185927</a><br><a target="_blank" rel="noopener" href="https://juejin.cn/post/6994669144490639368#heading-4">https://juejin.cn/post/6994669144490639368#heading-4</a></p>
<h1 id="Glide-Flow"><a href="#Glide-Flow" class="headerlink" title="Glide Flow"></a><span class="ez-toc-section" id="Glide_Flow"></span>Glide Flow<span class="ez-toc-section-end"></span></h1><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/oSXDYhc_t4xhAVCfADxXfg">https://mp.weixin.qq.com/s/oSXDYhc_t4xhAVCfADxXfg</a><br><a target="_blank" rel="noopener" href="https://juejin.cn/post/7083367492810686472">https://juejin.cn/post/7083367492810686472</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43298955/article/details/118661784">https://blog.csdn.net/weixin_43298955&#x2F;article&#x2F;details&#x2F;118661784</a><br><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1gq4y1n7wq?p=4">https://www.bilibili.com/video/BV1gq4y1n7wq?p=4</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/48d9e4d5d75d">https://www.jianshu.com/p/48d9e4d5d75d</a></p>
<p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/Architecture/2021-08-09_4.51_glideflow.png"></p>
<p>According to this picture, the image acquisition process is first from Active Resource, then from Memory cache, and then from Disk cache.</p>
<h2 id="sequenceDiagram-Status-WAITING-FOR-SIZE"><a href="#sequenceDiagram-Status-WAITING-FOR-SIZE" class="headerlink" title="sequenceDiagram Status.WAITING_FOR_SIZE"></a><span class="ez-toc-section" id="sequenceDiagram_StatusWAITING_FOR_SIZE"></span>sequenceDiagram Status.WAITING_FOR_SIZE<span class="ez-toc-section-end"></span></h2><p>Loading an image flow for the first time from the network</p>
<div class="mermaid">
  sequenceDiagram
  RequestBuilder ->> RequestManager : track()
  RequestBuilder ->> RequestTracker : runRequest()
  RequestBuilder ->> SingleRequest : begin()
alt status.WAITING_FOR_SIZE
  SingleRequest ->> SingleRequest : onSizeReady()
  SingleRequest ->> Engine : load()

 alt  no memoryResource 
  Engine ->> Engine : waitForExistingOrStartNewJob()
  Engine ->> Engine : build()
  Engine ->> DecodeJob : run()
  DecodeJob ->> DecodeJob : runWrapped() INITIALIZE
  DecodeJob ->> DecodeJob : getNextStage(INITIALIZE) 
  DecodeJob ->> DecodeJob : getNextGenerator(),runGenerators()
  DecodeJob ->> ResourceCacheGenerator : startNext()
  loop stage == Stage.SOURCE
  DecodeJob ->> DecodeJob :  reschedule(SWITCH_TO_SOURCE_SERVICE)
  end
  DecodeJob ->> DecodeJob : run()
  DecodeJob ->> DecodeJob : runWrapped(),runGenerators()
  DecodeJob ->> SourceGenerator : startNext()
  SourceGenerator ->> SourceGenerator : startNextLoad(loadData)
  SourceGenerator ->> MultiModelLoader : loadData(loadData)
  MultiModelLoader ->> HttpUrlFetcher : loadData(loadData)
  HttpUrlFetcher -->> MultiModelLoader :  callback.onDataReady(data)
  MultiModelLoader -->> SourceGenerator :  callback.onDataReady(data)
  SourceGenerator -->> SourceGenerator :  onDataReadyInternal()
  SourceGenerator -->> DecodeJob :  reschedule(SWITCH_TO_SOURCE_SERVICE)
  DecodeJob ->> DecodeJob : run()
  DecodeJob ->> DecodeJob : runWrapped(),runGenerators()
  DecodeJob ->> DecodeJob : startNext()
  DecodeJob ->> SourceGenerator : startNext()
  SourceGenerator ->> SourceGenerator : startNextLoad(loadData)

  SourceGenerator ->> DataCacheGenerator : sourceCacheGenerator.startNext()
  DataCacheGenerator ->> ByteBufferFileLoader : loadData(helper.getPriority(), this)
  ByteBufferFileLoader -->> DataCacheGenerator : onDataReady(result)
  DataCacheGenerator -->> SourceGenerator : onDataFetcherReady()
  SourceGenerator -->> DecodeJob : onDataFetcherReady()
  DecodeJob ->> DecodeJob : decodeFromRetrievedData()
  DecodeJob ->> DecodeJob : decodeFromData(),notifyEncodeAndRelease()
  DecodeJob ->> DecodeJob : notifyComplete()
  DecodeJob ->> EngineJob : onResourceReady(),notifyCallbacksOfResult()
  EngineJob ->> CallResourceReady : run(),notifyCallbacksOfResult(cb)
  CallResourceReady -->> EngineJob : callCallbackOnResourceReady(cb)
  EngineJob -->> SingleRequest : onResourceReady(cb)
  SingleRequest ->> ImageViewTarget : target.onResourceReady(result)
  ImageViewTarget ->> ImageViewTarget : setResourceInternal()
  ImageViewTarget ->> DrawableImageViewTarget : setResource()
 end
end
</div>


<p>What should be noted here is that I looked at the source code. After getting the image from the Internet, it will not go directly to the active resource, nor will it be displayed directly on the ImageView. Instead, <strong>it will be saved to the disk and then read from the disk</strong>. I saw this</p>
<h1 id="Bind-lifecycle"><a href="#Bind-lifecycle" class="headerlink" title="Bind lifecycle"></a><span class="ez-toc-section" id="Bind_lifecycle"></span>Bind lifecycle<span class="ez-toc-section-end"></span></h1><h2 id="Old-lifecycle-architecture"><a href="#Old-lifecycle-architecture" class="headerlink" title="Old lifecycle architecture"></a><span class="ez-toc-section" id="Old_lifecycle_architecture"></span>Old lifecycle architecture<span class="ez-toc-section-end"></span></h2><p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/Architecture/2021-08-09_4.52_lifecycle.png"></p>
<h2 id="new-lifecycle-architecture"><a href="#new-lifecycle-architecture" class="headerlink" title="new lifecycle architecture"></a><span class="ez-toc-section" id="new_lifecycle_architecture"></span>new lifecycle architecture<span class="ez-toc-section-end"></span></h2><p>The Glide library for Android indeed underwent significant changes in its architecture. As of Glide version 4.x, Glide has moved away from using <del>RequestManagerFragment</del> for lifecycle management. Instead, Glide now uses <strong>LifecycleListener</strong> interfaces and <strong>RequestManagerRetriever</strong> to more efficiently manage the lifecycle of requests.</p>
<p>Here is a brief overview of the changes:</p>
<p>Glide 4.x and Lifecycle Management</p>
<ol>
<li>Lifecycle Integration:<br>  Glide now directly integrates with Android’s lifecycle components (Activity, Fragment, Application), which simplifies the lifecycle management of requests. Glide automatically pauses and resumes requests based on the lifecycle events.</li>
<li>LifecycleListeners:<br>  Glide uses LifecycleListener interfaces to handle lifecycle events. These listeners are registered with the Android components (Activities and Fragments), and they notify Glide when to start, stop, or recycle requests.</li>
</ol>
<h2 id="Advantages-of-the-New-Approach"><a href="#Advantages-of-the-New-Approach" class="headerlink" title="Advantages of the New Approach"></a><span class="ez-toc-section" id="Advantages_of_the_New_Approach"></span>Advantages of the New Approach<span class="ez-toc-section-end"></span></h2><ul>
<li>Improved Lifecycle Handling: Glide now more accurately handles the lifecycle of requests, reducing the chances of memory leaks or unnecessary work.</li>
<li>Simplified API: The new API is more intuitive and easier to use, thanks to the integration with Android’s lifecycle components.</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Qy4y1s7Gh?p=15">https://www.bilibili.com/video/BV1Qy4y1s7Gh?p=15</a></p>
<h2 id="LifeCycle-flow-UML"><a href="#LifeCycle-flow-UML" class="headerlink" title="LifeCycle flow UML"></a><span class="ez-toc-section" id="LifeCycle_flow_UML"></span>LifeCycle flow UML<span class="ez-toc-section-end"></span></h2><div class="mermaid">
  sequenceDiagram
autonumber
Glide ->> RequestManagerRetriever : get(FragmentActivity)
RequestManagerRetriever ->> LifecycleRequestManagerRetriever : getOrCreate(getLifecycle())

LifecycleRequestManagerRetriever ->> LifecycleLifecycle:  constructor(lifecycle)
LifecycleLifecycle ->> LifecycleRegistry : lifecycle.addObserver(this)

LifecycleRequestManagerRetriever ->> RequestManager : build(getLifecycle)
RequestManager ->> DefaultConnectivityMonitor : ConnectivityMonitor
Note over RequestManager , DefaultConnectivityMonitor : network connection monitor

LifecycleRegistry -->> LifecycleLifecycle : onStart()
LifecycleRegistry -->> LifecycleLifecycle : onStop()
LifecycleRegistry -->> LifecycleLifecycle : onDestroy()
LifecycleLifecycle ->> RequestManager :  onStart()
Note right of RequestManager : resumeRequests()
LifecycleLifecycle ->> RequestManager :  onStop()
Note right of RequestManager : pauseRequests()
LifecycleLifecycle ->> RequestManager :  onDestroy()
</div>


<h2 id="connective-lifecycle-UML"><a href="#connective-lifecycle-UML" class="headerlink" title="connective lifecycle UML"></a><span class="ez-toc-section" id="connective_lifecycle_UML"></span>connective lifecycle UML<span class="ez-toc-section-end"></span></h2><div class="mermaid">
  classDiagram
%% Creator
  class ConnectivityMonitorFactory {
    + someOperation()
    + factoryMethod(): ConnectivityMonitor
  }

%% concreate factory
  class DefaultConnectivityMonitorFactory {
    +createProduct(): Product
  }

  class ConnectivityMonitor {
     interface
    +operation(): void
  }

%% concreate product
  class DefaultConnectivityMonitor 

%% concreate product
  class NullConnectivityMonitor 

  ConnectivityMonitor <|-- defaultconnectivitymonitor : inheritance connectivitymonitor <|-- nullconnectivitymonitor connectivitymonitorfactory <|.. defaultconnectivitymonitorfactory realization ..> ConnectivityMonitor
</|--></div>


<h1 id="Glide-caching-strategy"><a href="#Glide-caching-strategy" class="headerlink" title="Glide caching strategy"></a><span class="ez-toc-section" id="Glide_caching_strategy"></span>Glide caching strategy<span class="ez-toc-section-end"></span></h1><p>Glide使用什么缓存机制<br>LRUcache底层实现</p>
<p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/glide/Screenshot%202024-06-19%20at%2009.58.55.png"></p>
<h2 id="Concept"><a href="#Concept" class="headerlink" title="Concept"></a><span class="ez-toc-section" id="Concept"></span>Concept<span class="ez-toc-section-end"></span></h2><h3 id="Cache-Levels"><a href="#Cache-Levels" class="headerlink" title="Cache Levels"></a><span class="ez-toc-section" id="Cache_Levels"></span>Cache Levels<span class="ez-toc-section-end"></span></h3><ul>
<li><strong>Active Resources</strong>: These are images currently being displayed. They are kept in memory for immediate access.</li>
<li><strong>Memory Cache</strong>: Once images are no longer in the active resources, they move to the memory cache if there is enough space.</li>
<li><strong>Disk Cache</strong> : If images are no longer in the memory cache, they are still stored in the disk cache. This allows for retrieval without needing to download the image again.</li>
</ul>
<h3 id="Caching-Keys"><a href="#Caching-Keys" class="headerlink" title="Caching Keys"></a><span class="ez-toc-section" id="Caching_Keys"></span>Caching Keys<span class="ez-toc-section-end"></span></h3><ul>
<li>Glide generates unique keys for caching images. These keys are based on the image URL and any transformation or resizing options applied to the image.</li>
<li>Custom keys can be provided by the developer to manage cache more effectively, especially when dealing with dynamic content.</li>
</ul>
<h3 id="Image-Requests"><a href="#Image-Requests" class="headerlink" title="Image Requests"></a><span class="ez-toc-section" id="Image_Requests"></span>Image Requests<span class="ez-toc-section-end"></span></h3><ul>
<li>When a request for an image is made, Glide first checks the active resources, then the memory cache, and finally the disk cache.</li>
<li>If the image is not found in any of these caches, it is fetched from the network or local storage.</li>
</ul>
<h3 id="Cache-Invalidation"><a href="#Cache-Invalidation" class="headerlink" title="Cache Invalidation"></a><span class="ez-toc-section" id="Cache_Invalidation"></span>Cache Invalidation<span class="ez-toc-section-end"></span></h3><ul>
<li>Cache invalidation is necessary to ensure outdated images are not served. Glide allows developers to clear specific entries or entire caches.</li>
<li>It supports automatic cache invalidation based on configurable time intervals.</li>
<li>If the image does not exist in the memory cache, it is read from the disk cache and then placed into the active resources.</li>
<li>If the image does not exist in the memory cache, it will be requested from the network. and then what ???</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/dba296118f35">https://www.jianshu.com/p/dba296118f35</a><br><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1mT4y1R7F4/?p=37">https://www.bilibili.com/video/BV1mT4y1R7F4/?p=37</a></p>
<h2 id="Disk-Cache"><a href="#Disk-Cache" class="headerlink" title="Disk Cache"></a><span class="ez-toc-section" id="Disk_Cache"></span>Disk Cache<span class="ez-toc-section-end"></span></h2><div class="mermaid">
  sequenceDiagram
  autonumber
  RequestBuilder ->> RequestBuilder : into()
  RequestBuilder ->> RequestManager : track()
  RequestBuilder ->> RequestTracker : runRequest()
  RequestTracker ->> SingleRequest : begin()
  SingleRequest ->> SingleRequest : onSizeReady(overrideWidth, overrideHeight)
  SingleRequest ->> Engine : load()
  Engine ->> Engine : loadFromMemory()
  Engine ->> Engine : loadFromActiveResources(key) 
  Note right of Engine : Active Resource
  Engine ->> Engine : loadFromCache(key)
  Note right of Engine : Memory Cache
  Engine ->> DecodeJob : runWrapped(),runGenerators()
  Engine ->> DataCacheGenerator : currentGenerator.startNext()
  DataCacheGenerator ->> ByteBufferFileLoader : loadData(helper.getPriority(), this)
  ByteBufferFileLoader -->> DataCacheGenerator : onDataReady(result)
  DataCacheGenerator -->> SourceGenerator : onDataFetcherReady()
  SourceGenerator -->> DecodeJob : onDataFetcherReady()
  DecodeJob ->> DecodeJob : decodeFromRetrievedData()
  DecodeJob ->> DecodeJob : decodeFromData(),notifyEncodeAndRelease()
  DecodeJob ->> DecodeJob : notifyComplete()
  DecodeJob ->> EngineJob : onResourceReady(),notifyCallbacksOfResult()
  EngineJob -->> Engine : onEngineJobComplete()
  Note right of Engine : activeResources.activate()

  EngineJob ->> CallResourceReady : run(),notifyCallbacksOfResult(cb)
  CallResourceReady -->> EngineJob : callCallbackOnResourceReady(cb)
  EngineJob -->> SingleRequest : onResourceReady(cb)
  SingleRequest ->> ImageViewTarget : target.onResourceReady(result)
  ImageViewTarget ->> ImageViewTarget : setResourceInternal()
  ImageViewTarget ->> DrawableImageViewTarget : setResource()
</div>


<p>step8 : get Active Resources<br>step9 : get Memery Cache<br>step20 : Read from disk cache and then put into active resources.</p>
<h1 id="KEY"><a href="#KEY" class="headerlink" title="KEY"></a><span class="ez-toc-section" id="KEY"></span>KEY<span class="ez-toc-section-end"></span></h1><p>In Java, the equals and hashCode methods are used to compare objects and manage how objects are stored in certain collections like HashMap and HashSet.</p>
<ul>
<li>equals Method<br>The equals method determines whether two objects are equal. By default, the equals method in the Object class compares the memory addresses of the objects (i.e., whether they are the same instance). However, it is common to override this method to provide a meaningful equality check based on the object’s state (i.e., its fields).</li>
<li>hashCode Method<br>The hashCode method returns an integer hash code representation of the object. The contract between equals and hashCode is that if two objects are equal according to the equals method, they must have the same hash code. However, two objects with the same hash code do not necessarily have to be equal.</li>
</ul>
<h2 id="Identifying-an-Object"><a href="#Identifying-an-Object" class="headerlink" title="Identifying an Object"></a><span class="ez-toc-section" id="Identifying_an_Object"></span>Identifying an Object<span class="ez-toc-section-end"></span></h2><p>When you override the equals and hashCode methods properly, they can be used to uniquely identify an object in certain collections. Here’s how:</p>
<ol>
<li>Equality Check: When you use collections like HashSet or keys in HashMap, the equals method is used to check if an object already exists in the collection.</li>
<li>Hash Code: The hashCode method is used by hash-based collections (like HashMap and HashSet) to efficiently locate a bucket in which the object might be stored. Proper implementation of hashCode ensures that objects are distributed evenly across the buckets, reducing the number of collisions and improving performance.</li>
</ol>
<h2 id="Example-Implementation"><a href="#Example-Implementation" class="headerlink" title="Example Implementation"></a><span class="ez-toc-section" id="Example_Implementation"></span>Example Implementation<span class="ez-toc-section-end"></span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Constructor, getters, and setters</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == obj) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="literal">null</span> || getClass() != obj.getClass()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> (Person) obj;</span><br><span class="line">        <span class="keyword">return</span> age == person.age &amp;&amp; Objects.equals(name, person.name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hash(name, age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Key-Points"><a href="#Key-Points" class="headerlink" title="Key Points"></a><span class="ez-toc-section" id="Key_Points"></span>Key Points<span class="ez-toc-section-end"></span></h2><ol>
<li>Consistency: Ensure that equals and hashCode are consistent. If equals returns true for two objects, hashCode must return the same value for both.</li>
<li>Non-Equal Objects: It is acceptable for non-equal objects to have the same hash code, though this can degrade the performance of hash-based collections.</li>
</ol>
<h3 id="equal-objects-cannot-have-different-hash-codes"><a href="#equal-objects-cannot-have-different-hash-codes" class="headerlink" title="equal objects cannot have different hash codes"></a><span class="ez-toc-section" id="equal_objects_cannot_have_different_hash_codes"></span>equal objects cannot have different hash codes<span class="ez-toc-section-end"></span></h3><ol>
<li>Consistent with equals: If two objects are equal according to the equals method, they must have the same hash code.</li>
<li>Self-Consistency: If an object is compared to itself, the equals method must return true, and the hashCode method must consistently return the same integer, provided no information used in equals comparisons on the object is modified.</li>
<li>Non-Equal Objects: If two objects are not equal according to the equals method, it is not required that they have different hash codes. However, different hash codes for non-equal objects can improve the performance of hash-based collections.</li>
</ol>
<p>  if two Person objects have the same name and age, they are considered equal. Consequently, their hash codes will also be the same because the hashCode method uses these fields to compute the hash code.</p>
<h3 id="Key-Points-1"><a href="#Key-Points-1" class="headerlink" title="Key Points"></a><span class="ez-toc-section" id="Key_Points-2"></span>Key Points<span class="ez-toc-section-end"></span></h3><ul>
<li>Consistency Requirement: Equal objects must have the same hash code to ensure that hash-based collections (like HashMap and HashSet) function correctly.</li>
<li>Implementation: The hashCode method should use the same fields that are used in the equals method to ensure consistency.</li>
<li>Efficiency: While it is not required for unequal objects to have different hash codes, it is beneficial for the performance of hash-based collections.</li>
</ul>
<p>Violating this contract by allowing equal objects to have different hash codes can lead to unexpected behavior in collections like HashMap and HashSet, resulting in problems such as missing entries or increased lookup times.</p>
<h2 id="Active-recyle"><a href="#Active-recyle" class="headerlink" title="Active recyle"></a><span class="ez-toc-section" id="Active_recyle"></span>Active recyle<span class="ez-toc-section-end"></span></h2><p>After onDestroy() or recycling the bitmap, the active resource is put into memory cache.</p>
<p>ActiveResources.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">void</span> <span class="title function_">cleanupActiveReference</span><span class="params">(<span class="meta">@NonNull</span> ResourceWeakReference ref)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">      activeEngineResources.remove(ref.key);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!ref.isCacheable || ref.resource == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EngineResource&lt;?&gt; newResource =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">EngineResource</span>&lt;&gt;(</span><br><span class="line">            ref.resource,</span><br><span class="line">            <span class="comment">/* isMemoryCacheable= */</span> <span class="literal">true</span>,</span><br><span class="line">            <span class="comment">/* isRecyclable= */</span> <span class="literal">false</span>,</span><br><span class="line">            ref.key,</span><br><span class="line">            listener);</span><br><span class="line">    listener.onResourceReleased(ref.key, newResource); <span class="comment">// 这里存储进内存缓存</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">Engine.java</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResourceReleased</span><span class="params">(Key cacheKey, EngineResource&lt;?&gt; resource)</span> &#123;</span><br><span class="line">    activeResources.deactivate(cacheKey);</span><br><span class="line">    <span class="keyword">if</span> (resource.isMemoryCacheable()) &#123;</span><br><span class="line">      cache.put(cacheKey, resource);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      resourceRecycler.recycle(resource, <span class="comment">/* forceNextFrame= */</span> <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h1 id="LruCache"><a href="#LruCache" class="headerlink" title="LruCache"></a><span class="ez-toc-section" id="LruCache"></span>LruCache<span class="ez-toc-section-end"></span></h1><p><code>LruCache</code> stands for Least Recently Used Cache. It’s a cache mechanism that keeps track of the most recently used items and evicts the least recently used items when the cache reaches its maximum size. This helps in maintaining a balance between memory usage and access speed.</p>
<h3 id="How-Glide-Uses-LruCache"><a href="#How-Glide-Uses-LruCache" class="headerlink" title="How Glide Uses LruCache"></a><span class="ez-toc-section" id="How_Glide_Uses_LruCache"></span>How Glide Uses LruCache<span class="ez-toc-section-end"></span></h3><p>Glide uses <code>LruCache</code> to store decoded images (<code>Bitmap</code> objects) in memory. When an image is requested:</p>
<ol>
<li><strong>Check Cache</strong>: Glide first checks the memory cache for the image.</li>
<li><strong>Load from Cache</strong>: If the image is found in the cache, it is loaded from there, making the process very fast.</li>
<li><strong>Fetch and Decode</strong>: If the image is not in the cache, Glide fetches it from the source (e.g., network, disk), decodes it, and adds it to the cache.</li>
<li></li>
</ol>
<p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/Architecture/2021-08-09_4.4_lrucache.png"></p>
<p>LinkedHashMap参数含义</p>
<p>initialCapacity : 最大容量</p>
<p>loadFactor : 负载因子</p>
<p>accessOrder : 排序方式, true 按照访问顺序排序， false 按照插入顺序排序</p>
<p>访问顺序排序</p>
<p>accessOrder : true</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">LinkedHashMap&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;(<span class="number">0</span>, <span class="number">0.75f</span>, <span class="literal">true</span>);</span><br><span class="line">map.put(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;A&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;b&quot;</span>, <span class="string">&quot;B&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;c&quot;</span>, <span class="string">&quot;C&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;d&quot;</span>, <span class="string">&quot;D&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;e&quot;</span>, <span class="string">&quot;E&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;f&quot;</span>, <span class="string">&quot;F&quot;</span>);</span><br><span class="line"></span><br><span class="line">map.get(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;n&quot;</span>,<span class="string">&quot;N&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : map.entrySet()) &#123;</span><br><span class="line">    Log.d(<span class="string">&quot;LruCacheTest&quot;</span>, <span class="string">&quot;testLinkedHashMap : &quot;</span>+ entry.getKey()+<span class="string">&quot; : &quot;</span> + entry.getValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果</p>
<blockquote>
<p>D LruCacheTest: testLinkedHashMap : b : B<br>D LruCacheTest: testLinkedHashMap : c : C<br>D LruCacheTest: testLinkedHashMap : d : D<br>D LruCacheTest: testLinkedHashMap : e : E<br>D LruCacheTest: testLinkedHashMap : f : F<br>D LruCacheTest: testLinkedHashMap : a : A<br>D LruCacheTest: testLinkedHashMap : n : N</p>
</blockquote>
<p>可以看到 先访问a ,在插入n,把最新最近使用和访问的 A N,放到链表后面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LinkedHashMap&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;(<span class="number">100</span>, <span class="number">0.75f</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>D LruCacheTest: testLinkedHashMap : a : A<br>D LruCacheTest: testLinkedHashMap : b : B<br>D LruCacheTest: testLinkedHashMap : c : C<br>D LruCacheTest: testLinkedHashMap : d : D<br>D LruCacheTest: testLinkedHashMap : e : E<br>D LruCacheTest: testLinkedHashMap : f : F<br>D LruCacheTest: testLinkedHashMap : n : N</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/JakeWharton/DiskLruCache">https://github.com/JakeWharton/DiskLruCache</a></p>
<h1 id="Bitmap-Reuse"><a href="#Bitmap-Reuse" class="headerlink" title="Bitmap Reuse"></a><span class="ez-toc-section" id="Bitmap_Reuse"></span>Bitmap Reuse<span class="ez-toc-section-end"></span></h1><h2 id="botain-bitmap"><a href="#botain-bitmap" class="headerlink" title="botain bitmap"></a><span class="ez-toc-section" id="botain_bitmap"></span>botain bitmap<span class="ez-toc-section-end"></span></h2><div class="mermaid">
  sequenceDiagram
LruBitmapPool ->> LruBitmapPool : get()
LruBitmapPool ->> LruBitmapPool : getDirtyOrNull()
LruBitmapPool ->> SizeStrategy : strategy.get()
Note  right of SizeStrategy : possibleSize <= size * max_size_multiple(8) < div>


<p>LruBitmapPool</p>
<p>此步骤用于查找 entries 中最合适用来复用的 bitmap<br>先找到 sizes 中大于 size 且和 size 最接近的 key，如果 key 存在且其大小不超出 size 的四倍，则使用该 key，否则直接使用 size<br>即找到最接近 size 但又不超出 size 太多的 bitmap，否则如果拿来复用的 bitmap 太大的话也比较浪费</p>
<p>链接：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6956090846470995975">https://juejin.cn/post/6956090846470995975</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7133243966052368392">肢解Glide：LruBitmapPool如何具体操作Bitmap复用？ - 掘金</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">SizeStrategy</span> <span class="keyword">implements</span> <span class="title class_">LruPoolStrategy</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_SIZE_MULTIPLE</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Bitmap <span class="title function_">get</span><span class="params">(<span class="type">int</span> width, <span class="type">int</span> height, Bitmap.Config config)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> Util.getBitmapByteSize(width, height, config);</span><br><span class="line">    <span class="type">Key</span> <span class="variable">key</span> <span class="operator">=</span> keyPool.get(size);</span><br><span class="line"></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">possibleSize</span> <span class="operator">=</span> sortedSizes.ceilingKey(size);</span><br><span class="line">    <span class="keyword">if</span> (possibleSize != <span class="literal">null</span> &amp;&amp; possibleSize != size &amp;&amp; possibleSize &lt;= size * MAX_SIZE_MULTIPLE) &#123;</span><br><span class="line">      keyPool.offer(key);</span><br><span class="line">      key = keyPool.get(possibleSize);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="save-bitmap"><a href="#save-bitmap" class="headerlink" title="save bitmap"></a><span class="ez-toc-section" id="save_bitmap"></span>save bitmap<span class="ez-toc-section-end"></span></h2><div class="mermaid">
  sequenceDiagram
BitmapPool ->> LruBitmapPool : put(bitmap)
LruBitmapPool ->> SizeConfigStrategy : strategy.put(bitmap)
SizeConfigStrategy ->> KeyPool : get(size, bitmap.getConfig())
Note  over SizeConfigStrategy, KeyPool : groupedMap.put(key, bitmap);
</div>


<h3 id="bitmap-save-condition"><a href="#bitmap-save-condition" class="headerlink" title="bitmap save condition"></a><span class="ez-toc-section" id="bitmap_save_condition"></span>bitmap save condition<span class="ez-toc-section-end"></span></h3><ul>
<li>is mutable</li>
<li>less than maxSize</li>
<li>allowedConfigs</li>
</ul>
<p>LruBitmapPool.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(Bitmap bitmap)</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (!bitmap.isMutable()</span><br><span class="line">       || strategy.getSize(bitmap) &gt; maxSize</span><br><span class="line">       || !allowedConfigs.contains(bitmap.getConfig())) &#123;</span><br><span class="line">     bitmap.recycle();</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> strategy.getSize(bitmap);</span><br><span class="line">   strategy.put(bitmap);</span><br><span class="line">   tracker.add(bitmap);</span><br><span class="line"></span><br><span class="line">   puts++;</span><br><span class="line">   currentSize += size;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>SizeConfigStrategy.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Key</span> <span class="keyword">implements</span> <span class="title class_">Poolable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (o <span class="keyword">instanceof</span> Key) &#123;</span><br><span class="line">      <span class="type">Key</span> <span class="variable">other</span> <span class="operator">=</span> (Key) o;</span><br><span class="line">      <span class="keyword">return</span> size == other.size &amp;&amp; Util.bothNullOrEqual(config, other.config);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> size;</span><br><span class="line">    result = <span class="number">31</span> * result + (config != <span class="literal">null</span> ? config.hashCode() : <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The key is judged based on bitmap size and Config format.</p>
<h3 id="decoded-VS-without-decode"><a href="#decoded-VS-without-decode" class="headerlink" title="decoded VS without decode"></a><span class="ez-toc-section" id="decoded_VS_without_decode"></span>decoded VS without decode<span class="ez-toc-section-end"></span></h3><p>In the context of using the Glide library in Android for image loading, the terms “decoded cache” and “without decode” refer to different stages and aspects of the image loading process. Here’s a detailed explanation:</p>
<h4 id="Decoded-Cache"><a href="#Decoded-Cache" class="headerlink" title="Decoded Cache"></a><span class="ez-toc-section" id="Decoded_Cache"></span>Decoded Cache<span class="ez-toc-section-end"></span></h4><p><strong>Decoded Cache</strong> refers to the cache that stores images that have already been decoded into <code>Bitmap</code> objects. This means the images are stored in a format that can be directly used by the UI without needing further decoding. The benefits of using the decoded cache include:</p>
<ol>
<li><strong>Faster Loading:</strong> Since the images are already decoded, they can be quickly retrieved and displayed, reducing the load time and improving the user experience.</li>
<li><strong>Reduced CPU Usage:</strong> Decoding an image is a CPU-intensive process. By caching decoded images, you avoid repeatedly decoding the same image, which saves CPU resources.</li>
<li><strong>Efficient Memory Usage:</strong> Decoded images are stored in memory, which allows for quick access, but this also means that the memory usage can be higher, especially if you are caching many large images.</li>
</ol>
<h4 id="Without-Decode-Encoded-Cache"><a href="#Without-Decode-Encoded-Cache" class="headerlink" title="Without Decode (Encoded Cache)"></a><span class="ez-toc-section" id="Without_Decode_Encoded_Cache"></span>Without Decode (Encoded Cache)<span class="ez-toc-section-end"></span></h4><p><strong>Without Decode</strong> or <strong>Encoded Cache</strong> refers to the cache that stores the raw, compressed image files (such as JPEG, PNG, or WebP) without decoding them into <code>Bitmap</code> objects. This cache stores the images in their original, encoded format. The benefits of using the encoded cache include:</p>
<h1 id="BUILD-PROJECT"><a href="#BUILD-PROJECT" class="headerlink" title="BUILD PROJECT"></a><span class="ez-toc-section" id="BUILD_PROJECT"></span>BUILD PROJECT<span class="ez-toc-section-end"></span></h1><p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/Retrofit/20240618162126.jpg"></p>
<p>监控大图<br><a target="_blank" rel="noopener" href="https://juejin.im/post/6844904136266219534">https://juejin.im/post/6844904136266219534</a></p>
<p><a target="_blank" rel="noopener" href="https://bumptech.github.io/glide/">https://bumptech.github.io/glide/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/xfhy/Android-Notes/blob/master/Blogs/Android/%E4%B8%89%E6%96%B9%E5%BA%93%E5%8E%9F%E7%90%86/Glide%E4%B8%BB%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.md">https://github.com/xfhy/Android-Notes/blob/master/Blogs/Android/%E4%B8%89%E6%96%B9%E5%BA%93%E5%8E%9F%E7%90%86/Glide%E4%B8%BB%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.md</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/pAazRD9NaLPvBseG51ZOLw">https://mp.weixin.qq.com/s/pAazRD9NaLPvBseG51ZOLw</a></p>
</=></div></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-06-07T03:40:36.000Z" title="6/7/2024, 11:40:36 AM">2024-06-07</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-13T21:02:22.000Z" title="9/14/2024, 5:02:22 AM">2024-09-14</time></span><span class="level-item"> Jon </span><span class="level-item"><a class="link-muted" href="/categories/Library/">Library</a></span><span class="level-item">3 minutes read (About 511 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/06/07/gson/">GSON</a></p><div class="content"><div class="ez-toc-v2_0_66_1 ez-toc-wrap-right counter-hierarchy ez-toc-counter ez-toc-grey ez-toc-container-direction" id="ez-toc-container"><div class="ez-toc-title-container">Table of Contents

<p><span class="ez-toc-title-toggle"><a href="#"><span class="ez-toc-js-icon-con"><span class><span class="eztoc-hide" style="display:none;">Toggle</span><span class="ez-toc-icon-toggle-span"><svg class="list-377408" fill="none" height="20px" style="fill: #999;color:#999" viewbox="0 0 24 24" width="20px" xmlns="http://www.w3.org/2000/svg"><path d="M6 6H4v2h2V6zm14 0H8v2h12V6zM4 11h2v2H4v-2zm16 0H8v2h12v-2zM4 16h2v2H4v-2zm16 0H8v2h12v-2z" fill="currentColor"/></svg><svg baseprofile="tiny" class="arrow-unsorted-368013" height="10px" style="fill: #999;color:#999" version="1.2" viewbox="0 0 24 24" width="10px" xmlns="http://www.w3.org/2000/svg"><path d="M18.2 9.3l-6.2-6.3-6.2 6.3c-.2.2-.3.4-.3.7s.1.5.3.7c.2.2.4.3.7.3h11c.3 0 .5-.1.7-.3.2-.2.3-.5.3-.7s-.1-.5-.3-.7zM5.8 14.7l6.2 6.3 6.2-6.3c.2-.2.3-.5.3-.7s-.1-.5-.3-.7c-.2-.2-.4-.3-.7-.3h-11c-.3 0-.5.1-.7.3-.2.2-.3.5-.3.7s.1.5.3.7z"/></svg></span></span></span></a></span></p></div><nav>- <a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/07/gson/#Running_Gson_source_Codew" title="Running Gson source Codew">Running Gson source Codew</a><p></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/07/gson/#GsonTypes%E7%90%86%E8%A7%A3" title="$Gson$Types理解">$Gson$Types理解</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/07/gson/#Gson%E8%BD%ACmap" title="Gson转map">Gson转map</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/06/07/gson/#java_parse" title="java parse">java parse</a></li>
</ul>
</nav></div># <span class="ez-toc-section" id="Running_Gson_source_Codew"></span>Running Gson source Codew<span class="ez-toc-section-end"></span>

<p>注释</p>
<p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/gson/20240608090817.jpg"></p>
<p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/gson/20240608091843.jpg"></p>
<p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/gson/20240608091832.jpg"></p>
<p>给GitHub PR</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1JJ41197UK?spm_id_from=333.337.search-card.all.click">https://www.bilibili.com/video/BV1JJ41197UK?spm_id_from&#x3D;333.337.search-card.all.click</a></p>
<p>json格式</p>
<p>数组 [1,2,3]</p>
<p>对象格式 {“key”:”value”}</p>
<h2 id="Gson-Types理解"><a href="#Gson-Types理解" class="headerlink" title="$Gson$Types理解"></a><span class="ez-toc-section" id="GsonTypes%E7%90%86%E8%A7%A3"></span>$Gson$Types理解<span class="ez-toc-section-end"></span></h2><p>官方教程 <a target="_blank" rel="noopener" href="https://github.com/google/gson/blob/master/UserGuide.md" title="官方教程">https://github.com/google/gson/blob/master/UserGuide.md</a></p>
<p>源码分析<br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/89c314ae8c0b">http://www.jianshu.com/p/89c314ae8c0b</a></p>
<h2 id="Gson转map"><a href="#Gson转map" class="headerlink" title="Gson转map"></a><span class="ez-toc-section" id="Gson%E8%BD%ACmap"></span>Gson转map<span class="ez-toc-section-end"></span></h2><p>Gson可以直接把json转为map,但是在转成map时，默认將int long型的数字,转换成doublel类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">sms</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;Code\&quot;:200,\&quot;Data\&quot;:&#123;\&quot;Code\&quot;:\&quot;\&quot;&#125;,\&quot;Message\&quot;:\&quot;发送成功\&quot;&#125;&quot;</span>;</span><br><span class="line">Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">Gson</span>().fromJson(sms, HashMap.class);</span><br></pre></td></tr></table></figure>

<p>这里装成map后，Code值尾 200.0 ,解析方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Gson gson = new GsonBuilder()</span><br><span class="line">          .registerTypeAdapter(new TypeToken&lt;TreeMap&lt;String, Object&gt;&gt;() &#123;</span><br><span class="line">          &#125;.getType(), new JsonDeserializer&lt;TreeMap&lt;String, Object&gt;&gt;() &#123;</span><br><span class="line"></span><br><span class="line">              @Override</span><br><span class="line">              public TreeMap&lt;String, Object&gt; deserialize(JsonElement json, Type typeOfT, JsonDeserializationContext context) throws JsonParseException &#123;</span><br><span class="line">                  TreeMap&lt;String, Object&gt; treeMap = new TreeMap&lt;&gt;();</span><br><span class="line">                  JsonObject jsonObject = json.getAsJsonObject();</span><br><span class="line">                  Set&lt;Map.Entry&lt;String, JsonElement&gt;&gt; entrySet = jsonObject.entrySet();</span><br><span class="line">                  for (Map.Entry&lt;String, JsonElement&gt; entry : entrySet) &#123;</span><br><span class="line">                      treeMap.put(entry.getKey(), entry.getValue());</span><br><span class="line">                  &#125;</span><br><span class="line">                  return treeMap;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;).create();</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://blog.csdn.net/liangrui_cust/article/details/51197974">参考</a></p>
<ul>
<li><p>map to json(生成json数据)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;string object=&quot;&quot;&gt; map = new HashMap&lt;&gt;();</span><br><span class="line">map.put(&quot;key&quot;, &quot;real_name&quot;);</span><br><span class="line">map.put(&quot;value&quot;, userName);</span><br><span class="line">list.add(map);</span><br><span class="line">map = new HashMap&lt;&gt;();</span><br><span class="line">map.put(&quot;key&quot;, &quot;mobile_phone&quot;);</span><br><span class="line">map.put(&quot;value&quot;, userPhone);</span><br><span class="line">map.put(&quot;hidden&quot;, false);</span><br><span class="line">list.add(map);</span><br><span class="line">userInfo.data = new Gson().toJson(list);&lt;/string&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>kotlin json to object</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">val type = object : TypeToken&lt;BaseCount&lt;List&lt;Site&gt;&gt;&gt;() &#123;&#125;.type</span><br><span class="line">var response = gson.fromJson&lt;BaseCount&lt;List&lt;Site&gt;&gt;&gt;(json, type)</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://ask.helplib.com/java/post_498433">https://ask.helplib.com/java/post_498433</a></p>
<h2 id="java-parse"><a href="#java-parse" class="headerlink" title="java parse"></a><span class="ez-toc-section" id="java_parse"></span>java parse<span class="ez-toc-section-end"></span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"> public static List&lt;RecipeBean&gt; analysisChild(String receps) throws JSONException &#123;</span><br><span class="line">        List&lt;RecipeBean&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line">//        JSONObject jsonObject = new JSONObject();</span><br><span class="line">        JSONArray jsonArray = new JSONArray(receps);</span><br><span class="line">        for (int i = 0; i &lt; jsonArray.length(); i++) &#123;</span><br><span class="line">            JSONObject object = jsonArray.getJSONObject(i);</span><br><span class="line">            RecipeBean mPatient = new RecipeBean(TYPE_ITEM);</span><br><span class="line">            if (object.has(&quot;drug_name&quot;))&#123;</span><br><span class="line">                mPatient.setDrug_name(object.getString(&quot;drug_name&quot;));</span><br><span class="line">            &#125;</span><br><span class="line">            if (object.has(&quot;drug_num&quot;))&#123;</span><br><span class="line">               mPatient.setDrug_num(object.getString(&quot;drug_num&quot;));</span><br><span class="line">            &#125;</span><br><span class="line">            if (object.has(&quot;frequency&quot;))&#123;</span><br><span class="line">             mPatient.setFrequency(object.getString(&quot;frequency&quot;));</span><br><span class="line">            &#125;</span><br><span class="line">            if (object.has(&quot;num&quot;))&#123;</span><br><span class="line">               mPatient.setNum(object.getString(&quot;num&quot;));</span><br><span class="line">            &#125;</span><br><span class="line">            if (object.has(&quot;drug_num&quot;))&#123;</span><br><span class="line">               mPatient.setDrug_num(object.getString(&quot;drug_num&quot;));</span><br><span class="line">            &#125;</span><br><span class="line">            if (object.has(&quot;pharmacy_type&quot;))&#123;</span><br><span class="line">               mPatient.setPharmacy_type(object.getString(&quot;pharmacy_type&quot;));</span><br><span class="line">            &#125;</span><br><span class="line">            if (object.has(&quot;medicine_num&quot;))&#123;</span><br><span class="line">             mPatient.setMedicine_num(object.getString(&quot;medicine_num&quot;));</span><br><span class="line">            &#125;</span><br><span class="line">            if (object.has(&quot;medicine_unit&quot;))&#123;</span><br><span class="line">              mPatient.setMedicine_unit(object.getString(&quot;medicine_unit&quot;));</span><br><span class="line">            &#125;</span><br><span class="line">            list.add(mPatient);</span><br><span class="line">        &#125;</span><br><span class="line">        return list;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-05-14T02:01:38.000Z" title="5/14/2024, 10:01:38 AM">2024-05-14</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-13T21:02:22.000Z" title="9/14/2024, 5:02:22 AM">2024-09-14</time></span><span class="level-item"> Jon </span><span class="level-item"><a class="link-muted" href="/categories/Library/">Library</a></span><span class="level-item">26 minutes read (About 3871 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/05/14/retrofit/">Retrofit</a></p><div class="content"><div class="ez-toc-v2_0_66_1 ez-toc-wrap-right counter-hierarchy ez-toc-counter ez-toc-grey ez-toc-container-direction" id="ez-toc-container"><div class="ez-toc-title-container">Table of Contents

<p><span class="ez-toc-title-toggle"><a href="#"><span class="ez-toc-js-icon-con"><span class><span class="eztoc-hide" style="display:none;">Toggle</span><span class="ez-toc-icon-toggle-span"><svg class="list-377408" fill="none" height="20px" style="fill: #999;color:#999" viewbox="0 0 24 24" width="20px" xmlns="http://www.w3.org/2000/svg"><path d="M6 6H4v2h2V6zm14 0H8v2h12V6zM4 11h2v2H4v-2zm16 0H8v2h12v-2zM4 16h2v2H4v-2zm16 0H8v2h12v-2z" fill="currentColor"/></svg><svg baseprofile="tiny" class="arrow-unsorted-368013" height="10px" style="fill: #999;color:#999" version="1.2" viewbox="0 0 24 24" width="10px" xmlns="http://www.w3.org/2000/svg"><path d="M18.2 9.3l-6.2-6.3-6.2 6.3c-.2.2-.3.4-.3.7s.1.5.3.7c.2.2.4.3.7.3h11c.3 0 .5-.1.7-.3.2-.2.3-.5.3-.7s-.1-.5-.3-.7zM5.8 14.7l6.2 6.3 6.2-6.3c.2-.2.3-.5.3-.7s-.1-.5-.3-.7c-.2-.2-.4-.3-.7-.3h-11c-.3 0-.5.1-.7.3-.2.2-.3.5-.3.7s.1.5.3.7z"/></svg></span></span></span></a></span></p></div><nav>- <a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#Retofit%E8%B0%83%E7%94%A8%E5%85%B3%E7%B3%BB" title="Retofit调用关系">Retofit调用关系</a><p></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#illustrating_interceptor_request_flow" title="illustrating  interceptor request flow">illustrating interceptor request flow</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#Retrofit_VS_Okhttp" title="Retrofit VS  Okhttp">Retrofit VS Okhttp</a><ul>
<li><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#Ease_of_Use" title="Ease of Use:">Ease of Use:</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#Automatic_JSON_Parsing" title="Automatic JSON Parsing:">Automatic JSON Parsing:</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#Annotations" title="Annotations:">Annotations:</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#Interceptors_and_Customization" title="Interceptors and Customization:">Interceptors and Customization:</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#Error_Handling" title="Error Handling:">Error Handling:</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#Scalability" title="Scalability:">Scalability:</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#Retrofit%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%EF%BC%8C%E5%9C%A8okhttp%E7%9A%84%E5%9F%BA%E7%A1%80%E4%B8%8B%E5%81%9A%E4%BA%86%E5%93%AA%E4%BA%9B%E5%B0%81%E8%A3%85" title="Retrofit底层实现，在okhttp的基础下做了哪些封装">Retrofit底层实现，在okhttp的基础下做了哪些封装</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#Retrofit%E4%B8%AD%E7%9A%84Call%E5%AF%B9%E8%B1%A1%E5%A6%82%E4%BD%95%E8%BD%AC%E6%8D%A2%E6%88%90okhttp%E7%9A%84call%E5%AF%B9%E8%B1%A1" title="Retrofit中的Call对象如何转换成okhttp的call对象">Retrofit中的Call对象如何转换成okhttp的call对象</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#%E5%9C%A8retrofit%E4%B8%AD%E7%9A%84%E6%B3%9B%E5%9E%8B%E6%98%AF%E6%80%8E%E4%B9%88%E8%A7%A3%E6%9E%90%E7%9A%84" title="在retrofit中的泛型是怎么解析的?">在retrofit中的泛型是怎么解析的?</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#%E4%B8%BA%E4%BB%80%E4%B9%88retrofit%E8%A6%81%E4%BD%BF%E7%94%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E6%B3%A8%E8%A7%A3%EF%BC%9F%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E7%94%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E6%B3%A8%E8%A7%A3%EF%BC%9F" title="为什么retrofit要使用运行时注解？什么时候用运行时注解？">为什么retrofit要使用运行时注解？什么时候用运行时注解？</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#DESIGN_PATTERN" title="DESIGN PATTERN">DESIGN PATTERN</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#static_method_factory" title="static method factory">static method factory</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#Abstract_Factory_method" title="Abstract Factory method">Abstract Factory method</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#Adater_design" title="Adater design">Adater design</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#%E5%A4%96%E8%A7%82%E6%A8%A1%E5%BC%8F" title="外观模式">外观模式</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F" title="策略模式">策略模式</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#Retrofit_Rxjava" title="Retrofit Rxjava">Retrofit Rxjava</a><ul>
<li><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#Retrofit%E5%8C%85%E8%A3%85%E7%B1%BB" title="Retrofit包装类">Retrofit包装类</a></li>
</ul>
</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#Retrofit%E6%98%AF%E5%A6%82%E4%BD%95%E5%B0%86%E5%AD%90%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2%E5%88%B0%E4%B8%BB%E7%BA%BF%E7%A8%8B%EF%BC%9F" title="Retrofit是如何将子线程切换到主线程？">Retrofit是如何将子线程切换到主线程？</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#UML" title="UML">UML</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#implementation" title="implementation">implementation</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#Retrofit_%E6%B3%A8%E8%A7%A3%E6%98%AF%E6%80%8E%E4%B9%88%E6%B6%88%E8%B4%B9%E7%9A%84" title="Retrofit 注解是怎么消费的">Retrofit 注解是怎么消费的</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/14/retrofit/#Build_Project" title="Build Project">Build Project</a></li>
</ul>
</nav></div># <span class="ez-toc-section" id="Retofit%E8%B0%83%E7%94%A8%E5%85%B3%E7%B3%BB"></span>Retofit调用关系<span class="ez-toc-section-end"></span>

<p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/Retrofit/5d1ba3a67f83cdc0a03694e431bee4cda35c51a7.png"></p>
<p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/Retrofit/f2f4fc41e9bde83f0f4ff0f6661a3a3de8a8deed.png"></p>
<h1 id="illustrating-interceptor-request-flow"><a href="#illustrating-interceptor-request-flow" class="headerlink" title="illustrating interceptor request flow"></a><span class="ez-toc-section" id="illustrating_interceptor_request_flow"></span>illustrating interceptor request flow<span class="ez-toc-section-end"></span></h1><p>调用整体流程</p>
<div class="mermaid">
  sequenceDiagram
autonumber

participant SimpleService as Retrofit
participant ProxyClass as BinInterface$0
participant InvocationHandler 
participant ExecutorCallbackCall as RetrofitCall

SimpleService ->> ProxyClass : retrofit.create(IGitHub.class)
ProxyClass ->> InvocationHandler : github.contributors

InvocationHandler ->> ExecutorCallbackCall : h.invoke(this, m3, new Object[]{var1})
Note over InvocationHandler, ExecutorCallbackCall: it invoke in proxyclass <br>  loadServiceMethod(service, method).invoke(proxy, args) 

ExecutorCallbackCall ->> OkHttpCall : retrofit2::call.execute()
OkHttpCall  ->> OkHttpCall : createRaw Okhttp Call
OkHttpCall ->> RealCall : Okhttp Call.execute()
RealCall ->> RealCall: getResponseWithInterceptorChain
Note over RealCall : RetryAndFollowUpInterceptor <br> BridgeInterceptor <br> CacheInterceptor <br> CallServerInterceptor
RealCall -->> OkHttpCall : parseResponse
OkHttpCall -->> SimpleService :  Response Entity
</div>


<ol>
<li>动态代理创建一个接口的代理类,为代理类注入一个回调。</li>
<li>The step cannot check out the source code because it is generated by ProxyGenerator. Invoke the contributors method of the proxy class.</li>
<li>The InvocationHandler parameter, h, is passed in step 1. The object is constructed with var1.newInstance(var2).</li>
<li>In step 3, create an ExecutorCallbackCall object last so that it can invoke retrofit2::execute().</li>
<li>通过反射解析每个接口的注解、入参构造http请求获取到返回的http请求，使用Adapter解析成需要的返回值。</li>
</ol>
<p>  Retrofit 交付请求给OkHttp主要是，OkHttpCall中处理, 组装数据后，请求方式就是OkHttp官方提供的方式了。<br>  请求的body是在这里处理的</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">okhttp3.Request <span class="title function_">create</span><span class="params">(<span class="meta">@Nullable</span> Object instance, Object[] args)</span>  &#123;</span><br><span class="line">handlers[p].apply(requestBuilder, args[p]);</span><br><span class="line"><span class="keyword">return</span> requestBuilder</span><br><span class="line">    .get() <span class="comment">// 组装body和请求</span></span><br><span class="line">      .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Retrofit-VS-Okhttp"><a href="#Retrofit-VS-Okhttp" class="headerlink" title="Retrofit VS Okhttp"></a><span class="ez-toc-section" id="Retrofit_VS_Okhttp"></span>Retrofit VS Okhttp<span class="ez-toc-section-end"></span></h1><h3 id="Ease-of-Use"><a href="#Ease-of-Use" class="headerlink" title="Ease of Use:"></a><span class="ez-toc-section" id="Ease_of_Use"></span>Ease of Use:<span class="ez-toc-section-end"></span></h3><ul>
<li>Retrofit:<br>Provides a high-level API that simplifies the creation and execution of network requests. You define API endpoints using Java interfaces, and Retrofit generates the necessary code to handle these requests.</li>
<li>OkHttp:<br>While powerful, requires more boilerplate code to set up and execute requests. You need to manually construct HTTP requests, handle responses, and parse the results.</li>
</ul>
<h3 id="Automatic-JSON-Parsing"><a href="#Automatic-JSON-Parsing" class="headerlink" title="Automatic JSON Parsing:"></a><span class="ez-toc-section" id="Automatic_JSON_Parsing"></span>Automatic JSON Parsing:<span class="ez-toc-section-end"></span></h3><ul>
<li>Retrofit:<br>Integrates seamlessly with JSON libraries like Gson or Moshi to automatically convert JSON responses into Java objects. This reduces the need for manual parsing and makes the code cleaner and easier to maintain.</li>
<li>OkHttp:<br>Does not include built-in support for JSON parsing, so you need to manually parse JSON responses using a separate library.</li>
</ul>
<h3 id="Annotations"><a href="#Annotations" class="headerlink" title="Annotations:"></a><span class="ez-toc-section" id="Annotations"></span>Annotations:<span class="ez-toc-section-end"></span></h3><ul>
<li>Retrofit:<br>Uses annotations to define request parameters, headers, and endpoints. This makes the code more readable and easier to understand.</li>
<li>OkHttp:<br>Requires manual handling of these aspects, leading to more verbose and error-prone code.</li>
</ul>
<h3 id="Interceptors-and-Customization"><a href="#Interceptors-and-Customization" class="headerlink" title="Interceptors and Customization:"></a><span class="ez-toc-section" id="Interceptors_and_Customization"></span>Interceptors and Customization:<span class="ez-toc-section-end"></span></h3><ul>
<li>Retrofit:<br>Allows for easy integration of OkHttp interceptors to handle logging, authentication, and other concerns. Retrofit itself focuses on simplifying API interactions while allowing OkHttp to handle lower-level HTTP operations.</li>
<li>OkHttp:<br>You can also use interceptors and customize requests, but it requires more effort compared to Retrofit.</li>
</ul>
<h3 id="Error-Handling"><a href="#Error-Handling" class="headerlink" title="Error Handling:"></a><span class="ez-toc-section" id="Error_Handling"></span>Error Handling:<span class="ez-toc-section-end"></span></h3><ul>
<li>Retrofit:<br>Provides built-in support for error handling, including deserialization of error responses and easier differentiation between HTTP error codes.</li>
<li>OkHttp:<br>Requires manual implementation of error handling, which can be more complex and less consistent.</li>
</ul>
<h3 id="Scalability"><a href="#Scalability" class="headerlink" title="Scalability:"></a><span class="ez-toc-section" id="Scalability"></span>Scalability:<span class="ez-toc-section-end"></span></h3><ul>
<li>Retrofit:<br>Ideal for larger projects with multiple API endpoints. The use of interfaces and annotations makes it easier to manage and scale the codebase.</li>
<li>OkHttp:<br>Better suited for simpler or lower-level network tasks where fine-grained control over the HTTP layer is required.</li>
</ul>
<ol>
<li>用户网络请求的借口配置 繁琐， 尤其是需要配置复杂的请求body,请求头，参数的时候。</li>
<li>数据解析过程需要用户手动拿到respponsbody进行解析，不能复用。</li>
<li>无法适配自动进行线程的切换。</li>
</ol>
<h1 id="Retrofit底层实现，在okhttp的基础下做了哪些封装"><a href="#Retrofit底层实现，在okhttp的基础下做了哪些封装" class="headerlink" title="Retrofit底层实现，在okhttp的基础下做了哪些封装"></a><span class="ez-toc-section" id="Retrofit%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%EF%BC%8C%E5%9C%A8okhttp%E7%9A%84%E5%9F%BA%E7%A1%80%E4%B8%8B%E5%81%9A%E4%BA%86%E5%93%AA%E4%BA%9B%E5%B0%81%E8%A3%85"></span>Retrofit底层实现，在okhttp的基础下做了哪些封装<span class="ez-toc-section-end"></span></h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Retrofit在OkHttp的基础上进行了多个层次的封装，主要集中在简化网络请求的创建、执行和响应处理。以下是Retrofit在OkHttp基础上所做的主要封装：</span><br></pre></td></tr></table></figure>

<ul>
<li><p>接口定义和注解：<br>Retrofit允许开发者使用Java接口来定义网络请求。每个接口方法对应一个API端点，并通过注解（如@GET、@POST、@Path、@Query等）来描述请求的类型、路径和参数。<br>这些注解让代码更简洁、易读，避免了手动构建请求所需的冗长代码。</p>
</li>
<li><p>动态代理：<br>Retrofit使用Java的动态代理机制（Proxy类）在运行时生成接口实现。这些实现会将方法调用转换为HTTP请求。<br>通过动态代理，Retrofit能够在开发者调用接口方法时，自动创建并执行相应的OkHttp请求。</p>
</li>
<li><p>请求和响应转换：<br>Retrofit提供了Converter接口，用于将请求体转换为HTTP请求的有效负载（如JSON）以及将HTTP响应转换为Java对象。<br>常见的Converter包括GsonConverter、MoshiConverter和JacksonConverter，方便开发者使用各种JSON库来解析响应。</p>
</li>
<li><p>异步和同步请求：<br>Retrofit支持同步和异步请求。开发者可以选择返回Call<t>对象，并使用enqueue方法进行异步请 求，或者使用execute方法进行同步请求。这种灵活性使得网络请求的处理方式更加丰富和适应不同的需求场景.</t></p>
</li>
<li><p>错误处理:<br>Retrofit内置了对HTTP错误的处理机制，能够方便地捕获和处理HTTP错误状态码和网络异常。<br>开发者可以通过自定义Callback或者配合使用Call对象的Response类，方便地进行错误处理和重试逻辑。</p>
</li>
<li><p>拦截器：<br>虽然OkHttp本身也支持拦截器，Retrofit对其进行了更友好的集成。开发者可以轻松地将OkHttp的拦截器（如日志记录、认证拦截器）添加到Retrofit的配置中。<br>这使得调试和网络请求的管理更加方便。</p>
</li>
<li><p>URL管理：</p>
<p>Retrofit支持在接口方法上通过注解来灵活配置URL参数，路径变量和查询参数。这使得构建复杂的URL变得更加简单和直观。<br>通过注解和参数替换，Retrofit能够动态地生成完整的请求URL。<br>内置协程支持（在Kotlin中）：</p>
</li>
</ul>
<p>对于使用Kotlin的项目，Retrofit提供了对协程的支持，使得网络请求可以以挂起函数的形式实现，简化了异步代码的编写。<br>通过这些封装，Retrofit将OkHttp强大的低级网络功能与高层的API定义和处理结合起来，使得开发者能够更加专注于业务逻辑，而不需要过多关心底层的网络请求细节。</p>
<h1 id="Retrofit中的Call对象如何转换成okhttp的call对象"><a href="#Retrofit中的Call对象如何转换成okhttp的call对象" class="headerlink" title="Retrofit中的Call对象如何转换成okhttp的call对象"></a><span class="ez-toc-section" id="Retrofit%E4%B8%AD%E7%9A%84Call%E5%AF%B9%E8%B1%A1%E5%A6%82%E4%BD%95%E8%BD%AC%E6%8D%A2%E6%88%90okhttp%E7%9A%84call%E5%AF%B9%E8%B1%A1"></span>Retrofit中的Call对象如何转换成okhttp的call对象<span class="ez-toc-section-end"></span></h1><p>Retrofit中有一个OkHttpCall类，它实现了Call接口，并封装了OkHttp的Call对象。创建OkHttp Request对象：</p>
<p>在OkHttpCall类中，createRawCall方法会调用OkHttp的Call.Factory来创建一个新的OkHttp Call对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> okhttp3.Call <span class="title function_">createRawCall</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> serviceMethod.toRequest(args);</span><br><span class="line">    <span class="keyword">return</span> serviceMethod.callFactory.newCall(request);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="在retrofit中的泛型是怎么解析的"><a href="#在retrofit中的泛型是怎么解析的" class="headerlink" title="在retrofit中的泛型是怎么解析的?"></a><span class="ez-toc-section" id="%E5%9C%A8retrofit%E4%B8%AD%E7%9A%84%E6%B3%9B%E5%9E%8B%E6%98%AF%E6%80%8E%E4%B9%88%E8%A7%A3%E6%9E%90%E7%9A%84"></span>在retrofit中的泛型是怎么解析的?<span class="ez-toc-section-end"></span></h1><h1 id="为什么retrofit要使用运行时注解？什么时候用运行时注解？"><a href="#为什么retrofit要使用运行时注解？什么时候用运行时注解？" class="headerlink" title="为什么retrofit要使用运行时注解？什么时候用运行时注解？"></a><span class="ez-toc-section" id="%E4%B8%BA%E4%BB%80%E4%B9%88retrofit%E8%A6%81%E4%BD%BF%E7%94%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E6%B3%A8%E8%A7%A3%EF%BC%9F%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E7%94%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E6%B3%A8%E8%A7%A3%EF%BC%9F"></span>为什么retrofit要使用运行时注解？什么时候用运行时注解？<span class="ez-toc-section-end"></span></h1><p>Retrofit使用运行时注解的原因在于其灵活性和动态特性，这使得Retrofit能够在运行时解析接口方法的注解和参数，并根据这些信息动态地构建HTTP请求。下面是Retrofit使用运行时注解的具体原因以及适用场景：</p>
<ol>
<li>灵活的请求配置<br>  运行时注解允许开发者在接口方法上灵活地配置HTTP请求。例如，可以通过注解指定HTTP方法、URL路径、查询参数、请求头等。这种方式 比硬编码请求配置更加灵活和可维护。</li>
</ol>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ApiService</span> &#123;</span><br><span class="line"><span class="meta">@GET(&quot;users/&#123;user&#125;/repos&quot;)</span></span><br><span class="line">Call&lt;list&gt;&gt; listRepos(<span class="meta">@Path(&quot;user&quot;)</span> String user);</span><br><span class="line">&#125;&lt;/list&gt;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>动态解析和生成请求<br>  使用运行时注解，Retrofit可以在运行时解析接口方法的注解，生成相应的请求对象。这个过程包括解析HTTP方法、URL、请求参数等信息， 并动态构建请求。这种动态生成请求的方式相比于编译时生成请求代码，更加灵活且易于修改。</li>
<li>适应多变的API<br>  许多网络API会频繁变化，使用运行时注解可以更容易地适应这些变化。因为注解的解析和请求的生成是在运行时进行的，所以在代码中修改 注解即可应对API的变化，而不需要重新编译代码。</li>
</ol>
<h1 id="DESIGN-PATTERN"><a href="#DESIGN-PATTERN" class="headerlink" title="DESIGN PATTERN"></a><span class="ez-toc-section" id="DESIGN_PATTERN"></span>DESIGN PATTERN<span class="ez-toc-section-end"></span></h1><h2 id="static-method-factory"><a href="#static-method-factory" class="headerlink" title="static method factory"></a><span class="ez-toc-section" id="static_method_factory"></span>static method factory<span class="ez-toc-section-end"></span></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Platform <span class="title function_">findPlatform</span><span class="params">()</span> &#123;</span><br><span class="line"> <span class="keyword">if</span> (isAndroid()) &#123;</span><br><span class="line">   <span class="keyword">return</span> findAndroidPlatform();</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> findJvmPlatform();</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Abstract-Factory-method"><a href="#Abstract-Factory-method" class="headerlink" title="Abstract Factory method"></a><span class="ez-toc-section" id="Abstract_Factory_method"></span>Abstract Factory method<span class="ez-toc-section-end"></span></h2><p>Retrofit deserializes data using the abstract factory method</p>
<p><img src="https://refactoring.guru/images/patterns/diagrams/abstract-factory/structure.png"></p>
<div class="mermaid">
  classDiagram

  class Factory {
    +requestBodyConverter(): RequestBody
    +responseBodyConverter(): ResponseBody
  }

  class GsonConverterFactory {
    +requestBodyConverter(): GsonRequestBodyConverter
    +responseBodyConverter(): GsonResponseBodyConverter
  }

  class Converter {
    +convert(): T
  }

  class MoshiConverterFactory {
    +requestBodyConverter(): MoshiRequestBodyConverter
    +responseBodyConverter(): MoshiResponseBodyConverter
  }

  class RequestBody {
    +operationA(): void
  }

  class ResponseBody {
    +operationA(): void
  }

  class AbstractProductB {
    +operationB(): void
  }

  class ConcreteProductB1 {
    +operationB(): void
  }

  class ConcreteProductB2 {
    +operationB(): void
  }

  Factory <|-- gsonconverterfactory factory <|-- moshiconverterfactory converter <|..requestbody <|..responsebody *.. requestbody responsebody < div>


<p>invoke steps</p>
<ol>
<li>Retrofit , pass converterFactories &#96;&#96;&#96;java<br>  public Retrofit build() {<br> return new Retrofit(<br>   callFactory,<br>   baseUrl,<br>   unmodifiableList(converterFactories),<br>   defaultConverterFactoriesSize,<br>   unmodifiableList(callAdapterFactories),<br>   defaultCallAdapterFactories.size(),<br>   callbackExecutor,<br>   validateEagerly);<br>  }<br>  }  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">2. execute flow</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">call.execute();</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public Response&lt;t&gt; execute() throws IOException &#123;</span><br><span class="line">    return parseResponse(call.execute());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Response&lt;t&gt; parseResponse(okhttp3.Response rawResponse) throws IOException &#123;</span><br><span class="line">      ExceptionCatchingResponseBody catchingBody = new ExceptionCatchingResponseBody(rawBody);</span><br><span class="line">      T body = responseConverter.convert(catchingBody);</span><br><span class="line"></span><br><span class="line">      return Response.success(body, rawResponse);</span><br><span class="line">  &#125;&lt;/t&gt;&lt;/t&gt;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>CallAdapter.Factory is also an abstract factory method in the Retrofit library.</p>
<h2 id="Adater-design"><a href="#Adater-design" class="headerlink" title="Adater design"></a><span class="ez-toc-section" id="Adater_design"></span>Adater design<span class="ez-toc-section-end"></span></h2><p>In the Adapter design pattern, there are two types: Class Adapter and Object Adapter . 但是在Retrofit中，adater使用和上面两种模式，有点差别.</p>
<p>Call.java 对应 Adaptee</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Call</span>&lt;t&gt; <span class="keyword">extends</span> <span class="title class_">Cloneable</span> &#123; </span><br><span class="line"></span><br><span class="line">  Response&lt;t&gt; <span class="title function_">execute</span><span class="params">()</span> <span class="keyword">throws</span> IOException;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">enqueue</span><span class="params">(Callback&lt;t&gt; callback)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span>;</span><br><span class="line">  Request <span class="title function_">request</span><span class="params">()</span>;</span><br><span class="line">&#125;&lt;/t&gt;&lt;/t&gt;&lt;/t&gt;</span><br></pre></td></tr></table></figure>

<p>CallAdapter.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CallAdapter</span>&lt;r t=<span class="string">&quot;&quot;</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">  Type <span class="title function_">responseType</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">  T <span class="title function_">adapt</span><span class="params">(Call&lt;r&gt; call)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Factory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="meta">@Nullable</span> CallAdapter, ?&gt; get(</span><br><span class="line">        Type returnType, Annotation[] annotations, Retrofit retrofit);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  DefaultCallAdapterFactory.java</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">DefaultCallAdapterFactory</span> <span class="keyword">extends</span> <span class="title class_">CallAdapter</span>.Factory &#123;</span><br><span class="line"> &#125;</span><br><span class="line">&lt;/r&gt;&lt;/r&gt;</span><br></pre></td></tr></table></figure>

<p>Call：Adaptee ， 这个我理解的其实是OkhttpCall，这个OkhttpCall传到适配器中<br>CallAdapter：Target<br>CallAdapter匿名类：Adapter , 这个贴出来就报错，所以没有贴出来。<br>通过adater调用OkhttpCall,所以我理解Adaptee对应的是OkhttpCall</p>
<h2 id="外观模式"><a href="#外观模式" class="headerlink" title="外观模式"></a><span class="ez-toc-section" id="%E5%A4%96%E8%A7%82%E6%A8%A1%E5%BC%8F"></span>外观模式<span class="ez-toc-section-end"></span></h2><p>the use of Retrofit library</p>
<h2 id="策略模式"><a href="#策略模式" class="headerlink" title="策略模式"></a><span class="ez-toc-section" id="%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F"></span>策略模式<span class="ez-toc-section-end"></span></h2><p>3-28 retrofit面试题：sp跨进程&amp;apply和commit方法</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6879326343667023879">https://juejin.cn/post/6879326343667023879</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/435a5296ee94">https://www.jianshu.com/p/435a5296ee94</a></p>
<h1 id="Retrofit-Rxjava"><a href="#Retrofit-Rxjava" class="headerlink" title="Retrofit Rxjava"></a><span class="ez-toc-section" id="Retrofit_Rxjava"></span>Retrofit Rxjava<span class="ez-toc-section-end"></span></h1><p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/Retrofit/e60bb6dbf6f6ec0cb9f6ede98003154818a906f4.png"></p>
<p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/Retrofit/00e0ce6a69d77c815471a84f7f9eb221a6900951.png"></p>
<h3 id="Retrofit包装类"><a href="#Retrofit包装类" class="headerlink" title="Retrofit包装类"></a><span class="ez-toc-section" id="Retrofit%E5%8C%85%E8%A3%85%E7%B1%BB"></span>Retrofit包装类<span class="ez-toc-section-end"></span></h3><p>Retrofit组装完数据，使用Okhttp进行网络请求的类</p>
<p>OkHttpCall.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">enqueue</span><span class="params">(<span class="keyword">final</span> Callback&lt;T&gt; callback)</span> &#123;</span><br><span class="line">  Objects.requireNonNull(callback, <span class="string">&quot;callback == null&quot;</span>);</span><br><span class="line"></span><br><span class="line">  okhttp3.Call call;</span><br><span class="line">  Throwable failure;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">    call = rawCall = createRawCall();     <span class="comment">// 创建OkhttpCall</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  call.enqueue(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">okhttp3</span>.Callback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(okhttp3.Call call, okhttp3.Response rawResponse)</span> &#123;</span><br><span class="line">          Response&lt;T&gt; response;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            response = parseResponse(rawResponse);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            throwIfFatal(e);</span><br><span class="line">            callFailure(e);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            callback.onResponse(OkHttpCall.<span class="built_in">this</span>, response);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            throwIfFatal(t);</span><br><span class="line">            t.printStackTrace(); <span class="comment">// TODO this is not great</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(okhttp3.Call call, IOException e)</span> &#123;</span><br><span class="line">          callFailure(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">callFailure</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            callback.onFailure(OkHttpCall.<span class="built_in">this</span>, e);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            throwIfFatal(t);</span><br><span class="line">            t.printStackTrace(); <span class="comment">// TODO this is not great</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我还加了了提交Map参数的<a target="_blank" rel="noopener" href="https://gitee.com/huaiyi/RetrofitDemo.git">Demo</a> Demo<br><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1mU4y1p71g">https://www.bilibili.com/video/BV1mU4y1p71g</a><br><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV12Q4y1d7uD">https://www.bilibili.com/video/BV12Q4y1d7uD</a><br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/308f3c54abdd">http://www.jianshu.com/p/308f3c54abdd</a><br>这篇文章不错，深入浅出<br><a target="_blank" rel="noopener" href="http://blog.csdn.net/itjianghuxiaoxiong/article/details/52135748">http://blog.csdn.net/itjianghuxiaoxiong/article/details/52135748</a><br><a target="_blank" rel="noopener" href="https://juejin.im/post/5afc1706518825426f30f6ec">https://juejin.im/post/5afc1706518825426f30f6ec</a><br>要实现类似这样的请求,用post方式怎么也不行<br><a target="_blank" rel="noopener" href="https://newsapi.org/v2/top-headlines?sources=financial-times&amp;apiKey=e4f505f73a9f4ee99119ab33a19ab05e">https://newsapi.org/v2/top-headlines?sources=financial-times&amp;apiKey=e4f505f73a9f4ee99119ab33a19ab05e</a></p>
<h1 id="Retrofit是如何将子线程切换到主线程？"><a href="#Retrofit是如何将子线程切换到主线程？" class="headerlink" title="Retrofit是如何将子线程切换到主线程？"></a><span class="ez-toc-section" id="Retrofit%E6%98%AF%E5%A6%82%E4%BD%95%E5%B0%86%E5%AD%90%E7%BA%BF%E7%A8%8B%E5%88%87%E6%8D%A2%E5%88%B0%E4%B8%BB%E7%BA%BF%E7%A8%8B%EF%BC%9F"></span>Retrofit是如何将子线程切换到主线程？<span class="ez-toc-section-end"></span></h1><h2 id="UML"><a href="#UML" class="headerlink" title="UML"></a><span class="ez-toc-section" id="UML"></span>UML<span class="ez-toc-section-end"></span></h2><div class="mermaid">
  sequenceDiagram

RetrofitCall ->> DefaultCallAdapterFactory :  RetrofitCall.enqueue()
DefaultCallAdapterFactory ->> AndroidMainExecutor : callbackExecutor.execute
AndroidMainExecutor -->> DefaultCallAdapterFactory : handler.post(r);
DefaultCallAdapterFactory -->> RetrofitCall : callback.onResponse
</div>


<h2 id="implementation"><a href="#implementation" class="headerlink" title="implementation"></a><span class="ez-toc-section" id="implementation"></span>implementation<span class="ez-toc-section-end"></span></h2><p>在添加默认适配器工厂defaultCallAdapterFactories时，将callbackExecutor作为了一个参数，那么它的具体实现也就是在这个默认适配器工厂中。 我们来看下callbackExecutor在里面做了些啥。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ExecutorCallbackCall</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Call</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="keyword">final</span> Executor callbackExecutor;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">enqueue</span><span class="params">(<span class="keyword">final</span> Callback&lt;T&gt; callback)</span> &#123;</span><br><span class="line">    delegate.enqueue(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Callback</span>&lt;T&gt;() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(Call&lt;T&gt; call, <span class="keyword">final</span> Response&lt;T&gt; response)</span> &#123;</span><br><span class="line">            callbackExecutor.execute(        <span class="comment">// 这里切换到主线程</span></span><br><span class="line">                () -&gt; &#123;</span><br><span class="line">                    callback.onResponse(ExecutorCallbackCall.<span class="built_in">this</span>, response);</span><br><span class="line">                &#125;);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Call&lt;T&gt; call, <span class="keyword">final</span> Throwable t)</span> &#123;</span><br><span class="line">            callbackExecutor.execute(() -&gt; callback.onFailure(ExecutorCallbackCall.<span class="built_in">this</span>, t)); <span class="comment">// 这里切换到主线程</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>在上述代码里了解到，callbackExecutor即Executor，一个线程调度器。在Call的enqueue实现里执行了一个异步网络请求delegate.enqueue，在请求的响应onResponse、onFailure中 Executor也同样执行了一个线程，这里就有个疑问，为什么要在一个异步请求里又调用一个线程？我们知道callbackExecutor是一个线程调度器，那他内部到底实现的是什么？ 默认callbackExecutor的创建在Retrofit的初始化中，callbackExecutor &#x3D; platform.defaultCallbackExecutor();</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Android</span> <span class="keyword">extends</span> <span class="title class_">Platform</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Executor <span class="title function_">defaultCallbackExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MainThreadExecutor</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">MainThreadExecutor</span> <span class="keyword">implements</span> <span class="title class_">Executor</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Handler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Handler</span>(Looper.getMainLooper());</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">    handler.post(r);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>platform是一个Android平台，defaultCallbackExecutor 内部其实调用的是 new MainThreadExecutor() ，很清楚的看到， handler.post(r) 内部使用Handler将响应抛到了主线程。</p>
<p>这就是Retrofit将子线程切换到主线程的核心所在。</p>
<p>问3：Retrofit为什么要用动态代理？<br><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/Retrofit/e81f0a50834b2fb1b72fb6b7a2f92ec9ed09d6f1.png"></p>
<p>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_37492806/article/details/133995368">https://blog.csdn.net/qq_37492806&#x2F;article&#x2F;details&#x2F;133995368</a></p>
<p>Retrofit结合RxJava 感觉RxJava可以了解下，<br>Retrofit结合courutine 感觉courutine代码不懂，courutine的可以了解下，感觉courutine有先级别更高一点，回来再来画Retrofit其他的类图</p>
<h1 id="Retrofit-注解是怎么消费的"><a href="#Retrofit-注解是怎么消费的" class="headerlink" title="Retrofit 注解是怎么消费的"></a><span class="ez-toc-section" id="Retrofit_%E6%B3%A8%E8%A7%A3%E6%98%AF%E6%80%8E%E4%B9%88%E6%B6%88%E8%B4%B9%E7%9A%84"></span>Retrofit 注解是怎么消费的<span class="ez-toc-section-end"></span></h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">parseMethodAnnotation</span><span class="params">(Annotation annotation)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> DELETE) &#123;</span><br><span class="line">        parseHttpMethodAndPath(<span class="string">&quot;DELETE&quot;</span>, ((DELETE) annotation).value(), <span class="literal">false</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> GET) &#123;</span><br><span class="line">        parseHttpMethodAndPath(<span class="string">&quot;GET&quot;</span>, ((GET) annotation).value(), <span class="literal">false</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> HEAD) &#123;</span><br><span class="line">        parseHttpMethodAndPath(<span class="string">&quot;HEAD&quot;</span>, ((HEAD) annotation).value(), <span class="literal">false</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> PATCH) &#123;</span><br><span class="line">        parseHttpMethodAndPath(<span class="string">&quot;PATCH&quot;</span>, ((PATCH) annotation).value(), <span class="literal">true</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> POST) &#123;</span><br><span class="line">        parseHttpMethodAndPath(<span class="string">&quot;POST&quot;</span>, ((POST) annotation).value(), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/pengMaster/BestNote/blob/master/docs/android/Android-Interview/Android/Android%E9%AB%98%E7%BA%A7%E9%9D%A2%E8%AF%9510%E5%A4%A7%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.md">https://github.com/pengMaster/BestNote/blob/master/docs/android/Android-Interview/Android/Android%E9%AB%98%E7%BA%A7%E9%9D%A2%E8%AF%9510%E5%A4%A7%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.md</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/stven0king/designmode?tab=readme-ov-file">https://github.com/stven0king/designmode?tab=readme-ov-file</a></p>
<h1 id="Build-Project"><a href="#Build-Project" class="headerlink" title="Build Project"></a><span class="ez-toc-section" id="Build_Project"></span>Build Project<span class="ez-toc-section-end"></span></h1><p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/Retrofit/20240618162215.jpg"></p>
</|--></div></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-05-11T09:38:39.000Z" title="5/11/2024, 5:38:39 PM">2024-05-11</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-13T21:02:22.000Z" title="9/14/2024, 5:02:22 AM">2024-09-14</time></span><span class="level-item"> Jon </span><span class="level-item"><a class="link-muted" href="/categories/Library/">Library</a></span><span class="level-item">an hour read (About 7429 words)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/05/11/okhttp/">OKHTTP</a></p><div class="content"><div class="ez-toc-v2_0_66_1 ez-toc-wrap-right counter-hierarchy ez-toc-counter ez-toc-grey ez-toc-container-direction" id="ez-toc-container"><div class="ez-toc-title-container">Table of Contents

<p><span class="ez-toc-title-toggle"><a href="#"><span class="ez-toc-js-icon-con"><span class><span class="eztoc-hide" style="display:none;">Toggle</span><span class="ez-toc-icon-toggle-span"><svg class="list-377408" fill="none" height="20px" style="fill: #999;color:#999" viewbox="0 0 24 24" width="20px" xmlns="http://www.w3.org/2000/svg"><path d="M6 6H4v2h2V6zm14 0H8v2h12V6zM4 11h2v2H4v-2zm16 0H8v2h12v-2zM4 16h2v2H4v-2zm16 0H8v2h12v-2z" fill="currentColor"/></svg><svg baseprofile="tiny" class="arrow-unsorted-368013" height="10px" style="fill: #999;color:#999" version="1.2" viewbox="0 0 24 24" width="10px" xmlns="http://www.w3.org/2000/svg"><path d="M18.2 9.3l-6.2-6.3-6.2 6.3c-.2.2-.3.4-.3.7s.1.5.3.7c.2.2.4.3.7.3h11c.3 0 .5-.1.7-.3.2-.2.3-.5.3-.7s-.1-.5-.3-.7zM5.8 14.7l6.2 6.3 6.2-6.3c.2-.2.3-.5.3-.7s-.1-.5-.3-.7c-.2-.2-.4-.3-.7-.3h-11c-.3 0-.5.1-.7.3-.2.2-.3.5-.3.7s.1.5.3.7z"/></svg></span></span></span></a></span></p></div><nav>- <a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#Okhttp%E4%BC%98%E5%8A%BF" title="Okhttp优势">Okhttp优势</a><p></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#OKHttp%E8%AF%B7%E6%B1%82%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E4%BB%8B%E7%BB%8D" title="OKHttp请求整体流程介绍">OKHttp请求整体流程介绍</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#OKHttp%E5%88%86%E5%8F%91%E5%99%A8%E6%98%AF%E6%80%8E%E6%A0%B7%E5%B7%A5%E4%BD%9C%E7%9A%84" title="OKHttp分发器是怎样工作的">OKHttp分发器是怎样工作的</a><ul>
<li><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#%E5%90%8C%E6%AD%A5%E8%AF%B7%E6%B1%82" title="同步请求">同步请求</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82" title="异步请求">异步请求</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#OkHttp%E9%87%8C%E9%9D%A2%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%EF%BC%9F" title="OkHttp里面设计模式？">OkHttp里面设计模式？</a><ul>
<li><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F" title="责任链模式">责任链模式</a></li>
</ul>
</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#OkHttp%E7%9A%84%E6%8B%A6%E6%88%AA%E5%99%A8%EF%BC%9A" title="OkHttp的拦截器：">OkHttp的拦截器：</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#Okhttp_Cache" title="Okhttp Cache">Okhttp Cache</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#%E7%BC%93%E5%AD%98%E8%A7%84%E5%88%99" title="缓存规则">缓存规则</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#%E7%BC%93%E5%AD%98%E5%BA%94%E7%94%A8" title="缓存应用">缓存应用</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#%E5%BC%BA%E5%88%B6%E7%BC%93%E5%AD%98" title="强制缓存">强制缓存</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#%E5%AF%B9%E6%AF%94%E7%BC%93%E5%AD%98" title="对比缓存">对比缓存</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#Last-Modified_If-Modified-Since" title="Last-Modified / If-Modified-Since">Last-Modified &#x2F; If-Modified-Since</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#Etag_If-None-Match" title="Etag / If-None-Match">Etag &#x2F; If-None-Match</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#CacheInterceptor" title="CacheInterceptor">CacheInterceptor</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#Request" title="Request">Request</a><ul>
<li><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#RequestBody" title="RequestBody">RequestBody</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#FormBody" title="FormBody">FormBody</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#OkHttp%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E8%BF%9E%E6%8E%A5%E6%B1%A0" title="OkHttp怎么实现连接池">OkHttp怎么实现连接池</a><ul>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E9%85%8D%E7%BD%AE" title="连接池配置">连接池配置</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#%E8%BF%9E%E6%8E%A5%E5%A4%8D%E7%94%A8%E5%AE%9E%E7%8E%B0" title="连接复用实现">连接复用实现</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#okhttp%E6%80%8E%E4%B9%88%E6%94%AF%E6%8C%81http20" title="okhttp怎么支持http2.0">okhttp怎么支持http2.0</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#OKHTTP_%E6%8A%93%E5%8C%85" title="OKHTTP  抓包">OKHTTP 抓包</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#%E5%BA%94%E7%94%A8%E6%8B%A6%E6%88%AA%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%8B%A6%E6%88%AA%E5%99%A8%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB" title="应用拦截器和网络拦截器有什么区别">应用拦截器和网络拦截器有什么区别</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#OKHttp_%E5%A6%82%E4%BD%95%E5%A4%8D%E7%94%A8_TCP_%E8%BF%9E%E6%8E%A5" title="OKHttp 如何复用 TCP 连接">OKHttp 如何复用 TCP 连接</a></li>
<li><a target="_blank" rel="noopener" href="https://jonblog.site/2024/05/11/okhttp/#OKHttp_%E7%A9%BA%E9%97%B2%E8%BF%9E%E6%8E%A5%E5%A6%82%E4%BD%95%E6%B8%85%E9%99%A4" title="OKHttp 空闲连接如何清除">OKHttp 空闲连接如何清除</a></li>
</ul>
</nav></div>## <span class="ez-toc-section" id="Okhttp%E4%BC%98%E5%8A%BF"></span>Okhttp优势<span class="ez-toc-section-end"></span>

<p><a target="_blank" rel="noopener" href="https://square.github.io/okhttp/">https://square.github.io/okhttp/</a></p>
<p>OkHttp is an HTTP client that’s efficient by default:</p>
<ul>
<li>HTTP&#x2F;2 support allows all requests to the same host to share a socket.</li>
<li>Connection pooling reduces request latency (if HTTP&#x2F;2 isn’t available).</li>
<li>Transparent GZIP shrinks download sizes.</li>
<li>Response caching avoids the network completely for repeat requests.</li>
</ul>
<p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/OKHTTP/4118241-fd8b73fd6b395e8a.webp"></p>
<p>okhttp的请求原理</p>
<p>OkHttp的内部实现通过一个责任链模式完成，将网络请求的各个阶段封装到各个链条中，实现了各层的解耦。</p>
<h2 id="OKHttp请求整体流程介绍"><a href="#OKHttp请求整体流程介绍" class="headerlink" title="OKHttp请求整体流程介绍"></a><span class="ez-toc-section" id="OKHttp%E8%AF%B7%E6%B1%82%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E4%BB%8B%E7%BB%8D"></span>OKHttp请求整体流程介绍<span class="ez-toc-section-end"></span></h2><p>整个网络请求过程大致如上所示</p>
<ol>
<li>通过建造者模式构建 OKHttpClient 与 Request</li>
<li>OKHttpClient 通过 newCall 发起一个新的请求</li>
<li>通过分发器维护请求队列与线程池，完成请求调配</li>
<li>通过五大默认拦截器完成请求重试，缓存处理，建立连接等一系列操作得到网络请求结果</li>
</ol>
<p><img src="https://s6.51cto.com/oss/202111/09/4f789bee8f444f6c26e80fc8830b0bc2.jpg"></p>
<h2 id="OKHttp分发器是怎样工作的"><a href="#OKHttp分发器是怎样工作的" class="headerlink" title="OKHttp分发器是怎样工作的"></a><span class="ez-toc-section" id="OKHttp%E5%88%86%E5%8F%91%E5%99%A8%E6%98%AF%E6%80%8E%E6%A0%B7%E5%B7%A5%E4%BD%9C%E7%9A%84"></span>OKHttp分发器是怎样工作的<span class="ez-toc-section-end"></span></h2><p>分发器的主要作用是维护请求队列与线程池,比如我们有100个异步请求，肯定不能把它们同时请求，而是应该把它们排队分个类，分为正在请求中的列表和正在等待的列表， 等请求完成后，即可从等待中的列表中取出等待的请求，从而完成所有的请求</p>
<p>而这里同步请求各异步请求又略有不同</p>
<h4 id="同步请求"><a href="#同步请求" class="headerlink" title="同步请求"></a><span class="ez-toc-section" id="%E5%90%8C%E6%AD%A5%E8%AF%B7%E6%B1%82"></span>同步请求<span class="ez-toc-section-end"></span></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">executed</span><span class="params">(RealCall call)</span> &#123;  </span><br><span class="line">   runningSyncCalls.add(call);  </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>因为同步请求不需要线程池，也不存在任何限制。所以分发器仅做一下记录。后续按照加入队列的顺序同步请求即可</p>
<h4 id="异步请求"><a href="#异步请求" class="headerlink" title="异步请求"></a><span class="ez-toc-section" id="%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82"></span>异步请求<span class="ez-toc-section-end"></span></h4><p>最新的master分支</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">private fun promoteAndExecute(): Boolean &#123;</span><br><span class="line">  this.assertThreadDoesntHoldLock()</span><br><span class="line"></span><br><span class="line">  val executableCalls = mutableListOf&lt;AsyncCall&gt;()</span><br><span class="line">  val isRunning: Boolean</span><br><span class="line">  synchronized(this) &#123;</span><br><span class="line">    val i = readyAsyncCalls.iterator()  // 取出待执行的任务，根据条件添加到runningAsyncCalls</span><br><span class="line">    while (i.hasNext()) &#123;</span><br><span class="line">      val asyncCall = i.next()</span><br><span class="line">      println(&quot;runningAsyncCalls $&#123;runningAsyncCalls.size&#125;&quot;) </span><br><span class="line">      if (runningAsyncCalls.size &gt;= this.maxRequests) break // Max capacity.</span><br><span class="line">      if (asyncCall.callsPerHost.get() &gt;= this.maxRequestsPerHost) continue // Host max capacity.</span><br><span class="line">      i.remove()</span><br><span class="line">      asyncCall.callsPerHost.incrementAndGet()</span><br><span class="line">      executableCalls.add(asyncCall)</span><br><span class="line">      runningAsyncCalls.add(asyncCall)</span><br><span class="line">    &#125;</span><br><span class="line">    isRunning = runningCallsCount() &gt; 0</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>所有的请求都会先添加到readyAsyncCalls，当正在执行的任务未超过最大限制64，并且同一 Host 的请求不超过5个，则会添加到正在执行队列，同时提交给线程池。每个任务完成后，都会调用分发器的 finished 方法,这里面会取出等待队列中的任务继续执行.</p>
<p>&#x2F;&#x2F; 可以尝试修改 maxRequestsPerHost &#x3D;12,maxRequests &#x3D; 10</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span><span class="number">0</span> ; i &lt; <span class="number">20</span>;i++)&#123;</span><br><span class="line">  client.newCall(request).enqueue(callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据请求runningAsyncCalls.size 打印结果。可以看到运行状态</p>
<p>okhttp线程使用方式</p>
<p>根据线程池执行流程：</p>
<p>一开始看了网上视频，就说Okhttp是自驱动循环调用，相对于AsyncTask的优势就是 并发执行，但是这两条不就矛盾了吗，既然环形链式调用，怎么能并发呢。就从源码中找答案。 看了bi站的视频，超过5个在队列中的请求，应该是完成一个网络请求,继续从队列中取出，任务继续执行。</p>
<p>Dispatcher 最大请求数量</p>
<p>runningAsyncCalls 运行时的最大请求数量64,只有多个不同的host请求才能可能让走到下面代码.因为还有 if (asyncCall.callsPerHost.get() &gt;&#x3D; this.maxRequestsPerHost)这个条件限制.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (runningAsyncCalls.size &gt;= this.maxRequests)&#123;</span><br><span class="line">         println(&quot;promoteAndExecute &gt;= maxRequests&quot; )</span><br><span class="line">         break</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>Okhttp 异步请求维护的两个队列</p>
<p>Dispatcher.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/** Ready async calls in the order they&#x27;ll be run. */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">val</span> <span class="variable">readyAsyncCalls</span> <span class="operator">=</span> ArrayDeque&lt;AsyncCall&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Running asynchronous calls. Includes canceled calls that haven&#x27;t finished yet. */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">val</span> <span class="variable">runningAsyncCalls</span> <span class="operator">=</span> ArrayDeque&lt;AsyncCall&gt;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">maxRequests</span> <span class="operator">=</span> <span class="number">64</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">maxRequestsPerHost</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">enqueue</span><span class="params">(AsyncCall call)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (runningAsyncCalls.size() &lt; maxRequests &amp;&amp; runningCallsForHost(call) &lt; maxRequestsPerHost) &#123;</span><br><span class="line">      runningAsyncCalls.add(call);</span><br><span class="line">      executorService().execute(call);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      readyAsyncCalls.add(call);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">可以看到提交任务 &gt;<span class="number">5</span>时，才会被添加到readyAsyncCalls队列中。&lt;<span class="number">5</span>的任务直接提交。</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">promoteCalls</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (runningAsyncCalls.size() &gt;= maxRequests) <span class="keyword">return</span>; <span class="comment">// Already running max capacity.</span></span><br><span class="line">    <span class="keyword">if</span> (readyAsyncCalls.isEmpty()) <span class="keyword">return</span>; <span class="comment">// No ready calls to promote.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Iterator&lt;AsyncCall&gt; i = readyAsyncCalls.iterator(); i.hasNext(); ) &#123;</span><br><span class="line">      <span class="type">AsyncCall</span> <span class="variable">call</span> <span class="operator">=</span> i.next();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (runningCallsForHost(call) &lt; maxRequestsPerHost) &#123;</span><br><span class="line">        i.remove();</span><br><span class="line">        runningAsyncCalls.add(call);</span><br><span class="line">        Log.i(<span class="string">&quot;Dispatcher&quot;</span>, <span class="string">&quot;promoteCalls:  准备队列 &quot;</span>+call.request().tag+<span class="string">&quot; 执行&quot;</span>);</span><br><span class="line">        executorService().execute(call);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (runningAsyncCalls.size() &gt;= maxRequests) <span class="keyword">return</span>; <span class="comment">// Reached max capacity.</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">readyAsyncCalls不为空，然后取出一条，再执行，可以看到，默认情况下会有<span class="number">5</span>条环形任务链。</span><br></pre></td></tr></table></figure>

<p>if (asyncCall.callsPerHost.get() &gt;&#x3D; this.maxRequestsPerHost) 这个条件时如何判断的呢? 主要是下面的方法,默认forWebSocket&#x3D;&#x3D;true,走到条件里.如果AsyncCall已经存在队列中,那么就直接返回，把callsPerHost数值叠加.从而实现，上面的条件判断.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  // Mutate the AsyncCall so that it shares the AtomicInteger of an existing running call to</span><br><span class="line">  // the same host.</span><br><span class="line">  if (!call.call.forWebSocket) &#123;</span><br><span class="line">    val existingCall = findExistingCallWithHost(call.host)</span><br><span class="line">    if (existingCall != null) call.reuseCallsPerHostFrom(existingCall)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">fun reuseCallsPerHostFrom(other: AsyncCall) &#123;</span><br><span class="line">  this.callsPerHost = other.callsPerHost</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题 OkHttpThreadPool.java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ThreadPoolExecutor executor = new ThreadPoolExecutor(</span><br><span class="line">        0, Integer.MAX_VALUE, 60, TimeUnit.SECONDS, new LinkedBlockingDeque&lt;&gt;());</span><br><span class="line">executor.execute(() -&gt; &#123;</span><br><span class="line">    System.out.println(&quot;任务1&quot;);</span><br><span class="line">    System.out.println(Thread.currentThread());</span><br><span class="line">    while (true) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">executor.execute(() -&gt; &#123;</span><br><span class="line">    System.out.println(&quot;任务1&quot;);</span><br><span class="line">    System.out.println(Thread.currentThread());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">executor.execute(() -&gt; &#123;</span><br><span class="line">    System.out.println(&quot;任务1&quot;);</span><br><span class="line">    System.out.println(Thread.currentThread());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>运行结果:</p>
<p>任务1 Thread[pool-1-thread-1,5,main]</p>
<p>如果 new LinkedBlockingDeque&lt;&gt;(1)能正常执行，因为LinkedBlockingDeque加入 任务1 就满了，后面的任务创建非核心线程</p>
<p>但是有点疑惑，我这里核心线程是0，任务都加入到LinkedBlockingDeque, 按照线程池流程，非核心就不应该创建呀？怎么任务1就执行了呢</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV15y4y1B7Rw?p=5">https://www.bilibili.com/video/BV15y4y1B7Rw?p=5</a><br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/BHDrSgwUVXkzvswK1khidQ">https://mp.weixin.qq.com/s/BHDrSgwUVXkzvswK1khidQ</a><br><a target="_blank" rel="noopener" href="https://github.com/Snailclimb/programmer-advancement">https://github.com/Snailclimb/programmer-advancement</a><br><a target="_blank" rel="noopener" href="https://juejin.im/post/6855586076132655118">https://juejin.im/post/6855586076132655118</a><br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&mid=2247485441&idx=1&sn=303a25ab02fa9f14a319923e6b0d9759&chksm=cea247caf9d5cedc3a5e1d31f26c08d8ae4c11c349fbdc91ac1d90d8b35807517accb5f5d527&token=2128752750&lang=zh_CN#rd">https://mp.weixin.qq.com/s?__biz&#x3D;Mzg2OTA0Njk0OA&#x3D;&#x3D;&amp;mid&#x3D;2247485441&amp;idx&#x3D;1&amp;sn&#x3D;303a25ab02fa9f14a319923e6b0d9759&amp;chksm&#x3D;cea247caf9d5cedc3a5e1d31f26c08d8ae4c11c349fbdc91ac1d90d8b35807517accb5f5d527&amp;token&#x3D;2128752750&amp;lang&#x3D;zh_CN#rd</a></p>
<h2 id="OkHttp里面设计模式？"><a href="#OkHttp里面设计模式？" class="headerlink" title="OkHttp里面设计模式？"></a><span class="ez-toc-section" id="OkHttp%E9%87%8C%E9%9D%A2%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%EF%BC%9F"></span>OkHttp里面设计模式？<span class="ez-toc-section-end"></span></h2><h4 id="责任链模式"><a href="#责任链模式" class="headerlink" title="责任链模式"></a><span class="ez-toc-section" id="%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F"></span>责任链模式<span class="ez-toc-section-end"></span></h4><p>OKHttp 的核心就是责任链模式，通过5个默认拦截器构成的责任链完成请求的配置 .</p>
<p>拦截器</p>
<p><img src="https://blogforme.github.io/ImageServer/OKHTTP/2021-07-24_6.43_interupt.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">+----------------------------------+</span><br><span class="line">|         OkHttpInterceptor        |</span><br><span class="line">+----------------------------------+</span><br><span class="line">| - configuration: Configuration   |</span><br><span class="line">| - enabled: boolean               |</span><br><span class="line">+----------------------------------+</span><br><span class="line">| + intercept(chain: Chain): Response |</span><br><span class="line">| + enable(): void                |</span><br><span class="line">| + disable(): void               |</span><br><span class="line">+----------------------------------+</span><br><span class="line">|           &lt;&lt;interface&gt;&gt;          |</span><br><span class="line">|             Chain                |</span><br><span class="line">+----------------------------------+</span><br><span class="line">| + request(): Request             |</span><br><span class="line">| + proceed(request: Request): Response |</span><br><span class="line">+----------------------------------+</span><br></pre></td></tr></table></figure>

<h2 id="OkHttp的拦截器："><a href="#OkHttp的拦截器：" class="headerlink" title="OkHttp的拦截器："></a><span class="ez-toc-section" id="OkHttp%E7%9A%84%E6%8B%A6%E6%88%AA%E5%99%A8%EF%BC%9A"></span>OkHttp的拦截器：<span class="ez-toc-section-end"></span></h2><p>interceptor</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">getResponseWithInterceptorChain</span><span class="params">()</span></span>: Response &#123;</span><br><span class="line">   <span class="comment">// Build a full stack of interceptors.</span></span><br><span class="line">   <span class="keyword">val</span> interceptors = mutableListOf&lt;Interceptor&gt;()</span><br><span class="line">   interceptors += client.interceptors</span><br><span class="line">   interceptors += RetryAndFollowUpInterceptor(client)</span><br><span class="line">   interceptors += BridgeInterceptor(client.cookieJar)</span><br><span class="line">   interceptors += CacheInterceptor(client.cache)</span><br><span class="line">   interceptors += ConnectInterceptor</span><br><span class="line">   interceptors += CallServerInterceptor(forWebSocket)</span><br><span class="line">   <span class="keyword">val</span> chain =</span><br><span class="line">     RealInterceptorChain(</span><br><span class="line">       call = <span class="keyword">this</span>,</span><br><span class="line">       interceptors = interceptors,</span><br><span class="line">       index = <span class="number">0</span>,</span><br><span class="line">       request = originalRequest,</span><br><span class="line">     )</span><br><span class="line">     <span class="keyword">val</span> response = chain.proceed(originalRequest)</span><br><span class="line">     <span class="keyword">return</span> response</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>RetryAndFollowUpInterceptor：失败和重定向拦截器；</li>
<li>BridgeInterceptor：负责将http协议必备的请求头加入其中(host),并添加一些默认的行为(gzip),获得结果后，调用cookie接口并解析GZIP数据。</li>
<li>CacheInterceptor：缓存处理相关的拦截器；</li>
<li>ConnectInterceptor： 负责找到或者新建一个连接，并获取对应的socket流；在获得结果后不进行额外的处理。</li>
<li>CallServerInterceptor：进行真正的与服务器的通信，向服务器请求和读响应的拦截器；</li>
</ul>
<p>最终网络返回的数据请求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fun openResponseBody(response: Response): ResponseBody &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    val contentType = response.header(&quot;Content-Type&quot;)</span><br><span class="line">    val contentLength = codec.reportedContentLength(response)</span><br><span class="line">    val rawSource = codec.openResponseBodySource(response)</span><br><span class="line">    val source = ResponseBodySource(rawSource, contentLength)</span><br><span class="line">    return RealResponseBody(contentType, contentLength, source.buffer())</span><br></pre></td></tr></table></figure>

<p>构造者模式 : OkHttpClient ,Request,CacheControl 外观模式 : OkHttp使用了外观模式,将整个系统的复杂性给隐藏起来，将子系统接口通过一个客户端 OkHttpClient 统一暴露出来 工厂模式 : （在 Call 接口中，有一个内部工厂 Factory 接口）,只有一个实现RealCall， 而且这个RealCall在okhttp 代码中深度耦合，感觉这个工厂没什么用。</p>
<p>享元模式 : Dispatcher 的线程池中，不限量的线程池实现了对象复用,这个只是线程池的特性,线程池对线程的操作，没有什么代码的问题. 策略模式 : CacheInterceptor ,在响应数据的选择中使用了策略模式，选择缓存数据还是选择网络访问。</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jimuzz/p/13935677.html">https://www.cnblogs.com/jimuzz/p/13935677.html</a><a target="_blank" rel="noopener" href="https://www.codetd.com/article/4354895">https://www.codetd.com/article/4354895</a><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/d85e556b8da6">https://www.jianshu.com/p/d85e556b8da6</a></p>
<h2 id="Okhttp-Cache"><a href="#Okhttp-Cache" class="headerlink" title="Okhttp Cache"></a><span class="ez-toc-section" id="Okhttp_Cache"></span>Okhttp Cache<span class="ez-toc-section-end"></span></h2><p><a target="_blank" rel="noopener" href="https://web.dev/articles/http-cache">https://web.dev/articles/http-cache</a></p>
<p>The app requests an API for the first time. <img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/OKHTTP/image-20211122160654923.png">在客户端第一次请求数据时，此时缓存数据库中没有对应的缓存数据，需要请求服务器，服务器返回后，将数据存储至缓存数据库中：</p>
<h2 id="缓存规则"><a href="#缓存规则" class="headerlink" title="缓存规则"></a><span class="ez-toc-section" id="%E7%BC%93%E5%AD%98%E8%A7%84%E5%88%99"></span>缓存规则<span class="ez-toc-section-end"></span></h2><p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/OKHTTP/image-20211124124939616.png"></p>
<p>这张图描述了整个缓存策略，其中有缓存 模块，代表了 强制缓存模块.</p>
<h3 id="缓存应用"><a href="#缓存应用" class="headerlink" title="缓存应用"></a><span class="ez-toc-section" id="%E7%BC%93%E5%AD%98%E5%BA%94%E7%94%A8"></span>缓存应用<span class="ez-toc-section-end"></span></h3><p>假设缓存数据库存在缓存数据，仅基于强制缓存，请求数据的流程如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> client: OkHttpClient = OkHttpClient.Builder()</span><br><span class="line">     .cache(</span><br><span class="line">         Cache(</span><br><span class="line">             directory = context.cacheDir,</span><br><span class="line">             maxSize = <span class="number">10L</span> * <span class="number">1024L</span> * <span class="number">1024L</span> <span class="comment">// 10 MiB</span></span><br><span class="line">         )</span><br><span class="line">     )</span><br><span class="line">     .build()</span><br><span class="line"></span><br><span class="line"> <span class="keyword">val</span> request = Request.Builder()</span><br><span class="line">     .url(<span class="string">&quot;https://publicobject.com/helloworld.txt&quot;</span>)</span><br><span class="line">     .build()</span><br><span class="line"></span><br><span class="line"> <span class="keyword">val</span> response1Body = client.newCall(request).execute().use &#123;</span><br><span class="line">     <span class="keyword">if</span> (!it.isSuccessful) <span class="keyword">throw</span> IOException(<span class="string">&quot;Unexpected code <span class="variable">$it</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">     println(<span class="string">&quot;Response 1 response:          <span class="variable">$it</span>&quot;</span>)</span><br><span class="line">     println(<span class="string">&quot;Response 1 cache response:    <span class="subst">$&#123;it.cacheResponse&#125;</span>&quot;</span>)</span><br><span class="line">     println(<span class="string">&quot;Response 1 network response:  <span class="subst">$&#123;it.networkResponse&#125;</span>&quot;</span>)</span><br><span class="line">     <span class="keyword">return</span><span class="symbol">@use</span> it.body?.string()</span><br><span class="line"> &#125;</span><br><span class="line"> println(<span class="string">&quot;Response 1 response:          <span class="variable">$response1Body</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"> <span class="keyword">val</span> response2Body = client.newCall(request).execute().use &#123;</span><br><span class="line">     <span class="keyword">if</span> (!it.isSuccessful) <span class="keyword">throw</span> IOException(<span class="string">&quot;Unexpected code <span class="variable">$it</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">     println(<span class="string">&quot;Response 2 response:          <span class="variable">$it</span>&quot;</span>)</span><br><span class="line">     println(<span class="string">&quot;Response 2 cache response:    <span class="subst">$&#123;it.cacheResponse&#125;</span>&quot;</span>)</span><br><span class="line">     println(<span class="string">&quot;Response 2 network response:  <span class="subst">$&#123;it.networkResponse&#125;</span>&quot;</span>)</span><br><span class="line">     <span class="keyword">return</span><span class="symbol">@use</span> it.body?.string()</span><br><span class="line"> &#125;</span><br><span class="line"> println(<span class="string">&quot;Response 2 response:          <span class="variable">$response2Body</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"> println(<span class="string">&quot;Response 2 equals Response 1? &quot;</span> + (response1Body == response2Body))</span><br></pre></td></tr></table></figure>

<p>Response 1 cache response: null Response 1 network response: Response{protocol&#x3D;http&#x2F;1.1, code&#x3D;200, message&#x3D;OK, url&#x3D;<a target="_blank" rel="noopener" href="https://publicobject.com/helloworld.txt">https://publicobject.com/helloworld.txt</a>}</p>
<p>Response 2 cache response: Response{protocol&#x3D;http&#x2F;1.1, code&#x3D;200, message&#x3D;OK, url&#x3D;<a target="_blank" rel="noopener" href="https://publicobject.com/helloworld.txt">https://publicobject.com/helloworld.txt</a>}</p>
<p>Response 2 network response: null</p>
<h3 id="强制缓存"><a href="#强制缓存" class="headerlink" title="强制缓存"></a><span class="ez-toc-section" id="%E5%BC%BA%E5%88%B6%E7%BC%93%E5%AD%98"></span>强制缓存<span class="ez-toc-section-end"></span></h3><p>假设缓存数据库存在缓存数据，仅基于强制缓存，请求数据的流程如下：</p>
<p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/OKHTTP/image-20211122161109564.png"></p>
<div class="mermaid">
  flowchart LR
    A[Start] --> B{private or public ?}
    B -- Yes --> C[max-age or Expires]
    B -- No ----> E[End]
    C -- No ----> D[no-cache ?]
</div>


<p>强制缓存，类似这种图示。</p>
<p>可以看出，强制缓存如果生效，就不需要再和服务器发生交互。</p>
<p>强制缓存的实现依靠于Expires和Cache-Control这两个Header。</p>
<p>Expires&#x2F;Cache-Control Expires 是 HTTP&#x2F;1.0 所提供的对缓存的支持，通过这个 Header ，服务端可以告诉客户端缓存的过期时间，表示在过期时间内该资源都不会被更改，可以不用再向自己请求了。</p>
<p>例如：Expires: Mon, 22 Nov 2021 16:21:00 GMT 就标明了缓存的过期时间。</p>
<p>可以发现，它是由服务端生成的一个具体时间，浏览器之类的客户端应用会根据本地的时间与该具体时间对比，而客户端的时间可能跟服务端的时间有误差，这就会导致缓存命中的误差。</p>
<p>由于 Expires 存在上述的问题，因此在 HTTP&#x2F;1.1 协议中引入了 Cache-Control 机制，通过这个 Header 可以在服务端与客户端之间沟通缓存信息。常见的缓存指令如下</p>
<table>
<thead>
<tr>
<th>—</th>
</tr>
</thead>
<tbody><tr>
<td></td>
</tr>
<tr>
<td></td>
</tr>
<tr>
<td></td>
</tr>
</tbody></table>
<p>其中private是默认值。</p>
<p>在Http&#x2F;1.0版本，如果同时出现了 Cache-Control:max-age&#x3D; 以及 Expires，max-age指令会被忽略，以Expires为准；</p>
<p>在Http&#x2F;1.1版本，如果同时出现了 Cache-Control:max-age&#x3D; 以及 Expires，Expires会被忽略，以 max-age 为准。</p>
<p>如果有no-cache就考虑使用对比缓存</p>
<h3 id="对比缓存"><a href="#对比缓存" class="headerlink" title="对比缓存"></a><span class="ez-toc-section" id="%E5%AF%B9%E6%AF%94%E7%BC%93%E5%AD%98"></span>对比缓存<span class="ez-toc-section-end"></span></h3><p>假设缓存数据库存在缓存数据，仅基于对比缓存，请求数据的流程如下：</p>
<p><img src="https://raw.githubusercontent.com/BlogForMe/ImageServer/main/OKHTTP/image-20211122164303152.png"></p>
<p>可以看出， 都需要请求服务器验证缓存标识对应的数据是否失效,对比缓存不管是否生效，所以都需要与服务端发生交互。</p>
<p>浏览器第一次请求数据时，服务器会将缓存标识与数据一起返回给客户端，客户端将二者备份至缓存数据库中。 再次请求数据时，客户端将备份的缓存标识发送给服务器，服务器根据缓存标识进行判断，若缓存资源仍有效，服务器会返回304状态码，通知客户端比较成功，可以使用缓存数据。</p>
<p>分为两种标识传递，分别是Last-Modified &#x2F; If-Modified-Since和Etag &#x2F; If-None-Match，下面我们分别介绍。</p>
<h4 id="Last-Modified-If-Modified-Since"><a href="#Last-Modified-If-Modified-Since" class="headerlink" title="Last-Modified &#x2F; If-Modified-Since"></a><span class="ez-toc-section" id="Last-Modified_If-Modified-Since"></span>Last-Modified &#x2F; If-Modified-Since<span class="ez-toc-section-end"></span></h4><p>这两个字段需要配合 Cache-Control 进行使用，If-Modified-Since 位于请求头,Last-Modified 位于响应头，。它们的含义分别是：</p>
<ul>
<li>If-Modified-Since： 客户端缓存过期时（max-age 时间到期），发现该资源具有 Last-Modified 字段，可以在 Header 中填入 If-Modified-Since 字段，并填入Last-Modified记录的时间,(If-Modified-Since &#x3D; Last-Modified time)。服务端收到该时间后会与该资源的最后修改时间进行比较。</li>
<li>Last-Modified： 该响应资源最后的修改时间，服务器在响应请求的时候可以填入该字段。</li>
</ul>
<p>若该资源已经被修改 ，则会返回状态码200，并对整个资源响应。 否则说明该资源在访问时未被修改，则会响应状态码 304，告知客户端可以使用缓存的资源。</p>
<h4 id="Etag-If-None-Match"><a href="#Etag-If-None-Match" class="headerlink" title="Etag &#x2F; If-None-Match"></a><span class="ez-toc-section" id="Etag_If-None-Match"></span>Etag &#x2F; If-None-Match<span class="ez-toc-section-end"></span></h4><p>同样需要配合 Cache-Control 使用，Etag 位于响应头，If-None-Match 位于请求头。并且它们的优先级高于 Last-Modified&#x2F;If-Modified-Since。</p>
<p>它们的含义分别是：</p>
<ul>
<li>Etag： 请求的资源在服务器中的唯一标识，规则由服务器决定。</li>
<li>If-None-Match： 若客户端在缓存过期时（max-age 到期），发现该资源具有 Etag 字段，就可以添加 If-None-Match Header，并传入 Etag 中的值 (If-None-Match &#x3D; Etag value)，服务器收到请求后就会将If-None-Match的值与被请求资源的唯一标识进行比对 若比对不同，说明资源有被改动过，则会返回状态码200，并响应整个资源内容 若比对相同，说明资源没有新的修改，则会返回状态码 304，告知客户端可以继续使用缓存的资源。</li>
</ul>
<p>对于强制缓存，服务端通知客户端一个缓存时间，在缓存时间内客户端可以直接使用缓存的资源，不在缓存时间内，若客户端需要获取数据，则需要执行对比缓存策略。</p>
<p>对于比较缓存，客户端将缓存信息中的Etag和Last-Modified通过请求发送给服务器，由服务器校验，若返回304状态码，则客户端可以使用缓存中的资源。</p>
<p>网络请求缓存处理，okhttp如何处理网络缓存的</p>
<p>总结 强制缓存和对比缓存可以同时存在，强制缓存优先级高于对比缓存，也就是说，当执行强制缓存的规则时，如果缓存生效，直接使用缓存，不再执行对比缓存规则。</p>
<p>当强制缓存和对比缓存同时存在时：</p>
<p>对于强制缓存，服务端通知客户端一个缓存时间，在缓存时间内客户端可以直接使用缓存的资源，不在缓存时间内，若客户端需要获取数据，则需要执行对比缓存策略。</p>
<p>对于比较缓存，客户端将缓存信息中的Etag和Last-Modified通过请求发送给服务器，由服务器校验，若返回304状态码，则客户端可以使用缓存中的资源。</p>
<p>offline cache</p>
<p>Cached responses can be served even when the device is offline or has limited connectivity, ensuring that your app remains functional in challenging network conditions.</p>
<p>遗留的问题，sprintboot弄好后，mock服务端的head请求，再验证CacheInterceptor 策略。</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/giagor/p/15706508.htm">https://www.cnblogs.com/giagor/p/15706508.htm</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV12Q4y1d7uD">https://www.bilibili.com/video/BV12Q4y1d7uD</a><br><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MzA5MzI3NjE2MA==&mid=2650237860&idx=1&sn=d66e75f6f7752ededdcaa3ce780862d3&chksm=88639acbbf1413dd170ba41a67035c62811b489cfc7a405977ae23254205a6b3acb99358b1f2&scene=38#wechat_redirect"><em>OKHTTP</em>之缓存配置详解</a></p>
<h3 id="CacheInterceptor"><a href="#CacheInterceptor" class="headerlink" title="CacheInterceptor"></a><span class="ez-toc-section" id="CacheInterceptor"></span>CacheInterceptor<span class="ez-toc-section-end"></span></h3><p>By default, OkHttp’s CacheInterceptor only supports caching for GET requests.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="title">put</span><span class="params">(response: <span class="type">Response</span>)</span></span>: CacheRequest? &#123;</span><br><span class="line">    <span class="keyword">val</span> requestMethod = response.request.method</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (HttpMethod.invalidatesCache(response.request.method)) &#123; <span class="comment">//This method determines whether it is not a get request</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        remove(response.request)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (_: IOException) &#123;</span><br><span class="line">        <span class="comment">// The cache cannot be written.</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (requestMethod != <span class="string">&quot;GET&quot;</span>) &#123;</span><br><span class="line">      <span class="comment">// Don&#x27;t cache non-GET responses. We&#x27;re technically allowed to cache HEAD requests and some</span></span><br><span class="line">      <span class="comment">// POST requests, but the complexity of doing so is high and the benefit is low.</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Request"><a href="#Request" class="headerlink" title="Request"></a><span class="ez-toc-section" id="Request"></span>Request<span class="ez-toc-section-end"></span></h2><h4 id="RequestBody"><a href="#RequestBody" class="headerlink" title="RequestBody"></a><span class="ez-toc-section" id="RequestBody"></span>RequestBody<span class="ez-toc-section-end"></span></h4><p>The RequestBody is a basic request for OkHttp. It also provides FormBody and MultipartBody to construct the request body.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  RequestBody body = RequestBody.create(json, JSON);</span><br><span class="line">  Request request = new Request.Builder()</span><br><span class="line">      .url(url)</span><br><span class="line">      .post(body)</span><br><span class="line">      .build();</span><br><span class="line"></span><br><span class="line">fun ByteArray.commonToRequestBody(</span><br><span class="line">  contentType: MediaType?,</span><br><span class="line">  offset: Int,</span><br><span class="line">  byteCount: Int,</span><br><span class="line">): RequestBody &#123;</span><br><span class="line">  return object : RequestBody() &#123;</span><br><span class="line">    override fun writeTo(sink: BufferedSink) &#123;</span><br><span class="line">      sink.write(this@commonToRequestBody, offset, byteCount)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">actual sealed interface BufferedSink : Sink, WritableByteChannel &#123;</span><br><span class="line">  fun buffer(): Buffer</span><br><span class="line">  actual val buffer: Buffer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>针对这一开始不理解， sink.write 是怎么写入的,它只有一个方法，没法执行,中间以为acual字段会构造对象，其实不是的，后来写了个demo。 其实是在 CallServerInterceptor中createRequestBody,创建了bufferedRequestBody,然后把之前RequestBody的数据写入。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">val bufferedRequestBody = exchange.createRequestBody(request, false).buffer()</span><br><span class="line">requestBody.writeTo(bufferedRequestBody)</span><br></pre></td></tr></table></figure>

<h4 id="FormBody"><a href="#FormBody" class="headerlink" title="FormBody"></a><span class="ez-toc-section" id="FormBody"></span>FormBody<span class="ez-toc-section-end"></span></h4><p>FormBody 重写了writeto方法，上面解析后，走的就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">override fun writeTo(sink: BufferedSink) &#123;</span><br><span class="line">  writeOrCountBytes(sink, false)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="OkHttp怎么实现连接池"><a href="#OkHttp怎么实现连接池" class="headerlink" title="OkHttp怎么实现连接池"></a><span class="ez-toc-section" id="OkHttp%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E8%BF%9E%E6%8E%A5%E6%B1%A0"></span>OkHttp怎么实现连接池<span class="ez-toc-section-end"></span></h2><p>OkHttp对于网络请求都有哪些优化<br>Okhttp demo<br>WebSocketEcho</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904102669844493">https://juejin.cn/post/6844904102669844493</a><br><a target="_blank" rel="noopener" href="https://juejin.im/post/5f0452615188252e5522b747">https://juejin.im/post/5f0452615188252e5522b747</a></p>
<h3 id="连接池配置"><a href="#连接池配置" class="headerlink" title="连接池配置"></a><span class="ez-toc-section" id="%E8%BF%9E%E6%8E%A5%E6%B1%A0%E9%85%8D%E7%BD%AE"></span>连接池配置<span class="ez-toc-section-end"></span></h3><p>maxIdleConnections 和 keepAliveDuration 是影响连接池行为的重要参数，你可以根据你的应用程序需求和服务器配置进行适当的设置。</p>
<ul>
<li><p>maxIdleConnections（最大空闲连接数）<br>这个参数表示连接池中允许存在的最大空闲连接数。空闲连接是指当前没有正在使用的连接。如果连接池中的空闲连接数达到了这个最大值，那么新的连接将不再被创建，而是会被关闭。较大的空闲连接数可以提高连接的复用性和请求响应速度，但也会占用更多的系统资源。对于具体的值，可以根据你的应用程序负载和服务器负载进行评估和调整。</p>
</li>
<li><p>keepAliveDuration（保持活动连接的时间）</p>
<p>这个参数表示连接的最大空闲时间。如果一个连接在这段时间内处于空闲状态（没有被使用），它将被关闭并从连接池中移除。较长的 keep-alive 时间可以减少频繁创建和关闭连接的开销，并提高连接的复用性，但也会增加服务器端资源的占用。在设置这个值时，可以考虑服务器的 keep-alive 配置和网络延迟等因素。</p>
</li>
</ul>
<p>在连接池中找连接的时候会对比连接池中相同host的连接。</p>
<p>如果在连接池中找不到连接的话，会创建连接，创建完后会存储到连接池中。</p>
<p>在把连接放入连接池中时，会把清除操作的任务放入到线程池中执行，删除任务中会判断当前连接有没有在使用中，有没有正在使用通过RealConnection的transmitters集合的size是否为0来判断，如果不在使用中，找出空闲时间最长的连接，如果空闲时间最长的连接超过了keep-alive默认的5分钟或者空闲的连接数超过了最大的keep-alive连接数5个的话，会把存活时间最长的连接从连接池中删除。保证keep-alive的最大空闲时间和最大的连接数</p>
<h3 id="连接复用实现"><a href="#连接复用实现" class="headerlink" title="连接复用实现"></a><span class="ez-toc-section" id="%E8%BF%9E%E6%8E%A5%E5%A4%8D%E7%94%A8%E5%AE%9E%E7%8E%B0"></span>连接复用实现<span class="ez-toc-section-end"></span></h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">callAcquirePooledConnection</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  connectionUser: <span class="type">ConnectionUser</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  routes: <span class="type">List</span>&lt;<span class="type">Route</span>&gt;?,</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: RealConnection? &#123;</span><br><span class="line">  <span class="keyword">for</span> (connection <span class="keyword">in</span> connections) &#123;</span><br><span class="line">    <span class="comment">// In the first synchronized block, acquire the connection if it can satisfy this call.</span></span><br><span class="line">    <span class="keyword">val</span> acquired =</span><br><span class="line">      synchronized(connection) &#123;</span><br><span class="line">        <span class="keyword">when</span> &#123;</span><br><span class="line">          requireMultiplexed &amp;&amp; !connection.isMultiplexed -&gt; <span class="literal">false</span></span><br><span class="line">          !connection.isEligible(address, routes) -&gt; <span class="literal">false</span></span><br><span class="line">          <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">            connectionUser.acquireConnectionNoEvents(connection)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="comment">// Confirm the connection is healthy and return it.</span></span><br><span class="line">    <span class="keyword">if</span> (connection.isHealthy(doExtensiveHealthChecks)) <span class="keyword">return</span> connection</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OkHttp 对连接池的优化思路：cleanup</p>
<p>根据连接池中的连接对象闲置了多久</p>
<p>指定闲置时间限制：超过了，就清理掉<br>默认为5 min</p>
<p>连接池中存放了大量的空闲连接对象</p>
<p>此时没有正在使用，<br>将闲置时间最长的清理掉，知道不超过5 个连接(LRU 思想)</p>
<p>cleanup 具体的业务逻辑</p>
<p>遍历所有的连接，记录正在使用的连接数与空闲的连接数(会记录空闲时间)</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7126235541917401119">https://juejin.cn/post/7126235541917401119</a></p>
<h2 id="okhttp怎么支持http2-0"><a href="#okhttp怎么支持http2-0" class="headerlink" title="okhttp怎么支持http2.0"></a><span class="ez-toc-section" id="okhttp%E6%80%8E%E4%B9%88%E6%94%AF%E6%8C%81http20"></span>okhttp怎么支持http2.0<span class="ez-toc-section-end"></span></h2><p>Handshake则会把服务端支持的Tls版本，加密方式等都带回来，然后会把这个没有验证过的HandShake用X509Certificate去验证证书的有效性。然后会通过Platform去从SSLSocket去获取ALPN的协议支持信息，当后端支持的协议内包含Http2.0时，则就会把请求升级到Http2.0阶段。</p>
<p>glide和OkHttp的任务调度是怎么实现的（比如同时发起很多请求） 4.问第三方库如okhttp、picasso等底层原理如缓存机制等（一个也没答上来，literally</p>
<p>Http1 Http2是怎么切换的<br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/TeQhe4T4wRjdAEPz6Ne45g"><em>okhttp</em> 是如何支持 Http2 的？</a></p>
<p>Handshake则会把服务端支持的Tls版本，加密方式等都带回来，然后会把这个没有验证过的HandShake用X509Certificate去验证证书的有效性。然后会通过Platform去从SSLSocket去获取ALPN的协议支持信息，当后端支持的协议内包含Http2.0时，则就会把请求升级到Http2.0阶段。</p>
<p>13.Retrofit中的Call对象如何转换成okhttp的call对象(这个题目是埋坑的)</p>
<p>Interview Questions</p>
<p>汇总 <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/dfdfd45b076e">https://www.jianshu.com/p/dfdfd45b076e</a></p>
<p>分析</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6873476209737629709/">https://juejin.cn/post/6873476209737629709/</a></p>
<h2 id="OKHTTP-抓包"><a href="#OKHTTP-抓包" class="headerlink" title="OKHTTP 抓包"></a><span class="ez-toc-section" id="OKHTTP_%E6%8A%93%E5%8C%85"></span>OKHTTP 抓包<span class="ez-toc-section-end"></span></h2><p>如果要，需要设置Okhttp证书</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">fun disableCertificateVerification(): OkHttpClient &#123;</span><br><span class="line">   val trustAllCerts = arrayOf&lt;TrustManager&gt;(object : X509TrustManager &#123;</span><br><span class="line">     override fun checkClientTrusted(</span><br><span class="line">       chain: Array&lt;out java.security.cert.X509Certificate&gt;?,</span><br><span class="line">       authType: String?,</span><br><span class="line">     ) &#123;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     override fun checkServerTrusted(</span><br><span class="line">       chain: Array&lt;out java.security.cert.X509Certificate&gt;?,</span><br><span class="line">       authType: String?,</span><br><span class="line">     ) &#123;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     override fun getAcceptedIssuers(): Array&lt;java.security.cert.X509Certificate&gt; &#123;</span><br><span class="line">       return arrayOf()</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;)</span><br><span class="line"></span><br><span class="line">   val sslContext = SSLContext.getInstance(&quot;TLS&quot;)</span><br><span class="line">   sslContext.init(null, trustAllCerts, java.security.SecureRandom())</span><br><span class="line"></span><br><span class="line">   val sslSocketFactory = sslContext.socketFactory</span><br><span class="line">   val trustAllHostnames = HostnameVerifier &#123; _, _ -&gt; true &#125;</span><br><span class="line"></span><br><span class="line">   return OkHttpClient.Builder()</span><br><span class="line">     .sslSocketFactory(sslSocketFactory, trustAllCerts[0] as X509TrustManager)</span><br><span class="line">     .hostnameVerifier(trustAllHostnames)</span><br><span class="line">     .build()</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>验证证书</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">  private fun connectTls(</span><br><span class="line">    sslSocket: SSLSocket,</span><br><span class="line">    connectionSpec: ConnectionSpec,</span><br><span class="line">  ) &#123;</span><br><span class="line">      if (connectionSpec.supportsTlsExtensions) &#123;</span><br><span class="line">        Platform.get().configureTlsExtensions(sslSocket, address.url.host, address.protocols)</span><br><span class="line">      &#125;</span><br><span class="line">      // Force handshake. This can throw!</span><br><span class="line">      sslSocket.startHandshake()</span><br><span class="line">      // Verify that the socket&#x27;s certificates are acceptable for the target host.</span><br><span class="line">      if (!address.hostnameVerifier!!.verify(address.url.host, sslSocketSession)) &#123;</span><br><span class="line">        val peerCertificates = unverifiedHandshake.peerCertificates</span><br><span class="line">        if (peerCertificates.isNotEmpty()) &#123;</span><br><span class="line">          val cert = peerCertificates[0] as X509Certificate</span><br><span class="line">          throw SSLPeerUnverifiedException(</span><br><span class="line">            &quot;&quot;&quot;</span><br><span class="line">            |Hostname $&#123;address.url.host&#125; not verified:</span><br><span class="line">            |    certificate: $&#123;CertificatePinner.pin(cert)&#125;</span><br><span class="line">            |    DN: $&#123;cert.subjectDN.name&#125;</span><br><span class="line">            |    subjectAltNames: $&#123;OkHostnameVerifier.allSubjectAltNames(cert)&#125;</span><br><span class="line">            &quot;&quot;&quot;.trimMargin(),</span><br><span class="line">          )</span><br><span class="line">      val certificatePinner = address.certificatePinner!!</span><br><span class="line"></span><br><span class="line">      // Check that the certificate pinner is satisfied by the certificates presented.</span><br><span class="line">      certificatePinner.check(address.url.host) &#123;</span><br><span class="line">        handshake.peerCertificates.map &#123; it as X509Certificate &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="应用拦截器和网络拦截器有什么区别"><a href="#应用拦截器和网络拦截器有什么区别" class="headerlink" title="应用拦截器和网络拦截器有什么区别"></a><span class="ez-toc-section" id="%E5%BA%94%E7%94%A8%E6%8B%A6%E6%88%AA%E5%99%A8%E5%92%8C%E7%BD%91%E7%BB%9C%E6%8B%A6%E6%88%AA%E5%99%A8%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB"></span>应用拦截器和网络拦截器有什么区别<span class="ez-toc-section-end"></span></h2><p>从下面的代码可以看到 interceptors和networkInterceptors的区别.<br>interceptors 是在最前面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">internal fun getResponseWithInterceptorChain(): Response &#123;</span><br><span class="line">  // Build a full stack of interceptors.</span><br><span class="line">  val interceptors = mutableListOf&lt;Interceptor&gt;()</span><br><span class="line">  interceptors += client.interceptors</span><br><span class="line">  interceptors += RetryAndFollowUpInterceptor(client)</span><br><span class="line">  interceptors += BridgeInterceptor(client.cookieJar)</span><br><span class="line">  interceptors += CacheInterceptor(client.cache)</span><br><span class="line">  interceptors += ConnectInterceptor</span><br><span class="line">  if (!forWebSocket) &#123;</span><br><span class="line">    interceptors += client.networkInterceptors</span><br><span class="line">  &#125;</span><br><span class="line">  interceptors += CallServerInterceptor(forWebSocket)</span><br><span class="line">  val chain =</span><br><span class="line">    RealInterceptorChain(</span><br><span class="line">      call = this,</span><br><span class="line">      interceptors = interceptors,</span><br><span class="line">      index = 0,</span><br><span class="line">      request = originalRequest</span><br><span class="line">    )</span><br><span class="line">    val response = chain.proceed(originalRequest)</span><br><span class="line">    return response</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>应用拦截器</p>
<p>仅调用一次，即使 http 响应是从缓存中获取的结果。<br>主要关注应用程序的原始意图，不关心 okhttp 注入的头，如 If-None-Match …<br>允许短路操作，即 不调用 Chain.proceed()。<br>允许重试并多次调用 Chain.proceed()<br>可以使用 withConnectTimeout, withReadTimeout, withWriteTimeout 来调整 Call 超时时间。</p>
<p>网络拦截器</p>
<p>能够操作中间处理过程，如重定向和重试。<br>不关注 cache 层拦截的短路操作<br>关注网络层数据传输<br>执行 Connection 请求</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7151761448757264415">https://juejin.cn/post/7151761448757264415</a></p>
<h2 id="OKHttp-如何复用-TCP-连接"><a href="#OKHttp-如何复用-TCP-连接" class="headerlink" title="OKHttp 如何复用 TCP 连接"></a><span class="ez-toc-section" id="OKHttp_%E5%A6%82%E4%BD%95%E5%A4%8D%E7%94%A8_TCP_%E8%BF%9E%E6%8E%A5"></span>OKHttp 如何复用 TCP 连接<span class="ez-toc-section-end"></span></h2><p>ChatGpt<br>Resuming TCP connections in OkHttp is not straightforward because TCP connection resumption at the application level is generally managed by the underlying operating system and network stack rather than by application-level code. However, you can manage HTTP request retries and connection pooling to effectively handle network interruptions and failures.</p>
<p>Here are a few steps and strategies to handle TCP connection issues and retries in OkHttp:</p>
<p>Connection Pooling<br>OkHttp manages connections in a connection pool, which can be reused for multiple requests. This reduces latency by avoiding the need to establish a new TCP connection for each request. Ensure your connection pool is properly configured.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ConnectionPool</span> <span class="variable">connectionPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionPool</span>(<span class="number">5</span>, <span class="number">5</span>, TimeUnit.MINUTES);</span><br><span class="line"><span class="type">OkHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder()</span><br><span class="line">    .connectionPool(connectionPool)</span><br><span class="line">    .build();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个link 详细介绍了物理层面 连接复用规则Keep-Alive<br><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904037167415310#heading-8">https://juejin.cn/post/6844904037167415310#heading-8</a></p>
<h2 id="OKHttp-空闲连接如何清除"><a href="#OKHttp-空闲连接如何清除" class="headerlink" title="OKHttp 空闲连接如何清除"></a><span class="ez-toc-section" id="OKHttp_%E7%A9%BA%E9%97%B2%E8%BF%9E%E6%8E%A5%E5%A6%82%E4%BD%95%E6%B8%85%E9%99%A4"></span>OKHttp 空闲连接如何清除<span class="ez-toc-section-end"></span></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Find the longest-idle connections in 2 categories:</span><br><span class="line"></span><br><span class="line"> 1. OLD: Connections that have been idle for at least keepAliveDurationNs. We close these if</span><br><span class="line">    we find them, regardless of what the address policies need.</span><br><span class="line"></span><br><span class="line"> 2. EVICTABLE: Connections not required by any address policy. This matches connections that</span><br><span class="line">    don&#x27;t participate in any policy, plus connections whose policies won&#x27;t be violated if the</span><br><span class="line">    connection is closed. We only close these if the idle connection limit is exceeded.</span><br><span class="line"></span><br><span class="line">Also count the evictable connections to find out if we must close an EVICTABLE connection</span><br></pre></td></tr></table></figure>

<ol>
<li>在将连接加入连接池时就会启动定时任务 RealConenctionPool &#96;&#96;&#96;<br>  fun put(connection: RealConnection) {<br>  connection.assertThreadHoldsLock()<br>  connections.add(connection)<br>  &#x2F;&#x2F;    connection.queueEvent { connectionListener.connectEnd(connection) }<br>  scheduleCloser()<br>  }  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. 有空闲连接的话，如果最长的空闲时间大于5分钟 或 空闲数 大于5，就移除关闭这个最长空闲连接；如果 空闲数 不大于5 且 最长的空闲时间不大于5分钟，就返回到5分钟的剩余时间，然后等待这个时间再来清理。</span><br><span class="line"></span><br><span class="line">RealConnectionPool</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">  fun closeConnections(now: Long): Long &#123;</span><br><span class="line">    // Compute the concurrent call capacity for each address. We won&#x27;t close a connection if doing</span><br><span class="line">    // so would violate a policy, unless it&#x27;s OLD.</span><br><span class="line">    val addressStates = this.addressStates</span><br><span class="line">    for (state in addressStates.values) &#123;</span><br><span class="line">      state.concurrentCallCapacity = 0</span><br><span class="line">    &#125;</span><br><span class="line">    for (connection in connections) &#123;</span><br><span class="line">      val addressState = addressStates[connection.route.address] ?: continue</span><br><span class="line">      synchronized(connection) &#123;</span><br><span class="line">        addressState.concurrentCallCapacity += connection.allocationLimit</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Find the longest-idle connections in 2 categories:</span><br><span class="line">    //</span><br><span class="line">    //  1. OLD: Connections that have been idle for at least keepAliveDurationNs. We close these if</span><br><span class="line">    //     we find them, regardless of what the address policies need.</span><br><span class="line">    //</span><br><span class="line">    //  2. EVICTABLE: Connections not required by any address policy. This matches connections that</span><br><span class="line">    //     don&#x27;t participate in any policy, plus connections whose policies won&#x27;t be violated if the</span><br><span class="line">    //     connection is closed. We only close these if the idle connection limit is exceeded.</span><br><span class="line">    //</span><br><span class="line">    // Also count the evictable connections to find out if we must close an EVICTABLE connection</span><br><span class="line">    // before its keepAliveDurationNs is reached.</span><br><span class="line">    var earliestOldIdleAtNs = (now - keepAliveDurationNs) + 1</span><br><span class="line">    var earliestOldConnection: RealConnection? = null</span><br><span class="line">    var earliestEvictableIdleAtNs = Long.MAX_VALUE</span><br><span class="line">    var earliestEvictableConnection: RealConnection? = null</span><br><span class="line">    var inUseConnectionCount = 0</span><br><span class="line">    var evictableConnectionCount = 0</span><br><span class="line">    for (connection in connections) &#123;</span><br><span class="line">      synchronized(connection) &#123;</span><br><span class="line">        // If the connection is in use, keep searching. 如果该连接正在被使用，则继续遍历，使用连接数+1</span><br><span class="line">        if (pruneAndGetAllocationCount(connection, now) &gt; 0) &#123;</span><br><span class="line">          inUseConnectionCount++</span><br><span class="line">          return@synchronized</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 记录最长空闲时长，以及最长空闲时长对应的连接</span><br><span class="line">        val idleAtNs = connection.idleAtNs</span><br><span class="line"></span><br><span class="line">        if (idleAtNs &lt; earliestOldIdleAtNs) &#123;</span><br><span class="line">          earliestOldIdleAtNs = idleAtNs</span><br><span class="line">          earliestOldConnection = connection</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (isEvictable(addressStates, connection)) &#123;</span><br><span class="line">          evictableConnectionCount++</span><br><span class="line">          if (idleAtNs &lt; earliestEvictableIdleAtNs) &#123; // 当连接最长空闲时长大于配置的时长</span><br><span class="line">            earliestEvictableIdleAtNs = idleAtNs</span><br><span class="line">            earliestEvictableConnection = connection</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    val toEvict: RealConnection?</span><br><span class="line">    val toEvictIdleAtNs: Long</span><br><span class="line">    when &#123;</span><br><span class="line">      // We had at least one OLD connection. Close the oldest one.</span><br><span class="line">      earliestOldConnection != null -&gt; &#123;</span><br><span class="line">        toEvict = earliestOldConnection</span><br><span class="line">        toEvictIdleAtNs = earliestOldIdleAtNs</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // We have too many EVICTABLE connections. Close the oldest one.</span><br><span class="line">      evictableConnectionCount &gt; maxIdleConnections -&gt; &#123; //空闲连接个是&gt; 配置的个数</span><br><span class="line">        toEvict = earliestEvictableConnection</span><br><span class="line">        toEvictIdleAtNs = earliestEvictableIdleAtNs</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      else -&gt; &#123;</span><br><span class="line">        toEvict = null</span><br><span class="line">        toEvictIdleAtNs = -1L</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    when &#123;</span><br><span class="line">      toEvict != null -&gt; &#123;</span><br><span class="line">        // We&#x27;ve chosen a connection to evict. Confirm it&#x27;s still okay to be evicted, then close it.</span><br><span class="line">        synchronized(toEvict) &#123;</span><br><span class="line">          if (toEvict.calls.isNotEmpty()) return 0L // No longer idle.</span><br><span class="line">          if (toEvict.idleAtNs != toEvictIdleAtNs) return 0L // No longer oldest.</span><br><span class="line">          toEvict.noNewExchanges = true</span><br><span class="line">          connections.remove(toEvict)</span><br><span class="line">        &#125;</span><br><span class="line">        addressStates[toEvict.route.address]?.scheduleOpener()</span><br><span class="line">        toEvict.socket().closeQuietly()</span><br><span class="line">        connectionListener.connectionClosed(toEvict)</span><br><span class="line">        if (connections.isEmpty()) cleanupQueue.cancelAll()</span><br><span class="line"></span><br><span class="line">        // Clean up again immediately.</span><br><span class="line">        return 0L</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      earliestEvictableConnection != null -&gt; &#123;</span><br><span class="line">        // A connection will be ready to evict soon.</span><br><span class="line">        return earliestEvictableIdleAtNs + keepAliveDurationNs - now</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      inUseConnectionCount &gt; 0 -&gt; &#123;</span><br><span class="line">        // All connections are in use. It&#x27;ll be at least the keep alive duration &#x27;til we run again.</span><br><span class="line">        return keepAliveDurationNs</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      else -&gt; &#123;</span><br><span class="line">        // No connections, idle or in use.</span><br><span class="line">        return -1</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li>close OkhttpClient<br>立即关闭空闲连接，maxIdle、keepAliveDuration限制</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">fun <span class="title function_">evictAll</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">val</span> <span class="variable">i</span> <span class="operator">=</span> connections.iterator()</span><br><span class="line">  <span class="keyword">while</span> (i.hasNext()) &#123;</span><br><span class="line">    <span class="type">val</span> <span class="variable">connection</span> <span class="operator">=</span> i.next()</span><br><span class="line">    <span class="type">val</span> <span class="variable">socketToClose</span> <span class="operator">=</span></span><br><span class="line">      <span class="keyword">synchronized</span>(connection) &#123;</span><br><span class="line">        <span class="keyword">if</span> (connection.calls.isEmpty()) &#123;</span><br><span class="line">          i.remove()</span><br><span class="line">          connection.noNewExchanges = <span class="literal">true</span> <span class="comment">// 只有连接空闲，先标记，防止close前又被复用.</span></span><br><span class="line">          <span class="keyword">return</span><span class="meta">@synchronized</span> connection.socket()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span><span class="meta">@synchronized</span> <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">if</span> (socketToClose != <span class="literal">null</span>) &#123;</span><br><span class="line">      socketToClose.closeQuietly()</span><br><span class="line">      connectionListener.connectionClosed(connection)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (connections.isEmpty()) cleanupQueue.cancelAll()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (policy in addressStates.values) &#123;</span><br><span class="line">    policy.scheduleOpener()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904054095790087">https://juejin.cn/post/6844904054095790087</a></p>
<ol start="3">
<li>没有空闲连接就等5分钟后再尝试清理。</li>
<li>没有连接不清理。</li>
</ol>
</div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Your name"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Your name</p><p class="is-size-6 is-block">Your title</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Your location</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">243</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">30</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">33</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ppoffice" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ppoffice"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/ANDROID/"><span class="level-start"><span class="level-item">ANDROID</span></span><span class="level-end"><span class="level-item tag">54</span></span></a></li><li><a class="level is-mobile" href="/categories/Architecture/"><span class="level-start"><span class="level-item">Architecture</span></span><span class="level-end"><span class="level-item tag">3</span></span></a><ul><li><a class="level is-mobile" href="/categories/Architecture/DesignPattern/"><span class="level-start"><span class="level-item">DesignPattern</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/BLE/"><span class="level-start"><span class="level-item">BLE</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/C/"><span class="level-start"><span class="level-item">C++</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/COROUTINE/"><span class="level-start"><span class="level-item">COROUTINE</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Computer-Composition-principles/"><span class="level-start"><span class="level-item">Computer Composition principles</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/DataStructure/"><span class="level-start"><span class="level-item">DataStructure</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/categories/DesignPattern/"><span class="level-start"><span class="level-item">DesignPattern</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/DesignPatterns/"><span class="level-start"><span class="level-item">DesignPatterns</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/ENGLISH/"><span class="level-start"><span class="level-item">ENGLISH</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/INTERVIEW/"><span class="level-start"><span class="level-item">INTERVIEW</span></span><span class="level-end"><span class="level-item tag">9</span></span></a><ul><li><a class="level is-mobile" href="/categories/INTERVIEW/NETWORK/"><span class="level-start"><span class="level-item">NETWORK</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/JAVA/"><span class="level-start"><span class="level-item">JAVA</span></span><span class="level-end"><span class="level-item tag">27</span></span></a></li><li><a class="level is-mobile" href="/categories/JETPACK/"><span class="level-start"><span class="level-item">JETPACK</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Jetpack/"><span class="level-start"><span class="level-item">Jetpack</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Kotlin/"><span class="level-start"><span class="level-item">Kotlin</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/LIFE/"><span class="level-start"><span class="level-item">LIFE</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/LINUX/"><span class="level-start"><span class="level-item">LINUX</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/Library/"><span class="level-start"><span class="level-item">Library</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Mathematics/"><span class="level-start"><span class="level-item">Mathematics</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/NETWORK/"><span class="level-start"><span class="level-item">NETWORK</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/OS/"><span class="level-start"><span class="level-item">OS</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Organization/"><span class="level-start"><span class="level-item">Organization</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/SOURCE/"><span class="level-start"><span class="level-item">SOURCE</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/TEST/"><span class="level-start"><span class="level-item">TEST</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/TOOL/"><span class="level-start"><span class="level-item">TOOL</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile" href="/categories/VIEW/"><span class="level-start"><span class="level-item">VIEW</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/categories/anim/"><span class="level-start"><span class="level-item">anim</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/flutter/"><span class="level-start"><span class="level-item">flutter</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-07-04T07:57:26.000Z">2024-07-04</time></p><p class="title"><a href="/2024/07/04/DesignPatterns-State/">DesignPatterns_State</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-07-03T05:51:25.000Z">2024-07-03</time></p><p class="title"><a href="/2024/07/03/glide/">glide</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-06-28T09:37:49.000Z">2024-06-28</time></p><p class="title"><a href="/2024/06/28/bitmap/">Bitmap</a></p><p class="categories"><a href="/categories/Computer-Composition-principles/">Computer Composition principles</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-06-28T08:04:14.000Z">2024-06-28</time></p><p class="title"><a href="/2024/06/28/bits-and-bytes/">Bits and Bytes</a></p><p class="categories"><a href="/categories/Computer-Composition-principles/">Computer Composition principles</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-06-26T06:45:50.000Z">2024-06-26</time></p><p class="title"><a href="/2024/06/26/lifecycle/">LifeCycle</a></p><p class="categories"><a href="/categories/JETPACK/">JETPACK</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/07/"><span class="level-start"><span class="level-item">July 2024</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/06/"><span class="level-start"><span class="level-item">June 2024</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/05/"><span class="level-start"><span class="level-item">May 2024</span></span><span class="level-end"><span class="level-item tag">28</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/11/"><span class="level-start"><span class="level-item">November 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/08/"><span class="level-start"><span class="level-item">August 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/04/"><span class="level-start"><span class="level-item">April 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">January 2023</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/12/"><span class="level-start"><span class="level-item">December 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">October 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/09/"><span class="level-start"><span class="level-item">September 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">August 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">July 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">June 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">May 2022</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">April 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">March 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/02/"><span class="level-start"><span class="level-item">February 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">January 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">December 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">November 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">October 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/09/"><span class="level-start"><span class="level-item">September 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">August 2021</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">June 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">May 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">April 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">March 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">February 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">January 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">December 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">November 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">October 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">September 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">August 2020</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">July 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">June 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">May 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">April 2020</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">March 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">January 2020</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/12/"><span class="level-start"><span class="level-item">December 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">November 2019</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/09/"><span class="level-start"><span class="level-item">September 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">August 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">July 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/06/"><span class="level-start"><span class="level-item">June 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/04/"><span class="level-start"><span class="level-item">April 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/03/"><span class="level-start"><span class="level-item">March 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">January 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/11/"><span class="level-start"><span class="level-item">November 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/08/"><span class="level-start"><span class="level-item">August 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/07/"><span class="level-start"><span class="level-item">July 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/06/"><span class="level-start"><span class="level-item">June 2018</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/05/"><span class="level-start"><span class="level-item">May 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">April 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/03/"><span class="level-start"><span class="level-item">March 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/02/"><span class="level-start"><span class="level-item">February 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">January 2018</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">December 2017</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/11/"><span class="level-start"><span class="level-item">November 2017</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/10/"><span class="level-start"><span class="level-item">October 2017</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">September 2017</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/08/"><span class="level-start"><span class="level-item">August 2017</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/07/"><span class="level-start"><span class="level-item">July 2017</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ANDROID/"><span class="tag">ANDROID</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AOSP/"><span class="tag">AOSP</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Activity/"><span class="tag">Activity</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/AndroidNewFeatures/"><span class="tag">AndroidNewFeatures</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Assembly/"><span class="tag">Assembly</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BLOG/"><span class="tag">BLOG</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ConstraintLayout/"><span class="tag">ConstraintLayout</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DB/"><span class="tag">DB</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DesignPattern/"><span class="tag">DesignPattern</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Drawer/"><span class="tag">Drawer</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Fragment/"><span class="tag">Fragment</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JVM/"><span class="tag">JVM</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LEETCODE/"><span class="tag">LEETCODE</span><span class="tag">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Library/"><span class="tag">Library</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Operators/"><span class="tag">Operators</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Performance/"><span class="tag">Performance</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RecyclerView/"><span class="tag">RecyclerView</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RxJava/"><span class="tag">RxJava</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/THINK/"><span class="tag">THINK</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TOOL/"><span class="tag">TOOL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TabLayout/"><span class="tag">TabLayout</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Test/"><span class="tag">Test</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/TouchEvent/"><span class="tag">TouchEvent</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/VIEW/"><span class="tag">VIEW</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/XML/"><span class="tag">XML</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/anim/"><span class="tag">anim</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/compose/"><span class="tag">compose</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/concurrency/"><span class="tag">concurrency</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/coroutie/"><span class="tag">coroutie</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/inter/"><span class="tag">inter</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/keyboard/"><span class="tag">keyboard</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/permission/"><span class="tag">permission</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/proguard/"><span class="tag">proguard</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Jon&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2024 Jon</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2019</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>